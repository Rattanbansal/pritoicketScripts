---- query with all 5 column comparison with currency code

select * from (select pos_ticket_id, hotel_id, mec_id,currency_code,ticketPrice,pricetext,ticket_net_price,newPrice,totalticketPrice,resalecurrency,price_shouldbe, net_price_shouldbe,currency_shouldbe, startdate, enddate, (case when currency_code = currency_shouldbe then 0 else 1 end + case when ABS(ticketPrice-price_shouldbe) < '0.05' then 0 else 1 end + case when ABS(pricetext-price_shouldbe) < '0.05' then 0 else 1 end + case when ABS(ticket_net_price-net_price_shouldbe) < '0.05' then 0 else 1 end + case when ABS(newPrice-price_shouldbe) < '0.05' then 0 else 1 end + case when ABS(totalticketPrice-price_shouldbe) < '0.05' then 0 else 1 end) as totalvalue,  ROW_NUMBER() OVER (PARTITION BY hotel_id, mec_id ORDER BY resalecurrency) AS rn from (select *, CURRENT_DATE, case when tlc_tps_id is not NULL and tlc_tps_id = tps_id then tlc_price when tlc_tps_id is null and tlc_tps_id != tps_id and catalog_tps_id is not null and catalog_tps_id = tps_id then catalog_price when tlc_tps_id is null and tlc_tps_id != tps_id and catalog_tps_id is null and catalog_tps_id != tps_id and clc_tps_id is not null and clc_tps_id = tps_id then clc_price else tps_price end as price_shouldbe,case when tlc_tps_id is not NULL and tlc_tps_id = tps_id then tlc_net_price when tlc_tps_id is null and tlc_tps_id != tps_id and catalog_tps_id is not null and catalog_tps_id = tps_id then catalog_net_price when tlc_tps_id is null and tlc_tps_id != tps_id and catalog_tps_id is null and catalog_tps_id != tps_id and clc_tps_id is not null and clc_tps_id = tps_id then clc_net_price else tps_net_price end as net_price_shouldbe, case when tlc_tps_id is not NULL and tlc_tps_id = tps_id then tlc_currency_level when tlc_tps_id is null and tlc_tps_id != tps_id and catalog_tps_id is not null and catalog_tps_id = tps_id then catalog_currency_level when tlc_tps_id is null and tlc_tps_id != tps_id and catalog_tps_id is null and catalog_tps_id != tps_id and clc_tps_id is not null and clc_tps_id = tps_id then clc_currency_level else 1 end as resalecurrency,case when tlc_tps_id is not NULL and tlc_tps_id = tps_id then tlc_currency when tlc_tps_id is null and tlc_tps_id != tps_id and catalog_tps_id is not null and catalog_tps_id = tps_id then catalog_currency when tlc_tps_id is null and tlc_tps_id != tps_id and catalog_tps_id is null and catalog_tps_id != tps_id and clc_tps_id is not null and clc_tps_id = tps_id then clc_currency else tps_currency end as currency_shouldbe  from (SELECT pos.pos_ticket_id,pos.hotel_id, pos.mec_id,pos.currency_code,pos.ticketPrice, pos.pricetext, pos.ticket_net_price, pos.newPrice, pos.totalticketPrice, qc.channel_id, qc.sub_catalog_id,tlc.ticketpriceschedule_id as tlc_tps_id, tlc.currency as tlc_currency, tlc.ticket_gross_price as tlc_price, tlc.ticket_net_price as tlc_net_price, tlc.resale_currency_level as tlc_currency_level,catalog.ticketpriceschedule_id as catalog_tps_id, catalog.currency as catalog_currency, catalog.ticket_gross_price as catalog_price, catalog.ticket_net_price as catalog_net_price, catalog.resale_currency_level as catalog_currency_level,clc.ticketpriceschedule_id as clc_tps_id,clc.currency as clc_currency, clc.ticket_gross_price as clc_price, clc.ticket_net_price as clc_net_price, clc.resale_currency_level as clc_currency_level,tps.id as tps_id,tps.currency_code as tps_currency, tps.newPrice as tps_price, tps.ticket_net_price as tps_net_price, tps.start_date, tps.end_date, DATE(from_unixtime(if(tps.start_date like '%999999%', 1831131566, tps.start_date))) as startdate, DATE(from_unixtime(if(tps.end_date like '%999999%', 1831131566, tps.end_date))) as enddate  FROM pos_tickets pos left join qr_codes qc on pos.hotel_id = qc.cod_id left join ticket_level_commission tlc on pos.hotel_id = tlc.hotel_id and pos.mec_id = tlc.ticket_id and tlc.deleted = '0' and tlc.default_listing = '1' and tlc.is_adjust_pricing = '1' left join channel_level_commission catalog on pos.mec_id = catalog.ticket_id and if(qc.sub_catalog_id > '100',qc.sub_catalog_id, '11') = if(catalog.catalog_id > '0', catalog.catalog_id, 12) and catalog.deleted = '0' and catalog.is_adjust_pricing = '1' and catalog.default_listing = '1' left join channel_level_commission clc on clc.channel_id = qc.channel_id and clc.ticket_id = pos.mec_id and clc.deleted = '0' and clc.is_adjust_pricing = '1' and clc.default_listing = '1' left join ticketpriceschedule tps on tps.ticket_id = pos.mec_id and tps.deleted = '0' and tps.default_listing = '1' and (tlc.ticketpriceschedule_id = tps.id or catalog.ticketpriceschedule_id = tps.id or clc.ticketpriceschedule_id = tps.id or DATE(from_unixtime(if(tps.end_date like '%999999%', 1831131566, tps.end_date))) > CURRENT_DATE) where pos.hotel_id = '48470' and pos.deleted = '0' and qc.cashier_type = '1') as base where CURRENT_DATE between startdate and enddate) as base2) as final where rn = '1' and totalvalue != '0'


--- query with reduce 1 column currency code and totalticketprice

select * from (select pos_ticket_id, hotel_id, mec_id,currency_code,ticketPrice,pricetext,ticket_net_price,newPrice,totalticketPrice,resalecurrency,price_shouldbe, net_price_shouldbe,currency_shouldbe, startdate, enddate, (case when ABS(ticketPrice-price_shouldbe) < '0.05' then 0 else 1 end + case when ABS(pricetext-price_shouldbe) < '0.05' then 0 else 1 end + case when ABS(ticket_net_price-net_price_shouldbe) < '0.05' then 0 else 1 end + case when ABS(newPrice-price_shouldbe) < '0.05' then 0 else 1 end) as totalvalue,  ROW_NUMBER() OVER (PARTITION BY hotel_id, mec_id ORDER BY resalecurrency) AS rn from (select *, CURRENT_DATE, case when tlc_tps_id is not NULL and tlc_tps_id = tps_id then tlc_price when tlc_tps_id is null and tlc_tps_id != tps_id and catalog_tps_id is not null and catalog_tps_id = tps_id then catalog_price when tlc_tps_id is null and tlc_tps_id != tps_id and catalog_tps_id is null and catalog_tps_id != tps_id and clc_tps_id is not null and clc_tps_id = tps_id then clc_price else tps_price end as price_shouldbe,case when tlc_tps_id is not NULL and tlc_tps_id = tps_id then tlc_net_price when tlc_tps_id is null and tlc_tps_id != tps_id and catalog_tps_id is not null and catalog_tps_id = tps_id then catalog_net_price when tlc_tps_id is null and tlc_tps_id != tps_id and catalog_tps_id is null and catalog_tps_id != tps_id and clc_tps_id is not null and clc_tps_id = tps_id then clc_net_price else tps_net_price end as net_price_shouldbe, case when tlc_tps_id is not NULL and tlc_tps_id = tps_id then tlc_currency_level when tlc_tps_id is null and tlc_tps_id != tps_id and catalog_tps_id is not null and catalog_tps_id = tps_id then catalog_currency_level when tlc_tps_id is null and tlc_tps_id != tps_id and catalog_tps_id is null and catalog_tps_id != tps_id and clc_tps_id is not null and clc_tps_id = tps_id then clc_currency_level else 1 end as resalecurrency,case when tlc_tps_id is not NULL and tlc_tps_id = tps_id then tlc_currency when tlc_tps_id is null and tlc_tps_id != tps_id and catalog_tps_id is not null and catalog_tps_id = tps_id then catalog_currency when tlc_tps_id is null and tlc_tps_id != tps_id and catalog_tps_id is null and catalog_tps_id != tps_id and clc_tps_id is not null and clc_tps_id = tps_id then clc_currency else tps_currency end as currency_shouldbe  from (SELECT pos.pos_ticket_id,pos.hotel_id, pos.mec_id,pos.currency_code,pos.ticketPrice, pos.pricetext, pos.ticket_net_price, pos.newPrice, pos.totalticketPrice, qc.channel_id, qc.sub_catalog_id,tlc.ticketpriceschedule_id as tlc_tps_id, tlc.currency as tlc_currency, tlc.ticket_gross_price as tlc_price, tlc.ticket_net_price as tlc_net_price, tlc.resale_currency_level as tlc_currency_level,catalog.ticketpriceschedule_id as catalog_tps_id, catalog.currency as catalog_currency, catalog.ticket_gross_price as catalog_price, catalog.ticket_net_price as catalog_net_price, catalog.resale_currency_level as catalog_currency_level,clc.ticketpriceschedule_id as clc_tps_id,clc.currency as clc_currency, clc.ticket_gross_price as clc_price, clc.ticket_net_price as clc_net_price, clc.resale_currency_level as clc_currency_level,tps.id as tps_id,tps.currency_code as tps_currency, tps.newPrice as tps_price, tps.ticket_net_price as tps_net_price, tps.start_date, tps.end_date, DATE(from_unixtime(if(tps.start_date like '%999999%', 1831131566, tps.start_date))) as startdate, DATE(from_unixtime(if(tps.end_date like '%999999%', 1831131566, tps.end_date))) as enddate  FROM pos_tickets pos left join qr_codes qc on pos.hotel_id = qc.cod_id left join ticket_level_commission tlc on pos.hotel_id = tlc.hotel_id and pos.mec_id = tlc.ticket_id and tlc.deleted = '0' and tlc.default_listing = '1' and tlc.is_adjust_pricing = '1' left join channel_level_commission catalog on pos.mec_id = catalog.ticket_id and if(qc.sub_catalog_id > '100',qc.sub_catalog_id, '11') = if(catalog.catalog_id > '0', catalog.catalog_id, 12) and catalog.deleted = '0' and catalog.is_adjust_pricing = '1' and catalog.default_listing = '1' left join channel_level_commission clc on clc.channel_id = qc.channel_id and clc.ticket_id = pos.mec_id and clc.deleted = '0' and clc.is_adjust_pricing = '1' and clc.default_listing = '1' left join ticketpriceschedule tps on tps.ticket_id = pos.mec_id and tps.deleted = '0' and tps.default_listing = '1' and (tlc.ticketpriceschedule_id = tps.id or catalog.ticketpriceschedule_id = tps.id or clc.ticketpriceschedule_id = tps.id or DATE(from_unixtime(if(tps.end_date like '%999999%', 1831131566, tps.end_date))) > CURRENT_DATE) where pos.hotel_id = '46905' and pos.deleted = '0' and qc.cashier_type = '1') as base where CURRENT_DATE between startdate and enddate) as base2) as final where rn = '1' and totalvalue != '0'


-------Update query----------

explain update pos_tickets pos join (select pos_ticket_id, hotel_id, mec_id,currency_code,ticketPrice,pricetext,ticket_net_price,newPrice,totalticketPrice,resalecurrency,price_shouldbe, net_price_shouldbe,currency_shouldbe, startdate, enddate, (case when currency_code = currency_shouldbe then 0 else 1 end + case when ABS(ticketPrice-price_shouldbe) < '0.05' then 0 else 1 end + case when ABS(pricetext-price_shouldbe) < '0.05' then 0 else 1 end + case when ABS(ticket_net_price-net_price_shouldbe) < '0.05' then 0 else 1 end + case when ABS(newPrice-price_shouldbe) < '0.05' then 0 else 1 end + case when ABS(totalticketPrice-price_shouldbe) < '0.05' then 0 else 1 end) as totalvalue,  ROW_NUMBER() OVER (PARTITION BY hotel_id, mec_id ORDER BY resalecurrency) AS rn from (select *, CURRENT_DATE, case when tlc_tps_id is not NULL and tlc_tps_id = tps_id then tlc_price when tlc_tps_id is null and tlc_tps_id != tps_id and catalog_tps_id is not null and catalog_tps_id = tps_id then catalog_price when tlc_tps_id is null and tlc_tps_id != tps_id and catalog_tps_id is null and catalog_tps_id != tps_id and clc_tps_id is not null and clc_tps_id = tps_id then clc_price else tps_price end as price_shouldbe,case when tlc_tps_id is not NULL and tlc_tps_id = tps_id then tlc_net_price when tlc_tps_id is null and tlc_tps_id != tps_id and catalog_tps_id is not null and catalog_tps_id = tps_id then catalog_net_price when tlc_tps_id is null and tlc_tps_id != tps_id and catalog_tps_id is null and catalog_tps_id != tps_id and clc_tps_id is not null and clc_tps_id = tps_id then clc_net_price else tps_net_price end as net_price_shouldbe, case when tlc_tps_id is not NULL and tlc_tps_id = tps_id then tlc_currency_level when tlc_tps_id is null and tlc_tps_id != tps_id and catalog_tps_id is not null and catalog_tps_id = tps_id then catalog_currency_level when tlc_tps_id is null and tlc_tps_id != tps_id and catalog_tps_id is null and catalog_tps_id != tps_id and clc_tps_id is not null and clc_tps_id = tps_id then clc_currency_level else 1 end as resalecurrency,case when tlc_tps_id is not NULL and tlc_tps_id = tps_id then tlc_currency when tlc_tps_id is null and tlc_tps_id != tps_id and catalog_tps_id is not null and catalog_tps_id = tps_id then catalog_currency when tlc_tps_id is null and tlc_tps_id != tps_id and catalog_tps_id is null and catalog_tps_id != tps_id and clc_tps_id is not null and clc_tps_id = tps_id then clc_currency else tps_currency end as currency_shouldbe  from (SELECT pos.pos_ticket_id,pos.hotel_id, pos.mec_id,pos.currency_code,pos.ticketPrice, pos.pricetext, pos.ticket_net_price, pos.newPrice, pos.totalticketPrice, qc.channel_id, qc.sub_catalog_id,tlc.ticketpriceschedule_id as tlc_tps_id, tlc.currency as tlc_currency, tlc.ticket_gross_price as tlc_price, tlc.ticket_net_price as tlc_net_price, tlc.resale_currency_level as tlc_currency_level,catalog.ticketpriceschedule_id as catalog_tps_id, catalog.currency as catalog_currency, catalog.ticket_gross_price as catalog_price, catalog.ticket_net_price as catalog_net_price, catalog.resale_currency_level as catalog_currency_level,clc.ticketpriceschedule_id as clc_tps_id,clc.currency as clc_currency, clc.ticket_gross_price as clc_price, clc.ticket_net_price as clc_net_price, clc.resale_currency_level as clc_currency_level,tps.id as tps_id,tps.currency_code as tps_currency, tps.newPrice as tps_price, tps.ticket_net_price as tps_net_price, tps.start_date, tps.end_date, DATE(from_unixtime(if(tps.start_date like '%999999%', 1831131566, tps.start_date))) as startdate, DATE(from_unixtime(if(tps.end_date like '%999999%', 1831131566, tps.end_date))) as enddate  FROM pos_tickets pos left join qr_codes qc on pos.hotel_id = qc.cod_id left join ticket_level_commission tlc on pos.hotel_id = tlc.hotel_id and pos.mec_id = tlc.ticket_id and tlc.deleted = '0' and tlc.default_listing = '1' and tlc.is_adjust_pricing = '1' left join channel_level_commission catalog on pos.mec_id = catalog.ticket_id and if(qc.sub_catalog_id > '100',qc.sub_catalog_id, '11') = if(catalog.catalog_id > '0', catalog.catalog_id, 12) and catalog.deleted = '0' and catalog.is_adjust_pricing = '1' and catalog.default_listing = '1' left join channel_level_commission clc on clc.channel_id = qc.channel_id and clc.ticket_id = pos.mec_id and clc.deleted = '0' and clc.is_adjust_pricing = '1' and clc.default_listing = '1' left join ticketpriceschedule tps on tps.ticket_id = pos.mec_id and tps.deleted = '0' and tps.default_listing = '1' and (tlc.ticketpriceschedule_id = tps.id or catalog.ticketpriceschedule_id = tps.id or clc.ticketpriceschedule_id = tps.id or DATE(from_unixtime(if(tps.end_date like '%999999%', 1831131566, tps.end_date))) > CURRENT_DATE) where pos.hotel_id = '48470' and pos.deleted = '0' and qc.cashier_type = '1') as base where CURRENT_DATE between startdate and enddate) as base2) as final on final.pos_ticket_id = pos.pos_ticket_id set pos.currency_code = final.currency_shouldbe, pos.ticketPrice = final.price_shouldbe, pos.pricetext = final.price_shouldbe, pos.ticket_net_price = final.net_price_shouldbe, pos.newPrice = final.price_shouldbe, pos.totalticketPrice = final.price_shouldbe, pos.last_modified_at = '2025-01-13 13:13:13' where pos.hotel_id = '48470' and final.rn = '1' and final.totalvalue != '0'
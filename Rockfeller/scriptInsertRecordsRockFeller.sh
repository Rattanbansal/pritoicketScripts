#!/bin/bash

set -e  # Exit immediately if any command exits with a non-zero status
TIMEOUT_PERIOD=25

> found_mismatch.txt
> no_mismatch.txt

DB_HOST='localhost'
DB_USER='admin'
DB_PASS='redhat'
DB_NAME='dummy'
BATCH_SIZE=30

mysqlHost="prodrds.prioticket.com"
mysqlUser=pipeuser
mysqlPassword=d4fb46eccNRAL
mysqlDatabase="prioprodrds"

SECDATABASE='priopassdb'
SECHOST='production-secondary-db-node.cluster-ck6w2al7sgpk.eu-west-1.rds.amazonaws.com'
SECUSER='pipeuser'
SECPASSWORD='d4fb46eccNRAL'

vt_group_nos="173286205190378 173284005336226 173283755682717 173283391057802 173283175129610 173283070427815 173283063440844 173283037914623 173282923346804 173282948033140 173282749316450 173282737730203 173282632190440 173275970048861 173282612490062 173282414198659 173282406422807 173282386814214 173282287135284 173282039166847 173282006472524 173281697887705 173281552500584 173281431730028 173280558744723 173280680450562 173279349469925 173278312392146 173276006494611 173274933283567 173274602387183 173274316883925 173274220727554 173274177749256 173274159535618 173273980723008 173273934314578 173273853463527 173273449477105 173273385710424 173273119952201 173273114777071 173272555590659 173272531071490 173272389045073 173272079651852 173271455867908 173271477285694 173271299331117 173271046637430 173269977110365 173269872718796 173269321789550 173269313959155 173267291460312 173266849166455 173266718887646 173266725863651 173266208456625 173265728195403 173265214067006 173265051395217 173264775430013 173264457959108 173264070330840 173263497502650 173263437633505 173263137581675 173262628928568 173262354208460 173262107921574 173261857256179 173261096612856 173259205189672 173258674293072 173258117546667 173257928522396 173257778363061 173257456461655 173257331075080 173257055703228 173256992552079 173256946646837 173256950487247 173256880520860 173256853563642 173256695284786 173256605910087 173256581791241 173256563615185 173256474709728 173256241978327 173256158136212 173256058113417 173255843678589 173255690694372 173255710483765 173255709517450 173255711984852 173255653405369 173254823519391 173254728591599 173254756630046 173253958179745 173248175991423 173248745473056 173246823473234 173246777076222 173246569701537 173246065031324 173244350724247 173239490307430 173238377334997 173237467870908 173237280557273 173189037525801 173219535052866 173217935438381 173217472977720 173214364975328 173210731383747 173108180653186 173196499568473 173196044822853 173194288169158 173187100441642 173187583163455 173150218517117 173185757622287 173185466746976 173184656953927 173183534963012 173179737798169 173178263261190 173176835732629 173176637226864 173175850212088 173168196530102 173160139086925 173158024572651 173152830608703"

for vt_group_no in ${vt_group_nos}

do



    MISMATCH="select * from (select *, ROUND(case when row_type in ('1','4') then should_be+pricevariationamount when row_type = '20' then partner_net_price else should_be end,2) as partner_net_price_shouldbe from (select base.*, rvt.partner_net_price as pricevariationamount from (select * from (select *, (case when tlc_ticketpriceschedule_id is not NULL then tlc_commissions when tlc_ticketpriceschedule_id is NULL and sc_ticketpriceschedule_id is not NULL then sucatalog_commissions when tlc_ticketpriceschedule_id is NULL and sc_ticketpriceschedule_id is NULL and clc_ticketpriceschedule_id is not NULL then pricelist_commissions else 'No_Setting_found' end) as should_be from (select scdata.*, '----Price List Level---' as type3,pl.ticketpriceschedule_id as clc_ticketpriceschedule_id,(case when scdata.row_type = '1' then pl.ticket_net_price when scdata.row_type = '2' then pl.museum_net_commission when scdata.row_type = '17' then pl.merchant_net_commission when scdata.row_type = '3' then pl.hotel_commission_net_price when scdata.row_type = '4' then pl.hgs_commission_net_price else 0 end) as pricelist_commissions  from (select tlcdata.*, '----Sub catalog Level---' as type2, sc.catalog_id,sc.ticketpriceschedule_id as sc_ticketpriceschedule_id, sc.resale_currency_level as sc_resale_currency_level, (case when tlcdata.row_type = '1' then sc.ticket_net_price when tlcdata.row_type = '2' then sc.museum_net_commission when tlcdata.row_type = '17' then sc.merchant_net_commission when tlcdata.row_type = '3' then sc.hotel_commission_net_price when tlcdata.row_type = '4' then sc.hgs_commission_net_price else 0 end) as sucatalog_commissions   from (select vt.vt_group_no, concat(vt.transaction_id) as transaction_id,vt.order_confirm_date, vt.created_date,vt.hotel_id, vt.channel_id, vt.ticketId, vt.ticketpriceschedule_id, vt.version, vt.row_type, vt.partner_gross_price, vt.partner_net_price, vt.order_currency_partner_gross_price, vt.order_currency_partner_net_price, vt.supplier_gross_price, vt.supplier_net_price, vt.col2, qc.cod_id as company_id, qc.channel_id as company_pricelist_id, qc.sub_catalog_id as company_sub_catalog, '---TLC LEVEL---' as Type, tlc.ticketpriceschedule_id as tlc_ticketpriceschedule_id, tlc.resale_currency_level, (case when vt.row_type = '1' then tlc.ticket_net_price when vt.row_type = '2' then tlc.museum_net_commission when vt.row_type = '17' then tlc.merchant_net_commission when vt.row_type = '3' then tlc.hotel_commission_net_price when vt.row_type = '4' then tlc.hgs_commission_net_price else 0 end) as tlc_commissions from visitor_tickets vt join (select vt_group_no, transaction_id,row_type, max(version) as version from visitor_tickets where vt_group_no in ($vt_group_no) and col2 != '2' group by vt_group_no, transaction_id, row_type) as maxversion on vt.vt_group_no = maxversion.vt_group_no and vt.transaction_id = maxversion.transaction_id and vt.row_type = maxversion.row_type and ABS(vt.version-maxversion.version) = '0' left join tmp.qr_codes qc on qc.cod_id = vt.hotel_id and qc.cashier_type = '1' left join tmp.ticket_level_commission tlc on tlc.hotel_id = vt.hotel_id and tlc.ticketpriceschedule_id = vt.ticketpriceschedule_id and tlc.ticket_id = vt.ticketId and tlc.deleted = '0' and tlc.is_adjust_pricing = '1' where vt.col2 != '2') as tlcdata left join tmp.channel_level_commission sc on tlcdata.ticketpriceschedule_id = sc.ticketpriceschedule_id and tlcdata.ticketId = sc.ticket_id and if(tlcdata.company_sub_catalog = '0', 122222, tlcdata.company_sub_catalog) = sc.catalog_id and sc.is_adjust_pricing = '1' and sc.deleted = '0') as scdata left join tmp.channel_level_commission pl on scdata.ticketpriceschedule_id = pl.ticketpriceschedule_id and scdata.ticketId = pl.ticket_id and scdata.channel_id = pl.channel_id and pl.catalog_id = '0' and pl.is_adjust_pricing = '1' and pl.deleted = '0') as shouldbe) as final) as base left join visitor_tickets rvt on rvt.vt_group_no = base.vt_group_no and rvt.transaction_id = base.transaction_id and rvt.row_type = '20' and ABS(rvt.version-base.version) = '0' where rvt.col2 != '2') as base1) as base2 where partner_net_price != partner_net_price_shouldbe"

    echo "Found MIsmatch Query"

    echo "$MISMATCH" >> rattan.sql

    mismatchvgn=$(timeout $TIMEOUT_PERIOD time mysql -h"$mysqlHost" -u"$mysqlUser" -p"$mysqlPassword" -D"$mysqlDatabase" -sN -e "$MISMATCH") || exit 1

    echo "$mismatchvgn"

    if [ -z "$mismatchvgn" ]; then

        echo "No results found. Proceeding with further steps. for ($vt_group_no)" >> no_mismatch.txt

    else 

        echo "------$(date '+%Y-%m-%d %H:%M:%S.%3N')--------" >> found_mismatch.txt 
        echo "$vt_group_no" >> found_mismatch.txt
        # exit 1

        select_query_vt="insert into visitor_tickets (id, created_date, transaction_id, invoice_id, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, financial_id, financial_name, transaction_type_name, transaction_type_id, ticketId, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, ticket_title, ticketwithdifferentpricing, ticketpriceschedule_id, ticket_extra_option_id, group_type_ticket, group_price, group_quantity, group_linked_with, selected_date, booking_selected_date, from_time, to_time, slot_type, amount_before_extra_discount, discount_before_extra_discount, hto_id, visitor_group_no, roomNo, nights, user_age, gender, user_image, visitor_country, merchantAccountCode, merchantReference, original_pspReference, shopperReference, partner_id, relational_partner_id, partner_name, museum_name, museum_id, hotel_name, hotel_id, pos_point_id, pos_point_name, shift_id, passNo, pass_type, ticketAmt, visit_date, visit_date_time, ticketType, tickettype_name, discount_applied_on_how_many_tickets, paid, payment_method, isBillToHotel, card_name, pspReference, card_type, captured, age_group, discount, isDiscountInPercent, updated_discount_type, without_elo_reference_no, debitor, creditor, split_cash_amount, split_card_amount, split_voucher_amount, split_direct_payment_amount, total_gross_commission, total_net_commission, commission_type, partner_gross_price, order_currency_partner_gross_price, partner_gross_price_without_combi_discount, partner_net_price, order_currency_partner_net_price, partner_net_price_without_combi_discount, isCommissionInPercent, tax_id, tax_value, tax_name, timezone, invoice_status, row_type, updated_by_id, updated_by_username, voucher_updated_by, voucher_updated_by_name, redeem_method, redeem_by_ticket_id, redeem_by_ticket_title, cashier_id, cashier_name, cashier_register_id, targetlocation, paymentMethodType, targetcity, service_name, adjustment_row_type, description, distributor_status, adyen_status, adjustment_method, all_ticket_ids, time_based_done, visitor_invoice_id, ticketPrice, deleted, is_refunded, is_block, is_edited, vt_group_no, user_name, issuer_country_code, distributor_commission_invoice, activation_method, is_prioticket, is_shop_product, shop_category_name, external_account_number, used, ticket_status, is_prepaid, is_purchased_with_postpaid, invoice_type, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, invoice_variant, service_cost, service_cost_net_amount, service_cost_type, scanned_pass, groupTransactionId, booking_status, channel_type, is_voucher, extra_text_field_answer, distributor_type, distributor_partner_id, distributor_partner_name, issuer_country_name, chart_number, extra_discount, manual_payment_note, account_number, is_custom_setting, external_product_id, supplier_currency_code, col1, col2, partner_category_id, col4, partner_category_name, col6, col7, col8, is_data_moved, action_performed, updated_at, tp_payment_method, order_confirm_date, payment_date, order_cancellation_date, voucher_creation_date, primary_host_name,supplier_gross_price, supplier_discount, supplier_ticket_amt, supplier_tax_value,supplier_net_price, last_modified_at, market_merchant_id, merchant_admin_id, order_updated_cashier_id, order_updated_cashier_name, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code) select id, created_date, transaction_id, invoice_id, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, financial_id, financial_name, transaction_type_name, transaction_type_id, ticketId, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, ticket_title, ticketwithdifferentpricing, ticketpriceschedule_id, ticket_extra_option_id, group_type_ticket, group_price, group_quantity, group_linked_with, selected_date, booking_selected_date, from_time, to_time, slot_type, amount_before_extra_discount, discount_before_extra_discount, hto_id, visitor_group_no, roomNo, nights, user_age, gender, user_image, visitor_country, merchantAccountCode, merchantReference, original_pspReference, shopperReference, partner_id, relational_partner_id, partner_name, museum_name, museum_id, hotel_name, hotel_id, pos_point_id, pos_point_name, shift_id, passNo, pass_type, ticketAmt, visit_date, visit_date_time, ticketType, tickettype_name, discount_applied_on_how_many_tickets, paid, payment_method, isBillToHotel, card_name, pspReference, card_type, captured, age_group, discount, isDiscountInPercent, updated_discount_type, without_elo_reference_no, debitor, creditor, split_cash_amount, split_card_amount, split_voucher_amount, split_direct_payment_amount, total_gross_commission, total_net_commission, commission_type, (partner_net_price_shouldbe*((100+tax_value)/100)) as partner_gross_price, order_currency_partner_gross_price, partner_gross_price_without_combi_discount, partner_net_price_shouldbe as partner_net_price, order_currency_partner_net_price, partner_net_price_without_combi_discount, isCommissionInPercent, tax_id, tax_value, tax_name, timezone, invoice_status, row_type, updated_by_id, updated_by_username, voucher_updated_by, voucher_updated_by_name, redeem_method, redeem_by_ticket_id, redeem_by_ticket_title, cashier_id, cashier_name, cashier_register_id, targetlocation, paymentMethodType, targetcity, service_name, adjustment_row_type, description, distributor_status, adyen_status, adjustment_method, all_ticket_ids, time_based_done, visitor_invoice_id, ticketPrice, deleted, is_refunded, is_block, is_edited, vt_group_no, user_name, issuer_country_code, distributor_commission_invoice, activation_method, is_prioticket, is_shop_product, shop_category_name, external_account_number, used, ticket_status, is_prepaid, is_purchased_with_postpaid, invoice_type, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, invoice_variant, service_cost, service_cost_net_amount, service_cost_type, scanned_pass, groupTransactionId, booking_status, channel_type, is_voucher, extra_text_field_answer, distributor_type, distributor_partner_id, distributor_partner_name, issuer_country_name, chart_number, extra_discount, manual_payment_note, account_number, is_custom_setting, external_product_id, supplier_currency_code, col1, col2, partner_category_id, col4, partner_category_name, col6, col7, col8, is_data_moved,concat(action_performed,', RockFellerCommision_Update') as action_performed, updated_at, tp_payment_method, order_confirm_date, payment_date, order_cancellation_date, voucher_creation_date, primary_host_name,supplier_gross_price, supplier_discount, supplier_ticket_amt, supplier_tax_value,supplier_net_price, last_modified_at, market_merchant_id, merchant_admin_id, order_updated_cashier_id, order_updated_cashier_name, ROUND(version+1,1) as version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code from (select *, ROUND(case when row_type in ('1','4') then should_be+pricevariationamount when row_type = '20' then partner_net_price else should_be end,2) as partner_net_price_shouldbe from (select base.*, rvt.partner_net_price as pricevariationamount from (select * from (select *, (case when tlc_ticketpriceschedule_id is not NULL then tlc_commissions when tlc_ticketpriceschedule_id is NULL and sc_ticketpriceschedule_id is not NULL then sucatalog_commissions when tlc_ticketpriceschedule_id is NULL and sc_ticketpriceschedule_id is NULL and clc_ticketpriceschedule_id is not NULL then pricelist_commissions else 'No_Setting_found' end) as should_be from (select scdata.*, '----Price List Level---' as type3,pl.ticketpriceschedule_id as clc_ticketpriceschedule_id,(case when scdata.row_type = '1' then pl.ticket_net_price when scdata.row_type = '2' then pl.museum_net_commission when scdata.row_type = '17' then pl.merchant_net_commission when scdata.row_type = '3' then pl.hotel_commission_net_price when scdata.row_type = '4' then pl.hgs_commission_net_price else 0 end) as pricelist_commissions  from (select tlcdata.*, '----Sub catalog Level---' as type2, sc.catalog_id,sc.ticketpriceschedule_id as sc_ticketpriceschedule_id, sc.resale_currency_level as sc_resale_currency_level, (case when tlcdata.row_type = '1' then sc.ticket_net_price when tlcdata.row_type = '2' then sc.museum_net_commission when tlcdata.row_type = '17' then sc.merchant_net_commission when tlcdata.row_type = '3' then sc.hotel_commission_net_price when tlcdata.row_type = '4' then sc.hgs_commission_net_price else 0 end) as sucatalog_commissions   from (select vt.*, qc.cod_id as company_id, qc.channel_id as company_pricelist_id, qc.sub_catalog_id as company_sub_catalog, '---TLC LEVEL---' as Type, tlc.ticketpriceschedule_id as tlc_ticketpriceschedule_id, tlc.resale_currency_level, (case when vt.row_type = '1' then tlc.ticket_net_price when vt.row_type = '2' then tlc.museum_net_commission when vt.row_type = '17' then tlc.merchant_net_commission when vt.row_type = '3' then tlc.hotel_commission_net_price when vt.row_type = '4' then tlc.hgs_commission_net_price else 0 end) as tlc_commissions from visitor_tickets vt join (select vt_group_no, transaction_id,row_type, max(version) as version from visitor_tickets where vt_group_no in ($vt_group_no) and col2 != '2' group by vt_group_no, transaction_id, row_type) as maxversion on vt.vt_group_no = maxversion.vt_group_no and (vt.transaction_id+1) = (maxversion.transaction_id+1) and vt.row_type = maxversion.row_type and ABS(vt.version-maxversion.version) = '0' left join tmp.qr_codes qc on qc.cod_id = vt.hotel_id and qc.cashier_type = '1' left join tmp.ticket_level_commission tlc on tlc.hotel_id = vt.hotel_id and tlc.ticketpriceschedule_id = vt.ticketpriceschedule_id and tlc.ticket_id = vt.ticketId and tlc.deleted = '0' and tlc.is_adjust_pricing = '1' where vt.col2 != '2') as tlcdata left join tmp.channel_level_commission sc on tlcdata.ticketpriceschedule_id = sc.ticketpriceschedule_id and tlcdata.ticketId = sc.ticket_id and if(tlcdata.company_sub_catalog = '0', 122222, tlcdata.company_sub_catalog) = sc.catalog_id and sc.is_adjust_pricing = '1' and sc.deleted = '0') as scdata left join tmp.channel_level_commission pl on scdata.ticketpriceschedule_id = pl.ticketpriceschedule_id and scdata.ticketId = pl.ticket_id and scdata.channel_id = pl.channel_id and pl.catalog_id = '0' and pl.is_adjust_pricing = '1' and pl.deleted = '0') as shouldbe) as final) as base left join visitor_tickets rvt on rvt.vt_group_no = base.vt_group_no and (rvt.transaction_id+1) = (base.transaction_id+1) and rvt.row_type = '20' and ABS(rvt.version-base.version) = '0' where rvt.col2 != '2') as base1) as base2;SELECT ROW_COUNT();"
        
        echo "------$(date '+%Y-%m-%d %H:%M:%S.%3N')--------" >> vt_select_query.sql

        echo "$select_query_vt" >> vt_select_query.sql

        # sleep 3
        echo "VT RDS insert query vt"
        timeout $TIMEOUT_PERIOD time mysql -h"$mysqlHost" -u"$mysqlUser" -p"$mysqlPassword" -D"$mysqlDatabase" -sN -e "$select_query_vt" || exit 1

        # sleep 3

        echo "VT secondary insert query vt"
        timeout $TIMEOUT_PERIOD time mysql -h"$SECHOST" -u"$SECUSER" -p"$SECPASSWORD" -D"$SECDATABASE" -sN -e "$select_query_vt" || exit 1
        
        sleep 3
        select_query_pt="insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, \`unlock\`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image,vvt.sale_priceg as oroginal_price,vvt.sale_priceg as order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent,vvt.sale_priceg as price,vvt.sale_priceg as order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name,vvt.sale_price as net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', RockFellerCommision_Update') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in ($vt_group_no) and action_performed like '%RockFellerCommision_Update' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in ($vt_group_no) and action_performed like '%RockFellerCommision_Update' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';SELECT ROW_COUNT()"

        echo "------$(date '+%Y-%m-%d %H:%M:%S.%3N')--------" >> pt_select_query.sql

        echo "$select_query_pt" >> pt_select_query.sql

        echo "pt insert query rds"

        timeout $TIMEOUT_PERIOD time mysql -h"$mysqlHost" -u"$mysqlUser" -p"$mysqlPassword" -D"$mysqlDatabase" -sN -e "$select_query_pt" || exit 1

        # sleep 3

        echo "pt insert query sec"

        timeout $TIMEOUT_PERIOD time mysql -h"$SECHOST" -u"$SECUSER" -p"$SECPASSWORD" -D"$SECDATABASE" -sN -e "$select_query_pt" || exit 1


        echo "Sleep Started to Run next VGNS"
        echo "------$(date '+%Y-%m-%d %H:%M:%S.%3N')--------"
        sleep 3

        curl https://report.prioticket.com/Insert_api_data_nested/api_results_v2/$vt_group_no

    fi

done



# select transaction_id, count(*) from visitor_tickets where vt_group_no in (172045255276797,171025431591257,171727346539316,172053346499600,171141947172133,171574639920145,172704081562491,171163934037471,171536931080789,171986309649833,172100781072771,171351848854810,171433057167697,171242616086533,171741139833003,171185633076512,172156075664258,171472054427291,172547458139142,171994602778711,171930733511999,171011644400218,172578141163575,171563415795607,172409437657983,172685575287572,171738344350056,171915181827493,171297041994939,171694065980369,171372664507728,172359779009045,171009727210196,171328800669347,171913769909957,171233843827790,171695329843824,172302377028197,172712340166603,171614164484789,171680191898746,171542971521723,172314356772802,172667004798377,171261513579759,172493962896932,172489212878186,172227461759518,171820765792530,171967693251310) and action_performed like '%RockFellerCommision_Update' group by transaction_id


# select transaction_id, row_type, version, partner_gross_price from visitor_tickets where vt_group_no in (172045255276797) and action_performed like '%RockFellerCommision_Update' group by transaction_id


# select prepaid_ticket_id, version, museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee from visitor_tickets where visitor_group_no in (172372552429548,172581021304387,171319842070743,172044725102381,172424987440319,171581197165690,172218824782823,171294830620865,171963335467192,172632428502457,171845059887457,171249535930396,171753352986167,171615494480590,172415206736420,172595013086763,172211262744573,171109848818468,172686371291316,171432563777550,172271791662673,171137599486683,172338975718524,171846823963922,172248768288914,171150416414760,171733260622365,172718747512263,172171190436226,172632333684048,171026681260426,171573650317812,171849895407657,171880775596472,172842214750400,172245315860611,171519070314444,171121424818909,171311329769765,171319400365877,171414246206059,172236811194455,172528341037576,172490619649031,171168096454202,172434321667956,172770507844065,171907540129772,171737520896895,171197228065742,172045255276797,171025431591257,171727346539316,172053346499600,171141947172133,171574639920145,172704081562491,171163934037471,171536931080789,171986309649833,172100781072771,171351848854810,171433057167697,171242616086533,171741139833003,171185633076512,172156075664258,171472054427291,172547458139142,171994602778711,171930733511999,171011644400218,172578141163575,171563415795607,172409437657983,172685575287572,171738344350056,171915181827493,171297041994939,171694065980369,171372664507728,172359779009045,171009727210196,171328800669347,171913769909957,171233843827790,171695329843824,172302377028197,172712340166603,171614164484789,171680191898746,171542971521723,172314356772802,172667004798377,171261513579759,172493962896932,172489212878186,172227461759518,171820765792530,171967693251310)
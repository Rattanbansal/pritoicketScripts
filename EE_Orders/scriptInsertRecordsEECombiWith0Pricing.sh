#!/bin/bash

set -e  # Exit immediately if any command exits with a non-zero status
TIMEOUT_PERIOD=40


DB_HOST='163.47.214.30'
DB_USER='datalook'
DB_PASS='datalook2024$$'
DB_NAME='rattan'
PORT="3307"
BATCH_SIZE=25
tablename=$1

mysqlHost="prodrds.prioticket.com"
mysqlUser=pipeuser
mysqlPassword=d4fb46eccNRAL
mysqlDatabase="prioprodrds"

SECDATABASE='priopassdb'
SECHOST='production-secondary-db-node.cluster-ck6w2al7sgpk.eu-west-1.rds.amazonaws.com'
SECUSER='pipeuser'
SECPASSWORD='d4fb46eccNRAL'


vt_group_numbers=$(timeout $TIMEOUT_PERIOD time mysql -h"$DB_HOST" -u"$DB_USER" --port=$PORT -p"$DB_PASS" -D"$DB_NAME" -sN -e "SELECT visitor_group_no FROM $tablename WHERE status = '0'") || exit 1

# Convert the vt_group_numbers into an array
vt_group_array=($vt_group_numbers)
total_vt_groups=${#vt_group_array[@]}

# Print the total count of vt_group_no for the current ticket_id
echo "Processing Ticket ID: $ticket_id with $total_vt_groups vt_group_no values"

# Initialize the progress tracking for the current ticket_id
current_progress=0
    
# Loop through vt_group_no array in batches
for ((i=0; i<$total_vt_groups; i+=BATCH_SIZE)); do
    # Create a batch of vt_group_no values
    batch=("${vt_group_array[@]:$i:$BATCH_SIZE}")
    batch_size=${#batch[@]}

    # Calculate the current progress level for this ticket_id
    current_progress=$((i + batch_size))
    
    # Join the batch into a comma-separated list
    batch_str=$(IFS=,; echo "${batch[*]}")

    # Print progress information for the current ticket_id
    echo "Processing batch of size $batch_size : ($current_progress / $total_vt_groups processed)" >> log.txt


    select_query_vt="insert into visitor_tickets (id, created_date, transaction_id, invoice_id, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, financial_id, financial_name, transaction_type_name, transaction_type_id, ticketId, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, ticket_title, ticketwithdifferentpricing, ticketpriceschedule_id, ticket_extra_option_id, group_type_ticket, group_price, group_quantity, group_linked_with, selected_date, booking_selected_date, from_time, to_time, slot_type, amount_before_extra_discount, discount_before_extra_discount, hto_id, visitor_group_no, roomNo, nights, user_age, gender, user_image, visitor_country, merchantAccountCode, merchantReference, original_pspReference, shopperReference, partner_id, relational_partner_id, partner_name, museum_name, museum_id, hotel_name, hotel_id, pos_point_id, pos_point_name, shift_id, passNo, pass_type, ticketAmt, visit_date, visit_date_time, ticketType, tickettype_name, discount_applied_on_how_many_tickets, paid, payment_method, isBillToHotel, card_name, pspReference, card_type, captured, age_group, discount, isDiscountInPercent, updated_discount_type, without_elo_reference_no, debitor, creditor, split_cash_amount, split_card_amount, split_voucher_amount, split_direct_payment_amount, total_gross_commission, total_net_commission, commission_type, partner_gross_price, order_currency_partner_gross_price, partner_gross_price_without_combi_discount, partner_net_price, order_currency_partner_net_price, partner_net_price_without_combi_discount, isCommissionInPercent, tax_id, tax_value, tax_name, timezone, invoice_status, row_type, updated_by_id, updated_by_username, voucher_updated_by, voucher_updated_by_name, redeem_method, redeem_by_ticket_id, redeem_by_ticket_title, cashier_id, cashier_name, cashier_register_id, targetlocation, paymentMethodType, targetcity, service_name, adjustment_row_type, description, distributor_status, adyen_status, adjustment_method, all_ticket_ids, time_based_done, visitor_invoice_id, ticketPrice, deleted, is_refunded, is_block, is_edited, vt_group_no, user_name, issuer_country_code, distributor_commission_invoice, activation_method, is_prioticket, is_shop_product, shop_category_name, external_account_number, used, ticket_status, is_prepaid, is_purchased_with_postpaid, invoice_type, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, invoice_variant, service_cost, service_cost_net_amount, service_cost_type, scanned_pass, groupTransactionId, booking_status, channel_type, is_voucher, extra_text_field_answer, distributor_type, distributor_partner_id, distributor_partner_name, issuer_country_name, chart_number, extra_discount, manual_payment_note, account_number, is_custom_setting, external_product_id, supplier_currency_code, col1, col2, partner_category_id, col4, partner_category_name, col6, col7, col8, is_data_moved, action_performed, updated_at, tp_payment_method, order_confirm_date, payment_date, order_cancellation_date, voucher_creation_date, primary_host_name,supplier_gross_price, supplier_discount, supplier_ticket_amt, supplier_tax_value,supplier_net_price, last_modified_at, market_merchant_id, merchant_admin_id, order_updated_cashier_id, order_updated_cashier_name, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code) select vt.id, vt.created_date, vt.transaction_id, vt.invoice_id, vt.channel_id, vt.channel_name, vt.reseller_id, vt.reseller_name, vt.saledesk_id, vt.saledesk_name, vt.financial_id, vt.financial_name, vt.transaction_type_name, vt.transaction_type_id, vt.ticketId, vt.shared_capacity_id, vt.ticket_booking_id, vt.related_order_id, vt.related_booking_id, vt.ticket_title, vt.ticketwithdifferentpricing, vt.ticketpriceschedule_id, vt.ticket_extra_option_id, vt.group_type_ticket, vt.group_price, vt.group_quantity, vt.group_linked_with, vt.selected_date, vt.booking_selected_date, vt.from_time, vt.to_time, vt.slot_type, vt.amount_before_extra_discount, vt.discount_before_extra_discount, vt.hto_id, vt.visitor_group_no, vt.roomNo, vt.nights, vt.user_age, vt.gender, vt.user_image, vt.visitor_country, vt.merchantAccountCode, vt.merchantReference, vt.original_pspReference, vt.shopperReference, vt.partner_id, vt.relational_partner_id, vt.partner_name, vt.museum_name, vt.museum_id, vt.hotel_name, vt.hotel_id, vt.pos_point_id, vt.pos_point_name, vt.shift_id, vt.passNo, vt.pass_type, vt.ticketAmt, vt.visit_date, vt.visit_date_time, vt.ticketType, vt.tickettype_name, vt.discount_applied_on_how_many_tickets, vt.paid, vt.payment_method, vt.isBillToHotel, vt.card_name, vt.pspReference, vt.card_type, vt.captured, vt.age_group, vt.discount, vt.isDiscountInPercent, vt.updated_discount_type, vt.without_elo_reference_no, vt.debitor, vt.creditor, vt.split_cash_amount, vt.split_card_amount, vt.split_voucher_amount, vt.split_direct_payment_amount, vt.total_gross_commission, vt.total_net_commission, vt.commission_type,'0.00' as partner_gross_price, vt.order_currency_partner_gross_price, vt.partner_gross_price_without_combi_discount,'0.00' partner_net_price, vt.order_currency_partner_net_price, vt.partner_net_price_without_combi_discount, vt.isCommissionInPercent, vt.tax_id, vt.tax_value, vt.tax_name, vt.timezone, vt.invoice_status, vt.row_type, vt.updated_by_id, vt.updated_by_username, vt.voucher_updated_by, vt.voucher_updated_by_name, vt.redeem_method, vt.redeem_by_ticket_id, vt.redeem_by_ticket_title, vt.cashier_id, vt.cashier_name, vt.cashier_register_id, vt.targetlocation, vt.paymentMethodType, vt.targetcity, vt.service_name, vt.adjustment_row_type, vt.description, vt.distributor_status, vt.adyen_status, vt.adjustment_method, vt.all_ticket_ids, vt.time_based_done, vt.visitor_invoice_id, vt.ticketPrice, vt.deleted, vt.is_refunded, vt.is_block, vt.is_edited, vt.vt_group_no, vt.user_name, vt.issuer_country_code, vt.distributor_commission_invoice, vt.activation_method, vt.is_prioticket, vt.is_shop_product, vt.shop_category_name, vt.external_account_number, vt.used, vt.ticket_status, vt.is_prepaid, vt.is_purchased_with_postpaid, vt.invoice_type, vt.supplier_currency_symbol, vt.order_currency_code, vt.order_currency_symbol, vt.currency_rate, vt.invoice_variant, vt.service_cost, vt.service_cost_net_amount, vt.service_cost_type, vt.scanned_pass, vt.groupTransactionId, vt.booking_status, vt.channel_type, vt.is_voucher, vt.extra_text_field_answer, vt.distributor_type, vt.distributor_partner_id, vt.distributor_partner_name, vt.issuer_country_name, vt.chart_number, vt.extra_discount, vt.manual_payment_note, vt.account_number, vt.is_custom_setting, vt.external_product_id, vt.supplier_currency_code, vt.col1, vt.col2, vt.partner_category_id, vt.col4, vt.partner_category_name, vt.col6, vt.col7, vt.col8, vt.is_data_moved, concat(vt.action_performed, ' EECOMBICommission'), vt.updated_at, vt.tp_payment_method, vt.order_confirm_date, vt.payment_date, vt.order_cancellation_date, vt.voucher_creation_date, vt.primary_host_name,vt.supplier_gross_price, vt.supplier_discount, vt.supplier_ticket_amt, vt.supplier_tax_value,vt.supplier_net_price, vt.last_modified_at, vt.market_merchant_id, vt.merchant_admin_id, vt.order_updated_cashier_id, vt.order_updated_cashier_name, ROUND((vt.version+1),2) as version, vt.supplier_tax_id, vt.merchant_currency_code, vt.merchant_price, vt.merchant_net_price, vt.merchant_tax_id, vt.admin_currency_code from visitor_tickets vt join (SELECT transaction_id, vt_group_no, ticketId, ticketpriceschedule_id, max(version) as version FROM visitor_tickets where vt_group_no in ($batch_str) and col2 = 2 group by transaction_id, vt_group_no, ticketId, ticketpriceschedule_id) as mv on vt.vt_group_no = mv.vt_group_no and (vt.transaction_id+1) = (mv.transaction_id+1) and ABS(vt.version - mv.version) = '0' and vt.ticketId = mv.ticketId and vt.ticketpriceschedule_id = mv.ticketpriceschedule_id;SELECT ROW_COUNT();"
        
    echo "------$(date '+%Y-%m-%d %H:%M:%S.%3N')--------" >> vt_select_query.sql

    echo "$select_query_vt" >> vt_select_query.sql

    # sleep 3
    echo "VT RDS insert query vt"
    timeout $TIMEOUT_PERIOD time mysql -h"$mysqlHost" -u"$mysqlUser" -p"$mysqlPassword" -D"$mysqlDatabase" -sN -e "$select_query_vt" || exit 1

    # sleep 3

    echo "VT secondary insert query vt"
    timeout $TIMEOUT_PERIOD time mysql -h"$SECHOST" -u"$SECUSER" -p"$SECPASSWORD" -D"$SECDATABASE" -sN -e "$select_query_vt" || exit 1
        
    select_query_pt="insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date,\`unlock\`, checkin_uid, checkin_date, voucher_release_date) select pt1.prepaid_ticket_id, pt1.is_combi_ticket, pt1.visitor_group_no, pt1.ticket_id, pt1.shared_capacity_id, pt1.ticket_booking_id, pt1.related_order_id, pt1.related_booking_id, pt1.hotel_ticket_overview_id, pt1.hotel_id, pt1.own_supplier_id, pt1.distributor_partner_id, pt1.distributor_partner_name, pt1.hotel_name, pt1.shift_id, pt1.cashier_register_id, pt1.pos_point_id, pt1.pos_point_name, pt1.channel_id, pt1.channel_name, pt1.reseller_id, pt1.reseller_name, pt1.saledesk_id, pt1.saledesk_name, pt1.title, pt1.age_group, pt1.museum_id, pt1.museum_name, pt1.additional_information, pt1.location, pt1.highlights, pt1.image,'0.00' as oroginal_price, pt1.order_currency_oroginal_price, pt1.discount, pt1.order_currency_discount, pt1.is_discount_in_percent,'0.00' as price, pt1.order_currency_price, pt1.ticket_scan_price, pt1.cc_rows_value, pt1.tax, pt1.distributor_type, pt1.tax_name,'0.00' as net_price, pt1.order_currency_net_price, pt1.ticket_amount_before_extra_discount, pt1.extra_discount, pt1.extra_fee, pt1.order_currency_extra_discount, pt1.is_combi_discount, pt1.combi_discount_gross_amount, pt1.order_currency_combi_discount_gross_amount, pt1.is_discount_code, pt1.discount_code_value, pt1.discount_code_amount, pt1.order_currency_discount_code_amount, pt1.discount_code_promotion_title, pt1.service_cost_type, pt1.service_cost, pt1.net_service_cost, pt1.ticket_type, pt1.ticket_type_additional_info, pt1.discount_applied_on_how_many_tickets, pt1.quantity, pt1.refund_quantity, pt1.timeslot, pt1.from_time, pt1.to_time, pt1.selected_date, pt1.booking_selected_date, pt1.valid_till, pt1.created_date_time, pt1.created_at, pt1.scanned_at, pt1.redemption_notified_at,concat(pt1.action_performed, 'EECombiCommission') as action_performed, pt1.redeem_date_time, pt1.is_prioticket, pt1.product_type, pt1.shop_category_name, pt1.rezgo_id, pt1.rezgo_ticket_id, pt1.rezgo_ticket_price, pt1.tps_id, pt1.group_type_ticket, pt1.group_price, pt1.group_quantity, pt1.group_linked_with, pt1.group_id, pt1.supplier_currency_code, pt1.supplier_currency_symbol, pt1.order_currency_code, pt1.order_currency_symbol, pt1.currency_rate, pt1.selected_quantity, pt1.min_qty, pt1.max_qty, pt1.passNo, pt1.bleep_pass_no, pt1.pass_type, pt1.used, pt1.activated, pt1.visitor_tickets_id, pt1.activation_method, pt1.invoice_method_label, pt1.booking_type, pt1.split_payment_detail, pt1.timezone, pt1.is_pre_selected_ticket, pt1.is_prepaid, pt1.is_cancelled, pt1.deleted, pt1.time_based_done, pt1.booking_status, pt1.order_status, pt1.is_refunded, pt1.refunded_by, pt1.without_elo_reference_no, pt1.is_voucher, pt1.is_iticket_product, pt1.reference_id, pt1.is_addon_ticket, pt1.cluster_group_id, pt1.clustering_id, pt1.related_product_id, pt1.parent_product_id, pt1.related_product_title, pt1.pos_point_id_on_redeem, pt1.pos_point_name_on_redeem, pt1.distributor_id_on_redeem, pt1.distributor_cashier_id_on_redeem, pt1.third_party_type, pt1.third_party_booking_reference, pt1.third_party_response_data, pt1.supplier_original_price, pt1.supplier_discount, pt1.supplier_price, pt1.supplier_tax, pt1.supplier_net_price,pt1.museum_net_fee, pt1.distributor_net_fee,pt1.hgs_net_fee,pt1.museum_gross_fee, pt1.distributor_gross_fee,pt1.hgs_gross_fee, pt1.second_party_type, pt1.second_party_booking_reference, pt1.second_party_passNo, pt1.batch_id, pt1.batch_reference, pt1.cashier_id, pt1.cashier_name, pt1.redeem_users, pt1.cashier_code, pt1.location_code, pt1.voucher_updated_by, pt1.voucher_updated_by_name, pt1.redeem_method, pt1.tp_payment_method, pt1.order_confirm_date, pt1.payment_date, pt1.museum_cashier_id, pt1.museum_cashier_name, pt1.extra_text_field_answer, pt1.pick_up_location, pt1.refund_note, pt1.manual_payment_note, pt1.channel_type, pt1.financial_id, pt1.financial_name, pt1.is_custom_setting, pt1.external_product_id, pt1.account_number, pt1.chart_number, pt1.is_invoice, pt1.split_card_amount, pt1.split_cash_amount, pt1.split_voucher_amount, pt1.split_direct_payment_amount, pt1.is_data_moved, pt1.last_imported_date, pt1.redeem_by_ticket_id, pt1.redeem_by_ticket_title, pt1.updated_at, pt1.commission_type, pt1.barcode_type, pt1.guest_names, pt1.guest_emails, pt1.secondary_guest_email, pt1.secondary_guest_name, pt1.passport_number, pt1.order_status_hto, pt1.pspReference, pt1.merchantReference, pt1.merchantAccountCode, pt1.reserved_1, pt1.reserved_2, pt1.reserved_3, pt1.authcode, pt1.payment_gateway, pt1.payment_conditions, pt1.payment_term_category, pt1.order_cancellation_date, pt1.voucher_creation_date, pt1.partner_category_id, pt1.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt1.order_updated_cashier_id, pt1.order_updated_cashier_name, pt1.primary_host_name, pt1.is_order_confirmed, pt1.booking_information, pt1.extra_booking_information, pt1.contact_details, pt1.contact_information, pt1.phone_number, pt1.booking_details, pt1.market_merchant_id, pt1.merchant_admin_id, pt1.pax, pt1.capacity, pt1.commission_json, pt1.supplier_cost, pt1.partner_cost, pt1.tax_id, pt1.tax_exception_applied, ROUND(pt1.version+1) as version, pt1.supplier_tax_id, pt1.merchant_currency_code, pt1.merchant_price, pt1.merchant_net_price, pt1.merchant_tax_id, pt1.admin_currency_code, pt1.expiry_date, pt1.validity_date, pt1.unlock, pt1.checkin_uid, pt1.checkin_date, pt1.voucher_release_date from prepaid_tickets pt1 join (select pt.prepaid_ticket_id, max(pt.version) as version, pt.visitor_group_no from prepaid_tickets pt join (SELECT vt_group_no, targetlocation, ticketId, ticketpriceschedule_id FROM visitor_tickets where vt_group_no in ($batch_str) and col2 = 2 and action_performed like '%EECombiCommission') as base on pt.visitor_group_no = base.vt_group_no and pt.ticket_id = base.ticketId and pt.tps_id = base.ticketpriceschedule_id and pt.is_addon_ticket = '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as mv on pt1.visitor_group_no = mv.visitor_group_no and pt1.prepaid_ticket_id = mv.prepaid_ticket_id and pt1.version = mv.version and pt1.is_addon_ticket = '2';SELECT ROW_COUNT()"

    echo "------$(date '+%Y-%m-%d %H:%M:%S.%3N')--------" >> pt_select_query.sql

    echo "$select_query_pt" >> pt_select_query.sql

    echo "pt insert query rds"

    timeout $TIMEOUT_PERIOD time mysql -h"$mysqlHost" -u"$mysqlUser" -p"$mysqlPassword" -D"$mysqlDatabase" -sN -e "$select_query_pt" || exit 1

    # sleep 3

    echo "pt insert query sec"

    timeout $TIMEOUT_PERIOD time mysql -h"$SECHOST" -u"$SECUSER" -p"$SECPASSWORD" -D"$SECDATABASE" -sN -e "$select_query_pt" || exit 1

    # sleep 3

    timeout $TIMEOUT_PERIOD time mysql -h"$DB_HOST" -u"$DB_USER" --port=$PORT -p"$DB_PASS" -D"$DB_NAME" -sN -e "update $tablename set status = '1' where visitor_group_no in ($batch_str);SELECT ROW_COUNT()" || exit 1

    echo "Sleep Started to Run next VGNS"
    echo "------$(date '+%Y-%m-%d %H:%M:%S.%3N')--------"

    echo "https://report.prioticket.com/Insert_api_data_nested/api_results_v2/$batch_str"
    curl https://report.prioticket.com/Insert_api_data_nested/api_results_v2/$batch_str

    
    sleep 10

done

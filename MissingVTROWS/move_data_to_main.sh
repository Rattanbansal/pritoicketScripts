#!/bin/bash

    DATABASE='priopassdb'
    HOST='production-secondary-db-node.cluster-ck6w2al7sgpk.eu-west-1.rds.amazonaws.com'
    USER='pipeuser'
    PASSWORD='d4fb46eccNRAL'

    timeout_duration=60
    vt_no="166946202390952"

for vt_group in ${vt_no}

do

echo $vt_group

	
   secvt=$(time timeout "$timeout_duration" mysql -h $HOST --user=$USER --password=$PASSWORD $DATABASE -N  -e "insert into visitor_tickets (id, created_date, transaction_id, invoice_id, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, financial_id, financial_name, transaction_type_name, transaction_type_id, ticketId, shared_capacity_id, ticket_booking_id, ticket_title, ticketwithdifferentpricing, ticketpriceschedule_id, ticket_extra_option_id, group_type_ticket, group_price, group_quantity, group_linked_with, selected_date, booking_selected_date, from_time, to_time, slot_type, amount_before_extra_discount, discount_before_extra_discount, hto_id, visitor_group_no, roomNo, nights, user_age, gender, user_image, visitor_country, merchantAccountCode, merchantReference, original_pspReference, shopperReference, partner_id, relational_partner_id, partner_name, museum_name, museum_id, hotel_name, hotel_id, pos_point_id, pos_point_name, shift_id, passNo, pass_type, ticketAmt, visit_date, visit_date_time, ticketType, tickettype_name, discount_applied_on_how_many_tickets, paid, payment_method, isBillToHotel, card_name, pspReference, card_type, captured, age_group, discount, isDiscountInPercent, updated_discount_type, without_elo_reference_no, debitor, creditor, split_cash_amount, split_card_amount, split_voucher_amount, split_direct_payment_amount, total_gross_commission, total_net_commission, commission_type, partner_gross_price, order_currency_partner_gross_price, partner_gross_price_without_combi_discount, partner_net_price, order_currency_partner_net_price, partner_net_price_without_combi_discount, isCommissionInPercent, tax_id, tax_value, tax_name, timezone, invoice_status, row_type, updated_by_id, updated_by_username, voucher_updated_by, voucher_updated_by_name, redeem_method, redeem_by_ticket_id, redeem_by_ticket_title, cashier_id, cashier_name, cashier_register_id, targetlocation, paymentMethodType, targetcity, service_name, adjustment_row_type, description, distributor_status, adyen_status, adjustment_method, all_ticket_ids, time_based_done, visitor_invoice_id, ticketPrice, deleted, is_refunded, is_block, is_edited, vt_group_no, user_name, issuer_country_code, distributor_commission_invoice, activation_method, is_prioticket, is_shop_product, shop_category_name, external_account_number, used, ticket_status, is_prepaid, is_purchased_with_postpaid, invoice_type, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, invoice_variant, service_cost, service_cost_net_amount, service_cost_type, scanned_pass, groupTransactionId, booking_status, channel_type, is_voucher, extra_text_field_answer, distributor_type, distributor_partner_id, distributor_partner_name, issuer_country_name, chart_number, extra_discount, manual_payment_note, account_number, is_custom_setting, external_product_id, supplier_currency_code, col1, col2, partner_category_id, col4, partner_category_name, col6, col7, col8, is_data_moved, action_performed, updated_at, tp_payment_method, order_confirm_date, payment_date, order_cancellation_date, voucher_creation_date, primary_host_name, supplier_gross_price, supplier_discount, supplier_ticket_amt, supplier_tax_value, supplier_net_price, last_modified_at, market_merchant_id, merchant_admin_id, order_updated_cashier_id, order_updated_cashier_name, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code) select vtbk.id, vtbk.created_date, vtbk.transaction_id, vtbk.invoice_id, vtbk.channel_id, vtbk.channel_name, vtbk.reseller_id, vtbk.reseller_name, vtbk.saledesk_id, vtbk.saledesk_name, vtbk.financial_id, vtbk.financial_name, vtbk.transaction_type_name, vtbk.transaction_type_id, vtbk.ticketId, vtbk.shared_capacity_id, vtbk.ticket_booking_id, vtbk.ticket_title, vtbk.ticketwithdifferentpricing, vtbk.ticketpriceschedule_id, vtbk.ticket_extra_option_id, vtbk.group_type_ticket, vtbk.group_price, vtbk.group_quantity, vtbk.group_linked_with, vtbk.selected_date, vtbk.booking_selected_date, vtbk.from_time, vtbk.to_time, vtbk.slot_type, vtbk.amount_before_extra_discount, vtbk.discount_before_extra_discount, vtbk.hto_id, vtbk.visitor_group_no, vtbk.roomNo, vtbk.nights, vtbk.user_age, vtbk.gender, vtbk.user_image, vtbk.visitor_country, vtbk.merchantAccountCode, vtbk.merchantReference, vtbk.original_pspReference, vtbk.shopperReference, vtbk.partner_id, vtbk.relational_partner_id, vtbk.partner_name, vtbk.museum_name, vtbk.museum_id, vtbk.hotel_name, vtbk.hotel_id, vtbk.pos_point_id, vtbk.pos_point_name, vtbk.shift_id, vtbk.passNo, vtbk.pass_type, vtbk.ticketAmt, vtbk.visit_date, vtbk.visit_date_time, vtbk.ticketType, vtbk.tickettype_name, vtbk.discount_applied_on_how_many_tickets, vtbk.paid, vtbk.payment_method, vtbk.isBillToHotel, vtbk.card_name, vtbk.pspReference, vtbk.card_type, vtbk.captured, vtbk.age_group, vtbk.discount, vtbk.isDiscountInPercent, vtbk.updated_discount_type, vtbk.without_elo_reference_no, vtbk.debitor, vtbk.creditor, vtbk.split_cash_amount, vtbk.split_card_amount, vtbk.split_voucher_amount, vtbk.split_direct_payment_amount, vtbk.total_gross_commission, vtbk.total_net_commission, vtbk.commission_type, vtbk.partner_gross_price, vtbk.order_currency_partner_gross_price, vtbk.partner_gross_price_without_combi_discount, vtbk.partner_net_price, vtbk.order_currency_partner_net_price, vtbk.partner_net_price_without_combi_discount, vtbk.isCommissionInPercent, vtbk.tax_id, vtbk.tax_value, vtbk.tax_name, vtbk.timezone, vtbk.invoice_status, vtbk.row_type, vtbk.updated_by_id, vtbk.updated_by_username, vtbk.voucher_updated_by, vtbk.voucher_updated_by_name, vtbk.redeem_method, vtbk.redeem_by_ticket_id, vtbk.redeem_by_ticket_title, vtbk.cashier_id, vtbk.cashier_name, vtbk.cashier_register_id, vtbk.targetlocation, vtbk.paymentMethodType, vtbk.targetcity, vtbk.service_name, vtbk.adjustment_row_type, vtbk.description, vtbk.distributor_status, vtbk.adyen_status, vtbk.adjustment_method, vtbk.all_ticket_ids, vtbk.time_based_done, vtbk.visitor_invoice_id, vtbk.ticketPrice, vtbk.deleted, vtbk.is_refunded, vtbk.is_block, vtbk.is_edited, vtbk.vt_group_no, vtbk.user_name, vtbk.issuer_country_code, vtbk.distributor_commission_invoice, vtbk.activation_method, vtbk.is_prioticket, vtbk.is_shop_product, vtbk.shop_category_name, vtbk.external_account_number, vtbk.used, vtbk.ticket_status, vtbk.is_prepaid, vtbk.is_purchased_with_postpaid, vtbk.invoice_type, vtbk.supplier_currency_symbol, vtbk.order_currency_code, vtbk.order_currency_symbol, vtbk.currency_rate, vtbk.invoice_variant, vtbk.service_cost, vtbk.service_cost_net_amount, vtbk.service_cost_type, vtbk.scanned_pass, vtbk.groupTransactionId, vtbk.booking_status, vtbk.channel_type, vtbk.is_voucher, vtbk.extra_text_field_answer, vtbk.distributor_type, vtbk.distributor_partner_id, vtbk.distributor_partner_name, vtbk.issuer_country_name, vtbk.chart_number, vtbk.extra_discount, vtbk.manual_payment_note, vtbk.account_number, vtbk.is_custom_setting, vtbk.external_product_id, vtbk.supplier_currency_code, vtbk.col1, vtbk.col2, vtbk.partner_category_id, vtbk.col4, vtbk.partner_category_name, vtbk.col6, vtbk.col7, vtbk.col8, vtbk.is_data_moved, vtbk.action_performed, vtbk.updated_at, vtbk.tp_payment_method, vtbk.order_confirm_date, vtbk.payment_date, vtbk.order_cancellation_date, vtbk.voucher_creation_date, vtbk.primary_host_name, vtbk.supplier_gross_price, vtbk.supplier_discount, vtbk.supplier_ticket_amt, vtbk.supplier_tax_value, vtbk.supplier_net_price, vtbk.last_modified_at, vtbk.market_merchant_id, vtbk.merchant_admin_id, vtbk.order_updated_cashier_id, vtbk.order_updated_cashier_name, vtbk.version, vtbk.supplier_tax_id, vtbk.merchant_currency_code, vtbk.merchant_price, vtbk.merchant_net_price, vtbk.merchant_tax_id, vtbk.admin_currency_code from visitor_tickets_bk22sep vtbk left join visitor_tickets vt on vt.vt_group_no = vtbk.vt_group_no and concat(vt.id, vt.version, vt.row_type, 'R') = concat(vtbk.id, vtbk.version, vtbk.row_type, 'R') where vtbk.vt_group_no in ($vt_group) and vtbk.channel_type != '2'  and concat(vt.id, vt.version, vt.row_type, 'R') is NULL;select ROW_COUNT();")

    if [ $? -ne 0 ]; then
        echo "Visitor_tickets select action took too long. Exiting the script."
        timeout_flag=${timeout_flag+1}
        echo $timeout_flag
        echo "visitor_tickets_vk table last_modified_at between '$date_time' and '$end_date_time'" >> Action_takes_to_long.txt
        echo "Script stopped at timing::: '$date'" >> Action_takes_to_long.txt
        break
    fi

    if [ $secvt -gt 0 ]; then

    echo "$vt_group" >> need_to_update.txt

    fi

echo "$secvt"

sleep 5
done



# select * from (select vvt.transaction_id, vvt.row_type, vvt.vt_group_no, vvt.version, vvt.is_refunded, bbb.transaction_id as bbid from visitor_tickets vvt left join (select vt.transaction_id, vt.row_type, vt.vt_group_no, vt.version, vt.is_refunded from visitor_tickets vt join (SELECT vt_group_no,transaction_id, max(version) as version FROM `visitor_tickets` where vt_group_no = '166946202390952' group by vt_group_no, transaction_id) as bb on bb.vt_group_no = vt.vt_group_no and bb.transaction_id = vt.transaction_id and ABS(bb.version - vt.version) = '0') as bbb on bbb.vt_group_no = vvt.vt_group_no and bbb.transaction_id = vvt.transaction_id and vvt.row_type = bbb.row_type where vvt.vt_group_no = '166946202390952') as bbf where bbid is NULL

# select vt_group_no, transaction_id, group_concat(row_type ORDER BY row_type ASC) as row_type from (select vt.transaction_id, vt.row_type, vt.vt_group_no, vt.version, vt.is_refunded from visitor_tickets vt join (SELECT vt_group_no,transaction_id, max(version) as version FROM `visitor_tickets` where vt_group_no = '166946202390952' group by vt_group_no, transaction_id) as bb on bb.vt_group_no = vt.vt_group_no and bb.transaction_id = vt.transaction_id and ABS(bb.version - vt.version) = '0') as mr group by vt_group_no, transaction_id having row_type != '1,2,3,4,17'

#final Query

# select * from (select * from (select vvt.*, bbb.transaction_id as bbid from visitor_tickets vvt left join (select vt.transaction_id, vt.row_type, vt.vt_group_no, vt.version, vt.is_refunded from visitor_tickets vt join (SELECT vt_group_no,transaction_id, max(version) as version FROM `visitor_tickets` where vt_group_no = '166946202390952' group by vt_group_no, transaction_id) as bb on bb.vt_group_no = vt.vt_group_no and bb.transaction_id = vt.transaction_id and ABS(bb.version - vt.version) = '0') as bbb on bbb.vt_group_no = vvt.vt_group_no and bbb.transaction_id = vvt.transaction_id and vvt.row_type = bbb.row_type where vvt.vt_group_no = '166946202390952') as bbf where bbid is NULL) as finalData join (select vt_group_no, transaction_id, group_concat(row_type ORDER BY row_type ASC) as missingrow_type, max(version) as missingversion from (select vt.transaction_id, vt.row_type, vt.vt_group_no, vt.version, vt.is_refunded from visitor_tickets vt join (SELECT vt_group_no,transaction_id, max(version) as version FROM `visitor_tickets` where vt_group_no = '166946202390952' group by vt_group_no, transaction_id) as bb on bb.vt_group_no = vt.vt_group_no and bb.transaction_id = vt.transaction_id and ABS(bb.version - vt.version) = '0') as mr group by vt_group_no, transaction_id having missingrow_type != '1,2,3,4,17') as missingrow on  finalData.vt_group_no = missingrow.vt_group_no and finalData.transaction_id = missingrow.transaction_id
<!-- Bigquery query -->

WITH
pt1 AS (
    SELECT *, 
           ROW_NUMBER() OVER (PARTITION BY prepaid_ticket_id ORDER BY last_modified_at DESC, IFNULL(version, '1') DESC) AS rn 
    FROM prioticket-reporting.prio_olap.scan_report
),
pt AS (
    SELECT * 
    FROM pt1 
    WHERE rn=1 AND deleted=0
),vt1 AS (
    SELECT *, 
           ROW_NUMBER() OVER (PARTITION BY id ORDER BY last_modified_at DESC, IFNULL(version, '1') DESC) AS rn 
    FROM prioticket-reporting.prio_olap.financial_transactions
),
vt AS (
    SELECT * 
    FROM vt1 
    WHERE rn=1 AND deleted='0'
), scantborders as (select distinct visitor_group_no from pt where action_performed like '%SCAN_TB%' and order_confirm_date > '2024-01-01 00:00:01'), ptfinal as (select pt.visitor_group_no,pt.order_confirm_date,pt.ticket_id,pt.tps_id,pt.is_refunded,pt.prepaid_ticket_id,pt.ticket_type,pt.used,pt.action_performed,pt.activated,pt.redeem_date_time,pt.redemption_notified_at ,pt.version from pt where pt.visitor_group_no in (select visitor_group_no from scantborders) and pt.is_addon_ticket != '2'), vtfinal as (select vt.vt_group_no, vt.order_confirm_date, vt.transaction_id, vt.tickettype_name,vt.ticketId,vt.ticketpriceschedule_id, vt.used, vt.action_performed, vt.visit_date_time, vt.version,vt.is_refunded, vt.row_type from vt where vt.vt_group_no in (select visitor_group_no from scantborders) and vt.col2!= 2 and row_type =1), finalData as (select ptfinal.visitor_group_no as pt_order_id, vtfinal.vt_group_no as vt_order_id, ptfinal.prepaid_ticket_id as pt_transactionId, vtfinal.transaction_id as vt_transactionId, ptfinal.version as pt_version, vtfinal.version as vt_version, ptfinal.ticket_id as ptticketId, vtfinal.ticketId as vt_ticketId, ptfinal.tps_id as pt_tpsId, vtfinal.ticketpriceschedule_id as vt_tpsId, ptfinal.action_performed as pt_actionPerformed, vtfinal.action_performed as vt_actionPeformed, ptfinal.used as pt_used, vtfinal.used as vt_used, ptfinal.redeem_date_time as pt_redeemDate, vtfinal.visit_date_time as vt_redeemDate, ptfinal.is_refunded as pt_refunded, vtfinal.is_refunded as vt_refunded from ptfinal left join vtfinal on ptfinal.visitor_group_no = vtfinal.vt_group_no and ptfinal.prepaid_ticket_id = vtfinal.transaction_id) select * from finalData where (pt_version != vt_version or pt_used != vt_used or ABS(TIMESTAMP_DIFF(pt_redeemDate, vt_redeemDate, SECOND)) > 10800) and pt_used = '1'


<!-- Mysql Query To check Scan Issue -->

select ptt.visitor_group_no as pt_orderId, vt.vt_group_no as vt_orderId, ptt.prepaid_ticket_id as pt_transactionId, vt.transaction_id as vt_transactionId, ptt.version as pt_version, vt.version as vt_version, ptt.used as pt_used, vt.used as vt_used, ptt.redeem_date_time as pt_redeemDate, vt.visit_date_time as vt_redeemDate, ptt.action_performed as pt_actionPerformed, vt.action_performed as vt_actionPerformed from (select pt.visitor_group_no, pt.prepaid_ticket_id, pt.version, pt.used, pt.redeem_date_time, pt.action_performed from prepaid_tickets pt join (SELECT visitor_group_no, prepaid_ticket_id, max(version) as version FROM prepaid_tickets where visitor_group_no in (170419097077599) and is_addon_ticket != '2' group by prepaid_ticket_id, visitor_group_no) as base on pt.visitor_group_no = base.visitor_group_no and ABS(pt.version-base.version) = '0' and pt.prepaid_ticket_id = base.prepaid_ticket_id and pt.used = '1') as ptt left join (select vtt.vt_group_no, vtt.version, vtt.transaction_id, vtt.used, vtt.visit_date_time, vtt.action_performed from visitor_tickets vtt join (SELECT vt_group_no,transaction_id, row_type,max(version) as version FROM visitor_tickets where vt_group_no in (170419097077599) and col2 != '2' and row_type = '1' group by transaction_id, vt_group_no,row_type) as base1 on vtt.vt_group_no = base1.vt_group_no and ABS(vtt.version-base1.version) = '0' and vtt.transaction_id = base1.transaction_id and vtt.row_type = base1.row_type where vtt.col2 != '2') vt on ptt.visitor_group_no = vt.vt_group_no and ptt.prepaid_ticket_id = vt.transaction_id where ROUND(ABS(ptt.used-vt.used)) != '0' or ABS(TIMESTAMPDIFF(MINUTE, ptt.redeem_date_time, vt.visit_date_time)) > 180 or ABS(ptt.version-vt.version) != '0'


select vtt.vt_group_no, vtt.version, vtt.transaction_id, vtt.used, vtt.visit_date_time, vtt.action_performed from visitor_tickets vtt join (SELECT vt_group_no,transaction_id, row_type,max(version) as version FROM visitor_tickets where vt_group_no in (170419097077599) and col2 != '2' and row_type = '1' group by transaction_id, vt_group_no,row_type) as base1 on vtt.vt_group_no = base1.vt_group_no and ABS(vtt.version-base1.version) = '0' and vtt.transaction_id = base1.transaction_id and vtt.row_type = base1.row_type where vtt.col2 != '2'


<!-- Preparation of Insertion queries -->

select vtf.id, vtf.created_date, vtf.transaction_id, vtf.invoice_id, vtf.channel_id, vtf.channel_name, vtf.reseller_id, vtf.reseller_name, vtf.saledesk_id, vtf.saledesk_name, vtf.financial_id, vtf.financial_name, vtf.transaction_type_name, vtf.transaction_type_id, vtf.ticketId, vtf.shared_capacity_id, vtf.ticket_booking_id, vtf.related_order_id, vtf.related_booking_id, vtf.ticket_title, vtf.ticketwithdifferentpricing, vtf.ticketpriceschedule_id, vtf.ticket_extra_option_id, vtf.group_type_ticket, vtf.group_price, vtf.group_quantity, vtf.group_linked_with, vtf.selected_date, vtf.booking_selected_date, vtf.from_time, vtf.to_time, vtf.slot_type, vtf.amount_before_extra_discount, vtf.discount_before_extra_discount, vtf.hto_id, vtf.visitor_group_no, vtf.roomNo, vtf.nights, vtf.user_age, vtf.gender, vtf.user_image, vtf.visitor_country, vtf.merchantAccountCode, vtf.merchantReference, vtf.original_pspReference, vtf.shopperReference, vtf.partner_id, vtf.relational_partner_id, vtf.partner_name, vtf.museum_name, vtf.museum_id, vtf.hotel_name, vtf.hotel_id, vtf.pos_point_id, vtf.pos_point_name, vtf.shift_id, vtf.passNo, vtf.pass_type, vtf.ticketAmt, DATE(mm.pt_redeemDate) as visit_date, mm.pt_redeemDate as visit_date_time, vtf.ticketType, vtf.tickettype_name, vtf.discount_applied_on_how_many_tickets, vtf.paid, vtf.payment_method, vtf.isBillToHotel, vtf.card_name, vtf.pspReference, vtf.card_type, vtf.captured, vtf.age_group, vtf.discount, vtf.isDiscountInPercent, vtf.updated_discount_type, vtf.without_elo_reference_no, vtf.debitor, vtf.creditor, vtf.split_cash_amount, vtf.split_card_amount, vtf.split_voucher_amount, vtf.split_direct_payment_amount, vtf.total_gross_commission, vtf.total_net_commission, vtf.commission_type, vtf.partner_gross_price, vtf.order_currency_partner_gross_price, vtf.partner_gross_price_without_combi_discount, vtf.partner_net_price, vtf.order_currency_partner_net_price, vtf.partner_net_price_without_combi_discount, vtf.isCommissionInPercent, vtf.tax_id, vtf.tax_value, vtf.tax_name, vtf.timezone, vtf.invoice_status, vtf.row_type, vtf.updated_by_id, vtf.updated_by_username, vtf.voucher_updated_by, vtf.voucher_updated_by_name, vtf.redeem_method, vtf.redeem_by_ticket_id, vtf.redeem_by_ticket_title, vtf.cashier_id, vtf.cashier_name, vtf.cashier_register_id, vtf.targetlocation, vtf.paymentMethodType, vtf.targetcity, vtf.service_name, vtf.adjustment_row_type, vtf.description, vtf.distributor_status, vtf.adyen_status, vtf.adjustment_method, vtf.all_ticket_ids, vtf.time_based_done, vtf.visitor_invoice_id, vtf.ticketPrice, vtf.deleted, vtf.is_refunded, vtf.is_block, vtf.is_edited, vtf.vt_group_no, vtf.user_name, vtf.issuer_country_code, vtf.distributor_commission_invoice, vtf.activation_method, vtf.is_prioticket, vtf.is_shop_product, vtf.shop_category_name, vtf.external_account_number, mm.pt_used as used, vtf.ticket_status, vtf.is_prepaid, vtf.is_purchased_with_postpaid, vtf.invoice_type, vtf.supplier_currency_symbol, vtf.order_currency_code, vtf.order_currency_symbol, vtf.currency_rate, vtf.invoice_variant, vtf.service_cost, vtf.service_cost_net_amount, vtf.service_cost_type, vtf.scanned_pass, vtf.groupTransactionId, vtf.booking_status, vtf.channel_type, vtf.is_voucher, vtf.extra_text_field_answer, vtf.distributor_type, vtf.distributor_partner_id, vtf.distributor_partner_name, vtf.issuer_country_name, vtf.chart_number, vtf.extra_discount, vtf.manual_payment_note, vtf.account_number, vtf.is_custom_setting, vtf.external_product_id, vtf.supplier_currency_code, vtf.col1, vtf.col2, vtf.partner_category_id, vtf.col4, vtf.partner_category_name, vtf.col6, vtf.col7, vtf.col8, vtf.is_data_moved, concat(mm.pt_actionPerformed, ', SCANOPTMIZE') as action_performed, vtf.updated_at, vtf.tp_payment_method, vtf.order_confirm_date, vtf.payment_date, vtf.order_cancellation_date, vtf.voucher_creation_date, vtf.primary_host_name,vtf.supplier_gross_price, vtf.supplier_discount, vtf.supplier_ticket_amt, vtf.supplier_tax_value,vtf.supplier_net_price,CURRENT_TIMESTAMP as last_modified_at, vtf.market_merchant_id, vtf.merchant_admin_id, vtf.order_updated_cashier_id, vtf.order_updated_cashier_name, mm.pt_version as version, vtf.supplier_tax_id, vtf.merchant_currency_code, vtf.merchant_price, vtf.merchant_net_price, vtf.merchant_tax_id, vtf.admin_currency_code from visitor_tickets vtf join (select ptt.visitor_group_no as pt_orderId, vt.vt_group_no as vt_orderId, ptt.prepaid_ticket_id as pt_transactionId, vt.transaction_id as vt_transactionId, ptt.version as pt_version, vt.version as vt_version, ptt.used as pt_used, vt.used as vt_used, ptt.redeem_date_time as pt_redeemDate, vt.visit_date_time as vt_redeemDate, ptt.action_performed as pt_actionPerformed, vt.action_performed as vt_actionPerformed from (select pt.visitor_group_no, pt.prepaid_ticket_id, pt.version, pt.used, pt.redeem_date_time, pt.action_performed from prepaid_tickets pt join (SELECT visitor_group_no, prepaid_ticket_id, max(version) as version FROM prepaid_tickets where visitor_group_no in (170419097077599) and is_addon_ticket != '2' group by prepaid_ticket_id, visitor_group_no) as base on pt.visitor_group_no = base.visitor_group_no and ABS(pt.version-base.version) = '0' and pt.prepaid_ticket_id = base.prepaid_ticket_id and pt.used = '1') as ptt left join (select vtt.vt_group_no, vtt.version, vtt.transaction_id, vtt.used, vtt.visit_date_time, vtt.action_performed from visitor_tickets vtt join (SELECT vt_group_no,transaction_id, row_type,max(version) as version FROM visitor_tickets where vt_group_no in (170419097077599) and col2 != '2' and row_type = '1' group by transaction_id, vt_group_no,row_type) as base1 on vtt.vt_group_no = base1.vt_group_no and ABS(vtt.version-base1.version) = '0' and vtt.transaction_id = base1.transaction_id and vtt.row_type = base1.row_type where vtt.col2 != '2') vt on ptt.visitor_group_no = vt.vt_group_no and ptt.prepaid_ticket_id = vt.transaction_id where ROUND(ABS(ptt.used-vt.used)) != '0' or ABS(TIMESTAMPDIFF(MINUTE, ptt.redeem_date_time, vt.visit_date_time)) > 180 or ABS(ptt.version-vt.version) != '0') as mm on vtf.vt_group_no = mm.vt_orderId and vtf.transaction_id = mm.vt_transactionId and ABS(vtf.version-mm.vt_version) = '0' and vtf.col2 != '2' where vtf.vt_group_no in (170419097077599)


------2024-11-02 10:56:20.162--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171402682349905) and action_performed like '%CSSCommission' and col2!= '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171402682349905) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:06:22.396--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172811323930714,172839316979530) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172811323930714,172839316979530) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:06:36.890--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172788958396654,172803936013352,172811316463069) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172788958396654,172803936013352,172811316463069) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:06:50.851--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172792450055845,172813128630478,172841912597447) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172792450055845,172813128630478,172841912597447) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:07:05.253--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172786691745854,172811261700087,172811325014275) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172786691745854,172811261700087,172811325014275) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:07:19.629--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172788517687087,172808864776556,172811321388926) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172788517687087,172808864776556,172811321388926) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:07:33.646--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172811660966008,172824563138501,172839301613977) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172811660966008,172824563138501,172839301613977) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:07:47.683--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172797599795405,172803618886944,172820539003030) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172797599795405,172803618886944,172820539003030) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:08:02.165--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172804255578590,172821834504741) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172804255578590,172821834504741) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:08:17.347--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172824224549105) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172824224549105) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:08:31.186--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172798538526668,172799335142675,172819693670379,172828823665563) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172798538526668,172799335142675,172819693670379,172828823665563) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:08:45.635--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172795185027024,172811971328042,172815099595186,172820776323272,172823508693789,172844256896577,172845186630989) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172795185027024,172811971328042,172815099595186,172820776323272,172823508693789,172844256896577,172845186630989) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:08:59.993--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172798789565430,172810662219844,172840383981137) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172798789565430,172810662219844,172840383981137) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:09:13.810--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172804226326773,172823210013502,172840799659769) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172804226326773,172823210013502,172840799659769) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:09:29.261--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172811805872165) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172811805872165) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:09:42.861--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172789879683248,172808780376795,172825217078963,172838513158062) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172789879683248,172808780376795,172825217078963,172838513158062) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:10:00.994--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171006542175713,171049779781925,171050044159507,171075584202516,171096221004446,171102786357906,171170027731228,171171008779460,171171140482858,171198093958891,171203954183885,171206077868421,171213501776851,171233332927944,171273212925591,171293429524089,171316708002308,171377681685010,171420532241360,171481477590381,171517280220883,171532993665593,171560435970165,171593787426267,171610161404158,171847891527259,172090128113096,172302201148554,172304718940401,172356899469193,172763963860727,172804683961803,172806220909970,172821493420952) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171006542175713,171049779781925,171050044159507,171075584202516,171096221004446,171102786357906,171170027731228,171171008779460,171171140482858,171198093958891,171203954183885,171206077868421,171213501776851,171233332927944,171273212925591,171293429524089,171316708002308,171377681685010,171420532241360,171481477590381,171517280220883,171532993665593,171560435970165,171593787426267,171610161404158,171847891527259,172090128113096,172302201148554,172304718940401,172356899469193,172763963860727,172804683961803,172806220909970,172821493420952) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:10:23.628--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171034573799956,171042860627083,171093645551082,171122439289145,171131370078105,171144866539849,171207893922176,171248802162126,171264810629079,171274399029157,171316782070311,171359825590357,171360396746318,171368699906770,171420235236388,171420912926067,171430505678240,171431756599644,171439663102994,171440671518546,171446636950668,171456153403635,171462834613144,171489522068851,171517336147284,171551775719557,171593486001076,171597550799774,171611369215775,171632413044946,171768169631450,171837549581340,171848911921816,171865453572234,171898303727106,171926138101752,172011385746471,172090127878456,172104169264364,172225802396193,172435707050439,172782424979262) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171034573799956,171042860627083,171093645551082,171122439289145,171131370078105,171144866539849,171207893922176,171248802162126,171264810629079,171274399029157,171316782070311,171359825590357,171360396746318,171368699906770,171420235236388,171420912926067,171430505678240,171431756599644,171439663102994,171440671518546,171446636950668,171456153403635,171462834613144,171489522068851,171517336147284,171551775719557,171593486001076,171597550799774,171611369215775,171632413044946,171768169631450,171837549581340,171848911921816,171865453572234,171898303727106,171926138101752,172011385746471,172090127878456,172104169264364,172225802396193,172435707050439,172782424979262) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:10:43.422--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171015204237132,171075274957539,171084168622982,171092887446647,171136000897520,171140511729942,171140688276326,171164392777948,171179570203475,171213539822049,171301044005855,171342225026517,171343190832345,171446964733567,171447733617949,171498539279630,171509438616657,171510592396176,171542763272046,171567903999540,171745594830674,171991067125193,172131907370387,172181464959075,172197962255395,172310221566642,172467094572593,172727878114492) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171015204237132,171075274957539,171084168622982,171092887446647,171136000897520,171140511729942,171140688276326,171164392777948,171179570203475,171213539822049,171301044005855,171342225026517,171343190832345,171446964733567,171447733617949,171498539279630,171509438616657,171510592396176,171542763272046,171567903999540,171745594830674,171991067125193,172131907370387,172181464959075,172197962255395,172310221566642,172467094572593,172727878114492) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:11:03.217--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171015757456867,171119787621914,171136862490586,171137354008235,171147376376969,171152936471648,171170942242351,171199737946432,171205448845757,171207910499513,171265653172973,171269348706395,171273633943802,171319847982636,171449010810742,171463680906034,171493750867364,171516098600492,171542032279997,171543066166635,171550357080673,171560849403152,171567182127384,171583792456094,171620561143818,171657265809643,171662710492368,171676391058816,171834955277798,172082858786041,172114854781149,172345263131871,172467712441159,172547157904904,172647582879991,172668399303031,172669266858284,172696350309320) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171015757456867,171119787621914,171136862490586,171137354008235,171147376376969,171152936471648,171170942242351,171199737946432,171205448845757,171207910499513,171265653172973,171269348706395,171273633943802,171319847982636,171449010810742,171463680906034,171493750867364,171516098600492,171542032279997,171543066166635,171550357080673,171560849403152,171567182127384,171583792456094,171620561143818,171657265809643,171662710492368,171676391058816,171834955277798,172082858786041,172114854781149,172345263131871,172467712441159,172547157904904,172647582879991,172668399303031,172669266858284,172696350309320) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:11:22.428--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171049667403813,171103911207356,171112183126525,171144923291645,171146184018547,171164422343783,171204902892113,171223477056335,171230751702748,171265145207243,171274384796050,171274398214586,171282246879871,171372015792323,171379295995477,171411524790206,171429204281530,171432237120670,171437575762848,171515521711796,171532967292804,171778885022247,171888356668749,171985805786870,172097802472219,172275541663337,172288992124433,172363588932655,172388935831563,172470507455285,172512847685367,172570194222788,172630340788632,172669161397467,172784849285846,172814367962395) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171049667403813,171103911207356,171112183126525,171144923291645,171146184018547,171164422343783,171204902892113,171223477056335,171230751702748,171265145207243,171274384796050,171274398214586,171282246879871,171372015792323,171379295995477,171411524790206,171429204281530,171432237120670,171437575762848,171515521711796,171532967292804,171778885022247,171888356668749,171985805786870,172097802472219,172275541663337,172288992124433,172363588932655,172388935831563,172470507455285,172512847685367,172570194222788,172630340788632,172669161397467,172784849285846,172814367962395) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:11:41.077--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171008566662847,171085632217503,171092928461685,171093419624693,171136686956692,171140688400984,171162111354396,171166769812901,171171008294272,171179037346145,171180897545435,171195561149766,171283072475452,171300806294519,171308195315458,171394928591310,171395959284440,171399425912535,171411964581675,171411991702439,171473834427278,171500731911381,171502266128563,171506378756373,171517229253563,171533388576411,171570157080747,171585798612086,171602414986852,171610100722882,171629051085583,171726820746917,172537745177372,172587563800750) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171008566662847,171085632217503,171092928461685,171093419624693,171136686956692,171140688400984,171162111354396,171166769812901,171171008294272,171179037346145,171180897545435,171195561149766,171283072475452,171300806294519,171308195315458,171394928591310,171395959284440,171399425912535,171411964581675,171411991702439,171473834427278,171500731911381,171502266128563,171506378756373,171517229253563,171533388576411,171570157080747,171585798612086,171602414986852,171610100722882,171629051085583,171726820746917,172537745177372,172587563800750) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:12:01.685--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171008861197418,171062099814529,171118946008925,171130022930299,171136546914953,171138052695097,171161934683943,171179655021607,171224143623449,171274724506425,171291696481158,171300415686386,171318418705813,171354651897942,171398722242982,171423085564879,171435843607430,171439190318969,171446910392888,171455623458898,171456395719232,171466154846860,171487261661068,171489761921419,171506501030068,171510056294300,171550486423097,171550992157880,171676273099681,172036942321575,172094861362946,172168971801126,172174144472380,172210797538832,172356905598847,172450951508478,172478421237480,172536269997160,172616334888035) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171008861197418,171062099814529,171118946008925,171130022930299,171136546914953,171138052695097,171161934683943,171179655021607,171224143623449,171274724506425,171291696481158,171300415686386,171318418705813,171354651897942,171398722242982,171423085564879,171435843607430,171439190318969,171446910392888,171455623458898,171456395719232,171466154846860,171487261661068,171489761921419,171506501030068,171510056294300,171550486423097,171550992157880,171676273099681,172036942321575,172094861362946,172168971801126,172174144472380,172210797538832,172356905598847,172450951508478,172478421237480,172536269997160,172616334888035) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:12:20.921--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171070533001756,171127139690669,171131950299185,171200990432569,171207959218097,171213708430711,171230967515229,171242337451781,171265662482847,171308581158206,171380155695172,171420890257493,171446073875603,171462784781487,171464046790731,171466499855049,171532695450708,171533083878383,171544387057619,171551475615660,171561685616705,171585251650245,171586060412138,171586757307933,171898762859548,171947670697685,171992133919599,172217065945833,172264722098431,172348776375140,172362839279818,172467030233503,172574416483559) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171070533001756,171127139690669,171131950299185,171200990432569,171207959218097,171213708430711,171230967515229,171242337451781,171265662482847,171308581158206,171380155695172,171420890257493,171446073875603,171462784781487,171464046790731,171466499855049,171532695450708,171533083878383,171544387057619,171551475615660,171561685616705,171585251650245,171586060412138,171586757307933,171898762859548,171947670697685,171992133919599,172217065945833,172264722098431,172348776375140,172362839279818,172467030233503,172574416483559) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:12:42.047--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171172977110933,171186872813655,171265152625976,171274457900754,171386451887336,171399701157413,171411642675355,171412422816857,171413949336777,171439234467084,171447238691198,171463961044780,171483672218832,171485420893608,171498498240938,171502345751915,171516808910023,171554991886140,171567182238165,171597876871563,171602344369684,171737270190312,171813171167718,171959951209472,171964751190019,172094698077915,172182678459368,172198368214598,172275544531739,172414394684441,172449209607057,172537884590826,172580722581633,172670912871299,172789049262165) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171172977110933,171186872813655,171265152625976,171274457900754,171386451887336,171399701157413,171411642675355,171412422816857,171413949336777,171439234467084,171447238691198,171463961044780,171483672218832,171485420893608,171498498240938,171502345751915,171516808910023,171554991886140,171567182238165,171597876871563,171602344369684,171737270190312,171813171167718,171959951209472,171964751190019,172094698077915,172182678459368,172198368214598,172275544531739,172414394684441,172449209607057,172537884590826,172580722581633,172670912871299,172789049262165) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:13:01.202--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171026225654590,171074831515397,171095027935171,171145698040005,171175401616600,171189627573446,171221997140169,171230577963248,171230991664924,171247821743454,171283088619309,171316021055301,171368878712346,171429820757833,171439240819445,171440662892826,171466969561726,171472757586662,171482193540692,171500540113067,171533107913394,171560431280075,171599622405049,171602789520493,171670441503984,171748908636790,171786712982491,171922512860798,172446714531692,172537728758101,172579638073663,172609362428150,172620489406607,172764184882508) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171026225654590,171074831515397,171095027935171,171145698040005,171175401616600,171189627573446,171221997140169,171230577963248,171230991664924,171247821743454,171283088619309,171316021055301,171368878712346,171429820757833,171439240819445,171440662892826,171466969561726,171472757586662,171482193540692,171500540113067,171533107913394,171560431280075,171599622405049,171602789520493,171670441503984,171748908636790,171786712982491,171922512860798,172446714531692,172537728758101,172579638073663,172609362428150,172620489406607,172764184882508) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:13:21.392--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171019861710043,171084182222391,171118632707526,171144555341576,171169253145946,171180973089655,171188104422357,171198360633615,171248633722049,171251037433182,171265148313672,171292188804970,171299584987347,171309527201211,171338818323668,171412431170101,171420658709003,171422438500590,171430605807133,171438515801323,171439220310000,171455468747696,171456336573656,171464378383847,171490088366062,171500558775633,171516077313643,171516483539113,171552445116751,171588060563797,171594349082301,171676268481419,171813120588960,172062384251335,172146068502761,172193181900438,172451257154517,172660784711758,172703281558927,172710787706512) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171019861710043,171084182222391,171118632707526,171144555341576,171169253145946,171180973089655,171188104422357,171198360633615,171248633722049,171251037433182,171265148313672,171292188804970,171299584987347,171309527201211,171338818323668,171412431170101,171420658709003,171422438500590,171430605807133,171438515801323,171439220310000,171455468747696,171456336573656,171464378383847,171490088366062,171500558775633,171516077313643,171516483539113,171552445116751,171588060563797,171594349082301,171676268481419,171813120588960,172062384251335,172146068502761,172193181900438,172451257154517,172660784711758,172703281558927,172710787706512) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:13:41.535--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171006080924639,171006146394524,171017632808178,171041856639332,171075974027152,171119893911348,171136555978309,171155030094473,171155361803328,171155920706525,171172587055583,171188612773173,171189836805755,171213546978772,171249078016657,171267068686637,171343064249619,171369033164760,171377644007995,171420043703778,171438323081748,171458298170604,171475424402249,171488722724461,171526803773774,171550932788763,171559880767023,171586497378774,171589925504260,171614316969634,171656641368042,171978369216348,172131642107829,172172583976881,172225371735538,172545035974622,172710920159922,172786955091923) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171006080924639,171006146394524,171017632808178,171041856639332,171075974027152,171119893911348,171136555978309,171155030094473,171155361803328,171155920706525,171172587055583,171188612773173,171189836805755,171213546978772,171249078016657,171267068686637,171343064249619,171369033164760,171377644007995,171420043703778,171438323081748,171458298170604,171475424402249,171488722724461,171526803773774,171550932788763,171559880767023,171586497378774,171589925504260,171614316969634,171656641368042,171978369216348,172131642107829,172172583976881,172225371735538,172545035974622,172710920159922,172786955091923) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:19:25.475--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171146490141676,172379261500689) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171146490141676,172379261500689) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:19:39.397--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172643332762788,172682950814185,172684622381499,172743241862938,172786029724090,172794863245249,172850828890295) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172643332762788,172682950814185,172684622381499,172743241862938,172786029724090,172794863245249,172850828890295) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:19:53.711--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172605354679162,172682308276228,172693121712902,172705120213835,172711938503945,172742665987253,172755442473936,172759324971750,172805420542295,172823941521423) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172605354679162,172682308276228,172693121712902,172705120213835,172711938503945,172742665987253,172755442473936,172759324971750,172805420542295,172823941521423) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:20:07.427--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172660378349636,172718384849026,172721444665821,172823590256524,172832064864634) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172660378349636,172718384849026,172721444665821,172823590256524,172832064864634) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:20:22.868--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172622289018838,172661190187765,172691000373576,172728422973618,172736724225449,172771165239988,172790081905709,172795721760225,172811549413641,172841577726181) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172622289018838,172661190187765,172691000373576,172728422973618,172736724225449,172771165239988,172790081905709,172795721760225,172811549413641,172841577726181) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:20:36.754--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172638355952251,172703544953486,172719990577481,172759760044993) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172638355952251,172703544953486,172719990577481,172759760044993) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:20:50.398--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172621726129113,172656332479441,172668333041227,172669004097699,172691157493183,172716821740362,172729030587184) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172621726129113,172656332479441,172668333041227,172669004097699,172691157493183,172716821740362,172729030587184) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:21:04.554--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172624872191635,172674292644839,172682487294891,172721232860160,172736605880622,172811124756117,172812210252038,172850427913388) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172624872191635,172674292644839,172682487294891,172721232860160,172736605880622,172811124756117,172812210252038,172850427913388) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:21:18.169--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172631966788752,172665484699652,172789615785592) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172631966788752,172665484699652,172789615785592) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:21:32.328--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172630800857793,172650342282707,172681103788959,172735844284514,172811838165956,172824956087760) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172630800857793,172650342282707,172681103788959,172735844284514,172811838165956,172824956087760) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:21:46.079--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172621713800095,172641442668337,172711026028546,172711988423929,172718844556171) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172621713800095,172641442668337,172711026028546,172711988423929,172718844556171) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:21:59.963--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172648689242254,172667721808121,172682074598412,172690730382409,172709578484590,172742822743725,172779069109022,172803984351467,172812126706880,172841838081622) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172648689242254,172667721808121,172682074598412,172690730382409,172709578484590,172742822743725,172779069109022,172803984351467,172812126706880,172841838081622) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:22:13.849--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172814482218749) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172814482218749) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:22:31.443--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171196325132941,171204321322827,171206860733198,171212677992244,171213460145359,171231409200993,171247120900544,171273452010951,171273633896528,171298388165558,171360930584120,171367294955122,171394666030708,171436608361597,171438326575803,171439350942548,171455511936162,171456303358752,171465030138720,171480083895646,171489237815631,171490093238881,171498694001441,171550885730416,171551650854845,171582520011242,171585222781470,171619389191376,171619791319984,171628923543482,171644073133871,171672159588605,171703674102813,171734195005100,171738466913909,171774550392009,171792851057623,171799896337239,171862594133968,171929854944662,171982866221934,172015777226693,172060951495898,172085180475065,172093820274796,172128875930499,172130195468984,172145907272268,172146671661963,172162030753844,172163124027952,172179330255598,172180234321799,172206539114695,172216813376631,172292885114635,172301524787053,172321385647067,172326202136222,172333825365825,172334904918900,172337276524356,172369313278236,172494395537990) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171196325132941,171204321322827,171206860733198,171212677992244,171213460145359,171231409200993,171247120900544,171273452010951,171273633896528,171298388165558,171360930584120,171367294955122,171394666030708,171436608361597,171438326575803,171439350942548,171455511936162,171456303358752,171465030138720,171480083895646,171489237815631,171490093238881,171498694001441,171550885730416,171551650854845,171582520011242,171585222781470,171619389191376,171619791319984,171628923543482,171644073133871,171672159588605,171703674102813,171734195005100,171738466913909,171774550392009,171792851057623,171799896337239,171862594133968,171929854944662,171982866221934,172015777226693,172060951495898,172085180475065,172093820274796,172128875930499,172130195468984,172145907272268,172146671661963,172162030753844,172163124027952,172179330255598,172180234321799,172206539114695,172216813376631,172292885114635,172301524787053,172321385647067,172326202136222,172333825365825,172334904918900,172337276524356,172369313278236,172494395537990) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:22:51.147--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171170504214594,171212158244462,171228649193007,171228671737532,171230345244900,171237889706265,171238746888507,171250765141573,171300671477593,171324220145164,171325472538729,171343573991131,171362689268300,171393642680026,171429197665840,171439112636132,171464324602393,171495405992436,171515928960646,171572119510851,171592929154429,171594266808664,171611403648307,171611552418367,171638289488403,171670254097305,171724441602151,171733228007091,171739822042594,171767292061903,171799446177802,171841565888126,171845609874641,171853074830970,171898665590404,171923037910613,171938478267248,171940239363692,172025064776177,172076024815288,172092869263663,172110316076238,172154572393491,172172694473370,172191299061323,172198552152305,172198874256933,172206197697249,172234342083092,172235132590122,172270131410572,172275963417287,172326173894288,172326191504497,172336862374164,172337539823329,172352015968995,172569293884834,172569453355216,172570542472467,172579398051784,172587758546263,172602010525916,172645743548578) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171170504214594,171212158244462,171228649193007,171228671737532,171230345244900,171237889706265,171238746888507,171250765141573,171300671477593,171324220145164,171325472538729,171343573991131,171362689268300,171393642680026,171429197665840,171439112636132,171464324602393,171495405992436,171515928960646,171572119510851,171592929154429,171594266808664,171611403648307,171611552418367,171638289488403,171670254097305,171724441602151,171733228007091,171739822042594,171767292061903,171799446177802,171841565888126,171845609874641,171853074830970,171898665590404,171923037910613,171938478267248,171940239363692,172025064776177,172076024815288,172092869263663,172110316076238,172154572393491,172172694473370,172191299061323,172198552152305,172198874256933,172206197697249,172234342083092,172235132590122,172270131410572,172275963417287,172326173894288,172326191504497,172336862374164,172337539823329,172352015968995,172569293884834,172569453355216,172570542472467,172579398051784,172587758546263,172602010525916,172645743548578) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:23:09.847--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171177176318702,171179181925041,171265247313514,171282894486210,171291077618140,171317007338697,171335583657302,171350992597847,171406004399946,171413241605587,171430298060745,171455928817153,171479869582143,171481544647556,171523855578236,171525522738268,171549381201137,171550487126993,171552326522958,171568395647804,171574370864525,171629226957874,171647839424403,171648781798955,171655393293031,171713368982066,171735882260377,171774761840482,171778097410425,171792183716569,171818175213937,171833324817957,171845946440217,171861879807006,171913397864181,171957144411656,171965037210706,172014991855068,172015741809557,172017936037480,172032882979590,172038233933686,172050427264224,172060289862511,172089124980725,172156104412062,172160849856672,172171192471463,172198088089677,172205492869785,172241587616106,172247714338716,172275958246775,172277439045352,172292807728928,172294155509632,172318841496205,172354343462346,172414691182506,172415176378586,172467338596959,172559159611591,172568811634436,172577254161641) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171177176318702,171179181925041,171265247313514,171282894486210,171291077618140,171317007338697,171335583657302,171350992597847,171406004399946,171413241605587,171430298060745,171455928817153,171479869582143,171481544647556,171523855578236,171525522738268,171549381201137,171550487126993,171552326522958,171568395647804,171574370864525,171629226957874,171647839424403,171648781798955,171655393293031,171713368982066,171735882260377,171774761840482,171778097410425,171792183716569,171818175213937,171833324817957,171845946440217,171861879807006,171913397864181,171957144411656,171965037210706,172014991855068,172015741809557,172017936037480,172032882979590,172038233933686,172050427264224,172060289862511,172089124980725,172156104412062,172160849856672,172171192471463,172198088089677,172205492869785,172241587616106,172247714338716,172275958246775,172277439045352,172292807728928,172294155509632,172318841496205,172354343462346,172414691182506,172415176378586,172467338596959,172559159611591,172568811634436,172577254161641) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:23:31.071--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171169683823100,171176286445993,171178430790273,171188024010501,171204751666491,171206034949426,171213324326454,171215419304127,171224186735308,171228312124440,171236586711894,171249367637285,171265667669120,171285825467552,171290484485906,171308541779519,171359347580313,171371527111891,171379396931727,171386184241857,171455680252665,171455686674139,171465007531147,171472603858950,171489741622061,171496993927807,171514480490157,171534060466087,171552695426045,171567864084794,171572171656979,171584033205625,171586285406719,171669788767439,171747514350085,171749194925239,171798531765781,171819377484314,171854555040426,171949607720458,171957032835261,171965242279109,171971865878873,171991493474505,172000052310149,172007298722103,172018303538921,172173236836790,172209479104422,172215262159995,172251058619940,172251080318534,172301718844198,172312807641655,172319775835303,172325527949873,172363122092273,172380305355090,172393704756100,172430699135419,172448715171964,172449044946608,172457503709383,172467031332953) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171169683823100,171176286445993,171178430790273,171188024010501,171204751666491,171206034949426,171213324326454,171215419304127,171224186735308,171228312124440,171236586711894,171249367637285,171265667669120,171285825467552,171290484485906,171308541779519,171359347580313,171371527111891,171379396931727,171386184241857,171455680252665,171455686674139,171465007531147,171472603858950,171489741622061,171496993927807,171514480490157,171534060466087,171552695426045,171567864084794,171572171656979,171584033205625,171586285406719,171669788767439,171747514350085,171749194925239,171798531765781,171819377484314,171854555040426,171949607720458,171957032835261,171965242279109,171971865878873,171991493474505,172000052310149,172007298722103,172018303538921,172173236836790,172209479104422,172215262159995,172251058619940,172251080318534,172301718844198,172312807641655,172319775835303,172325527949873,172363122092273,172380305355090,172393704756100,172430699135419,172448715171964,172449044946608,172457503709383,172467031332953) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:23:50.704--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171211320735734,171212732136827,171215160088587,171229038521895,171236560743064,171238983010617,171256735383201,171264151895141,171277669815161,171291490270110,171292342723593,171337344884521,171349023635490,171350042086474,171352598070171,171376842274629,171396048952113,171429265033378,171430000328208,171447657080020,171463153749841,171464223649883,171471079358877,171498293567960,171505378455666,171521542252040,171531657204779,171542914189580,171571697148751,171586014152302,171593322925133,171594818295909,171635637376754,171659841809885,171683368422017,171689905022037,171732418255368,171749592190356,171783095096518,171783996453492,171803029206824,171827763135378,171872977535014,171957265401678,171963120864104,171972314865445,171999348562757,172006314759779,172013315540039,172026841902561,172042361167349,172044992713081,172047418852294,172146479552473,172154845434515,172160860836012,172163652597930,172178262055438,172181655916360,172187907256294,172190606614251,172198721784059,172202039410468,172215059302808) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171211320735734,171212732136827,171215160088587,171229038521895,171236560743064,171238983010617,171256735383201,171264151895141,171277669815161,171291490270110,171292342723593,171337344884521,171349023635490,171350042086474,171352598070171,171376842274629,171396048952113,171429265033378,171430000328208,171447657080020,171463153749841,171464223649883,171471079358877,171498293567960,171505378455666,171521542252040,171531657204779,171542914189580,171571697148751,171586014152302,171593322925133,171594818295909,171635637376754,171659841809885,171683368422017,171689905022037,171732418255368,171749592190356,171783095096518,171783996453492,171803029206824,171827763135378,171872977535014,171957265401678,171963120864104,171972314865445,171999348562757,172006314759779,172013315540039,172026841902561,172042361167349,172044992713081,172047418852294,172146479552473,172154845434515,172160860836012,172163652597930,172178262055438,172181655916360,172187907256294,172190606614251,172198721784059,172202039410468,172215059302808) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:24:08.795--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171187777488854,171205280541516,171214423158698,171246543106454,171262610848792,171278562739051,171291051391006,171298675399507,171299741113045,171306489194823,171308986763275,171387309779098,171403313825310,171403674974340,171418584767887,171419496487231,171419789843179,171446785848418,171455720563520,171462563013036,171481514244426,171489152893488,171502002033752,171504846536365,171541704328447,171568217756952,171578369035314,171647321641251,171654350080343,171669257813986,171716092399028,171757644219752,171759464889137,171764948587491,171784066498783,171791716252488,171792562778578,171861861612128,171923118753777,171983009714015,172069245157242,172075571846454,172096568071392,172126920469732,172129485449094,172130783351439,172178251885437,172207561365086,172221623762344,172247834878202,172267668156285,172275344581603,172276681011181,172280692588644,172313169404762,172313172823497,172330462313231,172337517321241,172337590777166,172406698308290,172424123750038,172424210840451,172439379654804,172440348697770) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171187777488854,171205280541516,171214423158698,171246543106454,171262610848792,171278562739051,171291051391006,171298675399507,171299741113045,171306489194823,171308986763275,171387309779098,171403313825310,171403674974340,171418584767887,171419496487231,171419789843179,171446785848418,171455720563520,171462563013036,171481514244426,171489152893488,171502002033752,171504846536365,171541704328447,171568217756952,171578369035314,171647321641251,171654350080343,171669257813986,171716092399028,171757644219752,171759464889137,171764948587491,171784066498783,171791716252488,171792562778578,171861861612128,171923118753777,171983009714015,172069245157242,172075571846454,172096568071392,172126920469732,172129485449094,172130783351439,172178251885437,172207561365086,172221623762344,172247834878202,172267668156285,172275344581603,172276681011181,172280692588644,172313169404762,172313172823497,172330462313231,172337517321241,172337590777166,172406698308290,172424123750038,172424210840451,172439379654804,172440348697770) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:24:28.007--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171211150242152,171239436353579,171246844471227,171256808755951,171273170686262,171273920953905,171290179405535,171309679899311,171327327344543,171334072465791,171349795120664,171359923981255,171387870013628,171398387995546,171403958421184,171411487872042,171412670909736,171413316609387,171439117954425,171455611234997,171456573076905,171482036229437,171540495767095,171569526339791,171576723424664,171585644742636,171585968664311,171611143034634,171611348144451,171616308711795,171619734616618,171672172686042,171696469822795,171733145872970,171741590355849,171756059849902,171850776274608,171905378371120,171912022340744,171940226883121,171946020276004,171983433088471,171988918938367,172007475883047,172015159822829,172033051155538,172084633467455,172094573763729,172154696542415,172171104175497,172179389021603,172196731779581,172212759929595,172213506451120,172259343253231,172276456735136,172319273461696,172325879456976,172328352612292,172336767056035,172345952037681,172377568035482,172439958533668,172448778841232) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171211150242152,171239436353579,171246844471227,171256808755951,171273170686262,171273920953905,171290179405535,171309679899311,171327327344543,171334072465791,171349795120664,171359923981255,171387870013628,171398387995546,171403958421184,171411487872042,171412670909736,171413316609387,171439117954425,171455611234997,171456573076905,171482036229437,171540495767095,171569526339791,171576723424664,171585644742636,171585968664311,171611143034634,171611348144451,171616308711795,171619734616618,171672172686042,171696469822795,171733145872970,171741590355849,171756059849902,171850776274608,171905378371120,171912022340744,171940226883121,171946020276004,171983433088471,171988918938367,172007475883047,172015159822829,172033051155538,172084633467455,172094573763729,172154696542415,172171104175497,172179389021603,172196731779581,172212759929595,172213506451120,172259343253231,172276456735136,172319273461696,172325879456976,172328352612292,172336767056035,172345952037681,172377568035482,172439958533668,172448778841232) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:24:46.639--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171168405001381,171176985631700,171177062583198,171219041580073,171227658308531,171231900826510,171236565062534,171237784237581,171237789474356,171238895448148,171265971970529,171300419225386,171309561033508,171313164701341,171313649664609,171345087705266,171363073574171,171376779939111,171386682958802,171387638633856,171419482829357,171426565692921,171430215558642,171438535629589,171444086318561,171489567649220,171497509574132,171524802675514,171530635451752,171609985093192,171653556657685,171669249270097,171767482030863,171808502321835,171815897612204,171837445691509,171857519301546,171869053908433,171887095246042,172005846618668,172022505923692,172025411990097,172035003774359,172042657462993,172112075360575,172130580686213,172138619100443,172156464184579,172171442653054,172192064590402,172233856068963,172234329483529,172243278794833,172275963958065,172294354857868,172311377175808,172319228561676,172352520445359,172369272972398,172376927699071,172387915105192,172392417299085,172396177941785,172396561696278) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171168405001381,171176985631700,171177062583198,171219041580073,171227658308531,171231900826510,171236565062534,171237784237581,171237789474356,171238895448148,171265971970529,171300419225386,171309561033508,171313164701341,171313649664609,171345087705266,171363073574171,171376779939111,171386682958802,171387638633856,171419482829357,171426565692921,171430215558642,171438535629589,171444086318561,171489567649220,171497509574132,171524802675514,171530635451752,171609985093192,171653556657685,171669249270097,171767482030863,171808502321835,171815897612204,171837445691509,171857519301546,171869053908433,171887095246042,172005846618668,172022505923692,172025411990097,172035003774359,172042657462993,172112075360575,172130580686213,172138619100443,172156464184579,172171442653054,172192064590402,172233856068963,172234329483529,172243278794833,172275963958065,172294354857868,172311377175808,172319228561676,172352520445359,172369272972398,172376927699071,172387915105192,172392417299085,172396177941785,172396561696278) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:26:45.930--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171176396453766,171197072891110,171204841640470,171211367616750,171234241604933,171240651748653,171247187274054,171258191328144,171262830444200,171339306825851,171350150869399,171378458923500,171378903819292,171387941358170,171412651580993,171421759799549,171429464053469,171431603627742,171433886971041,171456745876638,171473315812307,171491246686723,171498303656450,171506098936822,171526100833294,171542965645022,171551431328689,171551712703405,171600622974185,171604403734375,171636857991004,171646174133159,171654399029628,171670786211586,171675264909422,171729188876317,171731179354598,171731390253487,171774599616607,171782337669827,171791778457695,171845435843302,171871102051759,171972379909120,172017752221871,172033567313756,172063011952760,172110315823804,172131512421042,172149069029252,172191624336944,172303451594241,172311149101586,172363122147432,172374128137362,172396493075332,172403579082996,172507436932524,172516951651090,172549754997518,172575093350999,172595618811364,172608041850275,172628191557493) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171176396453766,171197072891110,171204841640470,171211367616750,171234241604933,171240651748653,171247187274054,171258191328144,171262830444200,171339306825851,171350150869399,171378458923500,171378903819292,171387941358170,171412651580993,171421759799549,171429464053469,171431603627742,171433886971041,171456745876638,171473315812307,171491246686723,171498303656450,171506098936822,171526100833294,171542965645022,171551431328689,171551712703405,171600622974185,171604403734375,171636857991004,171646174133159,171654399029628,171670786211586,171675264909422,171729188876317,171731179354598,171731390253487,171774599616607,171782337669827,171791778457695,171845435843302,171871102051759,171972379909120,172017752221871,172033567313756,172063011952760,172110315823804,172131512421042,172149069029252,172191624336944,172303451594241,172311149101586,172363122147432,172374128137362,172396493075332,172403579082996,172507436932524,172516951651090,172549754997518,172575093350999,172595618811364,172608041850275,172628191557493) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:27:15.678--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171179868780426,171214300685447,171223396489532,171259451714836,171266587694838,171267410776651,171287506046035,171343539256018,171405832686261,171420586526986,171429848186853,171439087930309,171454415464722,171497311320311,171527041108245,171542419426243,171565972945586,171587629679006,171592466239874,171593508124522,171593708205666,171644186426136,171645794987285,171713327038001,171817439362054,171836181181471,171860562059162,171861312254507,171904107920676,171982146951411,172009224076363,172016088793619,172059470956286,172078817755488,172124766302579,172144350167179,172156030373807,172165377935580,172180652718260,172187534051334,172240230730055,172249825840406,172282322842103,172310232178060,172322398695461,172395577999786,172451264765876,172492454163633,172501292439682,172527531960001,172570402544934,172577664551991,172596537800367,172657539445007,172666370507331,172682891876804,172683650176324,172708434853863,172732458944360,172751819286910,172761531479135,172828899398608,172847265881059) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171179868780426,171214300685447,171223396489532,171259451714836,171266587694838,171267410776651,171287506046035,171343539256018,171405832686261,171420586526986,171429848186853,171439087930309,171454415464722,171497311320311,171527041108245,171542419426243,171565972945586,171587629679006,171592466239874,171593508124522,171593708205666,171644186426136,171645794987285,171713327038001,171817439362054,171836181181471,171860562059162,171861312254507,171904107920676,171982146951411,172009224076363,172016088793619,172059470956286,172078817755488,172124766302579,172144350167179,172156030373807,172165377935580,172180652718260,172187534051334,172240230730055,172249825840406,172282322842103,172310232178060,172322398695461,172395577999786,172451264765876,172492454163633,172501292439682,172527531960001,172570402544934,172577664551991,172596537800367,172657539445007,172666370507331,172682891876804,172683650176324,172708434853863,172732458944360,172751819286910,172761531479135,172828899398608,172847265881059) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:27:46.849--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172449617192272,172461944531774,172504438152647,172510930704812,172521525095783,172525677853077,172541599613807,172545161787966,172545161824255,172547378334707,172557889447298,172579795583824,172580715739295,172581089224246,172604054862992,172605627441890,172621404096841,172625832330054,172641146767962,172647048914692,172647661771793,172675437505550,172686734252949,172703082881473,172717936041632,172721109191877,172752065923747,172768820147791,172769005628837,172779443736337,172803261322254,172808800752401,172831220256109,172833026682951) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172449617192272,172461944531774,172504438152647,172510930704812,172521525095783,172525677853077,172541599613807,172545161787966,172545161824255,172547378334707,172557889447298,172579795583824,172580715739295,172581089224246,172604054862992,172605627441890,172621404096841,172625832330054,172641146767962,172647048914692,172647661771793,172675437505550,172686734252949,172703082881473,172717936041632,172721109191877,172752065923747,172768820147791,172769005628837,172779443736337,172803261322254,172808800752401,172831220256109,172833026682951) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:28:15.972--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172444985264202,172468275393669,172469686294762,172470754287036,172477011082805,172479093313488,172518373701751,172525315546301,172526144370069,172527129556075,172546552716303,172560916366642,172581010421239,172587653182782,172591690544645,172595530335630,172598700316853,172633190740851,172638931889687,172668192205828,172710255929474,172727858178371,172737465761683,172737853803372,172740564736817,172743060878752,172751077868583,172751101810620,172751464383648,172754549333569,172760366860325,172779925899026,172797340958960,172803432665393,172810473968416,172823679190549,172847181947459) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172444985264202,172468275393669,172469686294762,172470754287036,172477011082805,172479093313488,172518373701751,172525315546301,172526144370069,172527129556075,172546552716303,172560916366642,172581010421239,172587653182782,172591690544645,172595530335630,172598700316853,172633190740851,172638931889687,172668192205828,172710255929474,172727858178371,172737465761683,172737853803372,172740564736817,172743060878752,172751077868583,172751101810620,172751464383648,172754549333569,172760366860325,172779925899026,172797340958960,172803432665393,172810473968416,172823679190549,172847181947459) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:28:44.355--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172454363837037,172462280499845,172522377814159,172561964394783,172563938557961,172582692330784,172595109884799,172612823971816,172617372192917,172630808457697,172638668245072,172639364019993,172649980781853,172675849465581,172685974145969,172691684683670,172695638575276,172700169855817,172700551037245,172707972179066,172717652050154,172718964046432,172720227622918,172742610534608,172755045300749,172755884663360,172759796482403,172761610779625,172761645455058,172771789876951,172794931958718,172797063072356,172803357727292,172812844016643,172829051437199) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172454363837037,172462280499845,172522377814159,172561964394783,172563938557961,172582692330784,172595109884799,172612823971816,172617372192917,172630808457697,172638668245072,172639364019993,172649980781853,172675849465581,172685974145969,172691684683670,172695638575276,172700169855817,172700551037245,172707972179066,172717652050154,172718964046432,172720227622918,172742610534608,172755045300749,172755884663360,172759796482403,172761610779625,172761645455058,172771789876951,172794931958718,172797063072356,172803357727292,172812844016643,172829051437199) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:29:12.742--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172434045390497,172451222036085,172458301381151,172458472468472,172537820201552,172554163308050,172596488101592,172600583197971,172621745918940,172640039510005,172656132121792,172677815362019,172690731279388,172693411178696,172695442431495,172696719490935,172718713700568,172726541729312,172734619687980,172735578249519,172737909853856,172738671927293,172742843116704,172742910454958,172752343130890,172760170517242,172772099522991,172782203483625,172788025621254,172803740931764,172805168616351,172814910237018,172844644055538,172849309921518) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172434045390497,172451222036085,172458301381151,172458472468472,172537820201552,172554163308050,172596488101592,172600583197971,172621745918940,172640039510005,172656132121792,172677815362019,172690731279388,172693411178696,172695442431495,172696719490935,172718713700568,172726541729312,172734619687980,172735578249519,172737909853856,172738671927293,172742843116704,172742910454958,172752343130890,172760170517242,172772099522991,172782203483625,172788025621254,172803740931764,172805168616351,172814910237018,172844644055538,172849309921518) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:29:40.813--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172449657779917,172459849013648,172475292860017,172503695247574,172509347851946,172511942053196,172512930154984,172565857754574,172570514867976,172578558053797,172586355500463,172588114540331,172595432903486,172622181320472,172622473205861,172642387167375,172648114016800,172649716880835,172649848738796,172655038016971,172656449330343,172683612791719,172744319039914,172744382239122,172752907493317,172760891186763,172776441213086,172787559766219,172790114799059,172796618998802,172830039416073,172832490848452,172833085219437,172850907850735) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172449657779917,172459849013648,172475292860017,172503695247574,172509347851946,172511942053196,172512930154984,172565857754574,172570514867976,172578558053797,172586355500463,172588114540331,172595432903486,172622181320472,172622473205861,172642387167375,172648114016800,172649716880835,172649848738796,172655038016971,172656449330343,172683612791719,172744319039914,172744382239122,172752907493317,172760891186763,172776441213086,172787559766219,172790114799059,172796618998802,172830039416073,172832490848452,172833085219437,172850907850735) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:30:11.390--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172465518841504,172477881544076,172492872652049,172539344797818,172577649728810,172579056831220,172580885049419,172587477629042,172591581279560,172597792836125,172600788839067,172614867518892,172639750278821,172651621649663,172675855137944,172682302722158,172690118177811,172691192532222,172701433670185,172720228176584,172726129921138,172729835756954,172734237867544,172743585610184,172760085746598,172769287597788,172785721958102,172787216363502,172788403002270,172803661246949,172806355385640,172829101551648,172829821306876) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172465518841504,172477881544076,172492872652049,172539344797818,172577649728810,172579056831220,172580885049419,172587477629042,172591581279560,172597792836125,172600788839067,172614867518892,172639750278821,172651621649663,172675855137944,172682302722158,172690118177811,172691192532222,172701433670185,172720228176584,172726129921138,172729835756954,172734237867544,172743585610184,172760085746598,172769287597788,172785721958102,172787216363502,172788403002270,172803661246949,172806355385640,172829101551648,172829821306876) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:30:40.286--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172449704938988,172465830089691,172485281884024,172557002766213,172561915740961,172605130007626,172607054766950,172625024494867,172640200310586,172645053058050,172648109749305,172658330245081,172677137133332,172691240987756,172692553513087,172707341838758,172734512225231,172760636629904,172781670858901,172784806814794,172787113013900,172788034808452,172790107787543,172803644504420,172821701653349,172842880469911,172847950595043) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172449704938988,172465830089691,172485281884024,172557002766213,172561915740961,172605130007626,172607054766950,172625024494867,172640200310586,172645053058050,172648109749305,172658330245081,172677137133332,172691240987756,172692553513087,172707341838758,172734512225231,172760636629904,172781670858901,172784806814794,172787113013900,172788034808452,172790107787543,172803644504420,172821701653349,172842880469911,172847950595043) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:31:15.843--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172813681098962) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172813681098962) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:31:41.871--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172802864776464) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172802864776464) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:32:07.538--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172821144914705,172855700524203) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172821144914705,172855700524203) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:32:37.596--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172819573383836) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172819573383836) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:33:08.613--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172819869578701) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172819869578701) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:33:34.798--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172790540813654,172824864061492) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172790540813654,172824864061492) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:34:00.662--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172828060763466) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172828060763466) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:34:26.200--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172804082047625,172842131444443) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172804082047625,172842131444443) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:36:45.734--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172846749561658) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172846749561658) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:37:14.120--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172848566920908) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172848566920908) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:37:41.945--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172805393039160) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172805393039160) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:38:07.512--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172802935541936) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172802935541936) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:38:37.447--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172811206711642) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172811206711642) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:39:15.302--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171239521497473,171256745873884,171318856444402,171360051778287,171364920184144,171412424675545,171430341310579,171481058246064,171519412473167,171525017883545,171534131109816,171535521961415,171554884380132,171570534323102,171593904442081,171597715556696,171611482516834,171647730888962,171709701278770,171709746530731,171723748441914,171732496685346,171784494089880,171814033602816,171938704136240,171955952472520,171965700372045,172010244286291,172037655704137,172190512784469,172241918178805,172266772051377,172275397572943,172297587208898,172318473792816,172337168951269,172346149909199,172350325057913,172354436373103,172411567824052,172414855287088,172416631500441,172430857889042,172448998982404,172479091319998,172510450720409,172522054705054,172527133243133,172552701354196,172556868039174,172569596165200,172576972970586,172589616779709,172604729162949,172647096845718,172651216313599,172671793961836,172672190028910,172710261949839,172777019426450,172792246446650,172838652195751) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171239521497473,171256745873884,171318856444402,171360051778287,171364920184144,171412424675545,171430341310579,171481058246064,171519412473167,171525017883545,171534131109816,171535521961415,171554884380132,171570534323102,171593904442081,171597715556696,171611482516834,171647730888962,171709701278770,171709746530731,171723748441914,171732496685346,171784494089880,171814033602816,171938704136240,171955952472520,171965700372045,172010244286291,172037655704137,172190512784469,172241918178805,172266772051377,172275397572943,172297587208898,172318473792816,172337168951269,172346149909199,172350325057913,172354436373103,172411567824052,172414855287088,172416631500441,172430857889042,172448998982404,172479091319998,172510450720409,172522054705054,172527133243133,172552701354196,172556868039174,172569596165200,172576972970586,172589616779709,172604729162949,172647096845718,172651216313599,172671793961836,172672190028910,172710261949839,172777019426450,172792246446650,172838652195751) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:39:46.908--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171240108185391,171294797569485,171353321936857,171354492672478,171361714237258,171407562513709,171412413544014,171414551654316,171419856227870,171477309609684,171588049353685,171602514736697,171604666850241,171615180960273,171672167709267,171695917318242,171845108491442,171846585548760,171852621700955,171943249547637,171959585649036,171968373846637,171982830817968,172000069777390,172017586161144,172027192536617,172036773018928,172070668234428,172081070943685,172094832631876,172156583557392,172251430636665,172306726661017,172314125870609,172319034937502,172324309986536,172327000115666,172327732962900,172336783358331,172346119426842,172402810798699,172416050859425,172433108737960,172466566474666,172467135389049,172483790599596,172519301167620,172526433778677,172537766335306,172538405618004,172579042087074,172603830221038,172625774502414,172685542784812,172734334109516,172744041700516,172777396917949,172799244170791) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171240108185391,171294797569485,171353321936857,171354492672478,171361714237258,171407562513709,171412413544014,171414551654316,171419856227870,171477309609684,171588049353685,171602514736697,171604666850241,171615180960273,171672167709267,171695917318242,171845108491442,171846585548760,171852621700955,171943249547637,171959585649036,171968373846637,171982830817968,172000069777390,172017586161144,172027192536617,172036773018928,172070668234428,172081070943685,172094832631876,172156583557392,172251430636665,172306726661017,172314125870609,172319034937502,172324309986536,172327000115666,172327732962900,172336783358331,172346119426842,172402810798699,172416050859425,172433108737960,172466566474666,172467135389049,172483790599596,172519301167620,172526433778677,172537766335306,172538405618004,172579042087074,172603830221038,172625774502414,172685542784812,172734334109516,172744041700516,172777396917949,172799244170791) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:40:17.694--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171238606259847,171248847561488,171275376354101,171299464195274,171299567198014,171299947439061,171308704606598,171325427368700,171335818358138,171354946069325,171360015683948,171379521360694,171389976071485,171396844739427,171412360092659,171416455161627,171420437226907,171422046406902,171518602472741,171611477860564,171611483591691,171611490087117,171618031790309,171775200726144,171827626940999,171830783770521,171896499325355,172020050706459,172021127565241,172114790701711,172120117792211,172148620130985,172192618215146,172253368300429,172255038039325,172305610044827,172310478677614,172312506320409,172322187591847,172322386580975,172329133161910,172349466676243,172423769621111,172432659234025,172448900405261,172461531990720,172465861501707,172496407081766,172528337606561,172645677746247,172690675059390,172716720815656,172719888810443,172777137321092,172814448408849,172841228188999) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171238606259847,171248847561488,171275376354101,171299464195274,171299567198014,171299947439061,171308704606598,171325427368700,171335818358138,171354946069325,171360015683948,171379521360694,171389976071485,171396844739427,171412360092659,171416455161627,171420437226907,171422046406902,171518602472741,171611477860564,171611483591691,171611490087117,171618031790309,171775200726144,171827626940999,171830783770521,171896499325355,172020050706459,172021127565241,172114790701711,172120117792211,172148620130985,172192618215146,172253368300429,172255038039325,172305610044827,172310478677614,172312506320409,172322187591847,172322386580975,172329133161910,172349466676243,172423769621111,172432659234025,172448900405261,172461531990720,172465861501707,172496407081766,172528337606561,172645677746247,172690675059390,172716720815656,172719888810443,172777137321092,172814448408849,172841228188999) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:40:49.645--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171222886655214,171224731957130,171230806121547,171231158115758,171241358141026,171248842264129,171256910457115,171268491282839,171358163119666,171368987456301,171403137691757,171419977863623,171525606974585,171536391433442,171550694992567,171550846650076,171602264371337,171612158299358,171656116836471,171659304430582,171707286620214,171776336499302,171826346581825,171843579559840,171907577083826,171914719119578,171961583677558,172011903463436,172025183759810,172036326487221,172102678635654,172155005502907,172235508252782,172258481531958,172296880723750,172310787261783,172319692369136,172347457047720,172364169168543,172391025064839,172401555060823,172413642692699,172415308896549,172433316690456,172434919496951,172439618635280,172440463578737,172477558300869,172491862310253,172492680151201,172496409866922,172522848224564,172534920655433,172538867784803,172554820884669,172586369742816,172595234002072,172616285909885,172632639826753,172648843858192,172674747671678,172707535612945,172805113702827,172822818810927) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171222886655214,171224731957130,171230806121547,171231158115758,171241358141026,171248842264129,171256910457115,171268491282839,171358163119666,171368987456301,171403137691757,171419977863623,171525606974585,171536391433442,171550694992567,171550846650076,171602264371337,171612158299358,171656116836471,171659304430582,171707286620214,171776336499302,171826346581825,171843579559840,171907577083826,171914719119578,171961583677558,172011903463436,172025183759810,172036326487221,172102678635654,172155005502907,172235508252782,172258481531958,172296880723750,172310787261783,172319692369136,172347457047720,172364169168543,172391025064839,172401555060823,172413642692699,172415308896549,172433316690456,172434919496951,172439618635280,172440463578737,172477558300869,172491862310253,172492680151201,172496409866922,172522848224564,172534920655433,172538867784803,172554820884669,172586369742816,172595234002072,172616285909885,172632639826753,172648843858192,172674747671678,172707535612945,172805113702827,172822818810927) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:41:22.419--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171231086896323,171235706218105,171256896709173,171302506730447,171360072563461,171360362971441,171441734971575,171490800954353,171542003564502,171561248022400,171567037134538,171587856661420,171593334921712,171594480715554,171594605486624,171605047063366,171786913446541,171787547351160,171882408922253,171909402671352,171912611669038,171912823617782,171932581687231,172089112864772,172217003485253,172232254143354,172271462720945,172275858593220,172279384869917,172303468340196,172319425675344,172337139771192,172337542232508,172340581408204,172366832668834,172439746199484,172449417588006,172457221814148,172520492215711,172526491324417,172539504554616,172548256279600,172595448589518,172604727276918,172625476222758,172652650625577,172677854570165,172684627181364,172700400510417,172703245637373,172707359636845,172716772073767,172769026019947,172802896853246,172803837593980,172845353995926,172855761521221) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171231086896323,171235706218105,171256896709173,171302506730447,171360072563461,171360362971441,171441734971575,171490800954353,171542003564502,171561248022400,171567037134538,171587856661420,171593334921712,171594480715554,171594605486624,171605047063366,171786913446541,171787547351160,171882408922253,171909402671352,171912611669038,171912823617782,171932581687231,172089112864772,172217003485253,172232254143354,172271462720945,172275858593220,172279384869917,172303468340196,172319425675344,172337139771192,172337542232508,172340581408204,172366832668834,172439746199484,172449417588006,172457221814148,172520492215711,172526491324417,172539504554616,172548256279600,172595448589518,172604727276918,172625476222758,172652650625577,172677854570165,172684627181364,172700400510417,172703245637373,172707359636845,172716772073767,172769026019947,172802896853246,172803837593980,172845353995926,172855761521221) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:41:53.272--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171126776611293,171187809172828,171248582228055,171259015102294,171290319534322,171354173166553,171360926909901,171368473931337,171416573286982,171428935061669,171429408269629,171472929791027,171480648607944,171481937322125,171485023986587,171490922814719,171533508396437,171533873235676,171545691741444,171562134182832,171579588360921,171611480502795,171653440801071,171663850278746,171663951779116,171792598128756,171965116542085,171974288826428,172099489971076,172206665414609,172206745874885,172226338820097,172288144286150,172341116069524,172346212085070,172347558271204,172357237557175,172358225828637,172359277145953,172366619395923,172370829990146,172382718466148,172413431095136,172427447785720,172439992308856,172448021874793,172462673798691,172500734780716,172544477503854,172606301526333,172607765856953,172624398788096,172659376975492,172674429004703,172690496935758,172724404595434,172751908034490,172811101953219) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171126776611293,171187809172828,171248582228055,171259015102294,171290319534322,171354173166553,171360926909901,171368473931337,171416573286982,171428935061669,171429408269629,171472929791027,171480648607944,171481937322125,171485023986587,171490922814719,171533508396437,171533873235676,171545691741444,171562134182832,171579588360921,171611480502795,171653440801071,171663850278746,171663951779116,171792598128756,171965116542085,171974288826428,172099489971076,172206665414609,172206745874885,172226338820097,172288144286150,172341116069524,172346212085070,172347558271204,172357237557175,172358225828637,172359277145953,172366619395923,172370829990146,172382718466148,172413431095136,172427447785720,172439992308856,172448021874793,172462673798691,172500734780716,172544477503854,172606301526333,172607765856953,172624398788096,172659376975492,172674429004703,172690496935758,172724404595434,172751908034490,172811101953219) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:42:24.242--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171086366052502,171110668651104,171218674344594,171247922234068,171256897210197,171275797557571,171323188243902,171360032672319,171369220884577,171411962919292,171416464979270,171420362735709,171421466866037,171466164415922,171480893486765,171483715969234,171534161886245,171541282679293,171575759017079,171594197274955,171611483284648,171706454338751,171707816082202,171925419886000,172012759727046,172026567241510,172036701400424,172062870573857,172073072278539,172106933903580,172141839272931,172252891566029,172254684079990,172294604196414,172295166954219,172321277627655,172337383438825,172339514115712,172426809578445,172432718505466,172448175880587,172450880612231,172457548039491,172466317670324,172468333591754,172484662552645,172487785883583,172500567361040,172501274129378,172600065311065,172616142456553,172621227746980,172622009974007,172719178339552,172750629121836,172752656246497,172769796467310,172776304123911,172776425320843,172785314480515,172794236894826,172806322177898,172822762281074,172828400352471) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171086366052502,171110668651104,171218674344594,171247922234068,171256897210197,171275797557571,171323188243902,171360032672319,171369220884577,171411962919292,171416464979270,171420362735709,171421466866037,171466164415922,171480893486765,171483715969234,171534161886245,171541282679293,171575759017079,171594197274955,171611483284648,171706454338751,171707816082202,171925419886000,172012759727046,172026567241510,172036701400424,172062870573857,172073072278539,172106933903580,172141839272931,172252891566029,172254684079990,172294604196414,172295166954219,172321277627655,172337383438825,172339514115712,172426809578445,172432718505466,172448175880587,172450880612231,172457548039491,172466317670324,172468333591754,172484662552645,172487785883583,172500567361040,172501274129378,172600065311065,172616142456553,172621227746980,172622009974007,172719178339552,172750629121836,172752656246497,172769796467310,172776304123911,172776425320843,172785314480515,172794236894826,172806322177898,172822762281074,172828400352471) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:42:55.299--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171333994875788,171334721942347,171337454360450,171351315776583,171351480060815,171353691803204,171372176783994,171421075926798,171421728956615,171447143899663,171458495769420,171482855068974,171503996609326,171534046064760,171542036087122,171602712220741,171610406395736,171610956151574,171611483665875,171637902713807,171709249804189,171895437562682,171896158217005,171968589783811,171976211089328,172051522225357,172077706453591,172079082070620,172086587137370,172114187695274,172121332337493,172149027244421,172258641440398,172260387146553,172309928685652,172341848272975,172388053510571,172398135862377,172414565077704,172423644946905,172432193038068,172435502502529,172455768818048,172521795937646,172526939236843,172543747460068,172552980560369,172564032658637,172570165000767,172586748447882,172589060899681,172604004796881,172619308557677,172622083954698,172647386319852,172682725778540,172699051135412,172710069681409,172711770035853,172768422433689,172823300099693) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171333994875788,171334721942347,171337454360450,171351315776583,171351480060815,171353691803204,171372176783994,171421075926798,171421728956615,171447143899663,171458495769420,171482855068974,171503996609326,171534046064760,171542036087122,171602712220741,171610406395736,171610956151574,171611483665875,171637902713807,171709249804189,171895437562682,171896158217005,171968589783811,171976211089328,172051522225357,172077706453591,172079082070620,172086587137370,172114187695274,172121332337493,172149027244421,172258641440398,172260387146553,172309928685652,172341848272975,172388053510571,172398135862377,172414565077704,172423644946905,172432193038068,172435502502529,172455768818048,172521795937646,172526939236843,172543747460068,172552980560369,172564032658637,172570165000767,172586748447882,172589060899681,172604004796881,172619308557677,172622083954698,172647386319852,172682725778540,172699051135412,172710069681409,172711770035853,172768422433689,172823300099693) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:43:23.189--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171308501670997,171516239497902,171611480452154,171943682803281,172019594335440,172284467320008,172380318283225,172398114149005,172398302725770,172493369790064,172613032589179) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171308501670997,171516239497902,171611480452154,171943682803281,172019594335440,172284467320008,172380318283225,172398114149005,172398302725770,172493369790064,172613032589179) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:43:52.346--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171185862505451,171245600440768,171293304950609,171375987171967,171428580447900,171514836031246,171646739421744,171677396836732,171753526515506,171758403968471,171842792248959,171862766192154,171864308894777,171932254842078,171950324806319,171973147367726,171976382096340,171976487137803,172024750336956,172040065542643,172107971891936,172110050712546,172135189958556,172136053221439,172156130929578,172239459156980,172295309310601,172368710024197,172373547526951,172446009974185,172468662451704,172492082284189,172550519130474,172611635453314,172681275146552,172688399001169,172688652421625,172754619058537,172792382394721,172812641407224,172847718886325) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171185862505451,171245600440768,171293304950609,171375987171967,171428580447900,171514836031246,171646739421744,171677396836732,171753526515506,171758403968471,171842792248959,171862766192154,171864308894777,171932254842078,171950324806319,171973147367726,171976382096340,171976487137803,172024750336956,172040065542643,172107971891936,172110050712546,172135189958556,172136053221439,172156130929578,172239459156980,172295309310601,172368710024197,172373547526951,172446009974185,172468662451704,172492082284189,172550519130474,172611635453314,172681275146552,172688399001169,172688652421625,172754619058537,172792382394721,172812641407224,172847718886325) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:44:20.984--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171168353248650,171198227706443,171211023008506,171346131164776,171398481913616,171496408851327,171660664714381,171660987441670,171662291451780,171678044197739,171678982286670,171719836729289,171837856685088,171905856581314,171929729884307,171937237448582,171942648126996,171962560720029,171997377381954,171998381016853,172002445757283,172035492938229,172049515543815,172071625525543,172139885965905,172153000036933,172182908866258,172261263919061,172381372674380,172391022531178,172396131739632,172477781488109,172570379075625,172662050372343,172740214238353,172757889555215,172784100574102,172803006048372,172818099879308) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171168353248650,171198227706443,171211023008506,171346131164776,171398481913616,171496408851327,171660664714381,171660987441670,171662291451780,171678044197739,171678982286670,171719836729289,171837856685088,171905856581314,171929729884307,171937237448582,171942648126996,171962560720029,171997377381954,171998381016853,172002445757283,172035492938229,172049515543815,172071625525543,172139885965905,172153000036933,172182908866258,172261263919061,172381372674380,172391022531178,172396131739632,172477781488109,172570379075625,172662050372343,172740214238353,172757889555215,172784100574102,172803006048372,172818099879308) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:44:49.737--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171219754850024,171288668864670,171461144920819,171496782174876,171717939391182,171846750635615,171863645815923,171877007585969,171890420035170,171989322681179,172005225971216,172008826139677,172014705683938,172024800177160,172053855018718,172066644014056,172105822565355,172146429565832,172182194045691,172222393764640,172228675048661,172228857903723,172274330118808,172280236581117,172312810566689,172381884348445,172436836053696,172451222641795,172460721556664,172463212653137,172477494222556,172497641659808,172533240321728,172581586426854,172613457187586,172624530244164,172644756137797,172683362823003,172731138509533,172785470329622,172794677008134,172827468397563) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171219754850024,171288668864670,171461144920819,171496782174876,171717939391182,171846750635615,171863645815923,171877007585969,171890420035170,171989322681179,172005225971216,172008826139677,172014705683938,172024800177160,172053855018718,172066644014056,172105822565355,172146429565832,172182194045691,172222393764640,172228675048661,172228857903723,172274330118808,172280236581117,172312810566689,172381884348445,172436836053696,172451222641795,172460721556664,172463212653137,172477494222556,172497641659808,172533240321728,172581586426854,172613457187586,172624530244164,172644756137797,172683362823003,172731138509533,172785470329622,172794677008134,172827468397563) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:45:23.141--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171196958143674,171280360304306,171415067378023,171415988237573,171488961897886,171502152467064,171552689524430,171638952485175,171821455138938,171918498159809,172066645017102,172083711953462,172136049675489,172137430184299,172213610926445,172232485977447,172270259128135,172285302633263,172291203384411,172293516297762,172338420666811,172351879919079,172421027652097,172436112151407,172509739764698,172520476713930,172533319368478,172625137672723,172632983751210,172776314101645,172812383087747) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171196958143674,171280360304306,171415067378023,171415988237573,171488961897886,171502152467064,171552689524430,171638952485175,171821455138938,171918498159809,172066645017102,172083711953462,172136049675489,172137430184299,172213610926445,172232485977447,172270259128135,172285302633263,172291203384411,172293516297762,172338420666811,172351879919079,172421027652097,172436112151407,172509739764698,172520476713930,172533319368478,172625137672723,172632983751210,172776314101645,172812383087747) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:45:52.127--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171219517459096,171279918040408,171358239226917,171453425753371,171456792216814,171482351099617,171540828471808,171547398666500,171548129462514,171551972698092,171560147212535,171704769726695,171761520321044,171787386580407,171846993936430,171851284570644,171891254924955,171902477453324,171910955476775,171967140237895,172026959281661,172048836743352,172066654583220,172067692356830,172071840229451,172083218021995,172092445219588,172145024641232,172161535273725,172187650084763,172196716664956,172214087389944,172223217142036,172290096089462,172300611950816,172322795504034,172332013297783,172346507299613,172356914268854,172373647305314,172384272978646,172507601977468,172568355386791,172586907310389,172705446207460,172749366583106,172752584449350,172818153029317,172839399358638) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171219517459096,171279918040408,171358239226917,171453425753371,171456792216814,171482351099617,171540828471808,171547398666500,171548129462514,171551972698092,171560147212535,171704769726695,171761520321044,171787386580407,171846993936430,171851284570644,171891254924955,171902477453324,171910955476775,171967140237895,172026959281661,172048836743352,172066654583220,172067692356830,172071840229451,172083218021995,172092445219588,172145024641232,172161535273725,172187650084763,172196716664956,172214087389944,172223217142036,172290096089462,172300611950816,172322795504034,172332013297783,172346507299613,172356914268854,172373647305314,172384272978646,172507601977468,172568355386791,172586907310389,172705446207460,172749366583106,172752584449350,172818153029317,172839399358638) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:46:21.160--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171236455497766,171280416571007,171416808023928,171458037500409,171458669682447,171484589157386,171617661952205,171625864390822,171654209345725,171682595458007,171699393745647,171743177212848,171749845967946,171793105129320,171871683080734,171901616548443,171961238194972,171984562839201,172087475226227,172232996858593,172256763198705,172284514390878,172290958980208,172326445343383,172374507828697,172458953408016,172468029369552,172529201536626,172577029576501,172610836454318,172613375371107,172629097453163,172644271483549,172653260377181,172714281735605,172748717850152,172837148143934,172839507713442,172853152497792) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171236455497766,171280416571007,171416808023928,171458037500409,171458669682447,171484589157386,171617661952205,171625864390822,171654209345725,171682595458007,171699393745647,171743177212848,171749845967946,171793105129320,171871683080734,171901616548443,171961238194972,171984562839201,172087475226227,172232996858593,172256763198705,172284514390878,172290958980208,172326445343383,172374507828697,172458953408016,172468029369552,172529201536626,172577029576501,172610836454318,172613375371107,172629097453163,172644271483549,172653260377181,172714281735605,172748717850152,172837148143934,172839507713442,172853152497792) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:46:49.386--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171168333309182,171267867394710,171325673962673,171332913485556,171392328162615,171404417765524,171476991847570,171520290063859,171620667889782,171675143859020,171697927552656,171733985745025,171910426744122,171923636517153,171938926901037,171985250061067,171988538351828,171993505101323,172143485979400,172172820851026,172173727134049,172212441829673,172239396094590,172260910054588,172262674502891,172279383723136,172298828186077,172301572715278,172308478462078,172348150377972,172361882139078,172372134626793,172436078420018,172463388556165,172503295135216,172718392524449,172740854735153,172743065327155,172814529842439,172815653789145,172830170211369) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171168333309182,171267867394710,171325673962673,171332913485556,171392328162615,171404417765524,171476991847570,171520290063859,171620667889782,171675143859020,171697927552656,171733985745025,171910426744122,171923636517153,171938926901037,171985250061067,171988538351828,171993505101323,172143485979400,172172820851026,172173727134049,172212441829673,172239396094590,172260910054588,172262674502891,172279383723136,172298828186077,172301572715278,172308478462078,172348150377972,172361882139078,172372134626793,172436078420018,172463388556165,172503295135216,172718392524449,172740854735153,172743065327155,172814529842439,172815653789145,172830170211369) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:47:17.369--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171327904628331,171358530924768,171648793764500,171738378738929,171746240078390,171750841423089,171827381103489,171877490832833,171893179222739,171942904862310,171980152733312,171993204941841,172001572704459,172032857741866,172040467740482,172050307087385,172066648868543,172101898360442,172206968944474,172309754665988,172359543207439,172425186183763,172432702932808,172498718924716,172499920182187,172658541037979,172670051228208,172782372121129,172844840139078) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171327904628331,171358530924768,171648793764500,171738378738929,171746240078390,171750841423089,171827381103489,171877490832833,171893179222739,171942904862310,171980152733312,171993204941841,172001572704459,172032857741866,172040467740482,172050307087385,172066648868543,172101898360442,172206968944474,172309754665988,172359543207439,172425186183763,172432702932808,172498718924716,172499920182187,172658541037979,172670051228208,172782372121129,172844840139078) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:47:45.314--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171178515621612,171280251312618,171280418048316,171326329692395,171491483156956,171652787900589,171754724869271,171828277141223,171836488782203,171886111255742,171937092719023,171963149086468,171984245655667,172024341601721,172058205865648,172059218275369,172066956536112,172083705330988,172152996090664,172216493989419,172230226671586,172312724712659,172331192660368,172373634074058,172402487792285,172435339848764,172477643544225,172479929259972,172509027037801,172538180878817,172639316440460,172669962695054,172731479975252,172801201276341) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171178515621612,171280251312618,171280418048316,171326329692395,171491483156956,171652787900589,171754724869271,171828277141223,171836488782203,171886111255742,171937092719023,171963149086468,171984245655667,172024341601721,172058205865648,172059218275369,172066956536112,172083705330988,172152996090664,172216493989419,172230226671586,172312724712659,172331192660368,172373634074058,172402487792285,172435339848764,172477643544225,172479929259972,172509027037801,172538180878817,172639316440460,172669962695054,172731479975252,172801201276341) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:49:14.797--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171203580161904,171219082171700,171223191307448,171230997410302,171285064603633,171308524590354,171436652347568,171547986896583,171758007205476,171818177978929,171885875632536,171983535009608,171988899298807,172022556412646,172040021165518,172135017484312,172187641896598,172208397949016,172224248994605,172265887676072,172274626687636,172278678474208,172347008740459,172352021796937,172391734787852,172396439775934,172403633539111,172450514094184,172543343138046,172610854855531,172628262648058,172636235259275,172766544809278,172784917407363,172803226195171) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171203580161904,171219082171700,171223191307448,171230997410302,171285064603633,171308524590354,171436652347568,171547986896583,171758007205476,171818177978929,171885875632536,171983535009608,171988899298807,172022556412646,172040021165518,172135017484312,172187641896598,172208397949016,172224248994605,172265887676072,172274626687636,172278678474208,172347008740459,172352021796937,172391734787852,172396439775934,172403633539111,172450514094184,172543343138046,172610854855531,172628262648058,172636235259275,172766544809278,172784917407363,172803226195171) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:49:32.366--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171266564673604,171294786037984,171299545763292,171321824662808,171360986884289,171416274380803,171448742564030,171493061739565,171494020228607,171515194419841,171536357853756,171619310418036,171622288506180,171627794739854,171627988193597,171653907432904,171701393853766,171820691557537,171820957906901,171830869311311,171839567154551,171845107463806,171879478979384,171890917152143,171912979229389,172051675814168,172063036639237,172064594932763,172068596414293,172086901798417,172172433753359,172202956171621,172210941285206,172247547505542,172253413778967,172269196687299,172276273325899,172298339340245,172301857014903,172323663765557,172353044148483,172366915150790,172368787758196,172372035779905,172401952473790,172410175079141,172430621953154,172451331484051,172482534413535,172486734432071,172588865771632,172595676356672,172606142766508,172606591248458,172624016230592,172629556029433,172638724318688,172709636884145,172748381830373,172785352325758,172803616809313,172805814017202,172831654362935) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171266564673604,171294786037984,171299545763292,171321824662808,171360986884289,171416274380803,171448742564030,171493061739565,171494020228607,171515194419841,171536357853756,171619310418036,171622288506180,171627794739854,171627988193597,171653907432904,171701393853766,171820691557537,171820957906901,171830869311311,171839567154551,171845107463806,171879478979384,171890917152143,171912979229389,172051675814168,172063036639237,172064594932763,172068596414293,172086901798417,172172433753359,172202956171621,172210941285206,172247547505542,172253413778967,172269196687299,172276273325899,172298339340245,172301857014903,172323663765557,172353044148483,172366915150790,172368787758196,172372035779905,172401952473790,172410175079141,172430621953154,172451331484051,172482534413535,172486734432071,172588865771632,172595676356672,172606142766508,172606591248458,172624016230592,172629556029433,172638724318688,172709636884145,172748381830373,172785352325758,172803616809313,172805814017202,172831654362935) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:49:50.965--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171171512967326,171188399507907,171247165683692,171291230297040,171302229519114,171303339038321,171315791269042,171333284588824,171355335548910,171437153356411,171463507675414,171476252252812,171498870490415,171524567563831,171541353712524,171636108168910,171655492123968,171692911551296,171791698248988,171834858619321,171843458562696,171852193660454,171882327615054,171894900430777,171915922174273,171959539707582,172027803039867,172038860645160,172046358557976,172059830166147,172064255251484,172100568131228,172157566807978,172158591798858,172250195255894,172278781725045,172293422676436,172314438493220,172320100414513,172342059917655,172356074146977,172409843563904,172417104940608,172473678322841,172487047384958,172552660810856,172577947619881,172587564274368,172589876570956,172590915610440,172595529746771,172603688390946,172617927072698,172631401307553,172640583314815,172656896730263,172741678496220,172742027980866,172771746666988,172794471812307,172798859018115,172816470471902,172819777149288,172833251578581) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171171512967326,171188399507907,171247165683692,171291230297040,171302229519114,171303339038321,171315791269042,171333284588824,171355335548910,171437153356411,171463507675414,171476252252812,171498870490415,171524567563831,171541353712524,171636108168910,171655492123968,171692911551296,171791698248988,171834858619321,171843458562696,171852193660454,171882327615054,171894900430777,171915922174273,171959539707582,172027803039867,172038860645160,172046358557976,172059830166147,172064255251484,172100568131228,172157566807978,172158591798858,172250195255894,172278781725045,172293422676436,172314438493220,172320100414513,172342059917655,172356074146977,172409843563904,172417104940608,172473678322841,172487047384958,172552660810856,172577947619881,172587564274368,172589876570956,172590915610440,172595529746771,172603688390946,172617927072698,172631401307553,172640583314815,172656896730263,172741678496220,172742027980866,172771746666988,172794471812307,172798859018115,172816470471902,172819777149288,172833251578581) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:50:09.498--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171209744812473,171233949806885,171255626077293,171285267164924,171331225953538,171345900739271,171363507846222,171415844613172,171422775241732,171458921310162,171495500022349,171515414628069,171586312040097,171610158299905,171619288163463,171683226480557,171727232876883,171759990338639,171786863032803,171818377730870,171831213126485,171852715350286,171877430861207,171891138126498,171938324031320,171938887771541,171982973989770,172009241665494,172020300836008,172076192550158,172081288357275,172120222547104,172124950013937,172158889561767,172191463893189,172253720471329,172267378002760,172274909477152,172310136368878,172332159584143,172371300787183,172383970327677,172397232259093,172397327946800,172401281238488,172414100327145,172426024101335,172427530567136,172459989049982,172467748574465,172493008658541,172500334249367,172511919353214,172517047315930,172518837843330,172581327664993,172603640322512,172608267832239,172691144057337,172708640802696,172711514635171,172722952098833,172724212223589,172739101919370) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171209744812473,171233949806885,171255626077293,171285267164924,171331225953538,171345900739271,171363507846222,171415844613172,171422775241732,171458921310162,171495500022349,171515414628069,171586312040097,171610158299905,171619288163463,171683226480557,171727232876883,171759990338639,171786863032803,171818377730870,171831213126485,171852715350286,171877430861207,171891138126498,171938324031320,171938887771541,171982973989770,172009241665494,172020300836008,172076192550158,172081288357275,172120222547104,172124950013937,172158889561767,172191463893189,172253720471329,172267378002760,172274909477152,172310136368878,172332159584143,172371300787183,172383970327677,172397232259093,172397327946800,172401281238488,172414100327145,172426024101335,172427530567136,172459989049982,172467748574465,172493008658541,172500334249367,172511919353214,172517047315930,172518837843330,172581327664993,172603640322512,172608267832239,172691144057337,172708640802696,172711514635171,172722952098833,172724212223589,172739101919370) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:50:27.558--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171294842909768,171304849494208,171309009593369,171359508255074,171363745419318,171368518680543,171368584335290,171398461876157,171413467017675,171413955543931,171446965439662,171449826387680,171535749756260,171579996495618,171586371714344,171593191254727,171725681777438,171770308220050,171783232109548,171783848897397,171796910147098,171822273183381,171861733774144,171861930297628,171895021448048,171976636459416,171991219928814,172094881691752,172096342615993,172128783984564,172150073691010,172175669129606,172191040861036,172206270792374,172224889492247,172227068669327,172244110909142,172294544851733,172318514655216,172362057404783,172371123160512,172392678637741,172409937183217,172443439170936,172483262147185,172502268405221,172517464451290,172527706789392,172562400627105,172564135319266,172604537259772,172642665757428,172733092512440,172733393171584,172737450740974,172742745486586,172743090060711,172799199384142,172811349411221,172819829146892,172841375273282,172846809600066) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171294842909768,171304849494208,171309009593369,171359508255074,171363745419318,171368518680543,171368584335290,171398461876157,171413467017675,171413955543931,171446965439662,171449826387680,171535749756260,171579996495618,171586371714344,171593191254727,171725681777438,171770308220050,171783232109548,171783848897397,171796910147098,171822273183381,171861733774144,171861930297628,171895021448048,171976636459416,171991219928814,172094881691752,172096342615993,172128783984564,172150073691010,172175669129606,172191040861036,172206270792374,172224889492247,172227068669327,172244110909142,172294544851733,172318514655216,172362057404783,172371123160512,172392678637741,172409937183217,172443439170936,172483262147185,172502268405221,172517464451290,172527706789392,172562400627105,172564135319266,172604537259772,172642665757428,172733092512440,172733393171584,172737450740974,172742745486586,172743090060711,172799199384142,172811349411221,172819829146892,172841375273282,172846809600066) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:50:45.855--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171229637734608,171272903024568,171302082977026,171321288874498,171331228699716,171337675901044,171377848203999,171485152336453,171492329621013,171527417090959,171578907754450,171585636479447,171636355023767,171657720798495,171731501979705,171765676592113,171792326006534,171890165696371,171913750380681,171915661670427,171942598614374,171956329637964,172025923021094,172053385332171,172054034084443,172059736072237,172064317809279,172064430724048,172068869471833,172093626449018,172116149436929,172149572983099,172185174460576,172189797083481,172198277738707,172200717296612,172214993158568,172234219817704,172279192893330,172322944024015,172340863004835,172348549560556,172349611859436,172364524919578,172425886335388,172457539616472,172467682773487,172483364096916,172486989648691,172520852606215,172527788002802,172560479151954,172565828399721,172569827208636,172577941322737,172599428765881,172600023068525,172616930721264,172641521854430,172641814922248,172690760259904,172698555948600,172700287070412,172718657735553) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171229637734608,171272903024568,171302082977026,171321288874498,171331228699716,171337675901044,171377848203999,171485152336453,171492329621013,171527417090959,171578907754450,171585636479447,171636355023767,171657720798495,171731501979705,171765676592113,171792326006534,171890165696371,171913750380681,171915661670427,171942598614374,171956329637964,172025923021094,172053385332171,172054034084443,172059736072237,172064317809279,172064430724048,172068869471833,172093626449018,172116149436929,172149572983099,172185174460576,172189797083481,172198277738707,172200717296612,172214993158568,172234219817704,172279192893330,172322944024015,172340863004835,172348549560556,172349611859436,172364524919578,172425886335388,172457539616472,172467682773487,172483364096916,172486989648691,172520852606215,172527788002802,172560479151954,172565828399721,172569827208636,172577941322737,172599428765881,172600023068525,172616930721264,172641521854430,172641814922248,172690760259904,172698555948600,172700287070412,172718657735553) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:51:04.570--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171173365830503,171223416651910,171261133972934,171265215303108,171303844014449,171316599371450,171342756293499,171363655888638,171371397304779,171406630416098,171413065435886,171438131285765,171454665061594,171460497047769,171506331731086,171524264940201,171525192652270,171579140640825,171593155523607,171645058320741,171692790906031,171739489035918,171830704505662,171856301562484,171863825769952,171930066340204,171948027828503,171977959870944,172041829439756,172042564003021,172052636722534,172057053415659,172087809031203,172107471234818,172167212123694,172179977547083,172206264806636,172223815267962,172243280911962,172276531460813,172319105275102,172413265138708,172414914883198,172443217962969,172459052707999,172468360601065,172476447436135,172485831702759,172495211539741,172503451778641,172509908701126,172511504428463,172535577298391,172569875159643,172603933932748,172606751352170,172646903565845,172659366811664,172699490025010,172726054273812,172742412477996,172821383532610,172823575116173,172828906236720) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171173365830503,171223416651910,171261133972934,171265215303108,171303844014449,171316599371450,171342756293499,171363655888638,171371397304779,171406630416098,171413065435886,171438131285765,171454665061594,171460497047769,171506331731086,171524264940201,171525192652270,171579140640825,171593155523607,171645058320741,171692790906031,171739489035918,171830704505662,171856301562484,171863825769952,171930066340204,171948027828503,171977959870944,172041829439756,172042564003021,172052636722534,172057053415659,172087809031203,172107471234818,172167212123694,172179977547083,172206264806636,172223815267962,172243280911962,172276531460813,172319105275102,172413265138708,172414914883198,172443217962969,172459052707999,172468360601065,172476447436135,172485831702759,172495211539741,172503451778641,172509908701126,172511504428463,172535577298391,172569875159643,172603933932748,172606751352170,172646903565845,172659366811664,172699490025010,172726054273812,172742412477996,172821383532610,172823575116173,172828906236720) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:51:22.764--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171195233954556,171294131840025,171368583541695,171429902324138,171448879611002,171471433761078,171492261203630,171493130764976,171515849573567,171528106257422,171625058157015,171635509867825,171647751601758,171649007428270,171654435583075,171665953679251,171688464281521,171730481285012,171749296262466,171783848601118,171784760090232,171800648249850,171810199324155,171853377090161,171904015125291,171917049683126,171990632056648,172053650665193,172072691032177,172129905619270,172136725069880,172166417700545,172174448767940,172180514757487,172202522997219,172246070065361,172250498432063,172260056298259,172281560664699,172301674416729,172310597971045,172353585929632,172361795270568,172393430267245,172396401613439,172408127273578,172452961503435,172457882534145,172510566160328,172530755705778,172540240898994,172574370923359,172595684935925,172616704955073,172630635901592,172655239001862,172678114686154,172681756155907,172682465658668,172710541190479,172733544086997,172776404594101) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171195233954556,171294131840025,171368583541695,171429902324138,171448879611002,171471433761078,171492261203630,171493130764976,171515849573567,171528106257422,171625058157015,171635509867825,171647751601758,171649007428270,171654435583075,171665953679251,171688464281521,171730481285012,171749296262466,171783848601118,171784760090232,171800648249850,171810199324155,171853377090161,171904015125291,171917049683126,171990632056648,172053650665193,172072691032177,172129905619270,172136725069880,172166417700545,172174448767940,172180514757487,172202522997219,172246070065361,172250498432063,172260056298259,172281560664699,172301674416729,172310597971045,172353585929632,172361795270568,172393430267245,172396401613439,172408127273578,172452961503435,172457882534145,172510566160328,172530755705778,172540240898994,172574370923359,172595684935925,172616704955073,172630635901592,172655239001862,172678114686154,172681756155907,172682465658668,172710541190479,172733544086997,172776404594101) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:51:41.138--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171199831838404,171239566299812,171265298152684,171298972464739,171299149238846,171336244112492,171336639279616,171368596344996,171415670914077,171415820314850,171428785677646,171429214501056,171498324652980,171506059911789,171525410731465,171551810268297,171552557407013,171576063703427,171595900365328,171615477983157,171670876993467,171693551869124,171812697928656,171813672222524,171817747454460,171827044974054,171834821190908,171880854436616,171883604912904,171889835115318,171955346500129,171968513157487,171990509416238,172012225560905,172036325498211,172091094418154,172131376262726,172155190148681,172155250757483,172157437306992,172214883077666,172223330308875,172278835187285,172307281440419,172341758135233,172365902839207,172379411571066,172379986541308,172400972254467,172407684655996,172418699951752,172444893894228,172477861259867,172521181432658,172527029725725,172547462242247,172556246451565,172570598570267,172572572932809,172588771364114,172612715808661,172725956777292,172744014563126,172802759981100) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171199831838404,171239566299812,171265298152684,171298972464739,171299149238846,171336244112492,171336639279616,171368596344996,171415670914077,171415820314850,171428785677646,171429214501056,171498324652980,171506059911789,171525410731465,171551810268297,171552557407013,171576063703427,171595900365328,171615477983157,171670876993467,171693551869124,171812697928656,171813672222524,171817747454460,171827044974054,171834821190908,171880854436616,171883604912904,171889835115318,171955346500129,171968513157487,171990509416238,172012225560905,172036325498211,172091094418154,172131376262726,172155190148681,172155250757483,172157437306992,172214883077666,172223330308875,172278835187285,172307281440419,172341758135233,172365902839207,172379411571066,172379986541308,172400972254467,172407684655996,172418699951752,172444893894228,172477861259867,172521181432658,172527029725725,172547462242247,172556246451565,172570598570267,172572572932809,172588771364114,172612715808661,172725956777292,172744014563126,172802759981100) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:51:59.816--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171205039401179,171277144255711,171282294056175,171294291247039,171295380314770,171300086477797,171316500112577,171368739588835,171401777769337,171411685517091,171455366999350,171456641511091,171460081916977,171464818855753,171466682401090,171550112116697,171561803437681,171587771719208,171614487563735,171631159467069,171632949925543,171637598359485,171666479813825,171689619997478,171765737679030,171807703799872,171855942454267,171924953421550,171942704710071,171973550807107,172021416795991,172034052303186,172038109717125,172043585676105,172067519442974,172149539937500,172159068728655,172258697090724,172279816903323,172292583114337,172293351461644,172305937381714,172320775334210,172349198465910,172354590810475,172361844810649,172364682277605,172379129053030,172434371005710,172448993554837,172470696937001,172483290380759,172496658485267,172538526811252,172570333524279,172587174237393,172591342454105,172626203330980,172643124506534,172708135575388,172709605684964,172719925825996,172758655617492,172768140327655) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171205039401179,171277144255711,171282294056175,171294291247039,171295380314770,171300086477797,171316500112577,171368739588835,171401777769337,171411685517091,171455366999350,171456641511091,171460081916977,171464818855753,171466682401090,171550112116697,171561803437681,171587771719208,171614487563735,171631159467069,171632949925543,171637598359485,171666479813825,171689619997478,171765737679030,171807703799872,171855942454267,171924953421550,171942704710071,171973550807107,172021416795991,172034052303186,172038109717125,172043585676105,172067519442974,172149539937500,172159068728655,172258697090724,172279816903323,172292583114337,172293351461644,172305937381714,172320775334210,172349198465910,172354590810475,172361844810649,172364682277605,172379129053030,172434371005710,172448993554837,172470696937001,172483290380759,172496658485267,172538526811252,172570333524279,172587174237393,172591342454105,172626203330980,172643124506534,172708135575388,172709605684964,172719925825996,172758655617492,172768140327655) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:52:19.070--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171171371140333,171173526694350,171248353855609,171252557289231,171274112533380,171368583737486,171432634148676,171459125538805,171506566003950,171516358496342,171570730195800,171601409015007,171610876552128,171615480710624,171673908630545,171687421089149,171713451504163,171776649941833,171810381696027,171826343948184,171889303916695,171900294945422,171916078111272,171941886873979,171990655943634,172002863723485,172064367718961,172078413661174,172081191864562,172096398763346,172103123931749,172129180314065,172190956649036,172216452508135,172254230505786,172277237972983,172284427834156,172286187169814,172302978839572,172346490397794,172406085738668,172417806395127,172422781928372,172492485687317,172521899388883,172531935146692,172583330066562,172591357367520,172595562051119,172633686910497,172650466203250,172663804415029,172711781282939,172717130243913,172733132467914,172768701596855,172786009731778,172811921168638,172836766954962) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171171371140333,171173526694350,171248353855609,171252557289231,171274112533380,171368583737486,171432634148676,171459125538805,171506566003950,171516358496342,171570730195800,171601409015007,171610876552128,171615480710624,171673908630545,171687421089149,171713451504163,171776649941833,171810381696027,171826343948184,171889303916695,171900294945422,171916078111272,171941886873979,171990655943634,172002863723485,172064367718961,172078413661174,172081191864562,172096398763346,172103123931749,172129180314065,172190956649036,172216452508135,172254230505786,172277237972983,172284427834156,172286187169814,172302978839572,172346490397794,172406085738668,172417806395127,172422781928372,172492485687317,172521899388883,172531935146692,172583330066562,172591357367520,172595562051119,172633686910497,172650466203250,172663804415029,172711781282939,172717130243913,172733132467914,172768701596855,172786009731778,172811921168638,172836766954962) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:52:36.828--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171389770367190,171412412882065,171464543966731,171485385107708,171498568904869,171509871397791,171542320728419,171571804736404,171606827940567,171636837425155,171649529334613,171662881349440,171683103783648,171831809476146,171835263006417,171848791970661,171906329356275,171909003348782,171920132583569,171934375684972,171959185647194,171960689195865,172021393464583,172046600670777,172051243646167,172106501111749,172146558290775,172154823387745,172191454855352,172219452062862,172219488032546,172230346707826,172234288056781,172306779247197,172313783274088,172330893525423,172340735346597,172341713261256,172349910480981,172353680250397,172358028700384,172397987076906,172406113677330,172432479458616,172457417990833,172477590187687,172484427297827,172511944048998,172522266440460,172571551225923,172587326735037,172605612257297,172611756150145,172614967176891,172638270637823,172647132605113,172694189164016,172725232545615,172759771827695,172777450712695,172820324235052,172836628666142,172849464752479) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171389770367190,171412412882065,171464543966731,171485385107708,171498568904869,171509871397791,171542320728419,171571804736404,171606827940567,171636837425155,171649529334613,171662881349440,171683103783648,171831809476146,171835263006417,171848791970661,171906329356275,171909003348782,171920132583569,171934375684972,171959185647194,171960689195865,172021393464583,172046600670777,172051243646167,172106501111749,172146558290775,172154823387745,172191454855352,172219452062862,172219488032546,172230346707826,172234288056781,172306779247197,172313783274088,172330893525423,172340735346597,172341713261256,172349910480981,172353680250397,172358028700384,172397987076906,172406113677330,172432479458616,172457417990833,172477590187687,172484427297827,172511944048998,172522266440460,172571551225923,172587326735037,172605612257297,172611756150145,172614967176891,172638270637823,172647132605113,172694189164016,172725232545615,172759771827695,172777450712695,172820324235052,172836628666142,172849464752479) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:52:54.759--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171169436929345,171183636929831,171188958717266,171247949409260,171261139826039,171309567112064,171311296394529,171333311513015,171369135202175,171407880146822,171420339374540,171465514571237,171480989331530,171485172375001,171497674485725,171514763539616,171560548199876,171596950876784,171648916996886,171681770804733,171683427984686,171719154016208,171731948322747,171765837877505,171780899051999,171800389043227,171813031613620,171840054948416,171861722548463,171864691971175,171878503707053,171888685843429,171927246441820,171999717686254,172012226741438,172013764745734,172081120469099,172131503735754,172158589789702,172207581391804,172232252768122,172251157241621,172331212297063,172336872816106,172356399343657,172363752430029,172387510781037,172413697038431,172423925414575,172427530503388,172477872131963,172490803210582,172535581000136,172548552386636,172580010437953,172586632329123,172664517035720,172698820226748,172719449861511,172728726500112,172729857109845,172746268239047,172811100042354,172816032664065) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171169436929345,171183636929831,171188958717266,171247949409260,171261139826039,171309567112064,171311296394529,171333311513015,171369135202175,171407880146822,171420339374540,171465514571237,171480989331530,171485172375001,171497674485725,171514763539616,171560548199876,171596950876784,171648916996886,171681770804733,171683427984686,171719154016208,171731948322747,171765837877505,171780899051999,171800389043227,171813031613620,171840054948416,171861722548463,171864691971175,171878503707053,171888685843429,171927246441820,171999717686254,172012226741438,172013764745734,172081120469099,172131503735754,172158589789702,172207581391804,172232252768122,172251157241621,172331212297063,172336872816106,172356399343657,172363752430029,172387510781037,172413697038431,172423925414575,172427530503388,172477872131963,172490803210582,172535581000136,172548552386636,172580010437953,172586632329123,172664517035720,172698820226748,172719449861511,172728726500112,172729857109845,172746268239047,172811100042354,172816032664065) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:53:11.718--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171204710802739,171273616675325,171299157060525,171303141720285,171342441972750,171354504317656,171368592689460,171414819199019,171428887339811,171430517589386,171465996326356,171493259999479,171502234705783,171526730507649,171579890616582,171619548899599,171632000338886,171740839004835,171759580203164,171765663964796,171804293752095,171843001251664,171852238266518,171860347043752,171864032753587,171869000738649,171884030651531,171938786504501,171941972801358,171954470707257,171965230340972,171975364885573,171977891278938,171981084480189,171981816249557,172052078646178,172059063849929,172076455487104,172108567406077,172110947700702,172112016878238,172129677944036,172146751784879,172172336725479,172208234130138,172219410116761,172262282797324,172289392542278,172302290604873,172393349352798,172407710862987,172475428727269,172483356527938,172522301061629,172534161086403,172534537376137,172565491063864,172646493150426,172665800281895,172668456441406,172727787471295,172768199233512,172784689014860,172828580487419) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171204710802739,171273616675325,171299157060525,171303141720285,171342441972750,171354504317656,171368592689460,171414819199019,171428887339811,171430517589386,171465996326356,171493259999479,171502234705783,171526730507649,171579890616582,171619548899599,171632000338886,171740839004835,171759580203164,171765663964796,171804293752095,171843001251664,171852238266518,171860347043752,171864032753587,171869000738649,171884030651531,171938786504501,171941972801358,171954470707257,171965230340972,171975364885573,171977891278938,171981084480189,171981816249557,172052078646178,172059063849929,172076455487104,172108567406077,172110947700702,172112016878238,172129677944036,172146751784879,172172336725479,172208234130138,172219410116761,172262282797324,172289392542278,172302290604873,172393349352798,172407710862987,172475428727269,172483356527938,172522301061629,172534161086403,172534537376137,172565491063864,172646493150426,172665800281895,172668456441406,172727787471295,172768199233512,172784689014860,172828580487419) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:53:29.116--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171011823707705,171221711631112,171264095977661,171273553120039,171342397583302,171368031705328,171368311627961,171368581857312,171369765596143,171378878577030,171436892979759,171489797117504,171500567159172,171615480899895,171654054777039,171662708261510,171662995943936,171687958414379,171795955805632,171817852590694,171822613195559,171830750340519,171879292328244,171889750715138,171891024049432,171916812738423,172012386634802,172102108753640,172140396841416,172157045653836,172177070931674,172183526355806,172227030462234,172236660516097,172241455288619,172268138026109,172289885266208,172306074530117,172338143661963,172388819338005,172400902353722,172413737401515,172443253901531,172444326117507,172449208816884,172466907256079,172534527127455,172534756842580,172538084421481,172554796610201,172617804838519,172634646695639,172659852176574,172672729533876,172673210229246,172673604337134,172743273378094,172759453553975,172764035751970,172790433761504,172840756013333,172846260679809) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171011823707705,171221711631112,171264095977661,171273553120039,171342397583302,171368031705328,171368311627961,171368581857312,171369765596143,171378878577030,171436892979759,171489797117504,171500567159172,171615480899895,171654054777039,171662708261510,171662995943936,171687958414379,171795955805632,171817852590694,171822613195559,171830750340519,171879292328244,171889750715138,171891024049432,171916812738423,172012386634802,172102108753640,172140396841416,172157045653836,172177070931674,172183526355806,172227030462234,172236660516097,172241455288619,172268138026109,172289885266208,172306074530117,172338143661963,172388819338005,172400902353722,172413737401515,172443253901531,172444326117507,172449208816884,172466907256079,172534527127455,172534756842580,172538084421481,172554796610201,172617804838519,172634646695639,172659852176574,172672729533876,172673210229246,172673604337134,172743273378094,172759453553975,172764035751970,172790433761504,172840756013333,172846260679809) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:53:47.001--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171217118110531,171260036010872,171286716417631,171320741457548,171343860596091,171345576627693,171355491459084,171360809915094,171368739322092,171393372450124,171422842715878,171433620460338,171454257804839,171462744946358,171485144766739,171485149323757,171532741586884,171546089551891,171550761346435,171558461248521,171566892984885,171671900773564,171678722073926,171699608763114,171706004981491,171743768138719,171786744949815,171788083960590,171817559316576,171821723643253,171863231919898,171865410177751,171900065420447,171925925007656,171960168126958,172025422393449,172054031090684,172227246214875,172259298502696,172304575395285,172305021118997,172305524476254,172328424250258,172363926926804,172417702412809,172432695421080,172435786115924,172511401621465,172530755801906,172544207115627,172582823214864,172586466047702,172590719549732,172595599982008,172621677076603,172632250382116,172642813514560,172647036352684,172649973812010,172690204918862,172710667765916,172751141341306,172797285944712,172833887581878) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171217118110531,171260036010872,171286716417631,171320741457548,171343860596091,171345576627693,171355491459084,171360809915094,171368739322092,171393372450124,171422842715878,171433620460338,171454257804839,171462744946358,171485144766739,171485149323757,171532741586884,171546089551891,171550761346435,171558461248521,171566892984885,171671900773564,171678722073926,171699608763114,171706004981491,171743768138719,171786744949815,171788083960590,171817559316576,171821723643253,171863231919898,171865410177751,171900065420447,171925925007656,171960168126958,172025422393449,172054031090684,172227246214875,172259298502696,172304575395285,172305021118997,172305524476254,172328424250258,172363926926804,172417702412809,172432695421080,172435786115924,172511401621465,172530755801906,172544207115627,172582823214864,172586466047702,172590719549732,172595599982008,172621677076603,172632250382116,172642813514560,172647036352684,172649973812010,172690204918862,172710667765916,172751141341306,172797285944712,172833887581878) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:54:05.190--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171178707947856,171204389607928,171226304447715,171268671099932,171317601227819,171338519421948,171351299156864,171355244328286,171364098172590,171489117529807,171526518381815,171622697176210,171638619364160,171650303581800,171674614569752,171691866395338,171714344316329,171722516729473,171774880734581,171820786643350,171826141803623,171830833312982,171835835521148,171888815108209,171895023267796,171913502223944,171993511214456,172042329045109,172042773436599,172085629077018,172091076962074,172091094073783,172100149372085,172158784076300,172159607853246,172163165078650,172165317041964,172173237510259,172173341577496,172189300154251,172199106930311,172217960410028,172232452624275,172246982948158,172255248180134,172295135253589,172319032144080,172349249778641,172358468013385,172371224869811,172374880440160,172383030304392,172426271422843,172427365682363,172440465349324,172448164674203,172539579124097,172586861277159,172590370343102,172591118815197,172597856535376,172643488521705,172661830314989,172668455967090) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171178707947856,171204389607928,171226304447715,171268671099932,171317601227819,171338519421948,171351299156864,171355244328286,171364098172590,171489117529807,171526518381815,171622697176210,171638619364160,171650303581800,171674614569752,171691866395338,171714344316329,171722516729473,171774880734581,171820786643350,171826141803623,171830833312982,171835835521148,171888815108209,171895023267796,171913502223944,171993511214456,172042329045109,172042773436599,172085629077018,172091076962074,172091094073783,172100149372085,172158784076300,172159607853246,172163165078650,172165317041964,172173237510259,172173341577496,172189300154251,172199106930311,172217960410028,172232452624275,172246982948158,172255248180134,172295135253589,172319032144080,172349249778641,172358468013385,172371224869811,172374880440160,172383030304392,172426271422843,172427365682363,172440465349324,172448164674203,172539579124097,172586861277159,172590370343102,172591118815197,172597856535376,172643488521705,172661830314989,172668455967090) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:54:22.843--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171169559025570,171214025410566,171283909824346,171307488482606,171449524640421,171450550899612,171535593826266,171602096435598,171609629577209,171610469497850,171674793286712,171775773637328,171807673161132,171817382755197,171817781691102,171821887789097,171887127432289,171915962181131,171967736762897,172011796340815,172041771071503,172050323211491,172060758847549,172080050100617,172085293107399,172091076920956,172102577954750,172102697858088,172181701662337,172232168699028,172267822751957,172279544255333,172280214094549,172284101221261,172284336970558,172284690479301,172293247928079,172332140861959,172388473686391,172390691460982,172414784684560,172417896384714,172444385746956,172457654491080,172474456856190,172478520332110,172482462649400,172527433823641,172599134048020,172622139395313,172668456010633,172669203691170,172676162861732,172707620437396,172710762550244,172710818308920,172736204098442,172780177274490,172788099445366,172795704723921,172798187051625,172846965254905) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171169559025570,171214025410566,171283909824346,171307488482606,171449524640421,171450550899612,171535593826266,171602096435598,171609629577209,171610469497850,171674793286712,171775773637328,171807673161132,171817382755197,171817781691102,171821887789097,171887127432289,171915962181131,171967736762897,172011796340815,172041771071503,172050323211491,172060758847549,172080050100617,172085293107399,172091076920956,172102577954750,172102697858088,172181701662337,172232168699028,172267822751957,172279544255333,172280214094549,172284101221261,172284336970558,172284690479301,172293247928079,172332140861959,172388473686391,172390691460982,172414784684560,172417896384714,172444385746956,172457654491080,172474456856190,172478520332110,172482462649400,172527433823641,172599134048020,172622139395313,172668456010633,172669203691170,172676162861732,172707620437396,172710762550244,172710818308920,172736204098442,172780177274490,172788099445366,172795704723921,172798187051625,172846965254905) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:54:40.232--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171239760010793,171265655397228,171273625558079,171294729664525,171346553976244,171437756528033,171465198356111,171476375310466,171481214045032,171522187242344,171528307108631,171576314970844,171593781405913,171622990819385,171683725722643,171683908553043,171757881819313,171759799766862,171768385663194,171809852001911,171891155376872,171905559053407,171940648698645,171950166573022,171974060228538,172021411965280,172036768268709,172047046629909,172064249384718,172155714653002,172172058643979,172190124317802,172229021662857,172273273760845,172283920164505,172295727112130,172296075074683,172303090013925,172338923140870,172356367255235,172396540200671,172520672927802,172529191244200,172548515292439,172562343453140,172582054652474,172600093308332,172641566744180,172655722074501,172663926555581,172682732883020,172710226791867,172759590896912,172768770299378,172782310536305,172785508201265,172794147910351,172794276157358,172829049973716,172841943626339,172854183809197) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171239760010793,171265655397228,171273625558079,171294729664525,171346553976244,171437756528033,171465198356111,171476375310466,171481214045032,171522187242344,171528307108631,171576314970844,171593781405913,171622990819385,171683725722643,171683908553043,171757881819313,171759799766862,171768385663194,171809852001911,171891155376872,171905559053407,171940648698645,171950166573022,171974060228538,172021411965280,172036768268709,172047046629909,172064249384718,172155714653002,172172058643979,172190124317802,172229021662857,172273273760845,172283920164505,172295727112130,172296075074683,172303090013925,172338923140870,172356367255235,172396540200671,172520672927802,172529191244200,172548515292439,172562343453140,172582054652474,172600093308332,172641566744180,172655722074501,172663926555581,172682732883020,172710226791867,172759590896912,172768770299378,172782310536305,172785508201265,172794147910351,172794276157358,172829049973716,172841943626339,172854183809197) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:54:55.832--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172784043276263,172802848090454,172803761001211,172822441696686) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172784043276263,172802848090454,172803761001211,172822441696686) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:55:09.897--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172796679740081) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172796679740081) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:55:23.707--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172786482751274,172787546837193,172804173928495) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172786482751274,172787546837193,172804173928495) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:55:37.400--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172793997371499,172796810137633,172828654489267) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172793997371499,172796810137633,172828654489267) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:55:51.680--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172830447288429) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172830447288429) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:56:09.250--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172787509549940,172787530842799,172802611130294,172803449345768) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172787509549940,172787530842799,172802611130294,172803449345768) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:56:22.698--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172812268949612) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172812268949612) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:56:36.243--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172803552746235) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172803552746235) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:56:50.879--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172797637337237,172804793766684,172811528069573,172812584281022,172814673805564) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172797637337237,172804793766684,172811528069573,172812584281022,172814673805564) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:57:05.407--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172794056389410,172803500239884,172804933732383) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172794056389410,172803500239884,172804933732383) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:57:19.027--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172794657253664,172829146721775) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172794657253664,172829146721775) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:57:32.600--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172811730581434) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172811730581434) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:57:46.162--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172788655319384,172795483047281,172828957602113) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172788655319384,172795483047281,172828957602113) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:58:01.093--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172803239790453,172805012827755,172805833110346,172813950282171,172842473131818) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172803239790453,172805012827755,172805833110346,172813950282171,172842473131818) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:58:15.108--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172837768051108,172842139796032) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172837768051108,172842139796032) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:58:28.851--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172787588642409,172811564308780,172829386411244,172839756489235) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172787588642409,172811564308780,172829386411244,172839756489235) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:58:42.896--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172838045196772,172838719070620) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172838045196772,172838719070620) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:58:57.036--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171376970690861,172838983171173) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171376970690861,172838983171173) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:59:11.425--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172788233057168,172795527277984,172798166861073,172804053936670,172810896463166,172811702876250,172829041104584) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172788233057168,172795527277984,172798166861073,172804053936670,172810896463166,172811702876250,172829041104584) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:59:25.225--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172806130983969,172806323790254,172813219588171,172813964123730,172831643527651,172838302038958) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172806130983969,172806323790254,172813219588171,172813964123730,172831643527651,172838302038958) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:59:38.965--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172797856773731,172829320096115,172830116374732,172837310902147) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172797856773731,172829320096115,172830116374732,172837310902147) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 11:59:58.298--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172802958755116,172804016499809,172806663697597,172820854463140,172829118097737,172829377633375) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172802958755116,172804016499809,172806663697597,172820854463140,172829118097737,172829377633375) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:00:13.708--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172812347184532,172814891457978,172821054259833) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172812347184532,172814891457978,172821054259833) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:00:28.622--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172787568733676,172837684458758) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172787568733676,172837684458758) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:00:42.197--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172795517656214,172796873711849) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172795517656214,172796873711849) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:00:55.949--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172838554434264) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172838554434264) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:02:07.088--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172789885439990,172815598287719) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172789885439990,172815598287719) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:02:24.162--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172788399850962,172795507849447,172806505345735,172808814041550,172829259642054,172829317531306) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172788399850962,172795507849447,172806505345735,172808814041550,172829259642054,172829317531306) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:02:39.899--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172802194267234,172828638568136) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172802194267234,172828638568136) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:02:53.831--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172806907078509,172812324863008,172812987357754,172820582075231) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172806907078509,172812324863008,172812987357754,172820582075231) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:03:07.527--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172786586716743,172828509315664) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172786586716743,172828509315664) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:03:26.432--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172786449105729,172786759128620) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172786449105729,172786759128620) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:03:40.310--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172796793523475,172802531368345,172829007715914) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172796793523475,172802531368345,172829007715914) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:03:54.326--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172815512352817,172816727053827,172841891776509) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172815512352817,172816727053827,172841891776509) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:04:07.932--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172820737945523,172837043883562) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172820737945523,172837043883562) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:04:22.089--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172821941079512) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172821941079512) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:04:35.950--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172798485554653,172802847448011) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172798485554653,172802847448011) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:04:49.441--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172796759900597,172857549628427) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172796759900597,172857549628427) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:05:03.158--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172795164823693,172797067288883) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172795164823693,172797067288883) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:05:16.775--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172796861357512,172797733805499,172803279152720) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172796861357512,172797733805499,172803279152720) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:05:30.726--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172787573181249,172788337692195,172814536088733,172841543586503) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172787573181249,172788337692195,172814536088733,172841543586503) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:05:44.948--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172803232726858,172837159612657) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172803232726858,172837159612657) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:05:58.284--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172799923743837,172826045152592) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172799923743837,172826045152592) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:06:40.980--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172103900004893,172106013381913,172116688956532,172125590853952,172254021914765,172340344214993,172344543792177,172345121866454,172353051978756,172381009900396,172427176936989,172444243656443,172448898593596,172467622279397,172500664028017,172510714681984,172512413752593,172534629849915,172569898571896,172623355187492,172624481040693,172641229707135,172672097475161,172717574587940,172764265282217,172776271800529,172848384346052) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172103900004893,172106013381913,172116688956532,172125590853952,172254021914765,172340344214993,172344543792177,172345121866454,172353051978756,172381009900396,172427176936989,172444243656443,172448898593596,172467622279397,172500664028017,172510714681984,172512413752593,172534629849915,172569898571896,172623355187492,172624481040693,172641229707135,172672097475161,172717574587940,172764265282217,172776271800529,172848384346052) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:06:56.490--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172102818828079,172185346569838,172199384278901,172250620999028,172284815640739,172318648156428,172319634601183,172325208446105,172347643073372,172419218689563,172434862664441,172440510114647,172464708016777,172491824778064,172492247552976,172506546604610,172530784418731,172534643267566,172553296885527,172553408796805,172591259644004,172595784741878,172604316788599,172677306344752,172726496532118,172824673379838,172846076082340,172848325808158) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172102818828079,172185346569838,172199384278901,172250620999028,172284815640739,172318648156428,172319634601183,172325208446105,172347643073372,172419218689563,172434862664441,172440510114647,172464708016777,172491824778064,172492247552976,172506546604610,172530784418731,172534643267566,172553296885527,172553408796805,172591259644004,172595784741878,172604316788599,172677306344752,172726496532118,172824673379838,172846076082340,172848325808158) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:07:11.936--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172095738401524,172106025890851,172115080606631,172137732468245,172139118164014,172299804721525,172311614766161,172345536107295,172362841182476,172448446010190,172527107090669,172529345739041,172543073975629,172552892881404,172564915719015,172692134030822,172803677376977,172805214074864,172807180734792) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172095738401524,172106025890851,172115080606631,172137732468245,172139118164014,172299804721525,172311614766161,172345536107295,172362841182476,172448446010190,172527107090669,172529345739041,172543073975629,172552892881404,172564915719015,172692134030822,172803677376977,172805214074864,172807180734792) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:07:27.664--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172085582877211,172103237644233,172113946470964,172116468664984,172120521074196,172137803199515,172148451928389,172184692598028,172193444030351,172223580036733,172230473443292,172240928276760,172262257913017,172268791896304,172347351613523,172349637134603,172357142849428,172371704619877,172379565675714,172461542395706,172485852824772,172495479471719,172543883990312,172564898990717,172586675460261,172590629925581,172767952647993,172789264112719,172824252108140,172837123926841) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172085582877211,172103237644233,172113946470964,172116468664984,172120521074196,172137803199515,172148451928389,172184692598028,172193444030351,172223580036733,172230473443292,172240928276760,172262257913017,172268791896304,172347351613523,172349637134603,172357142849428,172371704619877,172379565675714,172461542395706,172485852824772,172495479471719,172543883990312,172564898990717,172586675460261,172590629925581,172767952647993,172789264112719,172824252108140,172837123926841) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:07:42.763--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171860751188098,172124811094576,172125158462153,172138362783441,172142344972567,172183250171745,172259773907011,172292197148624,172348065308271,172415034877526,172417574561852,172465980215474,172466848346727,172494696010586,172509507903257,172534681876071,172536728047190,172542536799347,172569994276036,172571132874859,172730016970833,172735708509812,172820878807266,172823394124561) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171860751188098,172124811094576,172125158462153,172138362783441,172142344972567,172183250171745,172259773907011,172292197148624,172348065308271,172415034877526,172417574561852,172465980215474,172466848346727,172494696010586,172509507903257,172534681876071,172536728047190,172542536799347,172569994276036,172571132874859,172730016970833,172735708509812,172820878807266,172823394124561) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:07:58.235--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172183673702204,172184692524717,172197821191819,172292962838476,172336729550524,172354439425729,172358567258133,172369891140339,172372540060139,172414528504292,172422944865157,172433225440980,172435725109449,172453884358976,172474197085428,172486455499184,172500807183709,172534567228786,172553319230071,172624516935944,172641967187380,172703159557304,172734302437622,172743339221689,172791747541903,172802019031756,172820414306687) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172183673702204,172184692524717,172197821191819,172292962838476,172336729550524,172354439425729,172358567258133,172369891140339,172372540060139,172414528504292,172422944865157,172433225440980,172435725109449,172453884358976,172474197085428,172486455499184,172500807183709,172534567228786,172553319230071,172624516935944,172641967187380,172703159557304,172734302437622,172743339221689,172791747541903,172802019031756,172820414306687) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:08:12.785--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172149961417459,172232895897170,172406483499248,172431916398559,172451732339235,172480083807843,172500922392692,172522177924682,172534152314505,172537660654284,172562897402039,172607596286971,172613027970259,172617074731309,172717596054410,172820179520974,172834561671257) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172149961417459,172232895897170,172406483499248,172431916398559,172451732339235,172480083807843,172500922392692,172522177924682,172534152314505,172537660654284,172562897402039,172607596286971,172613027970259,172617074731309,172717596054410,172820179520974,172834561671257) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:08:30.370--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171178699146820,171197003409185,171248276055038,171249456543915,171277319050091,171338169513745,171397415091865,171476360537982,171499784252267,171511769752291,171517763093673,171526966998393,171568734061592,171674116156115,171688701038579,171708827858532,171740938159826,171741512316049,171786563031923,171803303378141,171804353002273,171844973050457,171910664866666,171912861810946,172012077410334,172045579391236,172123756808947,172155788758934,172189504592450,172203876658927,172273714022223,172327632783399,172355382416026,172355602170931,172362122350298,172379581033836,172418442094335,172469849811463,172509906168755,172527985445185,172534710333969,172551883655904,172555589532382,172597295162334,172607670430617,172630224564311,172640531929882,172703061917079,172716616576662,172726919830201,172728013298480,172786774675412,172815875236633,172822938147755,172829634467579,172833093439884,172837173152621) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171178699146820,171197003409185,171248276055038,171249456543915,171277319050091,171338169513745,171397415091865,171476360537982,171499784252267,171511769752291,171517763093673,171526966998393,171568734061592,171674116156115,171688701038579,171708827858532,171740938159826,171741512316049,171786563031923,171803303378141,171804353002273,171844973050457,171910664866666,171912861810946,172012077410334,172045579391236,172123756808947,172155788758934,172189504592450,172203876658927,172273714022223,172327632783399,172355382416026,172355602170931,172362122350298,172379581033836,172418442094335,172469849811463,172509906168755,172527985445185,172534710333969,172551883655904,172555589532382,172597295162334,172607670430617,172630224564311,172640531929882,172703061917079,172716616576662,172726919830201,172728013298480,172786774675412,172815875236633,172822938147755,172829634467579,172833093439884,172837173152621) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:08:48.623--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171264767058055,171325182738527,171335783958157,171372325388211,171381606828398,171420731989251,171433151553187,171477034841533,171481348892805,171498996941016,171509516199885,171523305599864,171647009410137,171665585997211,171715675118284,171734322940343,171735085784172,171749516732415,171773256323041,171788649566236,171852121914314,171943097668822,172045579315307,172077340426754,172079269003411,172110383024086,172192635694581,172224351109232,172227569162138,172268941464571,172364350614273,172425538331710,172450109799736,172491220461320,172493702134879,172522898076614,172534812956220,172546974073947,172616039030734,172621493207472,172625631164435,172660133240800,172667965231295,172710610686789,172728867152100,172787959742836,172805668734845,172849599917057) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171264767058055,171325182738527,171335783958157,171372325388211,171381606828398,171420731989251,171433151553187,171477034841533,171481348892805,171498996941016,171509516199885,171523305599864,171647009410137,171665585997211,171715675118284,171734322940343,171735085784172,171749516732415,171773256323041,171788649566236,171852121914314,171943097668822,172045579315307,172077340426754,172079269003411,172110383024086,172192635694581,172224351109232,172227569162138,172268941464571,172364350614273,172425538331710,172450109799736,172491220461320,172493702134879,172522898076614,172534812956220,172546974073947,172616039030734,172621493207472,172625631164435,172660133240800,172667965231295,172710610686789,172728867152100,172787959742836,172805668734845,172849599917057) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:09:07.177--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171169170244251,171205468214270,171247951485108,171261095459992,171274039123449,171314492960475,171398913789949,171475273181781,171497852608636,171523688809157,171529982527633,171553177724053,171561254933217,171603535850265,171638338404092,171640083017053,171714424641171,171714425328346,171725888555399,171743154923824,171748071986329,171770084109605,171782919512589,171810374375940,171853713273698,171870459262702,171988883992331,172000250976741,172008083524557,172010619409537,172016625929029,172114488586050,172120020889448,172141786056170,172167198309846,172260698955647,172276499684471,172337366686849,172436110973180,172446610679846,172452120948245,172456753063811,172456753121428,172473376378385,172474577558124,172491913797194,172500899207539,172565193672609,172578756569116,172579651742335,172612075614225,172622614579364,172624786936080,172638550015988,172653495865717,172674871019904,172735168451268,172753470707517,172760908546758,172763748645308) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171169170244251,171205468214270,171247951485108,171261095459992,171274039123449,171314492960475,171398913789949,171475273181781,171497852608636,171523688809157,171529982527633,171553177724053,171561254933217,171603535850265,171638338404092,171640083017053,171714424641171,171714425328346,171725888555399,171743154923824,171748071986329,171770084109605,171782919512589,171810374375940,171853713273698,171870459262702,171988883992331,172000250976741,172008083524557,172010619409537,172016625929029,172114488586050,172120020889448,172141786056170,172167198309846,172260698955647,172276499684471,172337366686849,172436110973180,172446610679846,172452120948245,172456753063811,172456753121428,172473376378385,172474577558124,172491913797194,172500899207539,172565193672609,172578756569116,172579651742335,172612075614225,172622614579364,172624786936080,172638550015988,172653495865717,172674871019904,172735168451268,172753470707517,172760908546758,172763748645308) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:09:24.477--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171178531901288,171268655635961,171276352430044,171334018766829,171362630235876,171371337689697,171395123049760,171419749762720,171422865376980,171438537447184,171481083360659,171550608494990,171586663008327,171631335537791,171645503154357,171696851842809,171697082074614,171732728985506,171788274856097,171830858669045,171847056459701,171854479321040,171861307212732,171922405061791,171930526133198,171954092926642,172059246873938,172068056660070,172068590545257,172165737556069,172201509100023,172338939081753,172365262277739,172380711116926,172520292624362,172522132602612,172534329900551,172542029545174,172570223867055,172574483729653,172631301256726,172745650955559,172755981445470,172761826016177,172776533958172,172810423753679,172828612808602) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171178531901288,171268655635961,171276352430044,171334018766829,171362630235876,171371337689697,171395123049760,171419749762720,171422865376980,171438537447184,171481083360659,171550608494990,171586663008327,171631335537791,171645503154357,171696851842809,171697082074614,171732728985506,171788274856097,171830858669045,171847056459701,171854479321040,171861307212732,171922405061791,171930526133198,171954092926642,172059246873938,172068056660070,172068590545257,172165737556069,172201509100023,172338939081753,172365262277739,172380711116926,172520292624362,172522132602612,172534329900551,172542029545174,172570223867055,172574483729653,172631301256726,172745650955559,172755981445470,172761826016177,172776533958172,172810423753679,172828612808602) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:09:41.430--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171241644993942,171290233777601,171291013237504,171335946612397,171351536630498,171371208993287,171431351745375,171504570289050,171548838450319,171612244603284,171658639751112,171688839864733,171698272462142,171710372036413,171734317186582,171817539714351,171818214622033,171879025289187,171892353621641,171912857295375,171952482151398,172077397157056,172151775940444,172165425726360,172226467120029,172231496550731,172241495303330,172293960727743,172391246419803,172432486160015,172474090651144,172518527962412,172522274282558,172620349333673,172719308062241,172759601022559,172769832513366,172785136425209,172811367976428) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171241644993942,171290233777601,171291013237504,171335946612397,171351536630498,171371208993287,171431351745375,171504570289050,171548838450319,171612244603284,171658639751112,171688839864733,171698272462142,171710372036413,171734317186582,171817539714351,171818214622033,171879025289187,171892353621641,171912857295375,171952482151398,172077397157056,172151775940444,172165425726360,172226467120029,172231496550731,172241495303330,172293960727743,172391246419803,172432486160015,172474090651144,172518527962412,172522274282558,172620349333673,172719308062241,172759601022559,172769832513366,172785136425209,172811367976428) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:09:57.555--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171189902527232,171190543023267,171202226001155,171224026234324,171249024141172,171256689932643,171302075827826,171394841629046,171424199145418,171437451957466,171461684002150,171471363766639,171472309467172,171527444301876,171637948030080,171649159663203,171732519739285,171804877653973,171857874053061,171900967767896,171923986989606,172292491505377,172332309321186,172465954285927,172468432985740,172488583396648,172566430406550,172595023789596,172607303163160,172608197112500,172686117005972,172706624605891,172741694335850,172787749584573,172814746510096,172816187426250,172838067345035) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171189902527232,171190543023267,171202226001155,171224026234324,171249024141172,171256689932643,171302075827826,171394841629046,171424199145418,171437451957466,171461684002150,171471363766639,171472309467172,171527444301876,171637948030080,171649159663203,171732519739285,171804877653973,171857874053061,171900967767896,171923986989606,172292491505377,172332309321186,172465954285927,172468432985740,172488583396648,172566430406550,172595023789596,172607303163160,172608197112500,172686117005972,172706624605891,172741694335850,172787749584573,172814746510096,172816187426250,172838067345035) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:10:14.581--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171182409937747,171183481422093,171343417880738,171351789329620,171423911591612,171458522864375,171510888318846,171606210576839,171733509783016,171752015062976,171752681640207,171770211303440,171776742579981,171796578747572,171844357926961,171861264215027,171861289937347,171877388209683,171962905460358,171964133170812,172047293869362,172058779210939,172071856625701,172103512800066,172115582942415,172120420963880,172149278388584,172158431239902,172192491367905,172192552600647,172219337282226,172295689435754,172310990506224,172350200537426,172355391414806,172397185670454,172399459536525,172435287244934,172442412706063,172526709563078,172546423471554,172569224930344,172571321890927,172617856571080,172650525326321,172682098842301,172693456698571,172707748465195,172745659627380,172778459693721) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171182409937747,171183481422093,171343417880738,171351789329620,171423911591612,171458522864375,171510888318846,171606210576839,171733509783016,171752015062976,171752681640207,171770211303440,171776742579981,171796578747572,171844357926961,171861264215027,171861289937347,171877388209683,171962905460358,171964133170812,172047293869362,172058779210939,172071856625701,172103512800066,172115582942415,172120420963880,172149278388584,172158431239902,172192491367905,172192552600647,172219337282226,172295689435754,172310990506224,172350200537426,172355391414806,172397185670454,172399459536525,172435287244934,172442412706063,172526709563078,172546423471554,172569224930344,172571321890927,172617856571080,172650525326321,172682098842301,172693456698571,172707748465195,172745659627380,172778459693721) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:10:31.536--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171241449592460,171247243194075,171251859817086,171256557461876,171264758142208,171295245656935,171316428366228,171350760214459,171402055926554,171494194756859,171536758418299,171580441050126,171621175216048,171629931632148,171671782196421,171674404016907,171684237284209,171702400512082,171732649845102,171739571023498,171752941425631,171769646632121,171827191809607,171852121777040,171889564554277,171949775314212,172003411854108,172062410757332,172125253780955,172133142124562,172181863654528,172295677073896,172355985907300,172379188404494,172491602014377,172494477948406,172643264517843,172693526305363,172721237103897,172729163102832,172742433076558,172768291149205,172819815012351,172831293275898,172840740850913,172842180589568) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171241449592460,171247243194075,171251859817086,171256557461876,171264758142208,171295245656935,171316428366228,171350760214459,171402055926554,171494194756859,171536758418299,171580441050126,171621175216048,171629931632148,171671782196421,171674404016907,171684237284209,171702400512082,171732649845102,171739571023498,171752941425631,171769646632121,171827191809607,171852121777040,171889564554277,171949775314212,172003411854108,172062410757332,172125253780955,172133142124562,172181863654528,172295677073896,172355985907300,172379188404494,172491602014377,172494477948406,172643264517843,172693526305363,172721237103897,172729163102832,172742433076558,172768291149205,172819815012351,172831293275898,172840740850913,172842180589568) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:10:48.525--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171190963673486,171245335010995,171259359437628,171394140398602,171431362021875,171434494091513,171442231658480,171483059458047,171523267555665,171534995239507,171558292383157,171580128753723,171580734864162,171590162201096,171691903987306,171710847435219,171726587827038,171779924217539,171896946455680,171923938380134,171956527529788,171960653222959,172007995727919,172034741405056,172047631106758,172054115176057,172060946402195,172076919068411,172127995826028,172367362011725,172388318570896,172415608967719,172656530474262,172668362278410,172673496143948,172702552758358,172703471072277,172717075965485,172760499021212,172762632965483,172769387978703,172795166537893) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171190963673486,171245335010995,171259359437628,171394140398602,171431362021875,171434494091513,171442231658480,171483059458047,171523267555665,171534995239507,171558292383157,171580128753723,171580734864162,171590162201096,171691903987306,171710847435219,171726587827038,171779924217539,171896946455680,171923938380134,171956527529788,171960653222959,172007995727919,172034741405056,172047631106758,172054115176057,172060946402195,172076919068411,172127995826028,172367362011725,172388318570896,172415608967719,172656530474262,172668362278410,172673496143948,172702552758358,172703471072277,172717075965485,172760499021212,172762632965483,172769387978703,172795166537893) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:11:05.964--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171253083697076,171273463274369,171428756531076,171429392647208,171462884908432,171473556087274,171477120813081,171519579551742,171528747258786,171594228264651,171656196689977,171680563991595,171706373454620,171714640779126,171811036333430,171817648963550,171861099588208,171864181170205,171869818632482,171896406788665,172044229294180,172099394547392,172119430306893,172127765538849,172138870056595,172141926360826,172159111804975,172184916901300,172190420745548,172232729269283,172302321546247,172354207990956,172425204803312,172426210565256,172433761784328,172467367383093,172477711725596,172477955117240,172512095819368,172518049662923,172551261518095,172578397716130,172781120222471,172795517408208,172823203710496) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171253083697076,171273463274369,171428756531076,171429392647208,171462884908432,171473556087274,171477120813081,171519579551742,171528747258786,171594228264651,171656196689977,171680563991595,171706373454620,171714640779126,171811036333430,171817648963550,171861099588208,171864181170205,171869818632482,171896406788665,172044229294180,172099394547392,172119430306893,172127765538849,172138870056595,172141926360826,172159111804975,172184916901300,172190420745548,172232729269283,172302321546247,172354207990956,172425204803312,172426210565256,172433761784328,172467367383093,172477711725596,172477955117240,172512095819368,172518049662923,172551261518095,172578397716130,172781120222471,172795517408208,172823203710496) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:11:23.174--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171172838260168,171251224227596,171256681191020,171294873816505,171299250571673,171352957842509,171377420734481,171437007393160,171438762399512,171449404115314,171456749613407,171488065515113,171489698067245,171492710597193,171498523528512,171509967494748,171551665193393,171594205542368,171601649060118,171614796622327,171623007297917,171665258478942,171731222992513,171765916016907,171915242963133,171989244012631,172050563051284,172077830706411,172167088971609,172226796704275,172261494445338,172277548874003,172278170785744,172409311921566,172452999057677,172536672100906,172674001010799,172699059337928,172699592656380,172778190728249) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171172838260168,171251224227596,171256681191020,171294873816505,171299250571673,171352957842509,171377420734481,171437007393160,171438762399512,171449404115314,171456749613407,171488065515113,171489698067245,171492710597193,171498523528512,171509967494748,171551665193393,171594205542368,171601649060118,171614796622327,171623007297917,171665258478942,171731222992513,171765916016907,171915242963133,171989244012631,172050563051284,172077830706411,172167088971609,172226796704275,172261494445338,172277548874003,172278170785744,172409311921566,172452999057677,172536672100906,172674001010799,172699059337928,172699592656380,172778190728249) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:11:38.894--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171183825573927,171199681977540,171243526135527,171247878168596,171352091795844,171356713190677,171389309373861,171478020509959,171480741116519,171499730710622,171500448691788,171597577310140,171614708608812,171621018723946,171654039998337,171654535469640,171723827439212,171804579898535,171932647453896,171993707731248,172095595029833,172145658713017,172225113869315,172232692199104,172233793321807,172245035165852,172274955541097,172347511791027,172379561678422,172455915843426,172483892954586,172521068906747,172529167926909,172538577043836,172568980798426,172569344650854,172616211570596,172638778702733,172734491251394,172750670949481) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171183825573927,171199681977540,171243526135527,171247878168596,171352091795844,171356713190677,171389309373861,171478020509959,171480741116519,171499730710622,171500448691788,171597577310140,171614708608812,171621018723946,171654039998337,171654535469640,171723827439212,171804579898535,171932647453896,171993707731248,172095595029833,172145658713017,172225113869315,172232692199104,172233793321807,172245035165852,172274955541097,172347511791027,172379561678422,172455915843426,172483892954586,172521068906747,172529167926909,172538577043836,172568980798426,172569344650854,172616211570596,172638778702733,172734491251394,172750670949481) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:11:55.735--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171170270599042,171286751817053,171292856949159,171300278950498,171325477249688,171446476491618,171454563095882,171500389763573,171524595091261,171571442054369,171584560010871,171587294816504,171620053289840,171627746342080,171646048064250,171701377746562,171769693168693,171854514249870,171878212144688,171904726326563,171922196882297,171925201335758,172122312723719,172203810272840,172215504631224,172216474819222,172240186128325,172240780509912,172397082264695,172491414380963,172511984272446,172518608119349,172615116607492,172655551490242,172676330301276,172692774817343,172699939366000,172722390778726,172786296184763) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171170270599042,171286751817053,171292856949159,171300278950498,171325477249688,171446476491618,171454563095882,171500389763573,171524595091261,171571442054369,171584560010871,171587294816504,171620053289840,171627746342080,171646048064250,171701377746562,171769693168693,171854514249870,171878212144688,171904726326563,171922196882297,171925201335758,172122312723719,172203810272840,172215504631224,172216474819222,172240186128325,172240780509912,172397082264695,172491414380963,172511984272446,172518608119349,172615116607492,172655551490242,172676330301276,172692774817343,172699939366000,172722390778726,172786296184763) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:12:11.942--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171230599131865,171265623206313,171276868570605,171285915624266,171446464777957,171447014115223,171457620035565,171458215898637,171473441879891,171474804248712,171475835708534,171532706440051,171606792309759,171674649085441,171675173658164,171786938847487,171804267447089,171830134686208,171874534068454,171897121074843,172064019806954,172155651923163,172271392707171,172378682237016,172388160046962,172388219249835,172407208098112,172409293174783,172413359676183,172431363863322,172459799948625,172491138245927,172528963018265,172543771606017,172579348278655,172582104437471,172586429710959,172640916346849,172651448655181,172686940626141,172690543257107,172712367820286,172794119182625) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171230599131865,171265623206313,171276868570605,171285915624266,171446464777957,171447014115223,171457620035565,171458215898637,171473441879891,171474804248712,171475835708534,171532706440051,171606792309759,171674649085441,171675173658164,171786938847487,171804267447089,171830134686208,171874534068454,171897121074843,172064019806954,172155651923163,172271392707171,172378682237016,172388160046962,172388219249835,172407208098112,172409293174783,172413359676183,172431363863322,172459799948625,172491138245927,172528963018265,172543771606017,172579348278655,172582104437471,172586429710959,172640916346849,172651448655181,172686940626141,172690543257107,172712367820286,172794119182625) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:12:29.939--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171222418390009,171243166552296,171302012523467,171350860925784,171431987248943,171438900869566,171455197603540,171474481868472,171524257673420,171533818308017,171619647835926,171697118780254,171715894933876,171935146878946,171947873478803,172001347180257,172181284842631,172241329816628,172263998676037,172297062213433,172318741166199,172335746525285,172349563958911,172361939964157,172409305072864,172458986753942,172470927506410,172478778557574,172484686992196,172510077100303,172514353303118,172535316309738,172553827359220,172569351653403,172569844144515,172578186202709,172587316873273,172631420055128,172695627933500,172733283072848) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171222418390009,171243166552296,171302012523467,171350860925784,171431987248943,171438900869566,171455197603540,171474481868472,171524257673420,171533818308017,171619647835926,171697118780254,171715894933876,171935146878946,171947873478803,172001347180257,172181284842631,172241329816628,172263998676037,172297062213433,172318741166199,172335746525285,172349563958911,172361939964157,172409305072864,172458986753942,172470927506410,172478778557574,172484686992196,172510077100303,172514353303118,172535316309738,172553827359220,172569351653403,172569844144515,172578186202709,172587316873273,172631420055128,172695627933500,172733283072848) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:12:46.630--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171256035567690,171258025086296,171307798117966,171404106070141,171428427014496,171467246178197,171477927994603,171480751124334,171489791354000,171534568877670,171601852260626,171643954467516,171675184927344,171681467937715,171696969867977,171713187469815,171757441503108,171814912762562,171862391705073,171877704334720,171898262760654,171900260341165,172042522022535,172044079983479,172077960371500,172118371683370,172137942937699,172198061410595,172293630644699,172318797008015,172355822798278,172357159130351,172379590961581,172414387792001,172416983742389,172433285898962,172433720801080,172451534249352,172486388198296,172497426143505,172561979463705,172589721564014,172595535251293,172614583330896,172619587765152,172693245211732,172699440365230,172742905336548,172769426263993,172778276922493,172789120034667,172799352948431) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171256035567690,171258025086296,171307798117966,171404106070141,171428427014496,171467246178197,171477927994603,171480751124334,171489791354000,171534568877670,171601852260626,171643954467516,171675184927344,171681467937715,171696969867977,171713187469815,171757441503108,171814912762562,171862391705073,171877704334720,171898262760654,171900260341165,172042522022535,172044079983479,172077960371500,172118371683370,172137942937699,172198061410595,172293630644699,172318797008015,172355822798278,172357159130351,172379590961581,172414387792001,172416983742389,172433285898962,172433720801080,172451534249352,172486388198296,172497426143505,172561979463705,172589721564014,172595535251293,172614583330896,172619587765152,172693245211732,172699440365230,172742905336548,172769426263993,172778276922493,172789120034667,172799352948431) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:13:08.182--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171182938208439,171232377737181,171243614311270,171273469623789,171345763261713,171350809213827,171463584989768,171465802605713,171468283043943,171490809353119,171518186092829,171523928597528,171532166523614,171621450998926,171627444499467,171708775882500,171722587691264,171724443884560,171791963759695,171878922709181,171888862230124,171984775121809,172079724133356,172108879520793,172207011045184,172291983284478,172305761253598,172337238141201,172373393622926,172380151448916,172423790170075,172435835057766,172443880021707,172509576034796,172511553956683,172569691674214,172586321600630,172743948580296,172780263176611,172786330536209,172823944961345) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171182938208439,171232377737181,171243614311270,171273469623789,171345763261713,171350809213827,171463584989768,171465802605713,171468283043943,171490809353119,171518186092829,171523928597528,171532166523614,171621450998926,171627444499467,171708775882500,171722587691264,171724443884560,171791963759695,171878922709181,171888862230124,171984775121809,172079724133356,172108879520793,172207011045184,172291983284478,172305761253598,172337238141201,172373393622926,172380151448916,172423790170075,172435835057766,172443880021707,172509576034796,172511553956683,172569691674214,172586321600630,172743948580296,172780263176611,172786330536209,172823944961345) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:13:24.683--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171233184474063,171286074568145,171299430907705,171300273855499,171437520368572,171472629975096,171503825132907,171610952931527,171612539458113,171624389162913,171646657442691,171722447720247,171730971269643,171812371929312,171838797918449,171861652629939,171864480127725,171869634887437,171905254113774,171941910296796,171986515661715,172052557711235,172111565586107,172177614985329,172236676192965,172249837492984,172357766343578,172370382156766,172422452663453,172468864856361,172483799383284,172498558098361,172501176403186,172512038650552,172578823592462,172579359217085,172621920991303,172673539182504,172708390789506,172710148268957,172742983415928,172746826064572,172752915721949,172803103033052,172823588474502) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171233184474063,171286074568145,171299430907705,171300273855499,171437520368572,171472629975096,171503825132907,171610952931527,171612539458113,171624389162913,171646657442691,171722447720247,171730971269643,171812371929312,171838797918449,171861652629939,171864480127725,171869634887437,171905254113774,171941910296796,171986515661715,172052557711235,172111565586107,172177614985329,172236676192965,172249837492984,172357766343578,172370382156766,172422452663453,172468864856361,172483799383284,172498558098361,172501176403186,172512038650552,172578823592462,172579359217085,172621920991303,172673539182504,172708390789506,172710148268957,172742983415928,172746826064572,172752915721949,172803103033052,172823588474502) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:13:41.250--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171265224317471,171321288959567,171360079356758,171514928468010,171532478395248,171571224185918,171612162824936,171679994505306,171736897979549,171804517750613,171809926093802,171908550689699,172035328122600,172086755947031,172198627698395,172224108086108,172357283326572,172424538384584,172469563231613,172526342500693,172537170941152,172556815065384,172585132336945,172639813744906,172641146963036,172647973450779,172648904391515,172690277273489,172729112718108,172746204495058,172776629424320,172823116565780,172829926382839,172840820717744) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171265224317471,171321288959567,171360079356758,171514928468010,171532478395248,171571224185918,171612162824936,171679994505306,171736897979549,171804517750613,171809926093802,171908550689699,172035328122600,172086755947031,172198627698395,172224108086108,172357283326572,172424538384584,172469563231613,172526342500693,172537170941152,172556815065384,172585132336945,172639813744906,172641146963036,172647973450779,172648904391515,172690277273489,172729112718108,172746204495058,172776629424320,172823116565780,172829926382839,172840820717744) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:13:58.148--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171166186305085,171199638966530,171230603679900,171242964103028,171309097248666,171405959775573,171415231802582,171464199772768,171520430460002,171545336660871,171621484449914,171645402311118,171663502509199,171682283754964,171716662572539,171726900271003,171835322535501,171856471502134,171869898935684,171917471344169,171964664132228,171966019216283,172036009030005,172133916651675,172147423944834,172213204762032,172224178167339,172233951792369,172276412279141,172303321466247,172338043631217,172346902216355,172382702736905,172407713252926,172416206371358,172423532370887,172502614336618,172518867590687,172569818387123,172574650717786,172595035710407,172628822962260,172675676557676,172678554217664,172708160099353,172735916245349,172744125461088,172779081168240) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171166186305085,171199638966530,171230603679900,171242964103028,171309097248666,171405959775573,171415231802582,171464199772768,171520430460002,171545336660871,171621484449914,171645402311118,171663502509199,171682283754964,171716662572539,171726900271003,171835322535501,171856471502134,171869898935684,171917471344169,171964664132228,171966019216283,172036009030005,172133916651675,172147423944834,172213204762032,172224178167339,172233951792369,172276412279141,172303321466247,172338043631217,172346902216355,172382702736905,172407713252926,172416206371358,172423532370887,172502614336618,172518867590687,172569818387123,172574650717786,172595035710407,172628822962260,172675676557676,172678554217664,172708160099353,172735916245349,172744125461088,172779081168240) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:14:16.018--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171191652443976,171350068979979,171403493309169,171425289771552,171532763840948,171594715148343,171622475509106,171637227017304,171637335255609,171665876905071,171733172996832,171733554778578,171779115542383,171860864624134,171871607671054,171913897555211,171957373561165,172052365690789,172054839133995,172154931685488,172185090408785,172240540992277,172319384004477,172492459259650,172523845093160,172541985221974,172591064526936,172591422179631,172596038745895,172600607882748,172693551156423,172727753976270,172729020519246,172735697049927,172737931929130) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171191652443976,171350068979979,171403493309169,171425289771552,171532763840948,171594715148343,171622475509106,171637227017304,171637335255609,171665876905071,171733172996832,171733554778578,171779115542383,171860864624134,171871607671054,171913897555211,171957373561165,172052365690789,172054839133995,172154931685488,172185090408785,172240540992277,172319384004477,172492459259650,172523845093160,172541985221974,172591064526936,172591422179631,172596038745895,172600607882748,172693551156423,172727753976270,172729020519246,172735697049927,172737931929130) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:14:31.584--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171291016794658,171308148739828,171349684758308,171355875945290,171373278514106,171498148795156,171502465584327,171545597771805,171622144584108,171648057822662,171658271576670,171663172732461,171681424841960,171714715670706,171844146234462,171891269982523,171967547730697,172276012860769,172278330212196,172278648726805,172310409920926,172312614425539,172344753513194,172392323092166,172494038455586,172500587610473,172500823301976,172641117902823,172641672607921,172677088992050,172699925092488,172742760373130,172776735251093,172780613364068,172831394949420,172838695003769) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171291016794658,171308148739828,171349684758308,171355875945290,171373278514106,171498148795156,171502465584327,171545597771805,171622144584108,171648057822662,171658271576670,171663172732461,171681424841960,171714715670706,171844146234462,171891269982523,171967547730697,172276012860769,172278330212196,172278648726805,172310409920926,172312614425539,172344753513194,172392323092166,172494038455586,172500587610473,172500823301976,172641117902823,172641672607921,172677088992050,172699925092488,172742760373130,172776735251093,172780613364068,172831394949420,172838695003769) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:14:48.076--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171235374714533,171239341982124,171258478789935,171265675270018,171269622476102,171290357616023,171300062413372,171308395339736,171403097332498,171447014234291,171473254324744,171493198998391,171610340028291,171610340135989,171614702957113,171615121034402,171627329239179,171766403952807,171767604460228,171856491681695,171955230569242,171993364059538,172037700801790,172070018889641,172114212442806,172145672190682,172172906464527,172188635695484,172234995266647,172357976408165,172381500194202,172466850593745,172493300294623,172519308547953,172539473200242,172562521789615,172569697138305,172587918021293,172589724876728,172637887879448,172643529520902,172691891813243,172692093549036,172787853499959,172799076602262,172825363446109,172837277775967,172850355827038) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171235374714533,171239341982124,171258478789935,171265675270018,171269622476102,171290357616023,171300062413372,171308395339736,171403097332498,171447014234291,171473254324744,171493198998391,171610340028291,171610340135989,171614702957113,171615121034402,171627329239179,171766403952807,171767604460228,171856491681695,171955230569242,171993364059538,172037700801790,172070018889641,172114212442806,172145672190682,172172906464527,172188635695484,172234995266647,172357976408165,172381500194202,172466850593745,172493300294623,172519308547953,172539473200242,172562521789615,172569697138305,172587918021293,172589724876728,172637887879448,172643529520902,172691891813243,172692093549036,172787853499959,172799076602262,172825363446109,172837277775967,172850355827038) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:15:07.189--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171187584378893,171204920321077,171214836664171,171267727495555,171338561748545,171347528990637,171403261320263,171420724054754,171446629291658,171455863581965,171472855565737,171474178947926,171481357283488,171499261817047,171501700215940,171509024745914,171523658524482,171570354672326,171578947546282,171589724242709,171636497794482,171705966764307,171725297240309,171775745074920,171796653720083,171800726750419,171821696162161,171830915660186,171855518708082,171942081247871,172010052398935,172010124560126,172113323869711,172172613938435,172174722177438,172226511660580,172288357534831,172370882651947,172440550527633,172466050051914,172466666105964,172554464188192,172591132022611,172619364293317,172643976019721,172662219501322,172665918455719,172741628970130,172787408450891,172795120791878) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171187584378893,171204920321077,171214836664171,171267727495555,171338561748545,171347528990637,171403261320263,171420724054754,171446629291658,171455863581965,171472855565737,171474178947926,171481357283488,171499261817047,171501700215940,171509024745914,171523658524482,171570354672326,171578947546282,171589724242709,171636497794482,171705966764307,171725297240309,171775745074920,171796653720083,171800726750419,171821696162161,171830915660186,171855518708082,171942081247871,172010052398935,172010124560126,172113323869711,172172613938435,172174722177438,172226511660580,172288357534831,172370882651947,172440550527633,172466050051914,172466666105964,172554464188192,172591132022611,172619364293317,172643976019721,172662219501322,172665918455719,172741628970130,172787408450891,172795120791878) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:15:25.871--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171181952690452,171200715495400,171204470545850,171256777000630,171428499778147,171506696898131,171514862498231,171571418587335,171620544861237,171645657735494,171700764803096,171701553723925,171716318601197,171780785710295,171817004979533,171856051965343,171906220027027,172060518513069,172089719497183,172118257863010,172132864876980,172171921276812,172223721886388,172233821363729,172243430319844,172267750150044,172295125944174,172336975268385,172338040979332,172418530441800,172439834757865,172441030451274,172449737925318,172459214252437,172492338817169,172510690998416,172581510302120,172597461980593,172617541099999,172640293238011,172675771042643,172723704861519,172723747428982,172790718371601,172798888817725,172814068583903,172832274448427) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171181952690452,171200715495400,171204470545850,171256777000630,171428499778147,171506696898131,171514862498231,171571418587335,171620544861237,171645657735494,171700764803096,171701553723925,171716318601197,171780785710295,171817004979533,171856051965343,171906220027027,172060518513069,172089719497183,172118257863010,172132864876980,172171921276812,172223721886388,172233821363729,172243430319844,172267750150044,172295125944174,172336975268385,172338040979332,172418530441800,172439834757865,172441030451274,172449737925318,172459214252437,172492338817169,172510690998416,172581510302120,172597461980593,172617541099999,172640293238011,172675771042643,172723704861519,172723747428982,172790718371601,172798888817725,172814068583903,172832274448427) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:15:44.876--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171243643972752,171257416088453,171269531512795,171405954393425,171459541576824,171567254549451,171568211064883,171591402622107,171688323934792,171709084586212,171740466129317,171845112309452,171856263571029,171869901635001,171917341725120,171921916873333,171942783501517,171950141049407,172042600592889,172054947795211,172094384919636,172101312361117,172137942940043,172158111198047,172163854018114,172174429131023,172183945152952,172209238725155,172260417223314,172275713458376,172278869010528,172343754943661,172345189792018,172419585835926,172468097263855,172491523201139,172536936890442,172581399696909,172591004469968,172631455489845,172660143889049,172681664835257,172712099774310,172840216966920) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171243643972752,171257416088453,171269531512795,171405954393425,171459541576824,171567254549451,171568211064883,171591402622107,171688323934792,171709084586212,171740466129317,171845112309452,171856263571029,171869901635001,171917341725120,171921916873333,171942783501517,171950141049407,172042600592889,172054947795211,172094384919636,172101312361117,172137942940043,172158111198047,172163854018114,172174429131023,172183945152952,172209238725155,172260417223314,172275713458376,172278869010528,172343754943661,172345189792018,172419585835926,172468097263855,172491523201139,172536936890442,172581399696909,172591004469968,172631455489845,172660143889049,172681664835257,172712099774310,172840216966920) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:16:53.721--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171179363090858,171188096079780,171200066601978,171290594292636,171291487733542,171394682980215,171397845563713,171457570305532,171522555823820,171543304207306,171550073354517,171568605314371,171583552622344,171586850110546,171726426107182,171761351019584,171810541600246,171829901815366,171865886843703,171917086319362,171938785279851,171948467713079,171967505364630,172039955488966,172061283936184,172117920650619,172137218679054,172137432415281,172137931348003,172279293632388,172285611264553,172356668115664,172467140427397,172486294343749,172497161524040,172544533030308,172581641068531,172597809768506,172673189395671,172682323487787,172764208587331,172779411409833,172797272074352,172811347636910) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171179363090858,171188096079780,171200066601978,171290594292636,171291487733542,171394682980215,171397845563713,171457570305532,171522555823820,171543304207306,171550073354517,171568605314371,171583552622344,171586850110546,171726426107182,171761351019584,171810541600246,171829901815366,171865886843703,171917086319362,171938785279851,171948467713079,171967505364630,172039955488966,172061283936184,172117920650619,172137218679054,172137432415281,172137931348003,172279293632388,172285611264553,172356668115664,172467140427397,172486294343749,172497161524040,172544533030308,172581641068531,172597809768506,172673189395671,172682323487787,172764208587331,172779411409833,172797272074352,172811347636910) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:17:26.696--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171205623012703,171264813224557,171326830720119,171516178490063,171528894883608,171528903484775,171593766705924,171631873688478,171683745247397,171741159386978,171843949156633,171869902836740,171905843826628,171915955448720,171924058682993,172006472422542,172010364281094,172107355676986,172124812350887,172176733092645,172189951882679,172191586411384,172242655036725,172276077223389,172276479438241,172319990502301,172349533554846,172375616649082,172425471879236,172537161229610,172552609101366,172561387976871,172569846604008,172616893394132,172638754532773,172712392839363,172783551385467,172794213397847,172823606306085) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171205623012703,171264813224557,171326830720119,171516178490063,171528894883608,171528903484775,171593766705924,171631873688478,171683745247397,171741159386978,171843949156633,171869902836740,171905843826628,171915955448720,171924058682993,172006472422542,172010364281094,172107355676986,172124812350887,172176733092645,172189951882679,172191586411384,172242655036725,172276077223389,172276479438241,172319990502301,172349533554846,172375616649082,172425471879236,172537161229610,172552609101366,172561387976871,172569846604008,172616893394132,172638754532773,172712392839363,172783551385467,172794213397847,172823606306085) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:18:01.423--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171224225159000,171239161508769,171250279960726,171326760831546,171453676221394,171459275043305,171463670610066,171464749607941,171594595030399,171608286921781,171732027491417,171742990097436,171808890180563,171878353471620,171905809642772,171906175782231,171955301425620,172054281496995,172077917566735,172120864609812,172237199641933,172278386842466,172284591203503,172296861441821,172379409690919,172426927548698,172435905770028,172476806120210,172477069223815,172478793494215,172503405754961,172605294155674,172633070804120,172718202318080,172742150438286,172788263974639,172832883341866) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171224225159000,171239161508769,171250279960726,171326760831546,171453676221394,171459275043305,171463670610066,171464749607941,171594595030399,171608286921781,171732027491417,171742990097436,171808890180563,171878353471620,171905809642772,171906175782231,171955301425620,172054281496995,172077917566735,172120864609812,172237199641933,172278386842466,172284591203503,172296861441821,172379409690919,172426927548698,172435905770028,172476806120210,172477069223815,172478793494215,172503405754961,172605294155674,172633070804120,172718202318080,172742150438286,172788263974639,172832883341866) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:18:33.136--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171194499480699,171288835359324,171289231225094,171334016284447,171371704002337,171386556024220,171473980254047,171569172284705,171623381127217,171665533069257,171708773170671,171726522093878,171734404309470,171794800668422,171886642696344,171965072221396,171979008683474,172029610764801,172139515691987,172172895765628,172209705094521,172297914037909,172372772949158,172379431270289,172415135798872,172474785087896,172480032980361,172530641135033,172539958595000,172572826407695,172599261595893,172607676249485,172667184747557,172702259572671,172718245020194,172756688867609,172761914014429) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171194499480699,171288835359324,171289231225094,171334016284447,171371704002337,171386556024220,171473980254047,171569172284705,171623381127217,171665533069257,171708773170671,171726522093878,171734404309470,171794800668422,171886642696344,171965072221396,171979008683474,172029610764801,172139515691987,172172895765628,172209705094521,172297914037909,172372772949158,172379431270289,172415135798872,172474785087896,172480032980361,172530641135033,172539958595000,172572826407695,172599261595893,172607676249485,172667184747557,172702259572671,172718245020194,172756688867609,172761914014429) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:19:06.703--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171171380021519,171186877226993,171198971501794,171266054254489,171336653791362,171338563434486,171355176013419,171386317748177,171442726545780,171463368258030,171497994523228,171576211624506,171596883521849,171635728018810,171688179123441,171718644727457,171725920544932,171745085492280,171745621256901,171834528658362,171869909476416,171878198500352,171916476346935,171933933845922,171934639686152,171967548755197,171991104353585,172076991417974,172111707521559,172319389360705,172327775476360,172360381872033,172374432484071,172424292464036,172429196972661,172432331666466,172507757169211,172557267184453,172608069139713,172643266808567,172703026806296,172725081687093,172726461998928,172733750413158,172751403159865,172760041212095,172760416281351,172788999857053,172849757911687) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171171380021519,171186877226993,171198971501794,171266054254489,171336653791362,171338563434486,171355176013419,171386317748177,171442726545780,171463368258030,171497994523228,171576211624506,171596883521849,171635728018810,171688179123441,171718644727457,171725920544932,171745085492280,171745621256901,171834528658362,171869909476416,171878198500352,171916476346935,171933933845922,171934639686152,171967548755197,171991104353585,172076991417974,172111707521559,172319389360705,172327775476360,172360381872033,172374432484071,172424292464036,172429196972661,172432331666466,172507757169211,172557267184453,172608069139713,172643266808567,172703026806296,172725081687093,172726461998928,172733750413158,172751403159865,172760041212095,172760416281351,172788999857053,172849757911687) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:19:38.625--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171178751570622,171197659996777,171258487822273,171300275547512,171325468795042,171481420018644,171486036809034,171510231608911,171528159248011,171595841948091,171612060135531,171636913545148,171664704012361,171666108545562,171830692208028,171853981526489,171861592437326,171869900647673,171873544589860,171917049348150,171968945695027,172044879100780,172090342834930,172136888331472,172206959995112,172217291698412,172236777029673,172260624691587,172340605909246,172354453716715,172355820292253,172457339911863,172523928595035,172551929239170,172673003692389,172686943323799,172736403126666,172746580758032,172829393358965,172830977080485) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171178751570622,171197659996777,171258487822273,171300275547512,171325468795042,171481420018644,171486036809034,171510231608911,171528159248011,171595841948091,171612060135531,171636913545148,171664704012361,171666108545562,171830692208028,171853981526489,171861592437326,171869900647673,171873544589860,171917049348150,171968945695027,172044879100780,172090342834930,172136888331472,172206959995112,172217291698412,172236777029673,172260624691587,172340605909246,172354453716715,172355820292253,172457339911863,172523928595035,172551929239170,172673003692389,172686943323799,172736403126666,172746580758032,172829393358965,172830977080485) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:20:11.160--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171175386273582,171300005802870,171359360976436,171438516134207,171455305432867,171458311323642,171464201872953,171497355783959,171559823633706,171649802653786,171654884946491,171701000143723,171709657411400,171836587945225,171908786839561,171994881103775,172010040341506,172106865707230,172159312245408,172228239193341,172237090194282,172252575450441,172288728862687,172379114351602,172434580400711,172471966450043,172544007221311,172563523534149,172621346885263,172621400952202,172640659336539,172727072182517,172732981025389,172797067652180,172840091441309) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171175386273582,171300005802870,171359360976436,171438516134207,171455305432867,171458311323642,171464201872953,171497355783959,171559823633706,171649802653786,171654884946491,171701000143723,171709657411400,171836587945225,171908786839561,171994881103775,172010040341506,172106865707230,172159312245408,172228239193341,172237090194282,172252575450441,172288728862687,172379114351602,172434580400711,172471966450043,172544007221311,172563523534149,172621346885263,172621400952202,172640659336539,172727072182517,172732981025389,172797067652180,172840091441309) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:20:42.950--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171319571207079,171368639423405,171395226058373,171439101190987,171457573545313,171466357379443,171468218032339,171472835073695,171474235569070,171490191169679,171532487233942,171532632830939,171558570389192,171627717718145,171634980186622,171679517699845,171706427281563,171727072854640,171779439169894,171869905745279,171965628147394,172025143928440,172038657559792,172068598516579,172103069646950,172121061982339,172146092719605,172158985764318,172269907387747,172297870305239,172331100275664,172332054249423,172339016060868,172379577410554,172387776042244,172477240264195,172478920872998,172517192990683,172536347511433,172544224207637,172630383370251,172683840190541,172731921387538,172761760700879,172771944306308,172780631329655,172810205455438,172853669794859) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171319571207079,171368639423405,171395226058373,171439101190987,171457573545313,171466357379443,171468218032339,171472835073695,171474235569070,171490191169679,171532487233942,171532632830939,171558570389192,171627717718145,171634980186622,171679517699845,171706427281563,171727072854640,171779439169894,171869905745279,171965628147394,172025143928440,172038657559792,172068598516579,172103069646950,172121061982339,172146092719605,172158985764318,172269907387747,172297870305239,172331100275664,172332054249423,172339016060868,172379577410554,172387776042244,172477240264195,172478920872998,172517192990683,172536347511433,172544224207637,172630383370251,172683840190541,172731921387538,172761760700879,172771944306308,172780631329655,172810205455438,172853669794859) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:21:15.067--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171178788987219,171300005391129,171329190996463,171390289492670,171394742991791,171442847685551,171457324667089,171492016034940,171523541492821,171619996173762,171675084221272,171700824484914,171710805465477,171727274102215,171730834050278,171810437981549,171843872524404,171943786728557,171968278086631,172076933508136,172095461529625,172096467723668,172131645866812,172180835304512,172181140410168,172249828133700,172251161987743,172360334119009,172433889873905,172457337941212,172466222831614,172509402149671,172537068515128,172586440496551,172586937669256,172615892662084,172691258929709,172709762282845,172762469402900,172764201526798,172778606973318) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171178788987219,171300005391129,171329190996463,171390289492670,171394742991791,171442847685551,171457324667089,171492016034940,171523541492821,171619996173762,171675084221272,171700824484914,171710805465477,171727274102215,171730834050278,171810437981549,171843872524404,171943786728557,171968278086631,172076933508136,172095461529625,172096467723668,172131645866812,172180835304512,172181140410168,172249828133700,172251161987743,172360334119009,172433889873905,172457337941212,172466222831614,172509402149671,172537068515128,172586440496551,172586937669256,172615892662084,172691258929709,172709762282845,172762469402900,172764201526798,172778606973318) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:21:45.768--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171198347589672,171225213540191,171235457898587,171259664740215,171275202190462,171405976048595,171428398285003,171441899865358,171566632279349,171571186062227,171626398967007,171627523939427,171684425600007,171734944001921,171770559340582,171793787516014,171833881435626,171869264387251,172023514477986,172052073901033,172141348006304,172147041318967,172246914750949,172250475809497,172339752240134,172509247498190,172535759101181,172565791016702,172583496220870,172587811255483,172614587990296,172668535260935,172699013272661,172699824980811,172720269646946,172735584950695,172742157488892,172746210971673,172770513423943,172815393482831) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171198347589672,171225213540191,171235457898587,171259664740215,171275202190462,171405976048595,171428398285003,171441899865358,171566632279349,171571186062227,171626398967007,171627523939427,171684425600007,171734944001921,171770559340582,171793787516014,171833881435626,171869264387251,172023514477986,172052073901033,172141348006304,172147041318967,172246914750949,172250475809497,172339752240134,172509247498190,172535759101181,172565791016702,172583496220870,172587811255483,172614587990296,172668535260935,172699013272661,172699824980811,172720269646946,172735584950695,172742157488892,172746210971673,172770513423943,172815393482831) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:22:18.903--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171171778615106,171225430934204,171234566064259,171247868952830,171281337191097,171326433194475,171328555346660,171335686565908,171381191620534,171386743878097,171395185045693,171406286160056,171407363300518,171433148491102,171458267560635,171458383706223,171458495118367,171461011220786,171468158952032,171484193491960,171485183665467,171498562443311,171503009533506,171505566975241,171507705235711,171539342602160,171558856412533,171561005310123,171563721520701,171584000877918,171605730169297,171647094114761,171661505018660,171688294771665,171798852860252,171825127469847,171858317664574,171871270000523,171932597042326,171938909385203,171973599149436,171977158194146,171978545757360,171991985771245,172085278674976,172089581638978,172095358957018,172158016079658,172174709402462,172253008916274,172269600444261,172297466405200,172316010098908,172408166132879,172417318320350,172458952998069,172500156741815,172509345307123,172531518083087,172537611672494,172547530797017,172642853409801,172700829713620,172736077492091) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171171778615106,171225430934204,171234566064259,171247868952830,171281337191097,171326433194475,171328555346660,171335686565908,171381191620534,171386743878097,171395185045693,171406286160056,171407363300518,171433148491102,171458267560635,171458383706223,171458495118367,171461011220786,171468158952032,171484193491960,171485183665467,171498562443311,171503009533506,171505566975241,171507705235711,171539342602160,171558856412533,171561005310123,171563721520701,171584000877918,171605730169297,171647094114761,171661505018660,171688294771665,171798852860252,171825127469847,171858317664574,171871270000523,171932597042326,171938909385203,171973599149436,171977158194146,171978545757360,171991985771245,172085278674976,172089581638978,172095358957018,172158016079658,172174709402462,172253008916274,172269600444261,172297466405200,172316010098908,172408166132879,172417318320350,172458952998069,172500156741815,172509345307123,172531518083087,172537611672494,172547530797017,172642853409801,172700829713620,172736077492091) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:22:52.193--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171218874609244,171230189403065,171255648045667,171258240857138,171271015840855,171342586785010,171351718320703,171396348412543,171454872595456,171484239431255,171491658110292,171510919551772,171524204233311,171552801613969,171597545585191,171601680061080,171618883029837,171626798826515,171665115283729,171679206175709,171683138318987,171688185309519,171705694253270,171730317155538,171796329302424,171801049924260,171812277204583,171822999661069,171824500894660,171881822884512,171914649030040,171946770164356,171995209758378,172019053412143,172035212112492,172164543611371,172181800837380,172211241497883,172270323953501,172271858000109,172323027377071,172336021665432,172354621554162,172418574102139,172419581301786,172431257576734,172434275040491,172479411840321,172513123258027,172531458876454,172571393697097,172580720275881,172604814145035,172619250468393,172631393019815) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171218874609244,171230189403065,171255648045667,171258240857138,171271015840855,171342586785010,171351718320703,171396348412543,171454872595456,171484239431255,171491658110292,171510919551772,171524204233311,171552801613969,171597545585191,171601680061080,171618883029837,171626798826515,171665115283729,171679206175709,171683138318987,171688185309519,171705694253270,171730317155538,171796329302424,171801049924260,171812277204583,171822999661069,171824500894660,171881822884512,171914649030040,171946770164356,171995209758378,172019053412143,172035212112492,172164543611371,172181800837380,172211241497883,172270323953501,172271858000109,172323027377071,172336021665432,172354621554162,172418574102139,172419581301786,172431257576734,172434275040491,172479411840321,172513123258027,172531458876454,172571393697097,172580720275881,172604814145035,172619250468393,172631393019815) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:23:24.750--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171165056821523,171172079372973,171240245070449,171241711798417,171256823466961,171292732122347,171311224780011,171358799705103,171360448576499,171379024560319,171395327702509,171405877987281,171423684945802,171432354103098,171455909120680,171505947835475,171525483922515,171533082873796,171545606476762,171550030989675,171591465920770,171610647233800,171616031484258,171616613478381,171641370144599,171660077459472,171662774123148,171704965587259,171797697065748,171800041920814,171861526719585,171922916219251,171939863665182,172019529946075,172079914004511,172136045266022,172137707004945,172179223394407,172209961136999,172222636528523,172322832862153,172417789348026,172420768159984,172449283380066,172482440518726,172493276797521,172525790124437,172560286953316,172582423734633,172646826941510,172690463747941,172707113767627,172734636449209,172754262934560,172781857652499,172782148536843,172829421626492) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171165056821523,171172079372973,171240245070449,171241711798417,171256823466961,171292732122347,171311224780011,171358799705103,171360448576499,171379024560319,171395327702509,171405877987281,171423684945802,171432354103098,171455909120680,171505947835475,171525483922515,171533082873796,171545606476762,171550030989675,171591465920770,171610647233800,171616031484258,171616613478381,171641370144599,171660077459472,171662774123148,171704965587259,171797697065748,171800041920814,171861526719585,171922916219251,171939863665182,172019529946075,172079914004511,172136045266022,172137707004945,172179223394407,172209961136999,172222636528523,172322832862153,172417789348026,172420768159984,172449283380066,172482440518726,172493276797521,172525790124437,172560286953316,172582423734633,172646826941510,172690463747941,172707113767627,172734636449209,172754262934560,172781857652499,172782148536843,172829421626492) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:23:57.537--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171181001338698,171195983687391,171221716962821,171239210079240,171256975392496,171258237638772,171310632608638,171329199942337,171335868065253,171376741793704,171388915730552,171405077584079,171420183061644,171449963405166,171454536948706,171456740661120,171476055450714,171483200110578,171488413223447,171490306713820,171491477576419,171498452733594,171499584625022,171533943155363,171549204140337,171552575493263,171558207104092,171622227474747,171649313421827,171657169401346,171657314283621,171683194082224,171698333960492,171731767326547,171754607052035,171863506748102,171896746003376,171976876222304,172001472514390,172107842283948,172115144249520,172117410283918,172134138593572,172141414512710,172203402444675,172222947477845,172227258366122,172229620833678,172243031677299,172288711171278,172316465539371,172325718107775,172361476473354,172384257669385,172424690406054,172465975154198,172509109880887,172513476375379,172607427413250,172718253855931,172741462836235,172742278173242,172769141843731,172771729337083) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171181001338698,171195983687391,171221716962821,171239210079240,171256975392496,171258237638772,171310632608638,171329199942337,171335868065253,171376741793704,171388915730552,171405077584079,171420183061644,171449963405166,171454536948706,171456740661120,171476055450714,171483200110578,171488413223447,171490306713820,171491477576419,171498452733594,171499584625022,171533943155363,171549204140337,171552575493263,171558207104092,171622227474747,171649313421827,171657169401346,171657314283621,171683194082224,171698333960492,171731767326547,171754607052035,171863506748102,171896746003376,171976876222304,172001472514390,172107842283948,172115144249520,172117410283918,172134138593572,172141414512710,172203402444675,172222947477845,172227258366122,172229620833678,172243031677299,172288711171278,172316465539371,172325718107775,172361476473354,172384257669385,172424690406054,172465975154198,172509109880887,172513476375379,172607427413250,172718253855931,172741462836235,172742278173242,172769141843731,172771729337083) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:24:30.740--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171174108408728,171181136195831,171195859494040,171199407553579,171239874878842,171253651833785,171317511827442,171369183015612,171394523125357,171403622328914,171436310984573,171441666521556,171445338432854,171450684083798,171506539416831,171513684146434,171514323943902,171515843302974,171540581169572,171546128039846,171562885203071,171578291037663,171708810875460,171715247676086,171718303236553,171730334549475,171744668199539,171773130817462,171811106332509,171812798785452,171829390252299,171912029905766,171926401872015,172187923198497,172232508731074,172240707273695,172302730876397,172307604759342,172380046360135,172394017752859,172429520898460,172432192254196,172449935119440,172456318811321,172521218853658,172539156999642,172543770660861,172545882796864,172554229129331,172571983149651,172626080879447,172640493949617,172649277501045,172689889659677,172692305754453,172699753620296,172731352229930,172742532583029,172837640579887) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171174108408728,171181136195831,171195859494040,171199407553579,171239874878842,171253651833785,171317511827442,171369183015612,171394523125357,171403622328914,171436310984573,171441666521556,171445338432854,171450684083798,171506539416831,171513684146434,171514323943902,171515843302974,171540581169572,171546128039846,171562885203071,171578291037663,171708810875460,171715247676086,171718303236553,171730334549475,171744668199539,171773130817462,171811106332509,171812798785452,171829390252299,171912029905766,171926401872015,172187923198497,172232508731074,172240707273695,172302730876397,172307604759342,172380046360135,172394017752859,172429520898460,172432192254196,172449935119440,172456318811321,172521218853658,172539156999642,172543770660861,172545882796864,172554229129331,172571983149651,172626080879447,172640493949617,172649277501045,172689889659677,172692305754453,172699753620296,172731352229930,172742532583029,172837640579887) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 12:25:03.998--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171164773476843,171165153522605,171170296048057,171174082370593,171214115903443,171231582711877,171244428056931,171250310157507,171250680254239,171297728263306,171343516955154,171362765485126,171385958562738,171411483956487,171433200446910,171524209015846,171541498303926,171544238918780,171552736901918,171592629655221,171646766800755,171648324798477,171710290444453,171716308983063,171724492644284,171724626763451,171739719687196,171762352422659,171784640439942,171817005823559,171998792699259,172045607537248,172076778705790,172086093970013,172097933087784,172126919563446,172163967623731,172202727322220,172229621574589,172231206498333,172241969484851,172271734018885,172273918846015,172307439916294,172429694256764,172522183367739,172545812291085,172547314165756,172547465157330,172562658934629,172640443511106,172718138265186,172755321221729,172786010635998,172811144610515,172823137086799) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171164773476843,171165153522605,171170296048057,171174082370593,171214115903443,171231582711877,171244428056931,171250310157507,171250680254239,171297728263306,171343516955154,171362765485126,171385958562738,171411483956487,171433200446910,171524209015846,171541498303926,171544238918780,171552736901918,171592629655221,171646766800755,171648324798477,171710290444453,171716308983063,171724492644284,171724626763451,171739719687196,171762352422659,171784640439942,171817005823559,171998792699259,172045607537248,172076778705790,172086093970013,172097933087784,172126919563446,172163967623731,172202727322220,172229621574589,172231206498333,172241969484851,172271734018885,172273918846015,172307439916294,172429694256764,172522183367739,172545812291085,172547314165756,172547465157330,172562658934629,172640443511106,172718138265186,172755321221729,172786010635998,172811144610515,172823137086799) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 13:42:37.120--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171172400078247,171187196573689,171188658384570,171190070253327,171205748675543,171218762351168,171250345570000,171295639934908,171335862446872,171342308201241,171351948265323,171362989844557,171371354448993,171393279141313,171411064404958,171413400477660,171420718392097,171432450191468,171443960072410,171455716396126,171463094000090,171472201010260,171480680903340,171488808388236,171494381169699,171496014280740,171517952026294,171602973653555,171605932456221,171613957572496,171702614912508,171718262161937,171796141871330,171837252331377,171886480139469,171901202544016,171906992553182,171956742727194,172010875155627,172028483447435,172030029996173,172037512452604,172046249045096,172062764653631,172109026988547,172125929327643,172198931726740,172298623828484,172314466058284,172331629485133,172340100583230,172347115062336,172431374393283,172435579751449,172482493840327,172482690180911,172497451174645,172500341212979,172513588551336,172530250947249,172779002698580) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171172400078247,171187196573689,171188658384570,171190070253327,171205748675543,171218762351168,171250345570000,171295639934908,171335862446872,171342308201241,171351948265323,171362989844557,171371354448993,171393279141313,171411064404958,171413400477660,171420718392097,171432450191468,171443960072410,171455716396126,171463094000090,171472201010260,171480680903340,171488808388236,171494381169699,171496014280740,171517952026294,171602973653555,171605932456221,171613957572496,171702614912508,171718262161937,171796141871330,171837252331377,171886480139469,171901202544016,171906992553182,171956742727194,172010875155627,172028483447435,172030029996173,172037512452604,172046249045096,172062764653631,172109026988547,172125929327643,172198931726740,172298623828484,172314466058284,172331629485133,172340100583230,172347115062336,172431374393283,172435579751449,172482493840327,172482690180911,172497451174645,172500341212979,172513588551336,172530250947249,172779002698580) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 13:43:10.932--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171231525079302,171272302078509,171284734213396,171299204238135,171307413866656,171337473266010,171339596514076,171378730951403,171381128000570,171394909573184,171396654243988,171455249672085,171458188235430,171472330124032,171521180076593,171522082494016,171556810471444,171564102415063,171575465519280,171576177015196,171579738246836,171595293208411,171669204584723,171725256978805,171783102774912,171864078368969,171892474158078,171897906709345,171898753686672,171900401401327,171915862343428,171932724361345,171965582723228,171999875516747,172008900724496,172077458477247,172156738741920,172200235702498,172245537523859,172301108329929,172305181965438,172334481996977,172352319102165,172439541361281,172461683667855,172470164275005,172529657318797,172592907548169,172613593554837,172648160411981,172677308246621,172728285542687,172728851703807,172758385027149,172837301518842) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171231525079302,171272302078509,171284734213396,171299204238135,171307413866656,171337473266010,171339596514076,171378730951403,171381128000570,171394909573184,171396654243988,171455249672085,171458188235430,171472330124032,171521180076593,171522082494016,171556810471444,171564102415063,171575465519280,171576177015196,171579738246836,171595293208411,171669204584723,171725256978805,171783102774912,171864078368969,171892474158078,171897906709345,171898753686672,171900401401327,171915862343428,171932724361345,171965582723228,171999875516747,172008900724496,172077458477247,172156738741920,172200235702498,172245537523859,172301108329929,172305181965438,172334481996977,172352319102165,172439541361281,172461683667855,172470164275005,172529657318797,172592907548169,172613593554837,172648160411981,172677308246621,172728285542687,172728851703807,172758385027149,172837301518842) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 13:43:43.793--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171253494702440,171277940732649,171337810534176,171360897381096,171370382253922,171371444024902,171372183256278,171390178700870,171396412359620,171428725653852,171439146121761,171458648984174,171464266111126,171482339825764,171494131224401,171495396824572,171519111471673,171564498816120,171601573256865,171603851695797,171610439712672,171630922663078,171641389430652,171670789115660,171674245187868,171695780885674,171706740116501,171783257775349,171829614227423,171835170590098,171837959716292,171878146403725,171933398559200,171939823356069,171982341348351,171990518825322,172038077485866,172061238649489,172104366517344,172139951937006,172167196216169,172253254740322,172261339868202,172361832487292,172369039694036,172387031888400,172465792091254,172477779130855,172479601649426,172521580824767,172522819532165,172546954390386,172548628321576,172593355458285,172686192866530,172706842984061,172717871959742,172725747585641,172728174134587,172781450563378,172797782417113,172820072099651,172822156548468) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171253494702440,171277940732649,171337810534176,171360897381096,171370382253922,171371444024902,171372183256278,171390178700870,171396412359620,171428725653852,171439146121761,171458648984174,171464266111126,171482339825764,171494131224401,171495396824572,171519111471673,171564498816120,171601573256865,171603851695797,171610439712672,171630922663078,171641389430652,171670789115660,171674245187868,171695780885674,171706740116501,171783257775349,171829614227423,171835170590098,171837959716292,171878146403725,171933398559200,171939823356069,171982341348351,171990518825322,172038077485866,172061238649489,172104366517344,172139951937006,172167196216169,172253254740322,172261339868202,172361832487292,172369039694036,172387031888400,172465792091254,172477779130855,172479601649426,172521580824767,172522819532165,172546954390386,172548628321576,172593355458285,172686192866530,172706842984061,172717871959742,172725747585641,172728174134587,172781450563378,172797782417113,172820072099651,172822156548468) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 13:44:16.918--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (170914432099792,171170978035666,171173466512860,171231759871350,171267218568521,171268414771813,171329981594979,171398764182795,171431593085399,171535231098693,171553089241137,171557866847803,171565259629238,171580267065309,171594080578346,171611585829585,171672819054533,171683795659925,171723311150663,171736554876717,171774497665025,171792944947695,171805078955626,171839099403815,171841841896459,171868942808396,171876618095646,171923288042310,171940771487872,171983196597379,172110742447515,172163234715289,172189304984936,172238947673443,172244009168214,172310954830737,172352778982112,172356868447783,172356906363661,172377235863549,172412582952321,172468259966975,172493091389389,172503806808097,172545725290814,172557633669285,172562424742281,172602952984327,172664505863069,172682974510071,172707517455033,172708243526943,172725311923894,172741755550160,172763627165640,172767581849258) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (170914432099792,171170978035666,171173466512860,171231759871350,171267218568521,171268414771813,171329981594979,171398764182795,171431593085399,171535231098693,171553089241137,171557866847803,171565259629238,171580267065309,171594080578346,171611585829585,171672819054533,171683795659925,171723311150663,171736554876717,171774497665025,171792944947695,171805078955626,171839099403815,171841841896459,171868942808396,171876618095646,171923288042310,171940771487872,171983196597379,172110742447515,172163234715289,172189304984936,172238947673443,172244009168214,172310954830737,172352778982112,172356868447783,172356906363661,172377235863549,172412582952321,172468259966975,172493091389389,172503806808097,172545725290814,172557633669285,172562424742281,172602952984327,172664505863069,172682974510071,172707517455033,172708243526943,172725311923894,172741755550160,172763627165640,172767581849258) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 13:44:50.174--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171172491080499,171239757558646,171272982683992,171302954170651,171313718492762,171333041588756,171337898098554,171346128465378,171359048635563,171405438226282,171442072778459,171446581611672,171457144043518,171471963043244,171499876581701,171528046356286,171528186730451,171547637055915,171575894488061,171578409613296,171645442574692,171716862729966,171727457318401,171763137456002,171783102960064,171802941081942,171815620100174,171829834615036,171834194922905,171847510145425,171882371590369,171887803539369,171910380248582,171959228222801,172062543522821,172081745311476,172108600698467,172181236256463,172227676088982,172257880257906,172322832691439,172322897704836,172361603601456,172381275691301,172436865681723,172481461394783,172503572514711,172545787107866,172595313865630,172603582943832,172606317228967,172607483181198,172642473807761,172672787653812,172684830659046,172712033665859,172726522139428,172742215829722,172780555391239,172799513164928) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171172491080499,171239757558646,171272982683992,171302954170651,171313718492762,171333041588756,171337898098554,171346128465378,171359048635563,171405438226282,171442072778459,171446581611672,171457144043518,171471963043244,171499876581701,171528046356286,171528186730451,171547637055915,171575894488061,171578409613296,171645442574692,171716862729966,171727457318401,171763137456002,171783102960064,171802941081942,171815620100174,171829834615036,171834194922905,171847510145425,171882371590369,171887803539369,171910380248582,171959228222801,172062543522821,172081745311476,172108600698467,172181236256463,172227676088982,172257880257906,172322832691439,172322897704836,172361603601456,172381275691301,172436865681723,172481461394783,172503572514711,172545787107866,172595313865630,172603582943832,172606317228967,172607483181198,172642473807761,172672787653812,172684830659046,172712033665859,172726522139428,172742215829722,172780555391239,172799513164928) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 13:45:26.215--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171167855737809,171180472992088,171241029137227,171268822857943,171281744150204,171330624967831,171369153028775,171376841016265,171382903651522,171412264937562,171415691742769,171420464100422,171428854939897,171441887190800,171448552674455,171451073792290,171462851684774,171472123519444,171474829403243,171480468568796,171504678474971,171550808925583,171573342213649,171585836743283,171603740054374,171615830443282,171619088019879,171620305687153,171653878898561,171674386363116,171692205444152,171723559076125,171733752885002,171740784844880,171794965454256,171806893630643,171914841954042,171928200528350,171932790615391,172048993595571,172052833859441,172131508783520,172132379335034,172163611626319,172206508571753,172356001635175,172362248484899,172387580704036,172406547326511,172442546794065,172476195431153,172488311451354,172643429471753,172693358318273,172693688162036,172721280714036,172752197103623,172813518919111,172832249834010) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171167855737809,171180472992088,171241029137227,171268822857943,171281744150204,171330624967831,171369153028775,171376841016265,171382903651522,171412264937562,171415691742769,171420464100422,171428854939897,171441887190800,171448552674455,171451073792290,171462851684774,171472123519444,171474829403243,171480468568796,171504678474971,171550808925583,171573342213649,171585836743283,171603740054374,171615830443282,171619088019879,171620305687153,171653878898561,171674386363116,171692205444152,171723559076125,171733752885002,171740784844880,171794965454256,171806893630643,171914841954042,171928200528350,171932790615391,172048993595571,172052833859441,172131508783520,172132379335034,172163611626319,172206508571753,172356001635175,172362248484899,172387580704036,172406547326511,172442546794065,172476195431153,172488311451354,172643429471753,172693358318273,172693688162036,172721280714036,172752197103623,172813518919111,172832249834010) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 13:46:05.845--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171172693124164,171191299347398,171257260110525,171287225290030,171307420635929,171327008836250,171342884944395,171394777142364,171563487394377,171568038122370,171611940789582,171630930207206,171633968022280,171647237596692,171664669549322,171748903605504,171781935673669,171820263275927,171834716370534,171838607602201,171870447779747,171872091636909,171945227458161,172043425166370,172094519017429,172264449258823,172287731086566,172490693610614,172520698336410,172545737539451,172545923475075,172584726501785,172596537827168) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171172693124164,171191299347398,171257260110525,171287225290030,171307420635929,171327008836250,171342884944395,171394777142364,171563487394377,171568038122370,171611940789582,171630930207206,171633968022280,171647237596692,171664669549322,171748903605504,171781935673669,171820263275927,171834716370534,171838607602201,171870447779747,171872091636909,171945227458161,172043425166370,172094519017429,172264449258823,172287731086566,172490693610614,172520698336410,172545737539451,172545923475075,172584726501785,172596537827168) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 13:46:36.259--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171182482533451,171182922218221,171232833212563,171301645100408,171333687996980,171360443842421,171402460100189,171608603931938,171614928842734,171661347231088,171667102675784,171674996892739,171679100251466,171770668530761,171796281895604,171917076044214,171975528193165,172035572788359,172053503640851,172090064764794,172099243560770,172112725802892,172122198017661,172186528995413,172341568420374,172560014314166,172590942490723,172621344172123,172692029494786,172821571100389,172822258256242,172826091379642) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171182482533451,171182922218221,171232833212563,171301645100408,171333687996980,171360443842421,171402460100189,171608603931938,171614928842734,171661347231088,171667102675784,171674996892739,171679100251466,171770668530761,171796281895604,171917076044214,171975528193165,172035572788359,172053503640851,172090064764794,172099243560770,172112725802892,172122198017661,172186528995413,172341568420374,172560014314166,172590942490723,172621344172123,172692029494786,172821571100389,172822258256242,172826091379642) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 13:47:06.373--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171164886145971,171165000630891,171215698356049,171271145421562,171294927810288,171314035209545,171318053223992,171385377199132,171437038046388,171496164739770,171502669996068,171534547966070,171558660664276,171610851810928,171636015928642,171721310959290,171815853113823,171822276848553,171948556911927,171988543592644,172263398765924,172343975761397,172372041894823,172484893412391,172616874834500,172780062355441,172829379362764) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171164886145971,171165000630891,171215698356049,171271145421562,171294927810288,171314035209545,171318053223992,171385377199132,171437038046388,171496164739770,171502669996068,171534547966070,171558660664276,171610851810928,171636015928642,171721310959290,171815853113823,171822276848553,171948556911927,171988543592644,172263398765924,172343975761397,172372041894823,172484893412391,172616874834500,172780062355441,172829379362764) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 13:47:40.551--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171186310892101,171214758827989,171255989070040,171334240061041,171390531583491,171406388760049,171431035406480,171433067736408,171457574969492,171466171987039,171531877708784,171577807223979,171578514606254,171699406209545,171717500023065,171733345936255,171978098419556,172013269961616,172114307020236,172169025485205,172185591120506,172254852183616,172286882797148,172316361409916,172332016167703,172402031955904,172402044560522,172422881044881,172552470169666) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171186310892101,171214758827989,171255989070040,171334240061041,171390531583491,171406388760049,171431035406480,171433067736408,171457574969492,171466171987039,171531877708784,171577807223979,171578514606254,171699406209545,171717500023065,171733345936255,171978098419556,172013269961616,172114307020236,172169025485205,172185591120506,172254852183616,172286882797148,172316361409916,172332016167703,172402031955904,172402044560522,172422881044881,172552470169666) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 13:48:11.417--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171165075034926,171240613021285,171355706588649,171382450882095,171398052746211,171440483629285,171446117932313,171459175734615,171615860982367,171641627319411,171653426446960,171705320574284,171824605678789,171853668089129,171865147088116,171877089369640,171881701785501,171908084558757,171910390349934,171925278300362,172033632175155,172062751922546,172097971814642,172132932110978,172143890998253,172322926823161,172384827726577,172414943368849,172784738165829,172852429397732) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171165075034926,171240613021285,171355706588649,171382450882095,171398052746211,171440483629285,171446117932313,171459175734615,171615860982367,171641627319411,171653426446960,171705320574284,171824605678789,171853668089129,171865147088116,171877089369640,171881701785501,171908084558757,171910390349934,171925278300362,172033632175155,172062751922546,172097971814642,172132932110978,172143890998253,172322926823161,172384827726577,172414943368849,172784738165829,172852429397732) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 13:48:41.179--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171227772818902,171231500537388,171284848341726,171302624246541,171319860387974,171324639438100,171445735721712,171455461058115,171469703602486,171499350102525,171533053772789,171588857375902,171606053988657,171614149764106,171814167867831,171938969401250,172115459696432,172167893386818,172349226149045,172407110241111,172410317394933,172474747948342,172537392573232,172538764735883,172606504488379,172675192111104,172728210949921) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171227772818902,171231500537388,171284848341726,171302624246541,171319860387974,171324639438100,171445735721712,171455461058115,171469703602486,171499350102525,171533053772789,171588857375902,171606053988657,171614149764106,171814167867831,171938969401250,172115459696432,172167893386818,172349226149045,172407110241111,172410317394933,172474747948342,172537392573232,172538764735883,172606504488379,172675192111104,172728210949921) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 13:49:11.390--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171179386968950,171217157397004,171413084647408,171433265665116,171481990594111,171492026976677,171526790788260,171550298800737,171560619968973,171564922415704,171650316961971,171717646399603,171776943373850,171823879676557,171844611455532,172044049770577,172044639711843,172155487960963,172277796462306,172401195726410,172402746211295,172494052301908,172532153845184,172659987750694,172725380584016,172731281624470,172755875846344,172782712325259) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171179386968950,171217157397004,171413084647408,171433265665116,171481990594111,171492026976677,171526790788260,171550298800737,171560619968973,171564922415704,171650316961971,171717646399603,171776943373850,171823879676557,171844611455532,172044049770577,172044639711843,172155487960963,172277796462306,172401195726410,172402746211295,172494052301908,172532153845184,172659987750694,172725380584016,172731281624470,172755875846344,172782712325259) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 13:49:41.140--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171177426401529,171201267789788,171204792643032,171216572325023,171226677372638,171256780019398,171338260182263,171386073161129,171390023069852,171464890976077,171489133128864,171525063809735,171673703716850,171688190858834,171689951909333,171772984562326,171963195243682,172065038758682,172080969864030,172090818369856,172143212522223,172178068870235,172531460386727,172547450305074,172569380300013,172608004431056,172732112683958,172770282260159) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171177426401529,171201267789788,171204792643032,171216572325023,171226677372638,171256780019398,171338260182263,171386073161129,171390023069852,171464890976077,171489133128864,171525063809735,171673703716850,171688190858834,171689951909333,171772984562326,171963195243682,172065038758682,172080969864030,172090818369856,172143212522223,172178068870235,172531460386727,172547450305074,172569380300013,172608004431056,172732112683958,172770282260159) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 13:50:11.900--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (170579150458352,171234905864033,171303511223039,171337567649493,171398223426267,171402883206278,171422238498073,171438499905299,171452232435055,171493323240570,171527032615107,171550044002471,171595111035590,171688702168615,171701163552541,171977662376121,171999825110086,172095489844729,172121158431510,172158291255152,172402096396795,172426964596555,172451542069247,172491976669429,172647641243380) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (170579150458352,171234905864033,171303511223039,171337567649493,171398223426267,171402883206278,171422238498073,171438499905299,171452232435055,171493323240570,171527032615107,171550044002471,171595111035590,171688702168615,171701163552541,171977662376121,171999825110086,172095489844729,172121158431510,172158291255152,172402096396795,172426964596555,172451542069247,172491976669429,172647641243380) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 13:50:42.222--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171165128186368,171189699508200,171441073728016,171446255668675,171456791337904,171708459961903,171921677821814,171922923355886,171982696261639,172010515915820,172023959999119,172096834250325,172215431298590,172298046588719,172308202632008,172322879820735,172355813612815,172368578250353,172372936771463,172425117844240,172471601408764,172568650732212,172679512975849,172759407850772) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171165128186368,171189699508200,171441073728016,171446255668675,171456791337904,171708459961903,171921677821814,171922923355886,171982696261639,172010515915820,172023959999119,172096834250325,172215431298590,172298046588719,172308202632008,172322879820735,172355813612815,172368578250353,172372936771463,172425117844240,172471601408764,172568650732212,172679512975849,172759407850772) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 13:51:12.200--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171178286759832,171188007139223,171218944863695,171226327101169,171282447869691,171283451419935,171301396371099,171333400793072,171386892464285,171393324012167,171482699210645,171507319700017,171549544853060,171584941430290,171667401325798,171699525905158,171821474714458,171939175903613,171967287511020,172391068090918,172426331184623,172431411207461,172451280491177,172488993335903,172553725893469,172556723689344,172559606677135,172619291184588,172813556092338) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171178286759832,171188007139223,171218944863695,171226327101169,171282447869691,171283451419935,171301396371099,171333400793072,171386892464285,171393324012167,171482699210645,171507319700017,171549544853060,171584941430290,171667401325798,171699525905158,171821474714458,171939175903613,171967287511020,172391068090918,172426331184623,172431411207461,172451280491177,172488993335903,172553725893469,172556723689344,172559606677135,172619291184588,172813556092338) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 13:51:42.217--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171164976961065,171189909086575,171196735310256,171270632160242,171279967242476,171310994514725,171313699931482,171376614101153,171413470144405,171427328574896,171445926785694,171451526141534,171458461083088,171479946808775,171492983707145,171510168907077,171519606151463,171529668961365,171567386498016,171605798999746,171672281704051,171721243737158,171760918206482,172054373913857,172268102887340,172375246396635,172417452112257,172470260338266,172668730677646,172673366489463,172735354978805,172771318130744) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171164976961065,171189909086575,171196735310256,171270632160242,171279967242476,171310994514725,171313699931482,171376614101153,171413470144405,171427328574896,171445926785694,171451526141534,171458461083088,171479946808775,171492983707145,171510168907077,171519606151463,171529668961365,171567386498016,171605798999746,171672281704051,171721243737158,171760918206482,172054373913857,172268102887340,172375246396635,172417452112257,172470260338266,172668730677646,172673366489463,172735354978805,172771318130744) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 13:52:13.159--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171274736827485,171344622557855,171381244471857,171413263696078,171428966110900,171486127337306,171501374745978,171530873519922,171535717943045,171552057509558,171629377578657,171639309216250,171656434465638,171664904415378,171694354871588,171698633106667,171723074926623,172036465082626,172078769795996,172098137932650,172137888763355,172147991304935,172167127407208,172251584247894,172325232760176,172480318400594,172497493160061,172588025982885,172777269050993) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171274736827485,171344622557855,171381244471857,171413263696078,171428966110900,171486127337306,171501374745978,171530873519922,171535717943045,171552057509558,171629377578657,171639309216250,171656434465638,171664904415378,171694354871588,171698633106667,171723074926623,172036465082626,172078769795996,172098137932650,172137888763355,172147991304935,172167127407208,172251584247894,172325232760176,172480318400594,172497493160061,172588025982885,172777269050993) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 13:52:44.196--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171189351280360,171215813461705,171242505001977,171299019639124,171310830904008,171342246552433,171352521789530,171436208153456,171472559043499,171498568092396,171512723238752,171533313891160,171564346291733,171602499251977,171672901309670,171776408171354,171776436060078,171913673349609,172042658019254,172097412034068,172108630472714,172116091537409,172181817558352,172316328919277,172374253681540,172575396961478,172702297061716,172704509273117,172793700402513) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171189351280360,171215813461705,171242505001977,171299019639124,171310830904008,171342246552433,171352521789530,171436208153456,171472559043499,171498568092396,171512723238752,171533313891160,171564346291733,171602499251977,171672901309670,171776408171354,171776436060078,171913673349609,172042658019254,172097412034068,172108630472714,172116091537409,172181817558352,172316328919277,172374253681540,172575396961478,172702297061716,172704509273117,172793700402513) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 13:53:15.284--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171165173183956,171268646441377,171351371594142,171381599270617,171383229938506,171550284464474,171564812982718,171586660311763,171616937939912,171655204066809,171664043216777,171669907887407,171736114855025,171741379057640,171862828424858,171891853904298,171892069971513,171982490921740,172006159002069,172076872572128,172140177995312,172193854597039,172206334151853,172234117217855,172283020245408,172316010092854,172332711335012,172374726785355,172399705444233,172420278058657,172746516525578,172768695448812,172823395787881) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171165173183956,171268646441377,171351371594142,171381599270617,171383229938506,171550284464474,171564812982718,171586660311763,171616937939912,171655204066809,171664043216777,171669907887407,171736114855025,171741379057640,171862828424858,171891853904298,171892069971513,171982490921740,172006159002069,172076872572128,172140177995312,172193854597039,172206334151853,172234117217855,172283020245408,172316010092854,172332711335012,172374726785355,172399705444233,172420278058657,172746516525578,172768695448812,172823395787881) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 13:53:45.309--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171165195426040,171170726417524,171184275611306,171258318833310,171303089470345,171363484253205,171375524103790,171382233078646,171409909658082,171412426392660,171424240316926,171468414007594,171482107890083,171511842810401,171515371775448,171558415304798,171791276360112,171919109648061,171934914990169,171995011652298,172328781998028,172365232269349,172414926066136,172449998787078,172497433725006,172545860584208,172648316401341) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171165195426040,171170726417524,171184275611306,171258318833310,171303089470345,171363484253205,171375524103790,171382233078646,171409909658082,171412426392660,171424240316926,171468414007594,171482107890083,171511842810401,171515371775448,171558415304798,171791276360112,171919109648061,171934914990169,171995011652298,172328781998028,172365232269349,172414926066136,172449998787078,172497433725006,172545860584208,172648316401341) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 13:54:15.065--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171165019178895,171223092499031,171223147058159,171238694788833,171401030055142,171412438283673,171450782697367,171496392207289,171499387091551,171612498403704,171622351576944,171772250626988,171949549265052,172012703144742,172158480376588,172160401288910,172174198536715,172218013581543,172320253762116,172362466833217,172375131478107,172414847551317,172436948519360,172547708662656,172595243333539,172680893020239,172831354122008) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171165019178895,171223092499031,171223147058159,171238694788833,171401030055142,171412438283673,171450782697367,171496392207289,171499387091551,171612498403704,171622351576944,171772250626988,171949549265052,172012703144742,172158480376588,172160401288910,172174198536715,172218013581543,172320253762116,172362466833217,172375131478107,172414847551317,172436948519360,172547708662656,172595243333539,172680893020239,172831354122008) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 13:54:45.265--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171180207298110,171224818275551,171342601338709,171351728815750,171384511687712,171407256675371,171422550697577,171480325447382,171491603850043,171693506192195,171751560197683,171796409145668,171828464913346,171897715657832,171977619743185,172054716533440,172267120673644,172328804722756,172373154694863,172426231573684,172633779437483,172658822607912,172661633308552,172805970571511,172844417018608) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171180207298110,171224818275551,171342601338709,171351728815750,171384511687712,171407256675371,171422550697577,171480325447382,171491603850043,171693506192195,171751560197683,171796409145668,171828464913346,171897715657832,171977619743185,172054716533440,172267120673644,172328804722756,172373154694863,172426231573684,172633779437483,172658822607912,172661633308552,172805970571511,172844417018608) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 13:55:15.455--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171281525550848,171324605596009,171414146342638,171432713338346,171472797639155,171487506596602,171501068374456,171547620151117,171603326492052,171659726647637,171735319160758,171745314618315,171871837600586,171976972949256,171977242898723,172074952649231,172106157255452,172137702661236,172243597461372,172251015174302,172301393478854,172303688329325,172417771117370,172432035320609,172598860039528,172703335895064,172712565724051,172745673301726) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171281525550848,171324605596009,171414146342638,171432713338346,171472797639155,171487506596602,171501068374456,171547620151117,171603326492052,171659726647637,171735319160758,171745314618315,171871837600586,171976972949256,171977242898723,172074952649231,172106157255452,172137702661236,172243597461372,172251015174302,172301393478854,172303688329325,172417771117370,172432035320609,172598860039528,172703335895064,172712565724051,172745673301726) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 13:55:45.432--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171170127705442,171235243511606,171291204451654,171311158169512,171348876438994,171365624528042,171371843437352,171385177127893,171430706739210,171456542027394,171507250965540,171550772801923,171576105338776,171593006780391,171610213403727,171640543801774,171645555180867,171650376211070,171671108904912,171788080180801,171790366129104,171832917049039,171908762035928,171917938741604,171994674587829,172025230218332,172084626469078,172108824763555,172263054365381,172325265796882,172446055165339,172497461639156,172569069493580,172820082458182) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171170127705442,171235243511606,171291204451654,171311158169512,171348876438994,171365624528042,171371843437352,171385177127893,171430706739210,171456542027394,171507250965540,171550772801923,171576105338776,171593006780391,171610213403727,171640543801774,171645555180867,171650376211070,171671108904912,171788080180801,171790366129104,171832917049039,171908762035928,171917938741604,171994674587829,172025230218332,172084626469078,172108824763555,172263054365381,172325265796882,172446055165339,172497461639156,172569069493580,172820082458182) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 13:56:15.664--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171244740367418,171247879037909,171294760408844,171317491550170,171334372745623,171350960069504,171355883336953,171418713559857,171526438307450,171564794669021,171591782773603,171602894830334,171700815512929,171890490532478,171894114088625,171913973818304,172122211366219,172306492585017,172354009255787,172393465671475,172434068297958,172501309879587,172547171732989,172609761228465,172692030247001,172828788119562,172829542169153) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171244740367418,171247879037909,171294760408844,171317491550170,171334372745623,171350960069504,171355883336953,171418713559857,171526438307450,171564794669021,171591782773603,171602894830334,171700815512929,171890490532478,171894114088625,171913973818304,172122211366219,172306492585017,172354009255787,172393465671475,172434068297958,172501309879587,172547171732989,172609761228465,172692030247001,172828788119562,172829542169153) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 13:56:44.755--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171340135472124,171392221506584,171402964327647,171433145981922,171567657725904,171623595632033,171651419278846,171732427053569,171751704675898,171786000354464,172307031610630,172331751515661) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171340135472124,171392221506584,171402964327647,171433145981922,171567657725904,171623595632033,171651419278846,171732427053569,171751704675898,171786000354464,172307031610630,172331751515661) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 13:57:14.689--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171991314081453,172105332570210,172251629857266,172293466111866,172302248220562) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171991314081453,172105332570210,172251629857266,172293466111866,172302248220562) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 13:57:43.594--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172159745613346,172226983689722) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172159745613346,172226983689722) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 13:58:11.992--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172042447844779,172070496820817,172111261596059,172129462269102,172243544937459,172259324472905,172302681333129) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172042447844779,172070496820817,172111261596059,172129462269102,172243544937459,172259324472905,172302681333129) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 13:58:40.819--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171977889532743,172004102567217,172124232386783,172224682640093,172245973487405) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171977889532743,172004102567217,172124232386783,172224682640093,172245973487405) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 13:59:09.265--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172037668370047,172056176256965,172201784185740) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172037668370047,172056176256965,172201784185740) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 13:59:37.839--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172055401159567,172245970949011) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172055401159567,172245970949011) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 14:00:06.396--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172273503169461,172285195603719) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172273503169461,172285195603719) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 14:00:38.624--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172089656907106,172104620433675,172176027189854,172267093940957) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172089656907106,172104620433675,172176027189854,172267093940957) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 14:01:07.280--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172114179534466,172122565469808,172211546357418,172224502210527,172267710307439,172294026526670) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172114179534466,172122565469808,172211546357418,172224502210527,172267710307439,172294026526670) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 14:01:36.298--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172062023409859,172246234829790,172285702701583,172302291124807) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172062023409859,172246234829790,172285702701583,172302291124807) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 14:02:06.938--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172190151740639) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172190151740639) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 14:02:39.797--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172076934849191) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172076934849191) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 14:03:08.222--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171957567054864,172124338252254,172289550281538) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171957567054864,172124338252254,172289550281538) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 14:03:36.765--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172254114813317,172276861926824,172297182829677) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172254114813317,172276861926824,172297182829677) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 14:04:05.295--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172021691339169) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172021691339169) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 14:04:33.510--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172026134788881,172101027098147) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172026134788881,172101027098147) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 14:05:01.979--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172198880375675,172284979099833) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172198880375675,172284979099833) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 14:05:30.435--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172030277325940,172232965516906,172299578031611) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172030277325940,172232965516906,172299578031611) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 14:05:58.795--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171925022009811,172123906543797,172198843757412,172208369059695) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171925022009811,172123906543797,172198843757412,172208369059695) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 14:06:27.454--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172095283327587,172263995882845) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172095283327587,172263995882845) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 14:06:56.434--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172050666485061,172064745112181,172071277525357,172078104720602) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172050666485061,172064745112181,172071277525357,172078104720602) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 14:07:24.748--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172086970662312) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172086970662312) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 14:07:53.674--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172043165959827,172084854209783,172231639833785,172276490712704,172294445827963) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172043165959827,172084854209783,172231639833785,172276490712704,172294445827963) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 14:08:24.541--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172146230034236,172277878938179) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172146230034236,172277878938179) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 14:08:52.739--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172130086066228) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172130086066228) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 14:09:21.553--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171602632806317,172087242212004,172095205840166,172115674130871,172138170202748,172164057661073,172293549636293) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171602632806317,172087242212004,172095205840166,172115674130871,172138170202748,172164057661073,172293549636293) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 14:09:50.585--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172149998006607,172208001070304,172210926220705,172216599854695,172218732938887,172260205241149) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172149998006607,172208001070304,172210926220705,172216599854695,172218732938887,172260205241149) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 14:10:19.493--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172020341324310,172047115216061,172085968299272,172147512715468,172305111256494) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172020341324310,172047115216061,172085968299272,172147512715468,172305111256494) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 14:10:48.245--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171982389698082,172030399004140,172078919298671,172215687651992,172294233009067) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171982389698082,172030399004140,172078919298671,172215687651992,172294233009067) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 14:11:16.815--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172016975953555) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172016975953555) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 14:11:45.180--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171930701140658,172048326423609,172077345692423,172211357661474,172232805300561,172250455464925,172307660032609) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171930701140658,172048326423609,172077345692423,172211357661474,172232805300561,172250455464925,172307660032609) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 14:12:13.872--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172078329816275,172080261888189,172117002455377) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172078329816275,172080261888189,172117002455377) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 14:12:42.455--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172202058211706,172302325110438) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172202058211706,172302325110438) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 14:13:11.096--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172068854312126,172072608551416,172207311579169,172286189700168,172293304650983,172305448834414) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172068854312126,172072608551416,172207311579169,172286189700168,172293304650983,172305448834414) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 14:13:39.699--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172060099180467,172078327659007) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172060099180467,172078327659007) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 14:14:08.824--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172150033056896,172165228505226,172201568731904,172209547013074,172286427934877) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172150033056896,172165228505226,172201568731904,172209547013074,172286427934877) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 14:14:37.274--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172034080748625,172132544421085,172155567421807) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172034080748625,172132544421085,172155567421807) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 14:15:10.998--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172069261280450,172171922245483,172234208313098,172251085440421,172259381728480) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (172069261280450,172171922245483,172234208313098,172251085440421,172259381728480) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
------2024-11-02 14:15:40.451--------
insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171974841020025,172206851869095,172262159941598) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171974841020025,172206851869095,172262159941598) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';

---start working

SELECT mec_id FROM modeventcontent mec where mec_id = '2614'


Step 1: Fetch All records from VT for mentioned date in the Jira card and for the product id mentioned in the card

with vt as ( select *, row_number () over ( partition by id order by last_modified_at desc, ifnull(version,'1') desc) as rn from `prioticket-reporting.prio_olap.financial_transactions` ),
vt1 as ( select * from vt where rn= 1 and deleted = '0') select * from vt1 where created_date between '2024-03-10 00:00:01' and '2024-10-10 23:59:59' and ticketId in (2614,2901,2907,2909,2913,2917,2963,2965,3213,3221,3227,3237,3241,3243,3245,3247,3249,3251,3253,3257,3269,3273,3285,3289,3343,3345,3389,3453,3455,3557,3571,3575,3579,3621,6547,6664,6667,7895,8090,9721,10813,10816,10819,10822,10825,10831,10834,10837,10840,10843,10846,10852,10855,10858,10861,10900,10906,10909,10912,10915,10918,10921,10924,10927,10930,10933,10936,10939,10942,10945,11107,11119,11122,11125,11128,11167,11707,11710,11716,11719,13073,13076,13082,13166,13487,13490,13493,13502,13511,15644,16547,16685,16688,16691,16706,16709,16712,16715,16718,17369,17372,17375,17378,17381,17384,17387,17390,17837,17984,18209,18215,18221,18729,21921,22061,22494,22495,22900,22972,22974,22975,22977,22978,24453,25149,25150,25151,25524,26659,28194,28196,28200,29155,29157,29159,29399,35357,35359,35361,35363,35367,35381,36438,36440,38570,38928,39306,40872,41520,41802,41804,41806,43874,43876,44598,45558,46185,46187,46189,46335,46353,46355,46443,47145,47453,47459,48341,48343,49099,51637,52617,53111,56065,56935,56936,57012,57013,57014,57015,57016,57017,57354,57618,58310,59456,59457,60740,60741,60742,61431,62917,62918,63056,63102,63450,63452,63453,63454,64069,64070,64071,64072,64073,64074,64075,64076,64077,64078,64079,64335,64878,64879,65322,65323,65366,65592,65726,65727,65771,65996,65997,66186,66187,66189,66190,66191,66333,67048,67233,67459,67460,67546,67547,67596,67629,67630,67631,67632,67633,67635,67689,67690,67984,67985,67986,67987,67988,67989,67990,67991,67992,67993,68833,68834,68835,68836,69215,69699,70232,70559,70812,70813,71615,71616,72778,72780,72781,72782,72783,72784,73759,74334,74335,74336,77225,77241,2871,2618,2616,3225,3231,3565,3675,3315,3317,3319,4534,3441,5578,3615,2806,2929,2915,2921,3553,3567,3569,3263,3687,3573,3293,3301,3303,3309,3585,3311,3313,3537,3801,3775,3551,4120,3211,3281,3235,3239,3277,3279,3291,3297,3299,3223,6100,2887,3563,3449,2999,4118,3349,6550,6565,6568,6691,6712,7898,9718,9751,9850,9853,9856,9895,2830,2828,2927,3305,10810)


with vt as ( select *, row_number () over ( partition by id order by last_modified_at desc, ifnull(version,'1') desc) as rn from `prioticket-reporting.prio_olap.financial_transactions` ),
vt1 as ( select * from vt where rn= 1 and deleted = '0') select vt_group_no, concat(transaction_id, 'R') as transaction,order_confirm_date, created_date,hotel_id, channel_id, ticketId, ticketpriceschedule_id, version, row_type, partner_gross_price, partner_net_price, order_currency_partner_gross_price, order_currency_partner_net_price, supplier_gross_price, supplier_net_price, col2 from vt1 where created_date between '2024-03-10 00:00:01' and '2024-10-10 23:59:59' and ticketId in (2614) and vt_group_no = 171032183339123 order by version, transaction_id, row_type asc


select count(*) from ticket_level_commission where deleted = '0' and is_adjust_pricing = '1' and ticket_id in (2614,2901,2907,2909,2913,2917,2963,2965,3213,3221,3227,3237,3241,3243,3245,3247,3249,3251,3253,3257,3269,3273,3285,3289,3343,3345,3389,3453,3455,3557,3571,3575,3579,3621,6547,6664,6667,7895,8090,9721,10813,10816,10819,10822,10825,10831,10834,10837,10840,10843,10846,10852,10855,10858,10861,10900,10906,10909,10912,10915,10918,10921,10924,10927,10930,10933,10936,10939,10942,10945,11107,11119,11122,11125,11128,11167,11707,11710,11716,11719,13073,13076,13082,13166,13487,13490,13493,13502,13511,15644,16547,16685,16688,16691,16706,16709,16712,16715,16718,17369,17372,17375,17378,17381,17384,17387,17390,17837,17984,18209,18215,18221,18729,21921,22061,22494,22495,22900,22972,22974,22975,22977,22978,24453,25149,25150,25151,25524,26659,28194,28196,28200,29155,29157,29159,29399,35357,35359,35361,35363,35367,35381,36438,36440,38570,38928,39306,40872,41520,41802,41804,41806,43874,43876,44598,45558,46185,46187,46189,46335,46353,46355,46443,47145,47453,47459,48341,48343,49099,51637,52617,53111,56065,56935,56936,57012,57013,57014,57015,57016,57017,57354,57618,58310,59456,59457,60740,60741,60742,61431,62917,62918,63056,63102,63450,63452,63453,63454,64069,64070,64071,64072,64073,64074,64075,64076,64077,64078,64079,64335,64878,64879,65322,65323,65366,65592,65726,65727,65771,65996,65997,66186,66187,66189,66190,66191,66333,67048,67233,67459,67460,67546,67547,67596,67629,67630,67631,67632,67633,67635,67689,67690,67984,67985,67986,67987,67988,67989,67990,67991,67992,67993,68833,68834,68835,68836,69215,69699,70232,70559,70812,70813,71615,71616,72778,72780,72781,72782,72783,72784,73759,74334,74335,74336,77225,77241,2871,2618,2616,3225,3231,3565,3675,3315,3317,3319,4534,3441,5578,3615,2806,2929,2915,2921,3553,3567,3569,3263,3687,3573,3293,3301,3303,3309,3585,3311,3313,3537,3801,3775,3551,4120,3211,3281,3235,3239,3277,3279,3291,3297,3299,3223,6100,2887,3563,3449,2999,4118,3349,6550,6565,6568,6691,6712,7898,9718,9751,9850,9853,9856,9895,2830,2828,2927,3305,10810)


---- Query to Get latest commission


select vt.vt_group_no, concat(vt.transaction_id, 'R') as transaction_id,vt.order_confirm_date, vt.created_date,vt.hotel_id, vt.channel_id, vt.ticketId, vt.ticketpriceschedule_id, vt.version, vt.row_type, vt.partner_gross_price, vt.partner_net_price, vt.order_currency_partner_gross_price, vt.order_currency_partner_net_price, vt.supplier_gross_price, vt.supplier_net_price, vt.col2 from visitor_tickets vt join (select vt_group_no, transaction_id,row_type, max(version) as version from visitor_tickets where created_date between '2024-03-10 00:00:01' and '2024-10-10 23:59:59' and ticketId in (2614) and vt_group_no = 171606095880779 group by vt_group_no, transaction_id, row_type) as maxversion on vt.vt_group_no = maxversion.vt_group_no and vt.transaction_id = maxversion.transaction_id and vt.row_type = maxversion.row_type and ABS(vt.version-maxversion.version) = '0'


--- Started join with setting table to fetch setting level pricing

version - 1 -- amenment in next version with addition in query

select tlcdata.*  from (select vt.vt_group_no, concat(vt.transaction_id, 'R') as transaction_id,vt.order_confirm_date, vt.created_date,vt.hotel_id, vt.channel_id, vt.ticketId, vt.ticketpriceschedule_id, vt.version, vt.row_type, vt.partner_gross_price, vt.partner_net_price, vt.order_currency_partner_gross_price, vt.order_currency_partner_net_price, vt.supplier_gross_price, vt.supplier_net_price, vt.col2, qc.cod_id as company_id, qc.channel_id as company_pricelist_id, qc.sub_catalog_id as company_sub_catalog, '---TLC LEVEL---' as Type, tlc.ticketpriceschedule_id as tlc_ticketpriceschedule_id, tlc.resale_currency_level, (case when vt.row_type = '1' then tlc.ticket_net_price when vt.row_type = '2' then tlc.museum_net_commission when vt.row_type = '17' then tlc.merchant_net_commission when vt.row_type = '3' then tlc.hotel_commission_net_price when vt.row_type = '4' then tlc.hgs_commission_net_price else 0 end) as tlc_commissions from visitor_tickets vt join (select vt_group_no, transaction_id,row_type, max(version) as version from visitor_tickets where created_date between '2024-03-10 00:00:01' and '2024-10-10 23:59:59' and ticketId in (2614) and vt_group_no = 171032183339123 group by vt_group_no, transaction_id, row_type) as maxversion on vt.vt_group_no = maxversion.vt_group_no and vt.transaction_id = maxversion.transaction_id and vt.row_type = maxversion.row_type and ABS(vt.version-maxversion.version) = '0' left join tmp.qr_codes qc on qc.cod_id = vt.hotel_id and qc.cashier_type = '1' left join tmp.ticket_level_commission tlc on tlc.hotel_id = vt.hotel_id and tlc.ticketpriceschedule_id = vt.ticketpriceschedule_id and tlc.ticket_id = vt.ticketId) as tlcdata


Verison - 2 Added subcatalog_join

select scdata.* from (select tlcdata.*, '----Sub catalog Level---' as type2, sc.catalog_id,sc.ticketpriceschedule_id as sc_ticketpriceschedule_id, sc.resale_currency_level as sc_resale_currency_level, (case when tlcdata.row_type = '1' then sc.ticket_net_price when tlcdata.row_type = '2' then sc.museum_net_commission when tlcdata.row_type = '17' then sc.merchant_net_commission when tlcdata.row_type = '3' then sc.hotel_commission_net_price when tlcdata.row_type = '4' then sc.hgs_commission_net_price else 0 end) as sucatalog_commissions   from (select vt.vt_group_no, concat(vt.transaction_id, 'R') as transaction_id,vt.order_confirm_date, vt.created_date,vt.hotel_id, vt.channel_id, vt.ticketId, vt.ticketpriceschedule_id, vt.version, vt.row_type, vt.partner_gross_price, vt.partner_net_price, vt.order_currency_partner_gross_price, vt.order_currency_partner_net_price, vt.supplier_gross_price, vt.supplier_net_price, vt.col2, qc.cod_id as company_id, qc.channel_id as company_pricelist_id, qc.sub_catalog_id as company_sub_catalog, '---TLC LEVEL---' as Type, tlc.ticketpriceschedule_id as tlc_ticketpriceschedule_id, tlc.resale_currency_level, (case when vt.row_type = '1' then tlc.ticket_net_price when vt.row_type = '2' then tlc.museum_net_commission when vt.row_type = '17' then tlc.merchant_net_commission when vt.row_type = '3' then tlc.hotel_commission_net_price when vt.row_type = '4' then tlc.hgs_commission_net_price else 0 end) as tlc_commissions from visitor_tickets vt join (select vt_group_no, transaction_id,row_type, max(version) as version from visitor_tickets where created_date between '2024-03-10 00:00:01' and '2024-10-10 23:59:59' and ticketId in (2614) and vt_group_no = 171032183339123 group by vt_group_no, transaction_id, row_type) as maxversion on vt.vt_group_no = maxversion.vt_group_no and vt.transaction_id = maxversion.transaction_id and vt.row_type = maxversion.row_type and ABS(vt.version-maxversion.version) = '0' left join tmp.qr_codes qc on qc.cod_id = vt.hotel_id and qc.cashier_type = '1' left join tmp.ticket_level_commission tlc on tlc.hotel_id = vt.hotel_id and tlc.ticketpriceschedule_id = vt.ticketpriceschedule_id and tlc.ticket_id = vt.ticketId) as tlcdata left join tmp.channel_level_commission sc on tlcdata.ticketpriceschedule_id = sc.ticketpriceschedule_id and tlcdata.ticketId = sc.ticket_id and if(tlcdata.company_sub_catalog = '0', 122222, tlcdata.company_sub_catalog) = sc.catalog_id) as scdata


Verison - 3 Added main_catalog_join

select * from (select scdata.*, '----Price List Level---' as type3,pl.ticketpriceschedule_id as clc_ticketpriceschedule_id,(case when scdata.row_type = '1' then pl.ticket_net_price when scdata.row_type = '2' then pl.museum_net_commission when scdata.row_type = '17' then pl.merchant_net_commission when scdata.row_type = '3' then pl.hotel_commission_net_price when scdata.row_type = '4' then pl.hgs_commission_net_price else 0 end) as pricelist_commissions  from (select tlcdata.*, '----Sub catalog Level---' as type2, sc.catalog_id,sc.ticketpriceschedule_id as sc_ticketpriceschedule_id, sc.resale_currency_level as sc_resale_currency_level, (case when tlcdata.row_type = '1' then sc.ticket_net_price when tlcdata.row_type = '2' then sc.museum_net_commission when tlcdata.row_type = '17' then sc.merchant_net_commission when tlcdata.row_type = '3' then sc.hotel_commission_net_price when tlcdata.row_type = '4' then sc.hgs_commission_net_price else 0 end) as sucatalog_commissions   from (select vt.vt_group_no, concat(vt.transaction_id, 'R') as transaction_id,vt.order_confirm_date, vt.created_date,vt.hotel_id, vt.channel_id, vt.ticketId, vt.ticketpriceschedule_id, vt.version, vt.row_type, vt.partner_gross_price, vt.partner_net_price, vt.order_currency_partner_gross_price, vt.order_currency_partner_net_price, vt.supplier_gross_price, vt.supplier_net_price, vt.col2, qc.cod_id as company_id, qc.channel_id as company_pricelist_id, qc.sub_catalog_id as company_sub_catalog, '---TLC LEVEL---' as Type, tlc.ticketpriceschedule_id as tlc_ticketpriceschedule_id, tlc.resale_currency_level, (case when vt.row_type = '1' then tlc.ticket_net_price when vt.row_type = '2' then tlc.museum_net_commission when vt.row_type = '17' then tlc.merchant_net_commission when vt.row_type = '3' then tlc.hotel_commission_net_price when vt.row_type = '4' then tlc.hgs_commission_net_price else 0 end) as tlc_commissions from visitor_tickets vt join (select vt_group_no, transaction_id,row_type, max(version) as version from visitor_tickets where created_date between '2024-03-10 00:00:01' and '2024-10-10 23:59:59' and ticketId in (3305) and vt_group_no = 171750806332229 group by vt_group_no, transaction_id, row_type) as maxversion on vt.vt_group_no = maxversion.vt_group_no and vt.transaction_id = maxversion.transaction_id and vt.row_type = maxversion.row_type and ABS(vt.version-maxversion.version) = '0' left join tmp.qr_codes qc on qc.cod_id = vt.hotel_id and qc.cashier_type = '1' left join tmp.ticket_level_commission tlc on tlc.hotel_id = vt.hotel_id and tlc.ticketpriceschedule_id = vt.ticketpriceschedule_id and tlc.ticket_id = vt.ticketId) as tlcdata left join tmp.channel_level_commission sc on tlcdata.ticketpriceschedule_id = sc.ticketpriceschedule_id and tlcdata.ticketId = sc.ticket_id and if(tlcdata.company_sub_catalog = '0', 122222, tlcdata.company_sub_catalog) = sc.catalog_id) as scdata left join tmp.channel_level_commission pl on scdata.ticketpriceschedule_id = pl.ticketpriceschedule_id and scdata.ticketId = pl.ticket_id and scdata.channel_id = pl.channel_id and pl.catalog_id = '0') as finalmismatch


Version - 4 Should be price included to find final mismatch

select * from (select *, (case when tlc_ticketpriceschedule_id is not NULL then tlc_commissions when tlc_ticketpriceschedule_id is NULL and sc_ticketpriceschedule_id is not NULL then sucatalog_commissions when tlc_ticketpriceschedule_id is NULL and sc_ticketpriceschedule_id is NULL and clc_ticketpriceschedule_id is not NULL then pricelist_commissions else 'No_Setting_found' end) as should_be from (select scdata.*, '----Price List Level---' as type3,pl.ticketpriceschedule_id as clc_ticketpriceschedule_id,(case when scdata.row_type = '1' then pl.ticket_net_price when scdata.row_type = '2' then pl.museum_net_commission when scdata.row_type = '17' then pl.merchant_net_commission when scdata.row_type = '3' then pl.hotel_commission_net_price when scdata.row_type = '4' then pl.hgs_commission_net_price else 0 end) as pricelist_commissions  from (select tlcdata.*, '----Sub catalog Level---' as type2, sc.catalog_id,sc.ticketpriceschedule_id as sc_ticketpriceschedule_id, sc.resale_currency_level as sc_resale_currency_level, (case when tlcdata.row_type = '1' then sc.ticket_net_price when tlcdata.row_type = '2' then sc.museum_net_commission when tlcdata.row_type = '17' then sc.merchant_net_commission when tlcdata.row_type = '3' then sc.hotel_commission_net_price when tlcdata.row_type = '4' then sc.hgs_commission_net_price else 0 end) as sucatalog_commissions   from (select vt.vt_group_no, concat(vt.transaction_id, 'R') as transaction_id,vt.order_confirm_date, vt.created_date,vt.hotel_id, vt.channel_id, vt.ticketId, vt.ticketpriceschedule_id, vt.version, vt.row_type, vt.partner_gross_price, vt.partner_net_price, vt.order_currency_partner_gross_price, vt.order_currency_partner_net_price, vt.supplier_gross_price, vt.supplier_net_price, vt.col2, qc.cod_id as company_id, qc.channel_id as company_pricelist_id, qc.sub_catalog_id as company_sub_catalog, '---TLC LEVEL---' as Type, tlc.ticketpriceschedule_id as tlc_ticketpriceschedule_id, tlc.resale_currency_level, (case when vt.row_type = '1' then tlc.ticket_net_price when vt.row_type = '2' then tlc.museum_net_commission when vt.row_type = '17' then tlc.merchant_net_commission when vt.row_type = '3' then tlc.hotel_commission_net_price when vt.row_type = '4' then tlc.hgs_commission_net_price else 0 end) as tlc_commissions from visitor_tickets vt join (select vt_group_no, transaction_id,row_type, max(version) as version from visitor_tickets where created_date between '2024-03-10 00:00:01' and '2024-10-10 23:59:59' and ticketId in (3305) and vt_group_no in (171606095880779,171671167122769,171813887426329,171916625964499,171967613655385,172514158364736,172658023115391,171743827903142,171869863308184,172570938433247,171084936598973,171369145923694,171619037811599,171622578524344,171845478290671,172021266321751) group by vt_group_no, transaction_id, row_type) as maxversion on vt.vt_group_no = maxversion.vt_group_no and vt.transaction_id = maxversion.transaction_id and vt.row_type = maxversion.row_type and ABS(vt.version-maxversion.version) = '0' left join tmp.qr_codes qc on qc.cod_id = vt.hotel_id and qc.cashier_type = '1' left join tmp.ticket_level_commission tlc on tlc.hotel_id = vt.hotel_id and tlc.ticketpriceschedule_id = vt.ticketpriceschedule_id and tlc.ticket_id = vt.ticketId) as tlcdata left join tmp.channel_level_commission sc on tlcdata.ticketpriceschedule_id = sc.ticketpriceschedule_id and tlcdata.ticketId = sc.ticket_id and if(tlcdata.company_sub_catalog = '0', 122222, tlcdata.company_sub_catalog) = sc.catalog_id) as scdata left join tmp.channel_level_commission pl on scdata.ticketpriceschedule_id = pl.ticketpriceschedule_id and scdata.ticketId = pl.ticket_id and scdata.channel_id = pl.channel_id and pl.catalog_id = '0') as shouldbe) as final where partner_net_price != should_be and should_be != 'No_Setting_found' and row_type != '1'

---- Select query to update records

select vtt.transaction_id, vtt.version,vtt.row_type,vtt.partner_net_price, final.should_be, vtt.partner_gross_price,vtt.tax_value, final.should_be*(100+vtt.tax_value)/100, vtt.supplier_net_price, final.should_be, vtt.supplier_gross_price,vtt.supplier_tax_value, final.should_be*(100+vtt.supplier_tax_value)/100, vtt.action_performed, concat(vtt.action_performed, ', CSSCommission') from visitor_tickets vtt join (select *, (case when tlc_ticketpriceschedule_id is not NULL then tlc_commissions when tlc_ticketpriceschedule_id is NULL and sc_ticketpriceschedule_id is not NULL then sucatalog_commissions when tlc_ticketpriceschedule_id is NULL and sc_ticketpriceschedule_id is NULL and clc_ticketpriceschedule_id is not NULL then pricelist_commissions else 'No_Setting_found' end) as should_be from (select scdata.*, '----Price List Level---' as type3,pl.ticketpriceschedule_id as clc_ticketpriceschedule_id,(case when scdata.row_type = '1' then pl.ticket_net_price when scdata.row_type = '2' then pl.museum_net_commission when scdata.row_type = '17' then pl.merchant_net_commission when scdata.row_type = '3' then pl.hotel_commission_net_price when scdata.row_type = '4' then pl.hgs_commission_net_price else 0 end) as pricelist_commissions  from (select tlcdata.*, '----Sub catalog Level---' as type2, sc.catalog_id,sc.ticketpriceschedule_id as sc_ticketpriceschedule_id, sc.resale_currency_level as sc_resale_currency_level, (case when tlcdata.row_type = '1' then sc.ticket_net_price when tlcdata.row_type = '2' then sc.museum_net_commission when tlcdata.row_type = '17' then sc.merchant_net_commission when tlcdata.row_type = '3' then sc.hotel_commission_net_price when tlcdata.row_type = '4' then sc.hgs_commission_net_price else 0 end) as sucatalog_commissions   from (select vt.vt_group_no, concat(vt.transaction_id, 'R') as transaction_id,vt.order_confirm_date, vt.created_date,vt.hotel_id, vt.channel_id, vt.ticketId, vt.ticketpriceschedule_id, vt.version, vt.row_type, vt.partner_gross_price, vt.partner_net_price, vt.order_currency_partner_gross_price, vt.order_currency_partner_net_price, vt.supplier_gross_price, vt.supplier_net_price, vt.col2, qc.cod_id as company_id, qc.channel_id as company_pricelist_id, qc.sub_catalog_id as company_sub_catalog, '---TLC LEVEL---' as Type, tlc.ticketpriceschedule_id as tlc_ticketpriceschedule_id, tlc.resale_currency_level, (case when vt.row_type = '1' then tlc.ticket_net_price when vt.row_type = '2' then tlc.museum_net_commission when vt.row_type = '17' then tlc.merchant_net_commission when vt.row_type = '3' then tlc.hotel_commission_net_price when vt.row_type = '4' then tlc.hgs_commission_net_price else 0 end) as tlc_commissions from visitor_tickets vt join (select vt_group_no, transaction_id,row_type, max(version) as version from visitor_tickets where created_date between '2024-03-10 00:00:01' and '2024-10-10 23:59:59' and ticketId in (57354) and vt_group_no in (171242616086533) group by vt_group_no, transaction_id, row_type) as maxversion on vt.vt_group_no = maxversion.vt_group_no and vt.transaction_id = maxversion.transaction_id and vt.row_type = maxversion.row_type and ABS(vt.version-maxversion.version) = '0' left join tmp.qr_codes qc on qc.cod_id = vt.hotel_id and qc.cashier_type = '1' left join tmp.ticket_level_commission tlc on tlc.hotel_id = vt.hotel_id and tlc.ticketpriceschedule_id = vt.ticketpriceschedule_id and tlc.ticket_id = vt.ticketId) as tlcdata left join tmp.channel_level_commission sc on tlcdata.ticketpriceschedule_id = sc.ticketpriceschedule_id and tlcdata.ticketId = sc.ticket_id and if(tlcdata.company_sub_catalog = '0', 122222, tlcdata.company_sub_catalog) = sc.catalog_id) as scdata left join tmp.channel_level_commission pl on scdata.ticketpriceschedule_id = pl.ticketpriceschedule_id and scdata.ticketId = pl.ticket_id and scdata.channel_id = pl.channel_id and pl.catalog_id = '0') as shouldbe) as final on vtt.vt_group_no = final.vt_group_no and ABS(vtt.version-final.version) = '0' and vtt.transaction_id = final.transaction_id and vtt.row_type = final.row_type where final.partner_net_price != final.should_be and final.should_be != 'No_Setting_found' and final.row_type != '1'

----- Final update

update visitor_tickets vtt join (select *, (case when tlc_ticketpriceschedule_id is not NULL then tlc_commissions when tlc_ticketpriceschedule_id is NULL and sc_ticketpriceschedule_id is not NULL then sucatalog_commissions when tlc_ticketpriceschedule_id is NULL and sc_ticketpriceschedule_id is NULL and clc_ticketpriceschedule_id is not NULL then pricelist_commissions else 'No_Setting_found' end) as should_be from (select scdata.*, '----Price List Level---' as type3,pl.ticketpriceschedule_id as clc_ticketpriceschedule_id,(case when scdata.row_type = '1' then pl.ticket_net_price when scdata.row_type = '2' then pl.museum_net_commission when scdata.row_type = '17' then pl.merchant_net_commission when scdata.row_type = '3' then pl.hotel_commission_net_price when scdata.row_type = '4' then pl.hgs_commission_net_price else 0 end) as pricelist_commissions  from (select tlcdata.*, '----Sub catalog Level---' as type2, sc.catalog_id,sc.ticketpriceschedule_id as sc_ticketpriceschedule_id, sc.resale_currency_level as sc_resale_currency_level, (case when tlcdata.row_type = '1' then sc.ticket_net_price when tlcdata.row_type = '2' then sc.museum_net_commission when tlcdata.row_type = '17' then sc.merchant_net_commission when tlcdata.row_type = '3' then sc.hotel_commission_net_price when tlcdata.row_type = '4' then sc.hgs_commission_net_price else 0 end) as sucatalog_commissions   from (select vt.vt_group_no, concat(vt.transaction_id, 'R') as transaction_id,vt.order_confirm_date, vt.created_date,vt.hotel_id, vt.channel_id, vt.ticketId, vt.ticketpriceschedule_id, vt.version, vt.row_type, vt.partner_gross_price, vt.partner_net_price, vt.order_currency_partner_gross_price, vt.order_currency_partner_net_price, vt.supplier_gross_price, vt.supplier_net_price, vt.col2, qc.cod_id as company_id, qc.channel_id as company_pricelist_id, qc.sub_catalog_id as company_sub_catalog, '---TLC LEVEL---' as Type, tlc.ticketpriceschedule_id as tlc_ticketpriceschedule_id, tlc.resale_currency_level, (case when vt.row_type = '1' then tlc.ticket_net_price when vt.row_type = '2' then tlc.museum_net_commission when vt.row_type = '17' then tlc.merchant_net_commission when vt.row_type = '3' then tlc.hotel_commission_net_price when vt.row_type = '4' then tlc.hgs_commission_net_price else 0 end) as tlc_commissions from visitor_tickets vt join (select vt_group_no, transaction_id,row_type, max(version) as version from visitor_tickets where created_date between '2024-03-10 00:00:01' and '2024-10-10 23:59:59' and ticketId in (3305) and vt_group_no in (171606095880779) group by vt_group_no, transaction_id, row_type) as maxversion on vt.vt_group_no = maxversion.vt_group_no and vt.transaction_id = maxversion.transaction_id and vt.row_type = maxversion.row_type and ABS(vt.version-maxversion.version) = '0' left join tmp.qr_codes qc on qc.cod_id = vt.hotel_id and qc.cashier_type = '1' left join tmp.ticket_level_commission tlc on tlc.hotel_id = vt.hotel_id and tlc.ticketpriceschedule_id = vt.ticketpriceschedule_id and tlc.ticket_id = vt.ticketId) as tlcdata left join tmp.channel_level_commission sc on tlcdata.ticketpriceschedule_id = sc.ticketpriceschedule_id and tlcdata.ticketId = sc.ticket_id and if(tlcdata.company_sub_catalog = '0', 122222, tlcdata.company_sub_catalog) = sc.catalog_id) as scdata left join tmp.channel_level_commission pl on scdata.ticketpriceschedule_id = pl.ticketpriceschedule_id and scdata.ticketId = pl.ticket_id and scdata.channel_id = pl.channel_id and pl.catalog_id = '0') as shouldbe) as final on vtt.vt_group_no = final.vt_group_no and ABS(vtt.version-final.version) = '0' and vtt.transaction_id = final.transaction_id and vtt.row_type = final.row_type set vtt.partner_net_price = final.should_be, vtt.partner_gross_price = final.should_be*(100+vtt.tax_value)/100, vtt.supplier_net_price = final.should_be, vtt.supplier_gross_price = final.should_be*(100+vtt.supplier_tax_value)/100, vtt.action_performed = concat(vtt.action_performed, ', CSSCommission') where final.partner_net_price != final.should_be and final.should_be != 'No_Setting_found' and final.row_type != '1'


----- Update Prepaid_tickets

UPDATE
    prepaid_tickets pt join (SELECT
            transaction_id,
            vt_group_no,
            version,
            ticketId,
            MAX(
                CASE WHEN row_type = '1' THEN partner_net_price ELSE 0
            END
    ) AS sale_price,
    MAX(
        CASE WHEN row_type = '2' THEN partner_net_price ELSE 0
    END
) AS purchase_price,
MAX(
    CASE WHEN row_type = '3' THEN partner_net_price ELSE 0
END
) AS distributor_fee,
MAX(
    CASE WHEN row_type = '4' THEN partner_net_price ELSE 0
END
) AS hgs_fee,
MAX(
    CASE WHEN row_type = '17' THEN partner_net_price ELSE 0
END
) AS merchant_fee,
MAX(
    CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0
END
) AS sale_priceg,
MAX(
    CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0
END
) AS purchase_priceg,
MAX(
    CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0
END
) AS distributor_feeg,
MAX(
    CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0
END
) AS hgs_feeg
FROM
    visitor_tickets
WHERE
    vt_group_no in (171606095880779) and action_performed like '%CSSCommission'
GROUP BY
    vt_group_no,
    transaction_id,
    ticketpriceschedule_id) as aggt ON
    pt.visitor_group_no = aggt.vt_group_no AND pt.prepaid_ticket_id = aggt.transaction_id and ABS(pt.version-aggt.version) = '0' SET
    pt.museum_net_fee = aggt.purchase_price,
    pt.distributor_net_fee = aggt.distributor_fee,
    pt.hgs_net_fee = aggt.hgs_fee,
    pt.museum_gross_fee = aggt.purchase_priceg,
    pt.distributor_gross_fee = aggt.distributor_feeg,
    pt.hgs_gross_fee = aggt.hgs_feeg


---- Preparion for Insert query----

select vtf.id, vtf.created_date, vtf.transaction_id, vtf.invoice_id, vtf.channel_id, vtf.channel_name, vtf.reseller_id, vtf.reseller_name, vtf.saledesk_id, vtf.saledesk_name, vtf.financial_id, vtf.financial_name, vtf.transaction_type_name, vtf.transaction_type_id, vtf.ticketId, vtf.shared_capacity_id, vtf.ticket_booking_id, vtf.related_order_id, vtf.related_booking_id, vtf.ticket_title, vtf.ticketwithdifferentpricing, vtf.ticketpriceschedule_id, vtf.ticket_extra_option_id, vtf.group_type_ticket, vtf.group_price, vtf.group_quantity, vtf.group_linked_with, vtf.selected_date, vtf.booking_selected_date, vtf.from_time, vtf.to_time, vtf.slot_type, vtf.amount_before_extra_discount, vtf.discount_before_extra_discount, vtf.hto_id, vtf.visitor_group_no, vtf.roomNo, vtf.nights, vtf.user_age, vtf.gender, vtf.user_image, vtf.visitor_country, vtf.merchantAccountCode, vtf.merchantReference, vtf.original_pspReference, vtf.shopperReference, vtf.partner_id, vtf.relational_partner_id, vtf.partner_name, vtf.museum_name, vtf.museum_id, vtf.hotel_name, vtf.hotel_id, vtf.pos_point_id, vtf.pos_point_name, vtf.shift_id, vtf.passNo, vtf.pass_type, vtf.ticketAmt, vtf.visit_date, vtf.visit_date_time, vtf.ticketType, vtf.tickettype_name, vtf.discount_applied_on_how_many_tickets, vtf.paid, vtf.payment_method, vtf.isBillToHotel, vtf.card_name, vtf.pspReference, vtf.card_type, vtf.captured, vtf.age_group, vtf.discount, vtf.isDiscountInPercent, vtf.updated_discount_type, vtf.without_elo_reference_no, vtf.debitor, vtf.creditor, vtf.split_cash_amount, vtf.split_card_amount, vtf.split_voucher_amount, vtf.split_direct_payment_amount, vtf.total_gross_commission, vtf.total_net_commission, vtf.commission_type, (case when vtf.row_type = ddd.ddd_row_type then ROUND(ddd.ddd_gross_should_be,2) else ROUND(vtf.partner_gross_price,2) end) as partner_gross_price, vtf.order_currency_partner_gross_price, vtf.partner_gross_price_without_combi_discount, (case when vtf.row_type = ddd.ddd_row_type then ROUND(ddd.ddd_should_be_net,2) else ROUND(vtf.partner_net_price,2) end) as partner_net_price, vtf.order_currency_partner_net_price, vtf.partner_net_price_without_combi_discount, vtf.isCommissionInPercent, vtf.tax_id, vtf.tax_value, vtf.tax_name, vtf.timezone, vtf.invoice_status, vtf.row_type, vtf.updated_by_id, vtf.updated_by_username, vtf.voucher_updated_by, vtf.voucher_updated_by_name, vtf.redeem_method, vtf.redeem_by_ticket_id, vtf.redeem_by_ticket_title, vtf.cashier_id, vtf.cashier_name, vtf.cashier_register_id, vtf.targetlocation, vtf.paymentMethodType, vtf.targetcity, vtf.service_name, vtf.adjustment_row_type, vtf.description, vtf.distributor_status, vtf.adyen_status, vtf.adjustment_method, vtf.all_ticket_ids, vtf.time_based_done, vtf.visitor_invoice_id, vtf.ticketPrice, vtf.deleted, vtf.is_refunded, vtf.is_block, vtf.is_edited, vtf.vt_group_no, vtf.user_name, vtf.issuer_country_code, vtf.distributor_commission_invoice, vtf.activation_method, vtf.is_prioticket, vtf.is_shop_product, vtf.shop_category_name, vtf.external_account_number, vtf.used, vtf.ticket_status, vtf.is_prepaid, vtf.is_purchased_with_postpaid, vtf.invoice_type, vtf.supplier_currency_symbol, vtf.order_currency_code, vtf.order_currency_symbol, vtf.currency_rate, vtf.invoice_variant, vtf.service_cost, vtf.service_cost_net_amount, vtf.service_cost_type, vtf.scanned_pass, vtf.groupTransactionId, vtf.booking_status, vtf.channel_type, vtf.is_voucher, vtf.extra_text_field_answer, vtf.distributor_type, vtf.distributor_partner_id, vtf.distributor_partner_name, vtf.issuer_country_name, vtf.chart_number, vtf.extra_discount, vtf.manual_payment_note, vtf.account_number, vtf.is_custom_setting, vtf.external_product_id, vtf.supplier_currency_code, vtf.col1, vtf.col2, vtf.partner_category_id, vtf.col4, vtf.partner_category_name, vtf.col6, vtf.col7, vtf.col8, vtf.is_data_moved,(case when vtf.row_type = ddd.ddd_row_type then ddd.dd_action_performed_should_be else vtf.action_performed end) as action_performed, vtf.updated_at, vtf.tp_payment_method, vtf.order_confirm_date, vtf.payment_date, vtf.order_cancellation_date, vtf.voucher_creation_date, vtf.primary_host_name,(case when vtf.row_type = ddd.ddd_row_type then ROUND(ddd.dd_supplier_gross_should_be,2) else ROUND(vtf.supplier_gross_price,2) end) as supplier_gross_price, vtf.supplier_discount, vtf.supplier_ticket_amt, vtf.supplier_tax_value, (case when vtf.row_type = ddd.ddd_row_type then ROUND(ddd.dd_supplier_net_should_be,2) else ROUND(vtf.supplier_net_price,2) end) as supplier_net_price, CURRENT_TIMESTAMP as last_modified_at, vtf.market_merchant_id, vtf.merchant_admin_id, vtf.order_updated_cashier_id, vtf.order_updated_cashier_name, ROUND(vtf.version+1,1) as version, vtf.supplier_tax_id, vtf.merchant_currency_code, vtf.merchant_price, vtf.merchant_net_price, vtf.merchant_tax_id, vtf.admin_currency_code from (select fvt.* from visitor_tickets fvt join (select vt_group_no, transaction_id,row_type, max(version) as version from visitor_tickets where ticketId in (57354) and vt_group_no in (171242616086533) group by vt_group_no, transaction_id, row_type) as mv on mv.vt_group_no = fvt.vt_group_no and fvt.transaction_id = mv.transaction_id and fvt.row_type = mv.row_type and ABS(fvt.version-mv.version) = '0') vtf left join (select vtt.vt_group_no as ddd_vt_group_no, vtt.transaction_id as ddd_transaction_id, vtt.version as ddd_version,vtt.row_type as ddd_row_type,vtt.partner_net_price as ddd_partner_net_price, final.should_be as ddd_should_be_net, vtt.partner_gross_price as ddd_partner_gross_price,vtt.tax_value as ddd_tax_value, final.should_be*(100+vtt.tax_value)/100 as ddd_gross_should_be, vtt.supplier_net_price as ddd_supplier_bet_price, final.should_be as dd_supplier_net_should_be, vtt.supplier_gross_price as ddd_supplier_gross_price,vtt.supplier_tax_value as ddd_supplier_tax, final.should_be*(100+vtt.supplier_tax_value)/100 as dd_supplier_gross_should_be, vtt.action_performed as dd_action_performed, concat(vtt.action_performed, ', CSSCommission') as dd_action_performed_should_be from visitor_tickets vtt join (select *, (case when tlc_ticketpriceschedule_id is not NULL then tlc_commissions when tlc_ticketpriceschedule_id is NULL and sc_ticketpriceschedule_id is not NULL then sucatalog_commissions when tlc_ticketpriceschedule_id is NULL and sc_ticketpriceschedule_id is NULL and clc_ticketpriceschedule_id is not NULL then pricelist_commissions else 'No_Setting_found' end) as should_be from (select scdata.*, '----Price List Level---' as type3,pl.ticketpriceschedule_id as clc_ticketpriceschedule_id,(case when scdata.row_type = '1' then pl.ticket_net_price when scdata.row_type = '2' then pl.museum_net_commission when scdata.row_type = '17' then pl.merchant_net_commission when scdata.row_type = '3' then pl.hotel_commission_net_price when scdata.row_type = '4' then pl.hgs_commission_net_price else 0 end) as pricelist_commissions  from (select tlcdata.*, '----Sub catalog Level---' as type2, sc.catalog_id,sc.ticketpriceschedule_id as sc_ticketpriceschedule_id, sc.resale_currency_level as sc_resale_currency_level, (case when tlcdata.row_type = '1' then sc.ticket_net_price when tlcdata.row_type = '2' then sc.museum_net_commission when tlcdata.row_type = '17' then sc.merchant_net_commission when tlcdata.row_type = '3' then sc.hotel_commission_net_price when tlcdata.row_type = '4' then sc.hgs_commission_net_price else 0 end) as sucatalog_commissions   from (select vt.vt_group_no, concat(vt.transaction_id, 'R') as transaction_id,vt.order_confirm_date, vt.created_date,vt.hotel_id, vt.channel_id, vt.ticketId, vt.ticketpriceschedule_id, vt.version, vt.row_type, vt.partner_gross_price, vt.partner_net_price, vt.order_currency_partner_gross_price, vt.order_currency_partner_net_price, vt.supplier_gross_price, vt.supplier_net_price, vt.col2, qc.cod_id as company_id, qc.channel_id as company_pricelist_id, qc.sub_catalog_id as company_sub_catalog, '---TLC LEVEL---' as Type, tlc.ticketpriceschedule_id as tlc_ticketpriceschedule_id, tlc.resale_currency_level, (case when vt.row_type = '1' then tlc.ticket_net_price when vt.row_type = '2' then tlc.museum_net_commission when vt.row_type = '17' then tlc.merchant_net_commission when vt.row_type = '3' then tlc.hotel_commission_net_price when vt.row_type = '4' then tlc.hgs_commission_net_price else 0 end) as tlc_commissions from visitor_tickets vt join (select vt_group_no, transaction_id,row_type, max(version) as version from visitor_tickets where created_date between '2024-03-10 00:00:01' and '2024-10-10 23:59:59' and ticketId in (57354) and vt_group_no in (171242616086533) group by vt_group_no, transaction_id, row_type) as maxversion on vt.vt_group_no = maxversion.vt_group_no and vt.transaction_id = maxversion.transaction_id and vt.row_type = maxversion.row_type and ABS(vt.version-maxversion.version) = '0' left join tmp.qr_codes qc on qc.cod_id = vt.hotel_id and qc.cashier_type = '1' left join tmp.ticket_level_commission tlc on tlc.hotel_id = vt.hotel_id and tlc.ticketpriceschedule_id = vt.ticketpriceschedule_id and tlc.ticket_id = vt.ticketId) as tlcdata left join tmp.channel_level_commission sc on tlcdata.ticketpriceschedule_id = sc.ticketpriceschedule_id and tlcdata.ticketId = sc.ticket_id and if(tlcdata.company_sub_catalog = '0', 122222, tlcdata.company_sub_catalog) = sc.catalog_id) as scdata left join tmp.channel_level_commission pl on scdata.ticketpriceschedule_id = pl.ticketpriceschedule_id and scdata.ticketId = pl.ticket_id and scdata.channel_id = pl.channel_id and pl.catalog_id = '0') as shouldbe) as final on vtt.vt_group_no = final.vt_group_no and ABS(vtt.version-final.version) = '0' and vtt.transaction_id = final.transaction_id and vtt.row_type = final.row_type where final.partner_net_price != final.should_be and final.should_be != 'No_Setting_found' and final.row_type != '1') as ddd on ddd.ddd_vt_group_no = vtf.vt_group_no and ddd.ddd_transaction_id = vtf.transaction_id and ABS(ddd.ddd_version - vtf.version) = '0' and vtf.row_type = ddd.ddd_row_type


Steps: 

1. Get All orders and ticket id which provided in jira card : Around 3.50 lacs orders

2. Need to check for which distrutors these products are enabled

3. After that need to get channel_id and catalog_id linked with that distributor

4. Get commission for each product and distributor on each different level  i.e. account level, sub catalog level and default level

5. Then prepare list of final data which we need to apply as per pricing hierarchy

6. Then update records in the visitor_tickets for partner_gross_price and partner_net_price

7. After update all these records also need to update the fees column in the prepaid_tickets as well
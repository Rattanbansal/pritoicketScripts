---start working

SELECT mec_id FROM modeventcontent mec where mec_id = '2614'


Step 1: Fetch All records from VT for mentioned date in the Jira card and for the product id mentioned in the card

with vt as ( select *, row_number () over ( partition by id order by last_modified_at desc, ifnull(version,'1') desc) as rn from `prioticket-reporting.prio_olap.financial_transactions` ),
vt1 as ( select * from vt where rn= 1 and deleted = '0') select * from vt1 where created_date between '2024-03-10 00:00:01' and '2024-10-10 23:59:59' and ticketId in (2614,2901,2907,2909,2913,2917,2963,2965,3213,3221,3227,3237,3241,3243,3245,3247,3249,3251,3253,3257,3269,3273,3285,3289,3343,3345,3389,3453,3455,3557,3571,3575,3579,3621,6547,6664,6667,7895,8090,9721,10813,10816,10819,10822,10825,10831,10834,10837,10840,10843,10846,10852,10855,10858,10861,10900,10906,10909,10912,10915,10918,10921,10924,10927,10930,10933,10936,10939,10942,10945,11107,11119,11122,11125,11128,11167,11707,11710,11716,11719,13073,13076,13082,13166,13487,13490,13493,13502,13511,15644,16547,16685,16688,16691,16706,16709,16712,16715,16718,17369,17372,17375,17378,17381,17384,17387,17390,17837,17984,18209,18215,18221,18729,21921,22061,22494,22495,22900,22972,22974,22975,22977,22978,24453,25149,25150,25151,25524,26659,28194,28196,28200,29155,29157,29159,29399,35357,35359,35361,35363,35367,35381,36438,36440,38570,38928,39306,40872,41520,41802,41804,41806,43874,43876,44598,45558,46185,46187,46189,46335,46353,46355,46443,47145,47453,47459,48341,48343,49099,51637,52617,53111,56065,56935,56936,57012,57013,57014,57015,57016,57017,57354,57618,58310,59456,59457,60740,60741,60742,61431,62917,62918,63056,63102,63450,63452,63453,63454,64069,64070,64071,64072,64073,64074,64075,64076,64077,64078,64079,64335,64878,64879,65322,65323,65366,65592,65726,65727,65771,65996,65997,66186,66187,66189,66190,66191,66333,67048,67233,67459,67460,67546,67547,67596,67629,67630,67631,67632,67633,67635,67689,67690,67984,67985,67986,67987,67988,67989,67990,67991,67992,67993,68833,68834,68835,68836,69215,69699,70232,70559,70812,70813,71615,71616,72778,72780,72781,72782,72783,72784,73759,74334,74335,74336,77225,77241,2871,2618,2616,3225,3231,3565,3675,3315,3317,3319,4534,3441,5578,3615,2806,2929,2915,2921,3553,3567,3569,3263,3687,3573,3293,3301,3303,3309,3585,3311,3313,3537,3801,3775,3551,4120,3211,3281,3235,3239,3277,3279,3291,3297,3299,3223,6100,2887,3563,3449,2999,4118,3349,6550,6565,6568,6691,6712,7898,9718,9751,9850,9853,9856,9895,2830,2828,2927,3305,10810)


with vt as ( select *, row_number () over ( partition by id order by last_modified_at desc, ifnull(version,'1') desc) as rn from `prioticket-reporting.prio_olap.financial_transactions` ),
vt1 as ( select * from vt where rn= 1 and deleted = '0') select vt_group_no, concat(transaction_id, 'R') as transaction,order_confirm_date, created_date,hotel_id, channel_id, ticketId, ticketpriceschedule_id, version, row_type, partner_gross_price, partner_net_price, order_currency_partner_gross_price, order_currency_partner_net_price, supplier_gross_price, supplier_net_price, col2 from vt1 where created_date between '2024-03-10 00:00:01' and '2024-10-10 23:59:59' and ticketId in (2614) and vt_group_no = 171032183339123 order by version, transaction_id, row_tyinsert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, `unlock`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171200476960351,171284713267679,171303673715817,171311756606074,171369179194498,171377487095541,171425511473851,171487986298291,171518335510773,171535514203498,171680421928718,171780258390418,171863835107549,171865768078291,171978380335443,172017559746652,172089276199113,172140265033496,172164782947180,172200478584407,172215324601392,172268024161825,172336779348817,172380471807036,172384200660550,172397771202793,172401180575728,172422740553217,172441250412994,172469280715902,172469463739927,172478920303633,172512946915585,172539207165564,172596564954525,172602119014824,172673082760249,172684803475850,172716885843769,172787635951895) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171200476960351,171284713267679,171303673715817,171311756606074,171369179194498,171377487095541,171425511473851,171487986298291,171518335510773,171535514203498,171680421928718,171780258390418,171863835107549,171865768078291,171978380335443,172017559746652,172089276199113,172140265033496,172164782947180,172200478584407,172215324601392,172268024161825,172336779348817,172380471807036,172384200660550,172397771202793,172401180575728,172422740553217,172441250412994,172469280715902,172469463739927,172478920303633,172512946915585,172539207165564,172596564954525,172602119014824,172673082760249,172684803475850,172716885843769,172787635951895) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';
pe asc


select count(*) from ticket_level_commission where deleted = '0' and is_adjust_pricing = '1' and ticket_id in (2614,2901,2907,2909,2913,2917,2963,2965,3213,3221,3227,3237,3241,3243,3245,3247,3249,3251,3253,3257,3269,3273,3285,3289,3343,3345,3389,3453,3455,3557,3571,3575,3579,3621,6547,6664,6667,7895,8090,9721,10813,10816,10819,10822,10825,10831,10834,10837,10840,10843,10846,10852,10855,10858,10861,10900,10906,10909,10912,10915,10918,10921,10924,10927,10930,10933,10936,10939,10942,10945,11107,11119,11122,11125,11128,11167,11707,11710,11716,11719,13073,13076,13082,13166,13487,13490,13493,13502,13511,15644,16547,16685,16688,16691,16706,16709,16712,16715,16718,17369,17372,17375,17378,17381,17384,17387,17390,17837,17984,18209,18215,18221,18729,21921,22061,22494,22495,22900,22972,22974,22975,22977,22978,24453,25149,25150,25151,25524,26659,28194,28196,28200,29155,29157,29159,29399,35357,35359,35361,35363,35367,35381,36438,36440,38570,38928,39306,40872,41520,41802,41804,41806,43874,43876,44598,45558,46185,46187,46189,46335,46353,46355,46443,47145,47453,47459,48341,48343,49099,51637,52617,53111,56065,56935,56936,57012,57013,57014,57015,57016,57017,57354,57618,58310,59456,59457,60740,60741,60742,61431,62917,62918,63056,63102,63450,63452,63453,63454,64069,64070,64071,64072,64073,64074,64075,64076,64077,64078,64079,64335,64878,64879,65322,65323,65366,65592,65726,65727,65771,65996,65997,66186,66187,66189,66190,66191,66333,67048,67233,67459,67460,67546,67547,67596,67629,67630,67631,67632,67633,67635,67689,67690,67984,67985,67986,67987,67988,67989,67990,67991,67992,67993,68833,68834,68835,68836,69215,69699,70232,70559,70812,70813,71615,71616,72778,72780,72781,72782,72783,72784,73759,74334,74335,74336,77225,77241,2871,2618,2616,3225,3231,3565,3675,3315,3317,3319,4534,3441,5578,3615,2806,2929,2915,2921,3553,3567,3569,3263,3687,3573,3293,3301,3303,3309,3585,3311,3313,3537,3801,3775,3551,4120,3211,3281,3235,3239,3277,3279,3291,3297,3299,3223,6100,2887,3563,3449,2999,4118,3349,6550,6565,6568,6691,6712,7898,9718,9751,9850,9853,9856,9895,2830,2828,2927,3305,10810)


---- Query to Get latest commission


select vt.vt_group_no, concat(vt.transaction_id, 'R') as transaction_id,vt.order_confirm_date, vt.created_date,vt.hotel_id, vt.channel_id, vt.ticketId, vt.ticketpriceschedule_id, vt.version, vt.row_type, vt.partner_gross_price, vt.partner_net_price, vt.order_currency_partner_gross_price, vt.order_currency_partner_net_price, vt.supplier_gross_price, vt.supplier_net_price, vt.col2 from visitor_tickets vt join (select vt_group_no, transaction_id,row_type, max(version) as version from visitor_tickets where created_date between '2024-03-10 00:00:01' and '2024-10-10 23:59:59' and ticketId in (2614) and vt_group_no = 171606095880779 group by vt_group_no, transaction_id, row_type) as maxversion on vt.vt_group_no = maxversion.vt_group_no and vt.transaction_id = maxversion.transaction_id and vt.row_type = maxversion.row_type and ABS(vt.version-maxversion.version) = '0'


--- Started join with setting table to fetch setting level pricing

version - 1 -- amenment in next version with addition in query

select tlcdata.*  from (select vt.vt_group_no, concat(vt.transaction_id, 'R') as transaction_id,vt.order_confirm_date, vt.created_date,vt.hotel_id, vt.channel_id, vt.ticketId, vt.ticketpriceschedule_id, vt.version, vt.row_type, vt.partner_gross_price, vt.partner_net_price, vt.order_currency_partner_gross_price, vt.order_currency_partner_net_price, vt.supplier_gross_price, vt.supplier_net_price, vt.col2, qc.cod_id as company_id, qc.channel_id as company_pricelist_id, qc.sub_catalog_id as company_sub_catalog, '---TLC LEVEL---' as Type, tlc.ticketpriceschedule_id as tlc_ticketpriceschedule_id, tlc.resale_currency_level, (case when vt.row_type = '1' then tlc.ticket_net_price when vt.row_type = '2' then tlc.museum_net_commission when vt.row_type = '17' then tlc.merchant_net_commission when vt.row_type = '3' then tlc.hotel_commission_net_price when vt.row_type = '4' then tlc.hgs_commission_net_price else 0 end) as tlc_commissions from visitor_tickets vt join (select vt_group_no, transaction_id,row_type, max(version) as version from visitor_tickets where created_date between '2024-03-10 00:00:01' and '2024-10-10 23:59:59' and ticketId in (2614) and vt_group_no = 171032183339123 group by vt_group_no, transaction_id, row_type) as maxversion on vt.vt_group_no = maxversion.vt_group_no and vt.transaction_id = maxversion.transaction_id and vt.row_type = maxversion.row_type and ABS(vt.version-maxversion.version) = '0' left join tmp.qr_codes qc on qc.cod_id = vt.hotel_id and qc.cashier_type = '1' left join tmp.ticket_level_commission tlc on tlc.hotel_id = vt.hotel_id and tlc.ticketpriceschedule_id = vt.ticketpriceschedule_id and tlc.ticket_id = vt.ticketId) as tlcdata


Verison - 2 Added subcatalog_join

select scdata.* from (select tlcdata.*, '----Sub catalog Level---' as type2, sc.catalog_id,sc.ticketpriceschedule_id as sc_ticketpriceschedule_id, sc.resale_currency_level as sc_resale_currency_level, (case when tlcdata.row_type = '1' then sc.ticket_net_price when tlcdata.row_type = '2' then sc.museum_net_commission when tlcdata.row_type = '17' then sc.merchant_net_commission when tlcdata.row_type = '3' then sc.hotel_commission_net_price when tlcdata.row_type = '4' then sc.hgs_commission_net_price else 0 end) as sucatalog_commissions   from (select vt.vt_group_no, concat(vt.transaction_id, 'R') as transaction_id,vt.order_confirm_date, vt.created_date,vt.hotel_id, vt.channel_id, vt.ticketId, vt.ticketpriceschedule_id, vt.version, vt.row_type, vt.partner_gross_price, vt.partner_net_price, vt.order_currency_partner_gross_price, vt.order_currency_partner_net_price, vt.supplier_gross_price, vt.supplier_net_price, vt.col2, qc.cod_id as company_id, qc.channel_id as company_pricelist_id, qc.sub_catalog_id as company_sub_catalog, '---TLC LEVEL---' as Type, tlc.ticketpriceschedule_id as tlc_ticketpriceschedule_id, tlc.resale_currency_level, (case when vt.row_type = '1' then tlc.ticket_net_price when vt.row_type = '2' then tlc.museum_net_commission when vt.row_type = '17' then tlc.merchant_net_commission when vt.row_type = '3' then tlc.hotel_commission_net_price when vt.row_type = '4' then tlc.hgs_commission_net_price else 0 end) as tlc_commissions from visitor_tickets vt join (select vt_group_no, transaction_id,row_type, max(version) as version from visitor_tickets where created_date between '2024-03-10 00:00:01' and '2024-10-10 23:59:59' and ticketId in (2614) and vt_group_no = 171032183339123 group by vt_group_no, transaction_id, row_type) as maxversion on vt.vt_group_no = maxversion.vt_group_no and vt.transaction_id = maxversion.transaction_id and vt.row_type = maxversion.row_type and ABS(vt.version-maxversion.version) = '0' left join tmp.qr_codes qc on qc.cod_id = vt.hotel_id and qc.cashier_type = '1' left join tmp.ticket_level_commission tlc on tlc.hotel_id = vt.hotel_id and tlc.ticketpriceschedule_id = vt.ticketpriceschedule_id and tlc.ticket_id = vt.ticketId) as tlcdata left join tmp.channel_level_commission sc on tlcdata.ticketpriceschedule_id = sc.ticketpriceschedule_id and tlcdata.ticketId = sc.ticket_id and if(tlcdata.company_sub_catalog = '0', 122222, tlcdata.company_sub_catalog) = sc.catalog_id) as scdata


Verison - 3 Added main_catalog_join

select * from (select scdata.*, '----Price List Level---' as type3,pl.ticketpriceschedule_id as clc_ticketpriceschedule_id,(case when scdata.row_type = '1' then pl.ticket_net_price when scdata.row_type = '2' then pl.museum_net_commission when scdata.row_type = '17' then pl.merchant_net_commission when scdata.row_type = '3' then pl.hotel_commission_net_price when scdata.row_type = '4' then pl.hgs_commission_net_price else 0 end) as pricelist_commissions  from (select tlcdata.*, '----Sub catalog Level---' as type2, sc.catalog_id,sc.ticketpriceschedule_id as sc_ticketpriceschedule_id, sc.resale_currency_level as sc_resale_currency_level, (case when tlcdata.row_type = '1' then sc.ticket_net_price when tlcdata.row_type = '2' then sc.museum_net_commission when tlcdata.row_type = '17' then sc.merchant_net_commission when tlcdata.row_type = '3' then sc.hotel_commission_net_price when tlcdata.row_type = '4' then sc.hgs_commission_net_price else 0 end) as sucatalog_commissions   from (select vt.vt_group_no, concat(vt.transaction_id, 'R') as transaction_id,vt.order_confirm_date, vt.created_date,vt.hotel_id, vt.channel_id, vt.ticketId, vt.ticketpriceschedule_id, vt.version, vt.row_type, vt.partner_gross_price, vt.partner_net_price, vt.order_currency_partner_gross_price, vt.order_currency_partner_net_price, vt.supplier_gross_price, vt.supplier_net_price, vt.col2, qc.cod_id as company_id, qc.channel_id as company_pricelist_id, qc.sub_catalog_id as company_sub_catalog, '---TLC LEVEL---' as Type, tlc.ticketpriceschedule_id as tlc_ticketpriceschedule_id, tlc.resale_currency_level, (case when vt.row_type = '1' then tlc.ticket_net_price when vt.row_type = '2' then tlc.museum_net_commission when vt.row_type = '17' then tlc.merchant_net_commission when vt.row_type = '3' then tlc.hotel_commission_net_price when vt.row_type = '4' then tlc.hgs_commission_net_price else 0 end) as tlc_commissions from visitor_tickets vt join (select vt_group_no, transaction_id,row_type, max(version) as version from visitor_tickets where created_date between '2024-03-10 00:00:01' and '2024-10-10 23:59:59' and ticketId in (3305) and vt_group_no = 171750806332229 group by vt_group_no, transaction_id, row_type) as maxversion on vt.vt_group_no = maxversion.vt_group_no and vt.transaction_id = maxversion.transaction_id and vt.row_type = maxversion.row_type and ABS(vt.version-maxversion.version) = '0' left join tmp.qr_codes qc on qc.cod_id = vt.hotel_id and qc.cashier_type = '1' left join tmp.ticket_level_commission tlc on tlc.hotel_id = vt.hotel_id and tlc.ticketpriceschedule_id = vt.ticketpriceschedule_id and tlc.ticket_id = vt.ticketId) as tlcdata left join tmp.channel_level_commission sc on tlcdata.ticketpriceschedule_id = sc.ticketpriceschedule_id and tlcdata.ticketId = sc.ticket_id and if(tlcdata.company_sub_catalog = '0', 122222, tlcdata.company_sub_catalog) = sc.catalog_id) as scdata left join tmp.channel_level_commission pl on scdata.ticketpriceschedule_id = pl.ticketpriceschedule_id and scdata.ticketId = pl.ticket_id and scdata.channel_id = pl.channel_id and pl.catalog_id = '0') as finalmismatch


Version - 4 Should be price included to find final mismatch

select * from (select *, (case when tlc_ticketpriceschedule_id is not NULL then tlc_commissions when tlc_ticketpriceschedule_id is NULL and sc_ticketpriceschedule_id is not NULL then sucatalog_commissions when tlc_ticketpriceschedule_id is NULL and sc_ticketpriceschedule_id is NULL and clc_ticketpriceschedule_id is not NULL then pricelist_commissions else 'No_Setting_found' end) as should_be from (select scdata.*, '----Price List Level---' as type3,pl.ticketpriceschedule_id as clc_ticketpriceschedule_id,(case when scdata.row_type = '1' then pl.ticket_net_price when scdata.row_type = '2' then pl.museum_net_commission when scdata.row_type = '17' then pl.merchant_net_commission when scdata.row_type = '3' then pl.hotel_commission_net_price when scdata.row_type = '4' then pl.hgs_commission_net_price else 0 end) as pricelist_commissions  from (select tlcdata.*, '----Sub catalog Level---' as type2, sc.catalog_id,sc.ticketpriceschedule_id as sc_ticketpriceschedule_id, sc.resale_currency_level as sc_resale_currency_level, (case when tlcdata.row_type = '1' then sc.ticket_net_price when tlcdata.row_type = '2' then sc.museum_net_commission when tlcdata.row_type = '17' then sc.merchant_net_commission when tlcdata.row_type = '3' then sc.hotel_commission_net_price when tlcdata.row_type = '4' then sc.hgs_commission_net_price else 0 end) as sucatalog_commissions   from (select vt.vt_group_no, concat(vt.transaction_id, 'R') as transaction_id,vt.order_confirm_date, vt.created_date,vt.hotel_id, vt.channel_id, vt.ticketId, vt.ticketpriceschedule_id, vt.version, vt.row_type, vt.partner_gross_price, vt.partner_net_price, vt.order_currency_partner_gross_price, vt.order_currency_partner_net_price, vt.supplier_gross_price, vt.supplier_net_price, vt.col2, qc.cod_id as company_id, qc.channel_id as company_pricelist_id, qc.sub_catalog_id as company_sub_catalog, '---TLC LEVEL---' as Type, tlc.ticketpriceschedule_id as tlc_ticketpriceschedule_id, tlc.resale_currency_level, (case when vt.row_type = '1' then tlc.ticket_net_price when vt.row_type = '2' then tlc.museum_net_commission when vt.row_type = '17' then tlc.merchant_net_commission when vt.row_type = '3' then tlc.hotel_commission_net_price when vt.row_type = '4' then tlc.hgs_commission_net_price else 0 end) as tlc_commissions from visitor_tickets vt join (select vt_group_no, transaction_id,row_type, max(version) as version from visitor_tickets where created_date between '2024-03-10 00:00:01' and '2024-10-10 23:59:59' and ticketId in (57354) and vt_group_no in (172045255276797,171025431591257,171727346539316,172053346499600,171141947172133,171574639920145,172704081562491,171163934037471,171536931080789,171986309649833,172100781072771,171351848854810,171433057167697,171242616086533,171741139833003,171185633076512,172156075664258,171472054427291,172547458139142,171994602778711,171930733511999,171011644400218,172578141163575,171563415795607,172409437657983,172685575287572,171738344350056,171915181827493,171297041994939,171694065980369,171372664507728,172359779009045,171009727210196,171328800669347,171913769909957,171233843827790,171695329843824,172302377028197,172712340166603,171614164484789,171680191898746,171542971521723,172314356772802,172667004798377,171261513579759,172493962896932,172489212878186,172227461759518,171820765792530,171967693251310) group by vt_group_no, transaction_id, row_type) as maxversion on vt.vt_group_no = maxversion.vt_group_no and vt.transaction_id = maxversion.transaction_id and vt.row_type = maxversion.row_type and ABS(vt.version-maxversion.version) = '0' left join tmp.qr_codes qc on qc.cod_id = vt.hotel_id and qc.cashier_type = '1' left join tmp.ticket_level_commission tlc on tlc.hotel_id = vt.hotel_id and tlc.ticketpriceschedule_id = vt.ticketpriceschedule_id and tlc.ticket_id = vt.ticketId) as tlcdata left join tmp.channel_level_commission sc on tlcdata.ticketpriceschedule_id = sc.ticketpriceschedule_id and tlcdata.ticketId = sc.ticket_id and if(tlcdata.company_sub_catalog = '0', 122222, tlcdata.company_sub_catalog) = sc.catalog_id) as scdata left join tmp.channel_level_commission pl on scdata.ticketpriceschedule_id = pl.ticketpriceschedule_id and scdata.ticketId = pl.ticket_id and scdata.channel_id = pl.channel_id and pl.catalog_id = '0') as shouldbe) as final where partner_net_price != should_be and should_be != 'No_Setting_found' and row_type != '1'

---- Select query to update records - combi case need to add

select vtt.transaction_id, vtt.version,vtt.row_type,vtt.partner_net_price, final.should_be, vtt.partner_gross_price,vtt.tax_value, final.should_be*(100+vtt.tax_value)/100, vtt.supplier_net_price, final.should_be, vtt.supplier_gross_price,vtt.supplier_tax_value, final.should_be*(100+vtt.supplier_tax_value)/100, vtt.action_performed, concat(vtt.action_performed, ', CSSCommission') from visitor_tickets vtt join (select *, (case when tlc_ticketpriceschedule_id is not NULL then tlc_commissions when tlc_ticketpriceschedule_id is NULL and sc_ticketpriceschedule_id is not NULL then sucatalog_commissions when tlc_ticketpriceschedule_id is NULL and sc_ticketpriceschedule_id is NULL and clc_ticketpriceschedule_id is not NULL then pricelist_commissions else 'No_Setting_found' end) as should_be from (select scdata.*, '----Price List Level---' as type3,pl.ticketpriceschedule_id as clc_ticketpriceschedule_id,(case when scdata.row_type = '1' then pl.ticket_net_price when scdata.row_type = '2' then pl.museum_net_commission when scdata.row_type = '17' then pl.merchant_net_commission when scdata.row_type = '3' then pl.hotel_commission_net_price when scdata.row_type = '4' then pl.hgs_commission_net_price else 0 end) as pricelist_commissions  from (select tlcdata.*, '----Sub catalog Level---' as type2, sc.catalog_id,sc.ticketpriceschedule_id as sc_ticketpriceschedule_id, sc.resale_currency_level as sc_resale_currency_level, (case when tlcdata.row_type = '1' then sc.ticket_net_price when tlcdata.row_type = '2' then sc.museum_net_commission when tlcdata.row_type = '17' then sc.merchant_net_commission when tlcdata.row_type = '3' then sc.hotel_commission_net_price when tlcdata.row_type = '4' then sc.hgs_commission_net_price else 0 end) as sucatalog_commissions   from (select vt.vt_group_no, concat(vt.transaction_id, 'R') as transaction_id,vt.order_confirm_date, vt.created_date,vt.hotel_id, vt.channel_id, vt.ticketId, vt.ticketpriceschedule_id, vt.version, vt.row_type, vt.partner_gross_price, vt.partner_net_price, vt.order_currency_partner_gross_price, vt.order_currency_partner_net_price, vt.supplier_gross_price, vt.supplier_net_price, vt.col2, qc.cod_id as company_id, qc.channel_id as company_pricelist_id, qc.sub_catalog_id as company_sub_catalog, '---TLC LEVEL---' as Type, tlc.ticketpriceschedule_id as tlc_ticketpriceschedule_id, tlc.resale_currency_level, (case when vt.row_type = '1' then tlc.ticket_net_price when vt.row_type = '2' then tlc.museum_net_commission when vt.row_type = '17' then tlc.merchant_net_commission when vt.row_type = '3' then tlc.hotel_commission_net_price when vt.row_type = '4' then tlc.hgs_commission_net_price else 0 end) as tlc_commissions from visitor_tickets vt join (select vt_group_no, transaction_id,row_type, max(version) as version from visitor_tickets where created_date between '2024-03-10 00:00:01' and '2024-10-10 23:59:59' and ticketId in (57354) and vt_group_no in (171242616086533) and col2!= '2' group by vt_group_no, transaction_id, row_type) as maxversion on vt.vt_group_no = maxversion.vt_group_no and vt.transaction_id = maxversion.transaction_id and vt.row_type = maxversion.row_type and ABS(vt.version-maxversion.version) = '0' left join tmp.qr_codes qc on qc.cod_id = vt.hotel_id and qc.cashier_type = '1' left join tmp.ticket_level_commission tlc on tlc.hotel_id = vt.hotel_id and tlc.ticketpriceschedule_id = vt.ticketpriceschedule_id and tlc.ticket_id = vt.ticketId where vt.col2 != '2') as tlcdata left join tmp.channel_level_commission sc on tlcdata.ticketpriceschedule_id = sc.ticketpriceschedule_id and tlcdata.ticketId = sc.ticket_id and if(tlcdata.company_sub_catalog = '0', 122222, tlcdata.company_sub_catalog) = sc.catalog_id) as scdata left join tmp.channel_level_commission pl on scdata.ticketpriceschedule_id = pl.ticketpriceschedule_id and scdata.ticketId = pl.ticket_id and scdata.channel_id = pl.channel_id and pl.catalog_id = '0') as shouldbe) as final on vtt.vt_group_no = final.vt_group_no and ABS(vtt.version-final.version) = '0' and vtt.transaction_id = final.transaction_id and vtt.row_type = final.row_type where final.partner_net_price != final.should_be and final.should_be != 'No_Setting_found' and final.row_type != '1'

----- Final update combi case need to add

update visitor_tickets vtt join (select *, (case when tlc_ticketpriceschedule_id is not NULL then tlc_commissions when tlc_ticketpriceschedule_id is NULL and sc_ticketpriceschedule_id is not NULL then sucatalog_commissions when tlc_ticketpriceschedule_id is NULL and sc_ticketpriceschedule_id is NULL and clc_ticketpriceschedule_id is not NULL then pricelist_commissions else 'No_Setting_found' end) as should_be from (select scdata.*, '----Price List Level---' as type3,pl.ticketpriceschedule_id as clc_ticketpriceschedule_id,(case when scdata.row_type = '1' then pl.ticket_net_price when scdata.row_type = '2' then pl.museum_net_commission when scdata.row_type = '17' then pl.merchant_net_commission when scdata.row_type = '3' then pl.hotel_commission_net_price when scdata.row_type = '4' then pl.hgs_commission_net_price else 0 end) as pricelist_commissions  from (select tlcdata.*, '----Sub catalog Level---' as type2, sc.catalog_id,sc.ticketpriceschedule_id as sc_ticketpriceschedule_id, sc.resale_currency_level as sc_resale_currency_level, (case when tlcdata.row_type = '1' then sc.ticket_net_price when tlcdata.row_type = '2' then sc.museum_net_commission when tlcdata.row_type = '17' then sc.merchant_net_commission when tlcdata.row_type = '3' then sc.hotel_commission_net_price when tlcdata.row_type = '4' then sc.hgs_commission_net_price else 0 end) as sucatalog_commissions   from (select vt.vt_group_no, concat(vt.transaction_id, 'R') as transaction_id,vt.order_confirm_date, vt.created_date,vt.hotel_id, vt.channel_id, vt.ticketId, vt.ticketpriceschedule_id, vt.version, vt.row_type, vt.partner_gross_price, vt.partner_net_price, vt.order_currency_partner_gross_price, vt.order_currency_partner_net_price, vt.supplier_gross_price, vt.supplier_net_price, vt.col2, qc.cod_id as company_id, qc.channel_id as company_pricelist_id, qc.sub_catalog_id as company_sub_catalog, '---TLC LEVEL---' as Type, tlc.ticketpriceschedule_id as tlc_ticketpriceschedule_id, tlc.resale_currency_level, (case when vt.row_type = '1' then tlc.ticket_net_price when vt.row_type = '2' then tlc.museum_net_commission when vt.row_type = '17' then tlc.merchant_net_commission when vt.row_type = '3' then tlc.hotel_commission_net_price when vt.row_type = '4' then tlc.hgs_commission_net_price else 0 end) as tlc_commissions from visitor_tickets vt join (select vt_group_no, transaction_id,row_type, max(version) as version from visitor_tickets where created_date between '2024-03-10 00:00:01' and '2024-10-10 23:59:59' and ticketId in (3305) and vt_group_no in (171606095880779) and col2!= '2' group by vt_group_no, transaction_id, row_type) as maxversion on vt.vt_group_no = maxversion.vt_group_no and vt.transaction_id = maxversion.transaction_id and vt.row_type = maxversion.row_type and ABS(vt.version-maxversion.version) = '0' left join tmp.qr_codes qc on qc.cod_id = vt.hotel_id and qc.cashier_type = '1' left join tmp.ticket_level_commission tlc on tlc.hotel_id = vt.hotel_id and tlc.ticketpriceschedule_id = vt.ticketpriceschedule_id and tlc.ticket_id = vt.ticketId where vt.col2 != '2') as tlcdata left join tmp.channel_level_commission sc on tlcdata.ticketpriceschedule_id = sc.ticketpriceschedule_id and tlcdata.ticketId = sc.ticket_id and if(tlcdata.company_sub_catalog = '0', 122222, tlcdata.company_sub_catalog) = sc.catalog_id) as scdata left join tmp.channel_level_commission pl on scdata.ticketpriceschedule_id = pl.ticketpriceschedule_id and scdata.ticketId = pl.ticket_id and scdata.channel_id = pl.channel_id and pl.catalog_id = '0') as shouldbe) as final on vtt.vt_group_no = final.vt_group_no and ABS(vtt.version-final.version) = '0' and vtt.transaction_id = final.transaction_id and vtt.row_type = final.row_type set vtt.partner_net_price = final.should_be, vtt.partner_gross_price = final.should_be*(100+vtt.tax_value)/100, vtt.supplier_net_price = final.should_be, vtt.supplier_gross_price = final.should_be*(100+vtt.supplier_tax_value)/100, vtt.action_performed = concat(vtt.action_performed, ', CSSCommission') where final.partner_net_price != final.should_be and final.should_be != 'No_Setting_found' and final.row_type != '1'


----- Update Prepaid_tickets

UPDATE
    prepaid_tickets pt join (SELECT
            transaction_id,
            vt_group_no,
            version,
            ticketId,
            MAX(
                CASE WHEN row_type = '1' THEN partner_net_price ELSE 0
            END
    ) AS sale_price,
    MAX(
        CASE WHEN row_type = '2' THEN partner_net_price ELSE 0
    END
) AS purchase_price,
MAX(
    CASE WHEN row_type = '3' THEN partner_net_price ELSE 0
END
) AS distributor_fee,
MAX(
    CASE WHEN row_type = '4' THEN partner_net_price ELSE 0
END
) AS hgs_fee,
MAX(
    CASE WHEN row_type = '17' THEN partner_net_price ELSE 0
END
) AS merchant_fee,
MAX(
    CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0
END
) AS sale_priceg,
MAX(
    CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0
END
) AS purchase_priceg,
MAX(
    CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0
END
) AS distributor_feeg,
MAX(
    CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0
END
) AS hgs_feeg
FROM
    visitor_tickets
WHERE
    vt_group_no in (171242616086533) and action_performed like '%CSSCommission'
GROUP BY
    vt_group_no,
    transaction_id,
    ticketpriceschedule_id) as aggt ON
    pt.visitor_group_no = aggt.vt_group_no AND pt.prepaid_ticket_id = aggt.transaction_id and ABS((pt.version+1)-aggt.version) = '0' SET
    pt.museum_net_fee = aggt.purchase_price,
    pt.distributor_net_fee = aggt.distributor_fee,
    pt.hgs_net_fee = aggt.hgs_fee,
    pt.museum_gross_fee = aggt.purchase_priceg,
    pt.distributor_gross_fee = aggt.distributor_feeg,
    pt.hgs_gross_fee = aggt.hgs_feeg


---- Preparion for Insert query---- combi case need to add

insert into visitor_tickets (id, created_date, transaction_id, invoice_id, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, financial_id, financial_name, transaction_type_name, transaction_type_id, ticketId, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, ticket_title, ticketwithdifferentpricing, ticketpriceschedule_id, ticket_extra_option_id, group_type_ticket, group_price, group_quantity, group_linked_with, selected_date, booking_selected_date, from_time, to_time, slot_type, amount_before_extra_discount, discount_before_extra_discount, hto_id, visitor_group_no, roomNo, nights, user_age, gender, user_image, visitor_country, merchantAccountCode, merchantReference, original_pspReference, shopperReference, partner_id, relational_partner_id, partner_name, museum_name, museum_id, hotel_name, hotel_id, pos_point_id, pos_point_name, shift_id, passNo, pass_type, ticketAmt, visit_date, visit_date_time, ticketType, tickettype_name, discount_applied_on_how_many_tickets, paid, payment_method, isBillToHotel, card_name, pspReference, card_type, captured, age_group, discount, isDiscountInPercent, updated_discount_type, without_elo_reference_no, debitor, creditor, split_cash_amount, split_card_amount, split_voucher_amount, split_direct_payment_amount, total_gross_commission, total_net_commission, commission_type, partner_gross_price, order_currency_partner_gross_price, partner_gross_price_without_combi_discount, partner_net_price, order_currency_partner_net_price, partner_net_price_without_combi_discount, isCommissionInPercent, tax_id, tax_value, tax_name, timezone, invoice_status, row_type, updated_by_id, updated_by_username, voucher_updated_by, voucher_updated_by_name, redeem_method, redeem_by_ticket_id, redeem_by_ticket_title, cashier_id, cashier_name, cashier_register_id, targetlocation, paymentMethodType, targetcity, service_name, adjustment_row_type, description, distributor_status, adyen_status, adjustment_method, all_ticket_ids, time_based_done, visitor_invoice_id, ticketPrice, deleted, is_refunded, is_block, is_edited, vt_group_no, user_name, issuer_country_code, distributor_commission_invoice, activation_method, is_prioticket, is_shop_product, shop_category_name, external_account_number, used, ticket_status, is_prepaid, is_purchased_with_postpaid, invoice_type, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, invoice_variant, service_cost, service_cost_net_amount, service_cost_type, scanned_pass, groupTransactionId, booking_status, channel_type, is_voucher, extra_text_field_answer, distributor_type, distributor_partner_id, distributor_partner_name, issuer_country_name, chart_number, extra_discount, manual_payment_note, account_number, is_custom_setting, external_product_id, supplier_currency_code, col1, col2, partner_category_id, col4, partner_category_name, col6, col7, col8, is_data_moved, action_performed, updated_at, tp_payment_method, order_confirm_date, payment_date, order_cancellation_date, voucher_creation_date, primary_host_name,supplier_gross_price, supplier_discount, supplier_ticket_amt, supplier_tax_value,supplier_net_price, last_modified_at, market_merchant_id, merchant_admin_id, order_updated_cashier_id, order_updated_cashier_name, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code) select vtf.id, vtf.created_date, vtf.transaction_id, vtf.invoice_id, vtf.channel_id, vtf.channel_name, vtf.reseller_id, vtf.reseller_name, vtf.saledesk_id, vtf.saledesk_name, vtf.financial_id, vtf.financial_name, vtf.transaction_type_name, vtf.transaction_type_id, vtf.ticketId, vtf.shared_capacity_id, vtf.ticket_booking_id, vtf.related_order_id, vtf.related_booking_id, vtf.ticket_title, vtf.ticketwithdifferentpricing, vtf.ticketpriceschedule_id, vtf.ticket_extra_option_id, vtf.group_type_ticket, vtf.group_price, vtf.group_quantity, vtf.group_linked_with, vtf.selected_date, vtf.booking_selected_date, vtf.from_time, vtf.to_time, vtf.slot_type, vtf.amount_before_extra_discount, vtf.discount_before_extra_discount, vtf.hto_id, vtf.visitor_group_no, vtf.roomNo, vtf.nights, vtf.user_age, vtf.gender, vtf.user_image, vtf.visitor_country, vtf.merchantAccountCode, vtf.merchantReference, vtf.original_pspReference, vtf.shopperReference, vtf.partner_id, vtf.relational_partner_id, vtf.partner_name, vtf.museum_name, vtf.museum_id, vtf.hotel_name, vtf.hotel_id, vtf.pos_point_id, vtf.pos_point_name, vtf.shift_id, vtf.passNo, vtf.pass_type, vtf.ticketAmt, vtf.visit_date, vtf.visit_date_time, vtf.ticketType, vtf.tickettype_name, vtf.discount_applied_on_how_many_tickets, vtf.paid, vtf.payment_method, vtf.isBillToHotel, vtf.card_name, vtf.pspReference, vtf.card_type, vtf.captured, vtf.age_group, vtf.discount, vtf.isDiscountInPercent, vtf.updated_discount_type, vtf.without_elo_reference_no, vtf.debitor, vtf.creditor, vtf.split_cash_amount, vtf.split_card_amount, vtf.split_voucher_amount, vtf.split_direct_payment_amount, vtf.total_gross_commission, vtf.total_net_commission, vtf.commission_type, (case when vtf.row_type = ddd.ddd_row_type then ROUND(ddd.ddd_gross_should_be,2) else ROUND(vtf.partner_gross_price,2) end) as partner_gross_price, vtf.order_currency_partner_gross_price, vtf.partner_gross_price_without_combi_discount, (case when vtf.row_type = ddd.ddd_row_type then ROUND(ddd.ddd_should_be_net,2) else ROUND(vtf.partner_net_price,2) end) as partner_net_price, vtf.order_currency_partner_net_price, vtf.partner_net_price_without_combi_discount, vtf.isCommissionInPercent, vtf.tax_id, vtf.tax_value, vtf.tax_name, vtf.timezone, vtf.invoice_status, vtf.row_type, vtf.updated_by_id, vtf.updated_by_username, vtf.voucher_updated_by, vtf.voucher_updated_by_name, vtf.redeem_method, vtf.redeem_by_ticket_id, vtf.redeem_by_ticket_title, vtf.cashier_id, vtf.cashier_name, vtf.cashier_register_id, vtf.targetlocation, vtf.paymentMethodType, vtf.targetcity, vtf.service_name, vtf.adjustment_row_type, vtf.description, vtf.distributor_status, vtf.adyen_status, vtf.adjustment_method, vtf.all_ticket_ids, vtf.time_based_done, vtf.visitor_invoice_id, vtf.ticketPrice, vtf.deleted, vtf.is_refunded, vtf.is_block, vtf.is_edited, vtf.vt_group_no, vtf.user_name, vtf.issuer_country_code, vtf.distributor_commission_invoice, vtf.activation_method, vtf.is_prioticket, vtf.is_shop_product, vtf.shop_category_name, vtf.external_account_number, vtf.used, vtf.ticket_status, vtf.is_prepaid, vtf.is_purchased_with_postpaid, vtf.invoice_type, vtf.supplier_currency_symbol, vtf.order_currency_code, vtf.order_currency_symbol, vtf.currency_rate, vtf.invoice_variant, vtf.service_cost, vtf.service_cost_net_amount, vtf.service_cost_type, vtf.scanned_pass, vtf.groupTransactionId, vtf.booking_status, vtf.channel_type, vtf.is_voucher, vtf.extra_text_field_answer, vtf.distributor_type, vtf.distributor_partner_id, vtf.distributor_partner_name, vtf.issuer_country_name, vtf.chart_number, vtf.extra_discount, vtf.manual_payment_note, vtf.account_number, vtf.is_custom_setting, vtf.external_product_id, vtf.supplier_currency_code, vtf.col1, vtf.col2, vtf.partner_category_id, vtf.col4, vtf.partner_category_name, vtf.col6, vtf.col7, vtf.col8, vtf.is_data_moved,(case when vtf.row_type = ddd.ddd_row_type then ddd.dd_action_performed_should_be else vtf.action_performed end) as action_performed, vtf.updated_at, vtf.tp_payment_method, vtf.order_confirm_date, vtf.payment_date, vtf.order_cancellation_date, vtf.voucher_creation_date, vtf.primary_host_name,(case when vtf.row_type = ddd.ddd_row_type then ROUND(ddd.dd_supplier_gross_should_be,2) else ROUND(vtf.supplier_gross_price,2) end) as supplier_gross_price, vtf.supplier_discount, vtf.supplier_ticket_amt, vtf.supplier_tax_value, (case when vtf.row_type = ddd.ddd_row_type then ROUND(ddd.dd_supplier_net_should_be,2) else ROUND(vtf.supplier_net_price,2) end) as supplier_net_price, CURRENT_TIMESTAMP as last_modified_at, vtf.market_merchant_id, vtf.merchant_admin_id, vtf.order_updated_cashier_id, vtf.order_updated_cashier_name, ROUND(vtf.version+1,1) as version, vtf.supplier_tax_id, vtf.merchant_currency_code, vtf.merchant_price, vtf.merchant_net_price, vtf.merchant_tax_id, vtf.admin_currency_code from (select fvt.* from visitor_tickets fvt join (select vt_group_no, transaction_id,row_type, max(version) as version from visitor_tickets where ticketId in (57354) and vt_group_no in (171242616086533) and col2 != '2' group by vt_group_no, transaction_id, row_type) as mv on mv.vt_group_no = fvt.vt_group_no and fvt.transaction_id = mv.transaction_id and fvt.row_type = mv.row_type and ABS(fvt.version-mv.version) = '0' where fvt.col2 != '2') vtf left join (select vtt.vt_group_no as ddd_vt_group_no, vtt.transaction_id as ddd_transaction_id, vtt.version as ddd_version,vtt.row_type as ddd_row_type,vtt.partner_net_price as ddd_partner_net_price, final.should_be as ddd_should_be_net, vtt.partner_gross_price as ddd_partner_gross_price,vtt.tax_value as ddd_tax_value, final.should_be*(100+vtt.tax_value)/100 as ddd_gross_should_be, vtt.supplier_net_price as ddd_supplier_bet_price, final.should_be as dd_supplier_net_should_be, vtt.supplier_gross_price as ddd_supplier_gross_price,vtt.supplier_tax_value as ddd_supplier_tax, final.should_be*(100+vtt.supplier_tax_value)/100 as dd_supplier_gross_should_be, vtt.action_performed as dd_action_performed, concat(vtt.action_performed, ', CSSCommission') as dd_action_performed_should_be from visitor_tickets vtt join (select *, (case when tlc_ticketpriceschedule_id is not NULL then tlc_commissions when tlc_ticketpriceschedule_id is NULL and sc_ticketpriceschedule_id is not NULL then sucatalog_commissions when tlc_ticketpriceschedule_id is NULL and sc_ticketpriceschedule_id is NULL and clc_ticketpriceschedule_id is not NULL then pricelist_commissions else 'No_Setting_found' end) as should_be from (select scdata.*, '----Price List Level---' as type3,pl.ticketpriceschedule_id as clc_ticketpriceschedule_id,(case when scdata.row_type = '1' then pl.ticket_net_price when scdata.row_type = '2' then pl.museum_net_commission when scdata.row_type = '17' then pl.merchant_net_commission when scdata.row_type = '3' then pl.hotel_commission_net_price when scdata.row_type = '4' then pl.hgs_commission_net_price else 0 end) as pricelist_commissions  from (select tlcdata.*, '----Sub catalog Level---' as type2, sc.catalog_id,sc.ticketpriceschedule_id as sc_ticketpriceschedule_id, sc.resale_currency_level as sc_resale_currency_level, (case when tlcdata.row_type = '1' then sc.ticket_net_price when tlcdata.row_type = '2' then sc.museum_net_commission when tlcdata.row_type = '17' then sc.merchant_net_commission when tlcdata.row_type = '3' then sc.hotel_commission_net_price when tlcdata.row_type = '4' then sc.hgs_commission_net_price else 0 end) as sucatalog_commissions   from (select vt.vt_group_no, concat(vt.transaction_id, 'R') as transaction_id,vt.order_confirm_date, vt.created_date,vt.hotel_id, vt.channel_id, vt.ticketId, vt.ticketpriceschedule_id, vt.version, vt.row_type, vt.partner_gross_price, vt.partner_net_price, vt.order_currency_partner_gross_price, vt.order_currency_partner_net_price, vt.supplier_gross_price, vt.supplier_net_price, vt.col2, qc.cod_id as company_id, qc.channel_id as company_pricelist_id, qc.sub_catalog_id as company_sub_catalog, '---TLC LEVEL---' as Type, tlc.ticketpriceschedule_id as tlc_ticketpriceschedule_id, tlc.resale_currency_level, (case when vt.row_type = '1' then tlc.ticket_net_price when vt.row_type = '2' then tlc.museum_net_commission when vt.row_type = '17' then tlc.merchant_net_commission when vt.row_type = '3' then tlc.hotel_commission_net_price when vt.row_type = '4' then tlc.hgs_commission_net_price else 0 end) as tlc_commissions from visitor_tickets vt join (select vt_group_no, transaction_id,row_type, max(version) as version from visitor_tickets where created_date between '2024-03-10 00:00:01' and '2024-10-10 23:59:59' and ticketId in (57354) and vt_group_no in (171242616086533) and col2 != '2' group by vt_group_no, transaction_id, row_type) as maxversion on vt.vt_group_no = maxversion.vt_group_no and vt.transaction_id = maxversion.transaction_id and vt.row_type = maxversion.row_type and ABS(vt.version-maxversion.version) = '0' left join tmp.qr_codes qc on qc.cod_id = vt.hotel_id and qc.cashier_type = '1' left join tmp.ticket_level_commission tlc on tlc.hotel_id = vt.hotel_id and tlc.ticketpriceschedule_id = vt.ticketpriceschedule_id and tlc.ticket_id = vt.ticketId where vt.col2 != '2') as tlcdata left join tmp.channel_level_commission sc on tlcdata.ticketpriceschedule_id = sc.ticketpriceschedule_id and tlcdata.ticketId = sc.ticket_id and if(tlcdata.company_sub_catalog = '0', 122222, tlcdata.company_sub_catalog) = sc.catalog_id) as scdata left join tmp.channel_level_commission pl on scdata.ticketpriceschedule_id = pl.ticketpriceschedule_id and scdata.ticketId = pl.ticket_id and scdata.channel_id = pl.channel_id and pl.catalog_id = '0') as shouldbe) as final on vtt.vt_group_no = final.vt_group_no and ABS(vtt.version-final.version) = '0' and vtt.transaction_id = final.transaction_id and vtt.row_type = final.row_type where final.partner_net_price != final.should_be and final.should_be != 'No_Setting_found' and final.row_type != '1' and vtt.col2 != '2') as ddd on ddd.ddd_vt_group_no = vtf.vt_group_no and (ddd.ddd_transaction_id+1) = (vtf.transaction_id+1) and ABS(ddd.ddd_version - vtf.version) = '0' and vtf.row_type = ddd.ddd_row_type



---- prepare insert query prepaid_tickets combi case need to add

insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, unlock, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', CSSCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171242616086533) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (171242616086533) and action_performed like '%CSSCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0'

Steps: 

1. Get All orders and ticket id which provided in jira card : Around 3.50 lacs orders

2. Need to check for which distrutors these products are enabled

3. After that need to get channel_id and catalog_id linked with that distributor

4. Get commission for each product and distributor on each different level  i.e. account level, sub catalog level and default level

5. Then prepare list of final data which we need to apply as per pricing hierarchy

6. Then update records in the visitor_tickets for partner_gross_price and partner_net_price

7. After update all these records also need to update the fees column in the prepaid_tickets as well



----- Debugging query




-- pt vt mismatch

select * from (select vtf.*, case when vtf.row_type =1 then vtf.partner_net_price when vtf.row_type = '2' then ptf.museum_net_fee when vtf.row_type = '3' then ptf.distributor_net_fee when vtf.row_type = 4 then ptf.hgs_net_fee when vtf.row_type =17 then vtf.partner_net_price else 0 end as pt_net_fee, case when vtf.row_type =1 then vtf.partner_gross_price when vtf.row_type = '2' then ptf.museum_gross_fee when vtf.row_type = '3' then ptf.distributor_gross_fee when vtf.row_type = 4 then ptf.hgs_gross_fee when vtf.row_type =17 then vtf.partner_gross_price else 0 end as pt_gross_fee from (select vt.vt_group_no,vt.transaction_id, vt.row_type, vt.version, vt.partner_net_price, ROUND(vt.partner_net_price*(100+vt.tax_value)/100,2) as partner_gross_price from visitor_tickets vt join (select vt_group_no, transaction_id, row_type, max(version) as version  from visitor_tickets where vt_group_no = '171526537331722' and col2 != '2' group by vt_group_no, transaction_id, row_type) as maxv on maxv.vt_group_no = vt.vt_group_no and maxv.transaction_id = vt.transaction_id and maxv.row_type = vt.row_type and ABS(ROUND(maxv.version-vt.version,1)) = '0') as vtf left join (select pt.visitor_group_no, pt.prepaid_ticket_id, pt.museum_net_fee, pt.museum_gross_fee, pt.distributor_net_fee, pt.distributor_gross_fee, pt.hgs_net_fee, pt.hgs_gross_fee from prepaid_tickets pt join (select visitor_group_no,prepaid_ticket_id, max(version) as version from prepaid_tickets where visitor_group_no in (171526537331722) and is_addon_ticket != '2' group by prepaid_ticket_id, visitor_group_no) as maxptv on maxptv.visitor_group_no = pt.visitor_group_no and maxptv.prepaid_ticket_id = pt.prepaid_ticket_id and ABS(ROUND(maxptv.version-pt.version,1)) = '0') as ptf on vtf.vt_group_no = ptf.visitor_group_no and vtf.transaction_id = ptf.prepaid_ticket_id) as final where partner_net_price != pt_net_fee or partner_gross_price != pt_gross_fee


SELECT * FROM `orders` where ticketid != '3305' and status = '1' 


CLC- Difference

select * from (SELECT channel_level_commission_id, channel_id, catalog_id, ticket_id, ticketpriceschedule_id, ticket_type, currency, resale_currency_level, ticket_list_price, ticket_new_price, ticket_discount, is_discount_in_percent, ticket_gross_price, ticket_net_price, museum_gross_commission, museum_net_commission,is_resale_percentage,resale_percentage, is_merchant_fee_percentage,merchant_fee_percentage,merchant_gross_commission, merchant_net_commission, subtotal_gross_amount, subtotal_net_amount, hotel_prepaid_commission_percentage, hgs_prepaid_commission_percentage,commission_on_sale_price, is_hotel_prepaid_commission_percentage, hotel_commission_gross_price, hotel_commission_net_price, hgs_commission_gross_price, hgs_commission_net_price, hotel_commission_tax_value, hgs_commission_tax_value FROM channel_level_commission where ticket_id in (2614,2901,2907,2909,2913,2917,2963,2965,3213,3221,3227,3237,3241,3243,3245,3247,3249,3251,3253,3257,3269,3273,3285,3289,3343,3345,3389,3453,3455,3557,3571,3575,3579,3621,6547,6664,6667,7895,8090,9721,10813,10816,10819,10822,10825,10831,10834,10837,10840,10843,10846,10852,10855,10858,10861,10900,10906,10909,10912,10915,10918,10921,10924,10927,10930,10933,10936,10939,10942,10945,11107,11119,11122,11125,11128,11167,11707,11710,11716,11719,13073,13076,13082,13166,13487,13490,13493,13502,13511,15644,16547,16685,16688,16691,16706,16709,16712,16715,16718,17369,17372,17375,17378,17381,17384,17387,17390,17837,17984,18209,18215,18221,18729,21921,22061,22494,22495,22900,22972,22974,22975,22977,22978,24453,25149,25150,25151,25524,26659,28194,28196,28200,29155,29157,29159,29399,35357,35359,35361,35363,35367,35381,36438,36440,38570,38928,39306,40872,41520,41802,41804,41806,43874,43876,44598,45558,46185,46187,46189,46335,46353,46355,46443,47145,47453,47459,48341,48343,49099,51637,52617,53111,56065,56935,56936,57012,57013,57014,57015,57016,57017,57354,57618,58310,59456,59457,60740,60741,60742,61431,62917,62918,63056,63102,63450,63452,63453,63454,64069,64070,64071,64072,64073,64074,64075,64076,64077,64078,64079,64335,64878,64879,65322,65323,65366,65592,65726,65727,65771,65996,65997,66186,66187,66189,66190,66191,66333,67048,67233,67459,67460,67546,67547,67596,67629,67630,67631,67632,67633,67635,67689,67690,67984,67985,67986,67987,67988,67989,67990,67991,67992,67993,68833,68834,68835,68836,69215,69699,70232,70559,70812,70813,71615,71616,72778,72780,72781,72782,72783,72784,73759,74334,74335,74336,77225,77241,2871,2618,2616,3225,3231,3565,3675,3315,3317,3319,4534,3441,5578,3615,2806,2929,2915,2921,3553,3567,3569,3263,3687,3573,3293,3301,3303,3309,3585,3311,3313,3537,3801,3775,3551,4120,3211,3281,3235,3239,3277,3279,3291,3297,3299,3223,6100,2887,3563,3449,2999,4118,3349,6550,6565,6568,6691,6712,7898,9718,9751,9850,9853,9856,9895,2830,2828,2927,3305,10810) and ticket_type not like '%infant%' and deleted = '0'  group by channel_level_commission_id having ABS(ticket_net_price-museum_net_commission-merchant_net_commission-hotel_commission_net_price-hgs_commission_net_price) > '0.05') as base


select * from (SELECT is_merchant_fee_percentage, merchant_fee_percentage, channel_level_commission_id, channel_id, catalog_id, ticket_id, ticketpriceschedule_id, ticket_type, currency, resale_currency_level, ticket_list_price, ticket_new_price, ticket_discount, is_discount_in_percent, ticket_gross_price, ticket_net_price, museum_gross_commission, museum_net_commission,is_resale_percentage,resale_percentage, merchant_gross_commission, merchant_net_commission, subtotal_gross_amount, subtotal_net_amount, hotel_prepaid_commission_percentage, hgs_prepaid_commission_percentage,commission_on_sale_price, is_hotel_prepaid_commission_percentage, hotel_commission_gross_price, hotel_commission_net_price, hgs_commission_gross_price, hgs_commission_net_price, hotel_commission_tax_value, hgs_commission_tax_value FROM channel_level_commission where ticket_id in (2614,2901,2907,2909,2913,2917,2963,2965,3213,3221,3227,3237,3241,3243,3245,3247,3249,3251,3253,3257,3269,3273,3285,3289,3343,3345,3389,3453,3455,3557,3571,3575,3579,3621,6547,6664,6667,7895,8090,9721,10813,10816,10819,10822,10825,10831,10834,10837,10840,10843,10846,10852,10855,10858,10861,10900,10906,10909,10912,10915,10918,10921,10924,10927,10930,10933,10936,10939,10942,10945,11107,11119,11122,11125,11128,11167,11707,11710,11716,11719,13073,13076,13082,13166,13487,13490,13493,13502,13511,15644,16547,16685,16688,16691,16706,16709,16712,16715,16718,17369,17372,17375,17378,17381,17384,17387,17390,17837,17984,18209,18215,18221,18729,21921,22061,22494,22495,22900,22972,22974,22975,22977,22978,24453,25149,25150,25151,25524,26659,28194,28196,28200,29155,29157,29159,29399,35357,35359,35361,35363,35367,35381,36438,36440,38570,38928,39306,40872,41520,41802,41804,41806,43874,43876,44598,45558,46185,46187,46189,46335,46353,46355,46443,47145,47453,47459,48341,48343,49099,51637,52617,53111,56065,56935,56936,57012,57013,57014,57015,57016,57017,57354,57618,58310,59456,59457,60740,60741,60742,61431,62917,62918,63056,63102,63450,63452,63453,63454,64069,64070,64071,64072,64073,64074,64075,64076,64077,64078,64079,64335,64878,64879,65322,65323,65366,65592,65726,65727,65771,65996,65997,66186,66187,66189,66190,66191,66333,67048,67233,67459,67460,67546,67547,67596,67629,67630,67631,67632,67633,67635,67689,67690,67984,67985,67986,67987,67988,67989,67990,67991,67992,67993,68833,68834,68835,68836,69215,69699,70232,70559,70812,70813,71615,71616,72778,72780,72781,72782,72783,72784,73759,74334,74335,74336,77225,77241,2871,2618,2616,3225,3231,3565,3675,3315,3317,3319,4534,3441,5578,3615,2806,2929,2915,2921,3553,3567,3569,3263,3687,3573,3293,3301,3303,3309,3585,3311,3313,3537,3801,3775,3551,4120,3211,3281,3235,3239,3277,3279,3291,3297,3299,3223,6100,2887,3563,3449,2999,4118,3349,6550,6565,6568,6691,6712,7898,9718,9751,9850,9853,9856,9895,2830,2828,2927,3305,10810) and ticket_type not like '%infant%' and deleted = '0'  group by channel_level_commission_id having ABS(ticket_net_price-museum_net_commission-merchant_net_commission-hotel_commission_net_price-hgs_commission_net_price) > '0.05') as base where is_resale_percentage = '1' and is_merchant_fee_percentage = '1' and is_hotel_prepaid_commission_percentage = '1' and hotel_prepaid_commission_percentage+resale_percentage+merchant_fee_percentage<='100'


select * from (SELECT ticket_level_commission_id, hotel_id, catalog_id, ticket_id, ticketpriceschedule_id, ticket_type, currency, resale_currency_level, ticket_list_price, ticket_new_price, ticket_discount, is_discount_in_percent, ticket_gross_price, ticket_net_price, is_resale_percentage, resale_percentage,museum_gross_commission, museum_net_commission,is_merchant_fee_percentage,merchant_fee_percentage, merchant_gross_commission, merchant_net_commission, subtotal_gross_amount, subtotal_net_amount,commission_on_sale_price, is_hotel_prepaid_commission_percentage, hotel_prepaid_commission_percentage, hgs_prepaid_commission_percentage, hotel_commission_gross_price, hotel_commission_net_price, hgs_commission_gross_price, hgs_commission_net_price FROM  ticket_level_commission where ticket_id in (2614,2901,2907,2909,2913,2917,2963,2965,3213,3221,3227,3237,3241,3243,3245,3247,3249,3251,3253,3257,3269,3273,3285,3289,3343,3345,3389,3453,3455,3557,3571,3575,3579,3621,6547,6664,6667,7895,8090,9721,10813,10816,10819,10822,10825,10831,10834,10837,10840,10843,10846,10852,10855,10858,10861,10900,10906,10909,10912,10915,10918,10921,10924,10927,10930,10933,10936,10939,10942,10945,11107,11119,11122,11125,11128,11167,11707,11710,11716,11719,13073,13076,13082,13166,13487,13490,13493,13502,13511,15644,16547,16685,16688,16691,16706,16709,16712,16715,16718,17369,17372,17375,17378,17381,17384,17387,17390,17837,17984,18209,18215,18221,18729,21921,22061,22494,22495,22900,22972,22974,22975,22977,22978,24453,25149,25150,25151,25524,26659,28194,28196,28200,29155,29157,29159,29399,35357,35359,35361,35363,35367,35381,36438,36440,38570,38928,39306,40872,41520,41802,41804,41806,43874,43876,44598,45558,46185,46187,46189,46335,46353,46355,46443,47145,47453,47459,48341,48343,49099,51637,52617,53111,56065,56935,56936,57012,57013,57014,57015,57016,57017,57354,57618,58310,59456,59457,60740,60741,60742,61431,62917,62918,63056,63102,63450,63452,63453,63454,64069,64070,64071,64072,64073,64074,64075,64076,64077,64078,64079,64335,64878,64879,65322,65323,65366,65592,65726,65727,65771,65996,65997,66186,66187,66189,66190,66191,66333,67048,67233,67459,67460,67546,67547,67596,67629,67630,67631,67632,67633,67635,67689,67690,67984,67985,67986,67987,67988,67989,67990,67991,67992,67993,68833,68834,68835,68836,69215,69699,70232,70559,70812,70813,71615,71616,72778,72780,72781,72782,72783,72784,73759,74334,74335,74336,77225,77241,2871,2618,2616,3225,3231,3565,3675,3315,3317,3319,4534,3441,5578,3615,2806,2929,2915,2921,3553,3567,3569,3263,3687,3573,3293,3301,3303,3309,3585,3311,3313,3537,3801,3775,3551,4120,3211,3281,3235,3239,3277,3279,3291,3297,3299,3223,6100,2887,3563,3449,2999,4118,3349,6550,6565,6568,6691,6712,7898,9718,9751,9850,9853,9856,9895,2830,2828,2927,3305,10810) and ticket_type not like '%infant%' and deleted = '0'  group by ticket_level_commission_id having ABS(ticket_net_price-museum_net_commission-merchant_net_commission-hotel_commission_net_price-hgs_commission_net_price) > '0.05') as base


SELECT transaction_id, row_type, version, action_performed, partner_net_price, supplier_net_price, transaction_type_name FROM `visitor_tickets` WHERE vt_group_no in (171141577754087) order by transaction_id, version, col2, row_type limit 200 


select prepaid_ticket_id, version, ticket_id, is_addon_ticket, action_performed, museum_net_fee, distributor_net_fee, hgs_net_fee from prepaid_tickets WHERE visitor_group_no in (171141577754087) order by version, prepaid_ticket_id limit 200


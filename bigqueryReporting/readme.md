# is_refunded and version mismatch but need to refine it in free time

with visitorTickets as (select *,row_number() over(partition by id order by last_modified_at desc, ifnull(version,'1') desc ) as rn from prio_olap.financial_transactions), orderId as (select distinct vt_group_no from visitorTickets where last_modified_at between '2025-01-17 00:00:01' and '2025-01-17 23:59:59'), finalRecords as (select * from visitorTickets where vt_group_no in (select vt_group_no from orderId) and rn = 1), prepaidTickets as (select *,row_number() over(partition by prepaid_ticket_id order by last_modified_at desc, ifnull(version,'1') desc ) as rn from prio_olap.scan_report), orderIdPT as (select distinct visitor_group_no from prepaidTickets where last_modified_at between '2025-01-17 00:00:01' and '2025-01-17 23:59:59'), finalRecordsPT as (select * from prepaidTickets where visitor_group_no in (select visitor_group_no from orderIdPT) and rn = 1), finalData as (select pt.visitor_group_no,pt.prepaid_ticket_id, vt.transaction_id,pt.version as ptVersion,vt.version as vtVersion, pt.last_modified_at as ptLastModified,vt.last_modified_at as vtLastModified, REPLACE(pt.action_performed, 'ADMND_INFO,', '') as ptActionPerformed,vt.action_performed as vtActionPerformed, pt.is_refunded as ptRefunded,vt.is_refunded as vtRefunded, vt.row_type, vt.transaction_type_name  from finalRecordsPT pt left join finalRecords vt on pt.visitor_group_no = vt.vt_group_no and pt.prepaid_ticket_id = vt.transaction_id) select * from finalData where ptVersion != vtVersion or ptRefunded != vtRefunded


# query to check mismatch between pt and vt prices

with visitorTickets as (select *,row_number() over(partition by id order by last_modified_at desc, ifnull(version,'1') desc ) as rn from prio_olap.financial_transactions), orderId as (select distinct vt_group_no from visitorTickets where last_modified_at between '2025-01-17 00:00:01' and '2025-01-17 23:59:59'), finalRecords as (select * from visitorTickets where vt_group_no in (select vt_group_no from orderId) and rn = 1), prepaidTickets as (select *,row_number() over(partition by prepaid_ticket_id order by last_modified_at desc, ifnull(version,'1') desc ) as rn from prio_olap.scan_report), orderIdPT as (select distinct visitor_group_no from prepaidTickets where last_modified_at between '2025-01-17 00:00:01' and '2025-01-17 23:59:59'), finalRecordsPT as (select * from prepaidTickets where visitor_group_no in (select visitor_group_no from orderIdPT) and rn = 1), vtFinalData as  (select vt_group_no, transaction_id, version, sum(case when row_type = 1 then partner_net_price else 0 end) as saleprice, sum(case when row_type = 2 then partner_net_price else 0 end) as purchaseprice,sum(case when row_type = 3 then partner_net_price else 0 end) as distributorcommission,sum(case when row_type = 4 then partner_net_price else 0 end) as hgscommission,sum(case when row_type = 17 then partner_net_price else 0 end) as merchantcommission from finalRecords group by vt_group_no, transaction_id,version), ptFinalData as (select visitor_group_no,prepaid_ticket_id, version, net_price, museum_net_fee, distributor_net_fee, hgs_net_fee from finalRecordsPT where is_addon_ticket != '2'), findmismatch as (select pt.visitor_group_no, vt.vt_group_no, pt.prepaid_ticket_id, vt.transaction_id, pt.version, vt.version, pt.net_price, vt.saleprice, pt.museum_net_fee, vt.purchaseprice, pt.distributor_net_fee, vt.distributorcommission, pt.hgs_net_fee, vt.hgscommission from ptFinalData pt left join vtFinalData vt on pt.visitor_group_no = vt.vt_group_no and pt.prepaid_ticket_id = vt.transaction_id) select * from findmismatch where ABS(cast(net_price as float64)-cast(saleprice as float64)) > 0.05 or ABS(cast(museum_net_fee as float64)-cast(purchaseprice as float64)) > 0.05 or (cast(distributor_net_fee as float64)-cast(distributorcommission as float64)) > 0.05 or (cast(hgs_net_fee as float64)-cast(hgscommission as float64)) > 0.05


# query to check mismatch between pricing check

with channellevelcommission as (select *,row_number() over(partition by channel_id, catalog_id,ticket_id,ticketpriceschedule_id order by resale_currency_level desc) as rn from prio_olap.channel_level_commission where deleted = 0),finalclc as (select * from channellevelcommission where rn = 1 and is_adjust_pricing = 1), qrcodes as (select *,row_number() over(partition by cod_id order by last_modified_at desc) as rn from prio_olap.qr_codes where cashier_type = '1'),finalqc as (select * from qrcodes where rn = 1),ticketlevelcommission as (select *,row_number() over(partition by hotel_id,ticket_id,ticketpriceschedule_id order by resale_currency_level desc) as rn from prio_olap.ticket_level_commission where deleted = 0),finaltlc as (select * from ticketlevelcommission where rn = 1 and is_adjust_pricing = 1), visitorTickets as (select *,row_number() over(partition by id order by last_modified_at desc, ifnull(version,'1') desc ) as rn from prio_olap.financial_transactions), orderId as (select distinct vt_group_no from visitorTickets where last_modified_at between '2025-01-17 00:00:01' and '2025-01-17 23:59:59'), finalRecords as (select * from visitorTickets where vt_group_no in (select vt_group_no from orderId) and rn = 1), prepaidTickets as (select *,row_number() over(partition by prepaid_ticket_id order by last_modified_at desc, ifnull(version,'1') desc ) as rn from prio_olap.scan_report), orderIdPT as (select distinct visitor_group_no from prepaidTickets where last_modified_at between '2025-01-17 00:00:01' and '2025-01-17 23:59:59'), finalRecordsPT as (select * from prepaidTickets where visitor_group_no in (select visitor_group_no from orderIdPT) and rn = 1), vtFinalData as  (select vt_group_no, transaction_id,max(hotel_id) as hotel_id, max(ticketId) as ticket_id, max(ticketpriceschedule_id) as ticketpriceschedule_id,version, sum(case when row_type = 1 then partner_net_price else 0 end) as saleprice, sum(case when row_type = 2 then partner_net_price else 0 end) as purchaseprice,sum(case when row_type = 3 then partner_net_price else 0 end) as distributorcommission,sum(case when row_type = 4 then partner_net_price else 0 end) as hgscommission,sum(case when row_type = 17 then partner_net_price else 0 end) as merchantcommission from finalRecords where row_type in (1,2,3,4,17) group by vt_group_no, transaction_id,version) select vt.*, qc.cod_id, qc.channel_id, qc.sub_catalog_id, tlc.ticket_net_price as tlcsaleprice, tlc.museum_net_commission as tlcmuseumfee, tlc.merchant_net_commission as tlcmerhantfee, tlc.hotel_commission_net_price as tlchotelfee,tlc.hgs_commission_net_price as tlchgsfee,catalog.ticket_net_price as catalogsaleprice, catalog.museum_net_commission as catalogmuseumfee, catalog.merchant_net_commission as catalogmerchantfee, catalog.hotel_commission_net_price as cataloghotelfee, catalog.hgs_commission_net_price as cataloghgsfee,clc.ticket_net_price as clcsaleprice, clc.museum_net_commission as clcmuseumfee, clc.merchant_net_commission as clcmerchantfee, clc.hotel_commission_net_price as clchotelfee, clc.hgs_commission_net_price as clchgsfee from vtFinalData vt left join finalqc qc on vt.hotel_id = qc.cod_id left join finaltlc tlc on vt.hotel_id = tlc.hotel_id and vt.ticket_id = tlc.ticket_id and vt.ticketpriceschedule_id = tlc.ticketpriceschedule_id left join finalclc catalog on catalog.catalog_id = if(qc.sub_catalog_id > 111, qc.sub_catalog_id, 111) and catalog.ticket_id = vt.ticket_id and catalog.ticketpriceschedule_id = vt.ticketpriceschedule_id left join finalclc clc on clc.channel_id = qc.channel_id and clc.ticket_id = vt.ticket_id and clc.ticketpriceschedule_id = vt.ticketpriceschedule_id
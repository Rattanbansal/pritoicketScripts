#!/bin/bash

set -e  # Exit immediately if any command exits with a non-zero status

echo "Script Stated at $(date)"
startdate=$(date +"%Y-%m-%d %H:%M:%S")

DB_HOST='production-secondary-db-node.cluster-ck6w2al7sgpk.eu-west-1.rds.amazonaws.com'
DB_USER=prt_dbadmin
DB_PASSWORD='YI7g3zXYLaRLf06HTX2s'
DB_NAME=priopassdb
table_name=visitor_tickets
column_name=vt_group_no
PORT=3306
BATCH_SIZE=25


DB2_HOST='prodrds.prioticket.com'
DB2_USER=prodrdsmaster
DB2_PASSWORD='FQ2b2RRCmehZi9gn'
DB2_NAME=prioprodrds
timeout_duration=60 # Timeout duration to kill queries if any queries taking time


vt_group_numbers="172701963608910 172676035737510 172671744456434 172657323972349 172610672682026 172583948665268 172538577151069 172536945301531 172523827993306 172520529958808 172494363128581 172453684017878 172433214971530 172416744337036 172390598196831 172390545644658 172382726610842 172373608145033 172366801339687 172366265821191 172366405679603 172348566477156 172347643481012 172347631881587 172313707293657 172312625712859 172308628061585 172305065503874 172272105953946 172253124282334 172226677403929 172218926828933 172209504366671 172184690928741 172167163691751 172158032238049 172151358374205 172151348707765 172150664693788 172141466079149 172130849430279 172123849503412 172117732467642 172116678419610 172113458237333 172089513098430 172062434422394 172055904944990 172045990279423 172029555356214 172023257302583 172021565709084 172010574487509 172004146519331 172002375242301 171988634182912 171968821640217 171951084185860 171945314582822 171945185101222 171935561656596 171932250154162 171924550192149 171923847733184 171866783405454 171864172704586 171854607875008 171825661011540 171796717318266 171778120139027 171751472582278 171692138615785 171544023445592 171539427022552 171535623202647 171491787635059 172713167689060 172676425882308 172660606122096 172660239706524 172624715563995 172571467716682 172564698777316 172554713056166 172553308323958 172532232242103 172520978015931 172520510366866 172511696920289 172511455277870 172306350486318 172226117455346 172217025818039 172203494180785 172171658952773 172165705742792 172147689944483 172135537485421 172132912846665 172122806841212 172110742302032 172080799309636 172072788385323 172062828530278 172062679897540 172053849822599 172045381017720 172029908473668 172029899259502 172019617573432 171962416221218 171924544172808 171874287831675 171829811508986 171812982675322 171812405657637 171811012655494 171805560776160 171798854046694 171779734061707 171762603756728 171759780969340 171744493773293 171742351040782 171742328834643 171726801550930 171724338656157 171709844325830 171701303221686 171648063171000 171632981885872 171624352428620 171623164561211 171578906085522 171577897882916 171535630964317 171534402119006 171408144569574 171347167153730 171329595427880 171286287891388 172511801667156 172462037906428 172445809897489 172441825066702 172416150157879 172411068947694 172339477913914 172289549739512 172159566947474 172018842908727 172002378910445 171997540147476 171993410739939 171961110128430 171959527664392 171950605217924 171891392816085 171875174850907 171797437007795 171759886504874 171759431349629 171750382783442 171742342144178 171735311546235 171710022213834 171614520817362 171589282109600 171589204871212 171569818810753 171543702653466 171528979019520 171522069143432 171510601305434 171381932502290 171314227103031 171276809799566 171216916957457 171208964907935 171207008376023 170976386904339 170854704903306 172620593314790 172262588927656 172254478015095 172243780128173 172105023489297 172098606991361 172055245166326 171819877726051 171787459211043 171552959377438 171448412523116 171180545708563 171604926352754 171389197080024 171156048372623 171096444698910 172636915308709 172598908497100 172538366069393 172433371379516 172373735004879 172337995807211 172290981665664 172244241887624 171969983059869 171950605044150 171803771959655 171475613024723 171155754037061 171630462753807 171563906867914 172004122295782 171797398728770 171795296788615 171764321395693 171754769811795 171745757786673 171708355124157 171672357611267 171640394708942 171640374661695 171518591107083 171457094329070 171422630116922 171303746108484 171053164227862 172636915308709 172588791932780 172573184096170 172416956423247 172242899098532 172030441489368 172030065101235 171985671325080 171985714938170 171977629894170 171968824983391 171802909136478 171760985744138 171758952716922 171694250190889 171675428010364 171665553234173 171617685440487 171589313023063 171579537438177 171539153650220 171512480470792 171433532986109 171338580315880 171155296135367 172634838152999 172555845354310 172513770872668 172304686841460 172153529439966 172063820995897 172048742196011 172045758452110 171942038685932 171918727042665 171874348770143 171807061542668 171807041743173 171806115664914 171734021242962 171691434868738 171691303205596 171665339672786 172279388074598 172211103887226 172279388074598 172229724655872 172211103887226 171745044581961 171708048240778 171693508782507 171664894676728 171647202586295 171440823593587 171405394946374 172226168242085 172136726218441 171838080769106 171819355743345 171796676614046 171788852848176 171751184031339 172437334240101 172340151096605 171788379424615 171666561786966 172132330892222 172114061697242 172036570877210 172030264255091 172012717101212 171986813576127 171984677658250 171969012636056 171949301231832 171923910256219 172468503825838 172202165988308 172202155523178 172182820776479 172176289715364 172170713431576 172053919636258 171927869092869 171871525979840 171863821511738 171838520050662 171746465866728 171730216040262 171443566303036 171899665809502 172513355921691 172208775595206 172098970616664 172044493392034 171943167246549 171798110580552 171762702400491 171654355037745 172091244129242 171793986574648 171733994781856"

# vt_group_numbers="171334036366002"

# Convert the vt_group_numbers into an array
vt_group_array=($vt_group_numbers)
total_vt_groups=${#vt_group_array[@]}

# Loop through vt_group_no array in batches
for ((i=0; i<$total_vt_groups; i+=BATCH_SIZE)); do
    # Create a batch of vt_group_no values
    batch=("${vt_group_array[@]:$i:$BATCH_SIZE}")
    batch_size=${#batch[@]}

    # Calculate the current progress level for this ticket_id
    current_progress=$((i + batch_size))
    
    # Join the batch into a comma-separated list
    batch_str=$(IFS=,; echo "${batch[*]}")

    echo "$batch_str"

    time timeout "$timeout_duration" mysqldump --single-transaction --skip-lock-tables --skip-add-locks --no-tablespaces -h $DB_HOST --set-gtid-purged=OFF -u $DB_USER --port=$PORT -p"$DB_PASSWORD"  --skip-add-drop-table --no-create-info $DB_NAME $table_name --where="$column_name in ($batch_str)" | gzip > $table_name.sql.gz

    echo "restore started"

    gunzip <  $table_name.sql.gz | time mysql -h $DB2_HOST -u $DB2_USER -p"$DB2_PASSWORD" $DB2_NAME || exit 1

    echo "restore ended"

    echo "---------Update started---------"

    time mysql -h $DB2_HOST -u $DB2_USER -p"$DB2_PASSWORD" $DB2_NAME -e "update visitor_tickets set last_modified_at = CURRENT_TIMESTAMP where vt_group_no in ($batch_str) " || exit 1

    echo "---------Update ended---------"

    rm -f $table_name.sql.gz

    sleep 10
    # exit 1

done
#!/bin/bash

set -e  # Exit immediately if any command exits with a non-zero status
TIMEOUT_PERIOD=15

### Database Credentials For 19 DB
DB_HOST="10.10.10.19"
DB_USER="pip"
DB_PASS="pip2024##"
DB_NAME="priopassdb"
AccountLEVELTABLE=ticket_level_commission # Define Variable which database table we are going to work
ChannelLEVELTABLE=channel_level_commission
BackupFILETLC="/home/intersoft-admin/rattan/backup/$AccountLEVELTABLE.sql"
BackupFILECLC="/home/intersoft-admin/rattan/backup/$AccountLEVELTABLE.sql"

### Database credentials for Local database so that can work without interuption
LOCAL_HOST="10.10.10.19"
LOCAL_USER="pip"
LOCAL_PASS="pip2024##"
LOCAL_NAME="priopassdb"
LOCAL_NAME_1="priopassdb"

echo "ticket_id,hotel_id,commission,reseller_id,cod_id,sub_catalog_id,channel_level_commission_id,ticketpriceschedule_id,resale_currency_level,currency,commission_on_sale_price,is_hotel_prepaid_commission_percentage,hotel_prepaid_commission_percentage,hgs_prepaid_commission_percentage,ticket_net_price,museum_net_commission,merchant_net_commission,hotel_commission_net_price,hgs_commission_net_price,hotel_commission_should_be,gap" > Catalog_level_mismatch.csv


product_ids=$(timeout $TIMEOUT_PERIOD time mysql -h"$LOCAL_HOST" -u"$LOCAL_USER" -p"$LOCAL_PASS" -D"$LOCAL_NAME" -sN  -e "select distinct ticket_id from (with qr_codess as (select reseller_id,cod_id, sub_catalog_id from "$LOCAL_NAME".qr_codes where cashier_type = '1' and sub_catalog_id is not NULL and sub_catalog_id > '0'), channels as (select d.*, qc.* from "$LOCAL_NAME_1".distributors d left join qr_codess qc on d.hotel_id = qc.cod_id group by d.ticket_id, qc.sub_catalog_id), final as (select c.*, clc.channel_level_commission_id, clc.ticketpriceschedule_id, clc.resale_currency_level, clc.currency, clc.commission_on_sale_price, clc.is_hotel_prepaid_commission_percentage, clc.hotel_prepaid_commission_percentage,clc.hgs_prepaid_commission_percentage, clc.ticket_net_price, clc.museum_net_commission, clc.merchant_net_commission, clc.hotel_commission_net_price, clc.hgs_commission_net_price, (clc.ticket_net_price*c.commission/100) as hotel_commission_should_be from channels c left join "$LOCAL_NAME".channel_level_commission clc on c.sub_catalog_id = clc.catalog_id and c.ticket_id = clc.ticket_id and clc.deleted = '0' and (clc.is_adjust_pricing = '1' or clc.hotel_prepaid_commission_percentage+clc.hgs_prepaid_commission_percentage>'0.05')) select *, ABS(hotel_commission_net_price - hotel_commission_should_be) as gap from final where ticketpriceschedule_id is not NULL and (ABS(hotel_commission_net_price - hotel_commission_should_be) > '0.05' or commission_on_sale_price != '1' or is_hotel_prepaid_commission_percentage != '1' or ABS(ticket_net_price-museum_net_commission-merchant_net_commission-hotel_commission_net_price-hgs_commission_net_price) > '0.02' or ABS(ticket_net_price-museum_net_commission-hotel_commission_net_price) > '0.02')) as raja;") || exit 1

for product_id in ${product_ids}

do

    echo $product_id

    ## Command to Record Mismatch
    timeout $TIMEOUT_PERIOD time mysql -h"$LOCAL_HOST" -u"$LOCAL_USER" -p"$LOCAL_PASS" -D"$LOCAL_NAME" -sN  -e "with qr_codess as (select reseller_id,cod_id, sub_catalog_id from "$LOCAL_NAME".qr_codes where cashier_type = '1' and sub_catalog_id is not NULL and sub_catalog_id > '0'), channels as (select d.*, qc.* from "$LOCAL_NAME_1".distributors d left join qr_codess qc on d.hotel_id = qc.cod_id where d.ticket_id = '$product_id' group by d.ticket_id, qc.sub_catalog_id), final as (select c.*, clc.channel_level_commission_id, clc.ticketpriceschedule_id, clc.resale_currency_level, clc.currency, clc.commission_on_sale_price, clc.is_hotel_prepaid_commission_percentage, clc.hotel_prepaid_commission_percentage,clc.hgs_prepaid_commission_percentage, clc.ticket_net_price, clc.museum_net_commission, clc.merchant_net_commission, clc.hotel_commission_net_price, clc.hgs_commission_net_price, (clc.ticket_net_price*c.commission/100) as hotel_commission_should_be from channels c left join "$LOCAL_NAME".channel_level_commission clc on c.sub_catalog_id = clc.catalog_id and c.ticket_id = clc.ticket_id and clc.deleted = '0' and c.sub_catalog_id is not NULL and (clc.is_adjust_pricing = '1' or clc.hotel_prepaid_commission_percentage+clc.hgs_prepaid_commission_percentage>'0.05')) select *, ABS(hotel_commission_net_price - hotel_commission_should_be) as gap from final where ticketpriceschedule_id is not NULL and (ABS(hotel_commission_net_price - hotel_commission_should_be) > '0.05' or commission_on_sale_price != '1' or is_hotel_prepaid_commission_percentage != '1' or ABS(ticket_net_price-museum_net_commission-merchant_net_commission-hotel_commission_net_price-hgs_commission_net_price) > '0.02' or ABS(ticket_net_price-museum_net_commission-hotel_commission_net_price) > '0.02');" >> Catalog_level_mismatch.csv || exit 1

    ## Command to Update Mismatch
    timeout $TIMEOUT_PERIOD time mysql -h"$LOCAL_HOST" -u"$LOCAL_USER" -p"$LOCAL_PASS" -D"$LOCAL_NAME" -sN -e "update "$LOCAL_NAME".channel_level_commission tlcu join (with qr_codess as (select reseller_id,cod_id, sub_catalog_id from "$LOCAL_NAME".qr_codes where cashier_type = '1' and sub_catalog_id is not NULL and sub_catalog_id > '0'), channels as (select d.*, qc.* from "$LOCAL_NAME_1".distributors d left join qr_codess qc on d.hotel_id = qc.cod_id where d.ticket_id = '$product_id' group by d.ticket_id, qc.sub_catalog_id), final as (select c.*, clc.channel_level_commission_id, clc.ticketpriceschedule_id, clc.resale_currency_level, clc.currency, clc.commission_on_sale_price, clc.is_hotel_prepaid_commission_percentage, clc.hotel_prepaid_commission_percentage,clc.hgs_prepaid_commission_percentage, clc.ticket_net_price, clc.museum_net_commission, clc.merchant_net_commission, clc.hotel_commission_net_price, clc.hgs_commission_net_price, (clc.ticket_net_price*c.commission/100) as hotel_commission_should_be from channels c left join "$LOCAL_NAME".channel_level_commission clc on c.sub_catalog_id = clc.catalog_id and c.ticket_id = clc.ticket_id and clc.deleted = '0' and (clc.is_adjust_pricing = '1' or clc.hotel_prepaid_commission_percentage+clc.hgs_prepaid_commission_percentage>'0.05')) select *, ABS(hotel_commission_net_price - hotel_commission_should_be) as gap from final where ticketpriceschedule_id is not NULL and (ABS(hotel_commission_net_price - hotel_commission_should_be) > '0.05' or commission_on_sale_price != '1' or is_hotel_prepaid_commission_percentage != '1' or ABS(ticket_net_price-museum_net_commission-merchant_net_commission-hotel_commission_net_price-hgs_commission_net_price) > '0.02' or ABS(ticket_net_price-museum_net_commission-hotel_commission_net_price) > '0.02')) as diff on tlcu.channel_level_commission_id = diff.channel_level_commission_id set tlcu.hotel_prepaid_commission_percentage = ROUND(diff.commission, 2), tlcu.resale_percentage = ROUND(100-diff.commission,2), tlcu.commission_on_sale_price = '1', tlcu.is_hotel_prepaid_commission_percentage = '1', tlcu.hotel_commission_net_price = ROUND(tlcu.ticket_net_price*diff.commission/100,2), tlcu.hotel_commission_gross_price = ROUND((tlcu.ticket_net_price*diff.commission/100)*(100+tlcu.hotel_commission_tax_value)/100,2), tlcu.museum_net_commission = ROUND(tlcu.ticket_net_price-(tlcu.ticket_net_price*diff.commission/100),2), tlcu.museum_gross_commission = ROUND((tlcu.ticket_net_price-(tlcu.ticket_net_price*diff.commission/100))*(100+tlcu.museum_commission_tax_value)/100,2), tlcu.merchant_net_commission = '0.00', tlcu.merchant_gross_commission = '0.00', tlcu.subtotal_net_amount = ROUND((tlcu.ticket_net_price*diff.commission/100),2), tlcu.subtotal_gross_amount = ROUND(((tlcu.ticket_net_price*diff.commission/100))*(100+tlcu.museum_commission_tax_value)/100,2), tlcu.hgs_commission_net_price = '0.00', tlcu.hgs_commission_gross_price = '0.00', tlcu.ip_address = '192.168.1.10', tlcu.is_resale_percentage = '1'; select ROW_COUNT();" || exit 1

    sleep 1
    # exit

done 

## Missing Entries Part

echo "Missing Entries Insertion stated"

echo "ticket_id	hotel_id,commission,reseller_id,cod_id,sub_catalog_id,mec_end_date,tps_id,currency_code,clcproduct_id,ticketpriceschedule_id,resale_currency_level" > Catalog_Missing_Entries.csv

MissingProduct_ids=$(timeout $TIMEOUT_PERIOD time mysql -h"$LOCAL_HOST" -u"$LOCAL_USER" -p"$LOCAL_PASS" -D"$LOCAL_NAME"  -e "select distinct(ticket_id) from (with qr_codess as (select reseller_id,cod_id, sub_catalog_id from priopassdb.qr_codes where cashier_type = '1' and sub_catalog_id is not NULL and sub_catalog_id > '0'), channels as (select d.*, qc.* from priopassdb.distributors d left join qr_codess qc on d.hotel_id = qc.cod_id group by d.ticket_id, qc.sub_catalog_id), catalogs as (select * from channels where sub_catalog_id is not NULL), products as (select c.*, date(from_unixtime(if(mec.endDate like '9999999', '1794812755', mec.endDate))) as mec_end_date, tps.id as tps_id, tps.currency_code from catalogs c left join modeventcontent mec on c.ticket_id = mec.mec_id left join ticketpriceschedule tps on mec.mec_id = tps.ticket_id where mec.deleted = '0' and  date(from_unixtime(if(mec.endDate like '9999999', '1794812755', mec.endDate))) > CURRENT_DATE and tps.deleted = '0' and date(from_unixtime(if(tps.end_date like '9999999', '1794812755', tps.end_date))) > CURRENT_DATE) select p.*, clc.ticket_id as clcproduct_id, clc.ticketpriceschedule_id, clc.resale_currency_level from products p left join channel_level_commission clc on p.sub_catalog_id = clc.catalog_id and clc.channel_id = '0' and clc.catalog_id > '0' and clc.deleted = '0' and p.ticket_id = clc.ticket_id and p.tps_id = clc.ticketpriceschedule_id and clc.is_adjust_pricing = '1') as final where clcproduct_id is NULL;") || exit 1

for Missing_product_id in ${MissingProduct_ids}

do 


    echo "$Missing_product_id"

    timeout $TIMEOUT_PERIOD time mysql -h"$LOCAL_HOST" -u"$LOCAL_USER" -p"$LOCAL_PASS" -D"$LOCAL_NAME" -sN  -e "select * from (with qr_codess as (select reseller_id,cod_id, sub_catalog_id from priopassdb.qr_codes where cashier_type = '1' and sub_catalog_id is not NULL and sub_catalog_id > '0'), channels as (select d.*, qc.* from priopassdb.distributors d left join qr_codess qc on d.hotel_id = qc.cod_id where d.ticket_id = '$Missing_product_id' group by d.ticket_id, qc.sub_catalog_id), catalogs as (select * from channels where sub_catalog_id is not NULL), products as (select c.*, date(from_unixtime(if(mec.endDate like '9999999', '1794812755', mec.endDate))) as mec_end_date, tps.id as tps_id, tps.currency_code from catalogs c left join modeventcontent mec on c.ticket_id = mec.mec_id left join ticketpriceschedule tps on mec.mec_id = tps.ticket_id where mec.mec_id = '$Missing_product_id' and mec.deleted = '0' and  date(from_unixtime(if(mec.endDate like '9999999', '1794812755', mec.endDate))) > CURRENT_DATE and tps.deleted = '0' and date(from_unixtime(if(tps.end_date like '9999999', '1794812755', tps.end_date))) > CURRENT_DATE) select p.*, clc.ticket_id as clcproduct_id, clc.ticketpriceschedule_id, clc.resale_currency_level from products p left join channel_level_commission clc on p.sub_catalog_id = clc.catalog_id and clc.channel_id = '0' and clc.catalog_id > '0' and clc.deleted = '0' and p.ticket_id = clc.ticket_id and p.tps_id = clc.ticketpriceschedule_id and clc.is_adjust_pricing = '1') as final where clcproduct_id is NULL;" >> Catalog_Missing_Entries.csv || exit 1


    timeout $TIMEOUT_PERIOD time mysql -h"$LOCAL_HOST" -u"$LOCAL_USER" -p"$LOCAL_PASS" -D"$LOCAL_NAME"  -e "insert into channel_level_commission (created_at, channel_id, ticket_id, ticketpriceschedule_id, museum_name,ticket_title,ticket_type,ticket_scan_price,ticket_list_price,ticket_new_price,ticket_discount,is_discount_in_percent,ticket_gross_price,ticket_tax_value,ticket_tax_id,ticket_net_price,museum_commission_old,museum_gross_commission,museum_net_commission,museum_commission_tax_value,museum_commission_tax_id,subtotal_net_amount,subtotal_gross_amount,subtotal_tax_value,subtotal_tax_id,is_combi_ticket_allowed,is_combi_discount,tickets_for_combi_discount,combi_discount_gross_amount,combi_discount_net_amount,combi_discount_tax_value, combi_discount_tax_id, commission_updated_at, ip_address, hotel_prepaid_commission_percentage, hotel_postpaid_commission_percentage, hotel_commission_tax_id, hotel_commission_tax_value, hgs_prepaid_commission_percentage, hgs_postpaid_commission_percentage, hgs_commission_tax_id, hgs_commission_tax_value, merchant_gross_commission, is_adjust_pricing, is_custom_setting, apply_service_tax, external_product_id, account_number, chart_number, deleted, market_merchant_id, merchant_net_commission, merchant_admin_id, merchant_admin_name, is_cluster_ticket_added, default_listing, catalog_id, last_modified_at, resale_percentage, is_resale_percentage, merchant_fee_percentage, is_merchant_fee_percentage, is_hotel_prepaid_commission_percentage, commission_on_sale_price, hotel_commission_gross_price, hotel_commission_net_price, hgs_commission_gross_price, hgs_commission_net_price, product_type, currency, resale_currency_level, resale_commission, affected_before_date, affected_date, is_active, publish_level, channel_level, reseller_id, own_merchant_id, discount_label, discount_setting_type) select CURRENT_TIMESTAMP as created_at,'0' as channel_id,ticket_id,tps_id as ticketpriceschedule_id, museum_name,ticket_title,LEFT(ticket_type, 10) AS ticket_type,ticket_scan_price,ticket_list_price, ticket_new_price, '0' as ticket_discount,'0' as is_discount_in_percent, ticket_gross_price,'0.00' as ticket_tax_value, '227' as ticket_tax_id,ticket_gross_price as ticket_net_price,'0' as museum_commission_old, ticket_gross_price*(100-commission)/100 as museum_gross_commission,ticket_gross_price*(100-commission)/100 as museum_net_commission,'0.00' as museum_commission_tax_value, '227' as museum_commission_tax_id,ticket_gross_price*(commission)/100 as subtotal_net_amount, ticket_gross_price*(commission)/100 as subtotal_gross_amount,'0.00' as subtotal_tax_value, '227' as subtotal_tax_id,'0' as is_combi_ticket_allowed,'0' as is_combi_discount, '0' as tickets_for_combi_discount,'0' as combi_discount_gross_amount,'0' as combi_discount_net_amount, '0.00' as combi_discount_tax_value,'227' as combi_discount_tax_id,CURRENT_TIMESTAMP as commission_updated_at,'192.168.1.11' as ip_address,commission as hotel_prepaid_commission_percentage,'0.00' as hotel_postpaid_commission_percentage, '2' as hotel_commission_tax_id,'21.00' as hotel_commission_tax_value,'0.00' as hgs_prepaid_commission_percentage,'0.00' as hgs_postpaid_commission_percentage, '227' as hgs_commission_tax_id,'0.00' as hgs_commission_tax_value,'0.00' as merchant_gross_commission, '1' as is_adjust_pricing,'0' as is_custom_setting,'0' as apply_service_tax,'0' as external_product_id, '1' as account_number,'1' as chart_number,'0' as deleted,'4' as market_merchant_id, '0.00' as merchant_net_commission,'49758' as merchant_admin_id,'Evan Evans' as merchant_admin_name, (case when is_combi in ('2', '3') then '1' else 0 end) as is_cluster_ticket_added,'0' default_listing,sub_catalog_id as catalog_id,CURRENT_TIMESTAMP as last_modified_at,(100-commission) as resale_percentage,'1' as is_resale_percentage, '0.00' as merchant_fee_percentage,'0' as is_merchant_fee_percentage,'1' as is_hotel_prepaid_commission_percentage,'1' as commission_on_sale_price, ((ticket_gross_price*commission/100)*(121/100)) as hotel_commission_gross_price, (ticket_gross_price*commission/100) as hotel_commission_net_price,'0.00' as hgs_commission_gross_price,'0.00' as hgs_commission_net_price,is_combi as product_type,currency_code as currency,'1' as resale_currency_level,'0' as resale_commission,CURRENT_TIMESTAMP as affected_before_date,CURRENT_TIMESTAMP as affected_date,'1' as is_active,'1' as publish_level,'1' as channel_level,reseller_id,'0' as own_merchant_id,'0' as discount_label,'0' as discount_setting_type from (with qr_codess as (select reseller_id,cod_id, sub_catalog_id from priopassdb.qr_codes where cashier_type = '1' and sub_catalog_id is not NULL and sub_catalog_id > '0'), channels as (select d.*, qc.* from priopassdb.distributors d left join qr_codess qc on d.hotel_id = qc.cod_id where d.ticket_id = '$Missing_product_id' group by d.ticket_id, qc.sub_catalog_id), catalogs as (select * from channels where sub_catalog_id is not NULL), products as (select c.*, date(from_unixtime(if(mec.endDate like '9999999', '1794812755', mec.endDate))) as mec_end_date,mec.museum_name,mec.postingEventTitle as ticket_title,tps.ticket_type_label as ticket_type,tps.newPrice as ticket_scan_price, tps.newPrice as ticket_list_price, tps.newPrice as ticket_new_price,tps.newPrice as ticket_gross_price, tps.id as tps_id, tps.currency_code, mec.is_combi from catalogs c left join modeventcontent mec on c.ticket_id = mec.mec_id left join ticketpriceschedule tps on mec.mec_id = tps.ticket_id where mec.deleted = '0' and mec.mec_id = '$Missing_product_id' and  date(from_unixtime(if(mec.endDate like '9999999', '1794812755', mec.endDate))) > CURRENT_DATE and tps.deleted = '0' and date(from_unixtime(if(tps.end_date like '9999999', '1794812755', tps.end_date))) > CURRENT_DATE) select p.*, clc.ticket_id as clcproduct_id, clc.ticketpriceschedule_id, clc.resale_currency_level from products p left join channel_level_commission clc on p.sub_catalog_id = clc.catalog_id and clc.channel_id = '0' and clc.catalog_id > '0' and clc.deleted = '0' and p.ticket_id = clc.ticket_id and p.tps_id = clc.ticketpriceschedule_id and clc.is_adjust_pricing = '1') as final where clcproduct_id is NULL;" || exit 1

    sleep 1

done





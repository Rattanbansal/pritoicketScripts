--- Query to Get PRicing from the channel_level_commission

SELECT channel_level_commission_id, channel_id, catalog_id, ticket_id, ticketpriceschedule_id, ticket_type, currency, resale_currency_level, ticket_list_price, ticket_new_price, ticket_discount, is_discount_in_percent, ticket_gross_price, ticket_net_price, museum_gross_commission, museum_net_commission, merchant_gross_commission, merchant_net_commission, subtotal_gross_amount, subtotal_net_amount, hotel_prepaid_commission_percentage, hgs_prepaid_commission_percentage, hotel_commission_gross_price, hotel_commission_net_price, hgs_commission_gross_price, hgs_commission_net_price FROM `channel_level_commission` where ticket_id = '77506' and ticket_type not like '%infant%' and deleted = '0' and channel_id = '1304';


---- Query with all entries for same product for different catalog as well

select * from (SELECT channel_level_commission_id, channel_id, catalog_id, ticket_id, ticketpriceschedule_id, ticket_type, currency, resale_currency_level, ticket_list_price, ticket_new_price, ticket_discount, is_discount_in_percent, ticket_gross_price, ticket_net_price, museum_gross_commission, museum_net_commission, merchant_gross_commission, merchant_net_commission, subtotal_gross_amount, subtotal_net_amount, hotel_prepaid_commission_percentage, hgs_prepaid_commission_percentage, hotel_commission_gross_price, hotel_commission_net_price, hgs_commission_gross_price, hgs_commission_net_price, discount_setting_type, last_modified_at, created_at FROM `channel_level_commission` where ticket_id = '77506' and ticket_type not like '%infant%' and deleted = '0' and channel_id = '1304'
union ALL
SELECT channel_level_commission_id, channel_id, catalog_id, ticket_id, ticketpriceschedule_id, ticket_type, currency, resale_currency_level, ticket_list_price, ticket_new_price, ticket_discount, is_discount_in_percent, ticket_gross_price, ticket_net_price, museum_gross_commission, museum_net_commission, merchant_gross_commission, merchant_net_commission, subtotal_gross_amount, subtotal_net_amount, hotel_prepaid_commission_percentage, hgs_prepaid_commission_percentage, hotel_commission_gross_price, hotel_commission_net_price, hgs_commission_gross_price, hgs_commission_net_price, discount_setting_type, last_modified_at, created_at FROM `channel_level_commission` where ticket_id = '77506' and ticket_type not like '%infant%' and deleted = '0' and catalog_id  in (select catalog_id from catalogs where catalog_category = '2' and reseller_id = '686' and is_deleted = '0' and catalog_type = '1')) as base where discount_setting_type = '3' and ticket_type = 'Adult' order by channel_id DESC, catalog_id, ticket_id, ticket_type, resale_currency_level limit 200


----- Get Applicable Pricing Level

select oac.catalog_id, oac.price_setting_type, oac.ticket_id, oac.pricing_level, oac.hotel_prepaid_commission_percentage,oac.hgs_prepaid_commission_percentage, appliedpricelevel.catalog_id, appliedpricelevel.ticket_id, appliedpricelevel.pricing_level from own_account_commissions oac join (select catalog_id, ticket_id, price_setting_type, (case when min_pricing_level = 1 and max_pricing = 2 then 1 when min_pricing_level = 1 and max_pricing = 1 then 1 when min_pricing_level = 2 and max_pricing = 2 then 2 else max_pricing end) as pricing_level from (SELECT catalog_id, ticket_id, price_setting_type, min(pricing_level) as min_pricing_level, max(pricing_level) as max_pricing FROM `own_account_commissions` where deleted = '0' and catalog_id  in (select catalog_id from catalogs where catalog_category = '2' and reseller_id = '686' and is_deleted = '0' and catalog_type = '1') group by catalog_id, ticket_id, price_setting_type) as pricinglevel) as appliedpricelevel on oac.catalog_id = appliedpricelevel.catalog_id and oac.ticket_id = appliedpricelevel.ticket_id and oac.price_setting_type = appliedpricelevel.price_setting_type and oac.pricing_level = appliedpricelevel.pricing_level


---- Pricing Difference on main catalog as compare to Sub

select * from (select clc.*, tps.id, tps.ticket_id as mec_id, tps.newPrice, from_unixtime(tps.start_date), from_unixtime(tps.end_date) from (SELECT channel_level_commission_id, channel_id, catalog_id, ticket_id, ticketpriceschedule_id, ticket_type, currency, resale_currency_level, ticket_list_price, ticket_new_price, ticket_discount, is_discount_in_percent, ticket_gross_price, ticket_net_price, museum_gross_commission, museum_net_commission, merchant_gross_commission, merchant_net_commission, subtotal_gross_amount, subtotal_net_amount, hotel_prepaid_commission_percentage, hgs_prepaid_commission_percentage, hotel_commission_gross_price, hotel_commission_net_price, hgs_commission_gross_price, hgs_commission_net_price, discount_setting_type, last_modified_at, created_at FROM `channel_level_commission` where ticket_type not like '%infant%' and resale_currency_level = '1' and deleted = '0' and channel_id = '1304' and created_at > '2024-05-13 00:00:01' and ticket_gross_price <= '0') as clc left join ticketpriceschedule tps on clc.ticketpriceschedule_id = tps.id and tps.deleted = '0') as basetable where ABS(ticket_new_price - newPrice) > '0' limit 500


---- Select Query to fetch the main catalog_price for the products where we have the ticket_new_price = '0'

select base.*, clc.ticket_new_price as should_be from (SELECT channel_level_commission_id, channel_id, catalog_id, ticket_id, ticketpriceschedule_id, ticket_type, currency, resale_currency_level, ticket_list_price, ticket_new_price FROM `channel_level_commission` where ticket_id = '77506' and ticket_type not like '%infant%' and deleted = '0' and catalog_id  in (select catalog_id from catalogs where catalog_category = '2' and reseller_id = '686' and is_deleted = '0' and catalog_type = '1') and ticket_new_price = '0' order by channel_id DESC, catalog_id, ticket_id, ticket_type, resale_currency_level) as base left join channel_level_commission clc on clc.channel_id = '1304' and clc.ticket_id = base.ticket_id and clc.ticketpriceschedule_id = base.ticketpriceschedule_id and clc.resale_currency_level = base.resale_currency_level and clc.ticket_type = base.ticket_type and clc.currency = base.currency and clc.deleted = '0' where clc.ticket_new_price != '0'


---- Select query to to calculate all relational columns

select clc1.channel_level_commission_id,clc1.ticket_id, clc1.catalog_id, clc1.channel_id, clc1.ticket_new_price, pricing.should_be, clc1.ticket_gross_price, ROUND((case when is_discount_in_percent = '1' then pricing.should_be - ((pricing.should_be*clc1.ticket_discount)/100) else pricing.should_be-ticket_discount end),2) as gross_price_should_be, clc1.ticket_net_price, clc1.ip_address, '88-88-88-88' as ipshould_be from channel_level_commission clc1 join (select base.*, clc.ticket_new_price as should_be from (SELECT channel_level_commission_id, channel_id, catalog_id, ticket_id, ticketpriceschedule_id, ticket_type, currency, resale_currency_level, ticket_list_price, ticket_new_price FROM `channel_level_commission` where ticket_id = '77506' and ticket_type not like '%infant%' and deleted = '0' and catalog_id  in (select catalog_id from catalogs where catalog_category = '2' and reseller_id = '686' and is_deleted = '0' and catalog_type = '1') and ticket_new_price = '0' order by channel_id DESC, catalog_id, ticket_id, ticket_type, resale_currency_level) as base left join channel_level_commission clc on clc.channel_id = '1304' and clc.ticket_id = base.ticket_id and clc.ticketpriceschedule_id = base.ticketpriceschedule_id and clc.resale_currency_level = base.resale_currency_level and clc.ticket_type = base.ticket_type and clc.currency = base.currency and clc.deleted = '0' where clc.ticket_new_price != '0') as pricing on clc1.channel_level_commission_id = pricing.channel_level_commission_id


---- Update query to to calculate all relational columns

update channel_level_commission clc1 join (select base.*, clc.ticket_new_price as should_be from (SELECT channel_level_commission_id, channel_id, catalog_id, ticket_id, ticketpriceschedule_id, ticket_type, currency, resale_currency_level, ticket_list_price, ticket_new_price FROM `channel_level_commission` where ticket_id in (82219) and ticket_type not like '%infant%' and deleted = '0' and catalog_id  in (select catalog_id from catalogs where catalog_category = '2' and reseller_id = '686' and is_deleted = '0' and catalog_type = '1') and ticket_new_price = '0' order by channel_id DESC, catalog_id, ticket_id, ticket_type, resale_currency_level) as base left join channel_level_commission clc on clc.channel_id = '1304' and clc.ticket_id = base.ticket_id and clc.ticketpriceschedule_id = base.ticketpriceschedule_id and clc.resale_currency_level = base.resale_currency_level and clc.ticket_type = base.ticket_type and clc.currency = base.currency and clc.deleted = '0' where clc.ticket_new_price != '0') as pricing on clc1.channel_level_commission_id = pricing.channel_level_commission_id set clc1.ticket_new_price = pricing.should_be, clc1.ticket_gross_price = ROUND((case when is_discount_in_percent = '1' then pricing.should_be - ((pricing.should_be*clc1.ticket_discount)/100) else pricing.should_be-ticket_discount end),2), clc1.ip_address = '88-88-88-88'


---- Select * from channel_level_commission where ip_address = '88-88-88-88'

select ticket_gross_price,ticket_net_price,ROUND(ticket_gross_price-((ticket_gross_price*ticket_tax_value)/100),2), subtotal_net_amount, ROUND(ticket_gross_price-((ticket_gross_price*ticket_tax_value)/100),2) - museum_net_commission - merchant_net_commission  from channel_level_commission where ip_address = '88-88-88-88' and last_modified_at > '2024-10-25 00:00:01'

update channel_level_commission set ticket_net_price =  ROUND(ticket_gross_price-((ticket_gross_price*ticket_tax_value)/100),2), ip_address = '88-88-88-89', hotel_commission_net_price = ROUND((ROUND(ticket_gross_price-((ticket_gross_price*ticket_tax_value)/100),2)*hotel_prepaid_commission_percentage)/100,2) where ip_address = '88-88-88-88' and last_modified_at > '2024-10-25 00:00:01' and commission_on_sale_price = '1'

update channel_level_commission set ip_address = '88-88-88-90', hotel_commission_gross_price = (hotel_commission_net_price*(100+hotel_commission_tax_value))/100 where ip_address = '88-88-88-89' and last_modified_at > '2024-10-25 00:00:01' and commission_on_sale_price = '1'

update channel_level_commission set ip_address = '88-88-88-91', subtotal_net_amount = hotel_commission_net_price, subtotal_gross_amount = hotel_commission_net_price*(100+subtotal_tax_value)/100, hgs_commission_gross_price = '0', hgs_commission_net_price = '0' where ip_address = '88-88-88-90' and last_modified_at > '2024-10-25 00:00:01' and commission_on_sale_price = '1' and ticket_net_price-museum_net_commission-merchant_net_commission-hotel_commission_net_price <= '0'

update channel_level_commission set ip_address = '88-88-88-92', subtotal_net_amount = ticket_net_price-museum_net_commission-merchant_net_commission, subtotal_gross_amount = (ticket_net_price-museum_net_commission-merchant_net_commission)*(100+subtotal_tax_value)/100, hgs_commission_gross_price = ((ticket_net_price-museum_net_commission-merchant_net_commission-hotel_commission_net_price)*(100+hgs_commission_tax_value)/100), hgs_commission_net_price = ticket_net_price-museum_net_commission-merchant_net_commission-hotel_commission_net_price where ip_address = '88-88-88-90' and last_modified_at > '2024-10-25 00:00:01' and commission_on_sale_price = '1' and ticket_net_price-museum_net_commission-merchant_net_commission-hotel_commission_net_price > '0'


update channel_level_commission set ip_address = '88-88-88-93', museum_net_commission = (museum_net_commission+(ticket_net_price-museum_net_commission-merchant_net_commission-hotel_commission_net_price)) where ip_address = '88-88-88-91' and last_modified_at > '2024-10-25 00:00:01' and commission_on_sale_price = '1' and ticket_net_price-museum_net_commission-merchant_net_commission-hotel_commission_net_price < '0'

update channel_level_commission set ip_address = '88-88-88-94', museum_gross_commission = (museum_net_commission*(100+museum_commission_tax_value)/100) where ip_address = '88-88-88-93' and last_modified_at > '2024-10-25 00:00:01' and commission_on_sale_price = '1'


-- Mismtch Records

SELECT channel_level_commission_id, channel_id, catalog_id, ticket_id, ticketpriceschedule_id, ticket_type, currency, resale_currency_level, ticket_list_price, ticket_new_price, ticket_discount, is_discount_in_percent, ticket_gross_price, ticket_net_price, museum_gross_commission, museum_net_commission, merchant_gross_commission, merchant_net_commission, subtotal_gross_amount, subtotal_net_amount, hotel_prepaid_commission_percentage, hgs_prepaid_commission_percentage, hotel_commission_gross_price, hotel_commission_net_price, hgs_commission_gross_price, hgs_commission_net_price FROM channel_level_commission where ticket_id = '77506' and ticket_type not like '%infant%' and deleted = '0' and channel_id = '1304' group by channel_level_commission_id having ABS(ticket_net_price-museum_net_commission-merchant_net_commission-hotel_commission_net_price-hgs_commission_net_price) > '0.05'

-- query to check the latest version to verify data

select vt.vt_group_no, vt.transaction_id,vt.hotel_id,vt.ticketId,vt.selected_date, vt.version, vt.row_type, vt.admin_currency_code, vt.partner_net_price, vt.partner_gross_price, vt.tax_value, vt.transaction_type_name, vt.col2 from visitor_tickets vt join (select vt_group_no, transaction_id, row_type, max(version) as version from visitor_tickets where vt_group_no = '166997241092017' and col2 != '2' group by vt_group_no, transaction_id, row_type) as maxv on maxv.vt_group_no = vt.vt_group_no and maxv.transaction_id = vt.transaction_id and maxv.row_type = vt.row_type and ABS(ROUND(maxv.version-vt.version,1)) = '0' 


---- After excluding refunded entries

select * from (select vt.vt_group_no, concat(vt.transaction_id, 'R') as transaction_id,vt.hotel_id,vt.ticketId,vt.selected_date, vt.version, vt.row_type, vt.admin_currency_code, vt.partner_net_price, vt.partner_gross_price, vt.tax_value, vt.transaction_type_name, vt.col2, vt.is_refunded from visitor_tickets vt join (select vt_group_no, transaction_id, row_type, max(version) as version from visitor_tickets where vt_group_no = '167248376982761' and col2 != '2' group by vt_group_no, transaction_id, row_type) as maxv on maxv.vt_group_no = vt.vt_group_no and maxv.transaction_id = vt.transaction_id and maxv.row_type = vt.row_type and ABS(ROUND(maxv.version-vt.version,1)) = '0' where vt.is_refunded = '0') as base 


---- Query to get the total order id amount

select vt_group_no, transaction_id, hotel_id, ticketId, selected_date, version, max(admin_currency_code) as admin_currency_code,sum(case when row_type = '1' and transaction_type_name not like '%Reprice%' then 1 else 0 end) as quantity,sum(case when row_type = '1' and transaction_type_name not like '%Reprice%' then partner_net_price else 0 end) as saleprice,sum(case when row_type = '2' and transaction_type_name not like '%Reprice%' then partner_net_price else 0 end) as purchaseprice,sum(case when row_type = '3' and transaction_type_name not like '%Reprice%' then partner_net_price else 0 end) as commission,sum(case when row_type = '4' and transaction_type_name not like '%Reprice%' then partner_net_price else 0 end) as hgscommission,sum(case when row_type = '17' and transaction_type_name not like '%Reprice%' then partner_net_price else 0 end) as merchantcommission,sum(case when row_type = '1' and transaction_type_name like '%Reprice%' then partner_net_price else 0 end) as salepriceDiscount,sum(case when row_type = '2' and transaction_type_name like '%Reprice%' then partner_net_price else 0 end) as purchasepriceDiscount,sum(case when row_type = '3' and transaction_type_name like '%Reprice%' then partner_net_price else 0 end) as commissionDiscount,sum(case when row_type = '4' and transaction_type_name like '%Reprice%' then partner_net_price else 0 end) as hgscommissionDiscount,
sum(case when row_type = '17' and transaction_type_name like '%Reprice%' then partner_net_price else 0 end) as merchantcommissionDiscount  from (select vt.vt_group_no, concat(vt.transaction_id, 'R') as transaction_id,vt.hotel_id,vt.ticketId,vt.ticketpriceschedule_id,vt.selected_date, vt.version, vt.row_type, vt.admin_currency_code, vt.partner_net_price, vt.partner_gross_price, vt.tax_value, vt.transaction_type_name, vt.col2, vt.is_refunded from visitor_tickets vt join (select vt_group_no, transaction_id, row_type, max(version) as version from visitor_tickets where vt_group_no = '167344709177764' and col2 != '2' group by vt_group_no, transaction_id, row_type, ticketId, ticketpriceschedule_id) as maxv on maxv.vt_group_no = vt.vt_group_no and maxv.transaction_id = vt.transaction_id and maxv.row_type = vt.row_type and ABS(ROUND(maxv.version-vt.version,1)) = '0' where vt.is_refunded = '0') as base group by vt_group_no, ticketId, ticketpriceschedule_id


--- Gneeral query

select vt.vt_group_no, concat(vt.transaction_id, 'R') as transaction_id,vt.hotel_id,vt.ticketId,vt.selected_date, vt.version, vt.row_type, vt.admin_currency_code, vt.partner_net_price, vt.partner_gross_price, vt.tax_value, vt.transaction_type_name, vt.col2, vt.is_refunded, vt.action_performed from visitor_tickets vt where vt.vt_group_no = '167344709177764' order by vt.version, vt.transaction_id, vt.row_type limit 200


select prepaid_ticket_id, version, is_refunded, action_performed, is_addon_ticket, quantity, pax, last_modified_at from prepaid_tickets where visitor_group_no = '166997241092017' limit 200 


---- Need to findout orders where last version is_refunded = 0 entries with admin_correction but still in that version is_refunded = 1 entries are missing

   --- pt

select ptt1.visitor_group_no, ptt1.prepaid_ticket_id, ptt1.is_refunded, ptt1.action_performed, ptt1.version from prepaid_tickets ptt1 join (select base.visitor_group_no as order_id, base.version as version_to_update,ptt.visitor_group_no, ptt.prepaid_ticket_id, ptt.is_refunded, ptt.action_performed, ptt.version from prepaid_tickets ptt right join (select pt.visitor_group_no, pt.prepaid_ticket_id, pt.is_refunded, pt.action_performed, pt.version from prepaid_tickets pt join (select visitor_group_no,prepaid_ticket_id, max(version) as version from prepaid_tickets where visitor_group_no in (172345532691306) group by prepaid_ticket_id, visitor_group_no) as maxptv on maxptv.visitor_group_no = pt.visitor_group_no and maxptv.prepaid_ticket_id = pt.prepaid_ticket_id and ABS(ROUND(maxptv.version-pt.version,1)) = '0' where pt.is_refunded = '0' and pt.action_performed like '%ADMND_COR' and pt.deleted = '0') as base on ptt.visitor_group_no = base.visitor_group_no and ABS(ptt.version-base.version) = '0' and ptt.is_refunded = '1') as base1 on ptt1.visitor_group_no = base1.order_id and ABS(ptt1.version-base1.version_to_update) = '0' where base1.visitor_group_no is NULL


update prepaid_tickets ptt1 join (select base.visitor_group_no as order_id, base.version as version_to_update,ptt.visitor_group_no, ptt.prepaid_ticket_id, ptt.is_refunded, ptt.action_performed, ptt.version from prepaid_tickets ptt right join (select pt.visitor_group_no, pt.prepaid_ticket_id, pt.is_refunded, pt.action_performed, pt.version from prepaid_tickets pt join (select visitor_group_no,prepaid_ticket_id, max(version) as version from prepaid_tickets where visitor_group_no in (167344709177764) group by prepaid_ticket_id, visitor_group_no) as maxptv on maxptv.visitor_group_no = pt.visitor_group_no and maxptv.prepaid_ticket_id = pt.prepaid_ticket_id and ABS(ROUND(maxptv.version-pt.version,1)) = '0' where pt.is_refunded = '0' and pt.action_performed like '%ADMND_COR' and pt.deleted = '0') as base on ptt.visitor_group_no = base.visitor_group_no and ABS(ptt.version-base.version) = '0' and ptt.is_refunded = '1') as base1 on ptt1.visitor_group_no = base1.order_id and ABS(ptt1.version-base1.version_to_update) = '0' set ptt1.deleted = '3', ptt1.action_performed = concat(ptt1.action_performed, ' Iceland_Refund_Missing_Entries') where base1.visitor_group_no is NULL

   --- VT

select vtt1.vt_group_no, vtt1.transaction_id,vtt1.version, vtt1.row_type, vtt1.action_performed, vtt1.is_refunded, vtt1.transaction_type_name from visitor_tickets vtt1 join (select base.*, vtt.vt_group_no as order_id, vtt.transaction_id as order_transaction_id, vtt.row_type as order_row_type from (select vt.vt_group_no, vt.transaction_id,vt.hotel_id,vt.ticketId,vt.selected_date, vt.version, vt.row_type, vt.admin_currency_code, vt.partner_net_price, vt.partner_gross_price, vt.tax_value, vt.transaction_type_name, vt.col2, vt.action_performed, vt.is_refunded from visitor_tickets vt join (select vt_group_no, transaction_id, row_type, max(version) as version from visitor_tickets where vt_group_no = '167344709177764' and col2 != '2' group by vt_group_no, transaction_id, row_type) as maxv on maxv.vt_group_no = vt.vt_group_no and (maxv.transaction_id+1) = (vt.transaction_id+1) and maxv.row_type = vt.row_type and ABS(ROUND(maxv.version-vt.version,1)) = '0' and vt.deleted = '0' and vt.action_performed like '%ADMND_COR' and vt.is_refunded = '0') as base left join visitor_tickets vtt on vtt.vt_group_no = base.vt_group_no and ABS(base.version-vtt.version) = '0' and vtt.action_performed not like '%ADMND_COR' and vtt.is_refunded = '1' and vtt.transaction_type_name not like '%Reprice%') as base1 on base1.vt_group_no = vtt1.vt_group_no and ABS(base1.version-vtt1.version) = '0' where base1.order_id is NULL limit 500


update visitor_tickets vtt1 join (select base.*, vtt.vt_group_no as order_id, vtt.transaction_id as order_transaction_id, vtt.row_type as order_row_type from (select vt.vt_group_no, vt.transaction_id,vt.hotel_id,vt.ticketId,vt.selected_date, vt.version, vt.row_type, vt.admin_currency_code, vt.partner_net_price, vt.partner_gross_price, vt.tax_value, vt.transaction_type_name, vt.col2, vt.action_performed, vt.is_refunded from visitor_tickets vt join (select vt_group_no, transaction_id, row_type, max(version) as version from visitor_tickets where vt_group_no = '167344709177764' and col2 != '2' group by vt_group_no, transaction_id, row_type) as maxv on maxv.vt_group_no = vt.vt_group_no and (maxv.transaction_id+1) = (vt.transaction_id+1) and maxv.row_type = vt.row_type and ABS(ROUND(maxv.version-vt.version,1)) = '0' and vt.deleted = '0' and vt.action_performed like '%ADMND_COR' and vt.is_refunded = '0') as base left join visitor_tickets vtt on vtt.vt_group_no = base.vt_group_no and ABS(base.version-vtt.version) = '0' and vtt.action_performed not like '%ADMND_COR' and vtt.is_refunded = '1' and vtt.transaction_type_name not like '%Reprice%') as base1 on base1.vt_group_no = vtt1.vt_group_no and ABS(base1.version-vtt1.version) = '0' set vtt1.deleted = '3', vtt1.action_performed = concat(vtt1.action_performed, ' Iceland_Refund_Missing_Entries') where base1.order_id is NULL


--------- Query to get the Latest record so that we can amend the pricing according to our need

select vt.vt_group_no, vt.transaction_id,vt.hotel_id,vt.ticketId,vt.selected_date, vt.version, vt.row_type, vt.admin_currency_code, vt.partner_net_price, vt.partner_gross_price, vt.tax_value, vt.transaction_type_name, vt.col2, vt.action_performed, vt.is_refunded from visitor_tickets vt join (select vt_group_no, transaction_id, row_type, max(version) as version from visitor_tickets where vt_group_no = '166997241092017' and col2 != '2' group by vt_group_no,row_type) as maxv on maxv.vt_group_no = vt.vt_group_no and maxv.row_type = vt.row_type and ABS(ROUND(maxv.version-vt.version,1)) = '0' and vt.deleted = '0' and vt.transaction_type_name not like '%Reprice%' and vt.col2!= '2' order by vt.version, vt.transaction_id, vt.row_type limit 200


--- Started with prepating insert query

insert into visitor_tickets (id, created_date, transaction_id, invoice_id, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, financial_id, financial_name, transaction_type_name, transaction_type_id, ticketId, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, ticket_title, ticketwithdifferentpricing, ticketpriceschedule_id, ticket_extra_option_id, group_type_ticket, group_price, group_quantity, group_linked_with, selected_date, booking_selected_date, from_time, to_time, slot_type, amount_before_extra_discount, discount_before_extra_discount, hto_id, visitor_group_no, roomNo, nights, user_age, gender, user_image, visitor_country, merchantAccountCode, merchantReference, original_pspReference, shopperReference, partner_id, relational_partner_id, partner_name, museum_name, museum_id, hotel_name, hotel_id, pos_point_id, pos_point_name, shift_id, passNo, pass_type, ticketAmt, visit_date, visit_date_time, ticketType, tickettype_name, discount_applied_on_how_many_tickets, paid, payment_method, isBillToHotel, card_name, pspReference, card_type, captured, age_group, discount, isDiscountInPercent, updated_discount_type, without_elo_reference_no, debitor, creditor, split_cash_amount, split_card_amount, split_voucher_amount, split_direct_payment_amount, total_gross_commission, total_net_commission, commission_type, partner_gross_price, order_currency_partner_gross_price, partner_gross_price_without_combi_discount, partner_net_price, order_currency_partner_net_price, partner_net_price_without_combi_discount, isCommissionInPercent, tax_id, tax_value, tax_name, timezone, invoice_status, row_type, updated_by_id, updated_by_username, voucher_updated_by, voucher_updated_by_name, redeem_method, redeem_by_ticket_id, redeem_by_ticket_title, cashier_id, cashier_name, cashier_register_id, targetlocation, paymentMethodType, targetcity, service_name, adjustment_row_type, description, distributor_status, adyen_status, adjustment_method, all_ticket_ids, time_based_done, visitor_invoice_id, ticketPrice, deleted, is_refunded, is_block, is_edited, vt_group_no, user_name, issuer_country_code, distributor_commission_invoice, activation_method, is_prioticket, is_shop_product, shop_category_name, external_account_number, used, ticket_status, is_prepaid, is_purchased_with_postpaid, invoice_type, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, invoice_variant, service_cost, service_cost_net_amount, service_cost_type, scanned_pass, groupTransactionId, booking_status, channel_type, is_voucher, extra_text_field_answer, distributor_type, distributor_partner_id, distributor_partner_name, issuer_country_name, chart_number, extra_discount, manual_payment_note, account_number, is_custom_setting, external_product_id, supplier_currency_code, col1, col2, partner_category_id, col4, partner_category_name, col6, col7, col8, is_data_moved, action_performed, updated_at, tp_payment_method, order_confirm_date, payment_date, order_cancellation_date, voucher_creation_date, primary_host_name,supplier_gross_price, supplier_discount, supplier_ticket_amt, supplier_tax_value,supplier_net_price, last_modified_at, market_merchant_id, merchant_admin_id, order_updated_cashier_id, order_updated_cashier_name, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code) select id, created_date, transaction_id, invoice_id, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, financial_id, financial_name, transaction_type_name, transaction_type_id, ticketId, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, ticket_title, ticketwithdifferentpricing, ticketpriceschedule_id, ticket_extra_option_id, group_type_ticket, group_price, group_quantity, group_linked_with, selected_date, booking_selected_date, from_time, to_time, slot_type, amount_before_extra_discount, discount_before_extra_discount, hto_id, visitor_group_no, roomNo, nights, user_age, gender, user_image, visitor_country, merchantAccountCode, merchantReference, original_pspReference, shopperReference, partner_id, relational_partner_id, partner_name, museum_name, museum_id, hotel_name, hotel_id, pos_point_id, pos_point_name, shift_id, passNo, pass_type, ticketAmt, visit_date, visit_date_time, ticketType, tickettype_name, discount_applied_on_how_many_tickets, paid, payment_method, isBillToHotel, card_name, pspReference, card_type, captured, age_group, discount, isDiscountInPercent, updated_discount_type, without_elo_reference_no, debitor, creditor, split_cash_amount, split_card_amount, split_voucher_amount, split_direct_payment_amount, total_gross_commission, total_net_commission, commission_type,round(((pricevalue/quanity)*(100+tax_value)/100),2) as partner_gross_price, order_currency_partner_gross_price, partner_gross_price_without_combi_discount,round(pricevalue/quanity,2) as partner_net_price, order_currency_partner_net_price, partner_net_price_without_combi_discount, isCommissionInPercent, tax_id, tax_value, tax_name, timezone, invoice_status, row_type, updated_by_id, updated_by_username, voucher_updated_by, voucher_updated_by_name, redeem_method, redeem_by_ticket_id, redeem_by_ticket_title, cashier_id, cashier_name, cashier_register_id, targetlocation, paymentMethodType, targetcity, service_name, adjustment_row_type, description, distributor_status, adyen_status, adjustment_method, all_ticket_ids, time_based_done, visitor_invoice_id, ticketPrice, deleted, is_refunded, is_block, is_edited, vt_group_no, user_name, issuer_country_code, distributor_commission_invoice, activation_method, is_prioticket, is_shop_product, shop_category_name, external_account_number, used, ticket_status, is_prepaid, is_purchased_with_postpaid, invoice_type, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, invoice_variant, service_cost, service_cost_net_amount, service_cost_type, scanned_pass, groupTransactionId, booking_status, channel_type, is_voucher, extra_text_field_answer, distributor_type, distributor_partner_id, distributor_partner_name, issuer_country_name, chart_number, extra_discount, manual_payment_note, account_number, is_custom_setting, external_product_id, supplier_currency_code, col1, col2, partner_category_id, col4, partner_category_name, col6, col7, col8, is_data_moved,concat(action_performed, ' IcelandPriceUpdate') as action_performed, updated_at, tp_payment_method, order_confirm_date, payment_date, order_cancellation_date, voucher_creation_date, primary_host_name,supplier_gross_price, supplier_discount, supplier_ticket_amt, supplier_tax_value,supplier_net_price, last_modified_at, market_merchant_id, merchant_admin_id, order_updated_cashier_id, order_updated_cashier_name,round(version+1,1) version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code from (select base.*,iceland.quanity, case when base.row_type = '1' then iceland.sale when base.row_type = '2' then iceland.purchase when base.row_type = '3' then iceland.distribtor when base.row_type = '4' then iceland.hgs else 0 end as pricevalue from (select vt.* from visitor_tickets vt join (select vt_group_no, transaction_id, row_type, max(version) as version from visitor_tickets where vt_group_no = '166997241092017' and col2 != '2' group by vt_group_no,row_type) as maxv on maxv.vt_group_no = vt.vt_group_no and maxv.row_type = vt.row_type and ABS(ROUND(maxv.version-vt.version,1)) = '0' and vt.deleted = '0' and vt.transaction_type_name not like '%Reprice%' and vt.col2!= '2') as base left join iceland on base.vt_group_no = iceland.vt_group_no) as final


-- PT Query

insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, \`unlock\`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image,vvt.sale_priceg as oroginal_price,vvt.sale_priceg as order_currency_oroginal_price,'0' as discount,'0' as order_currency_discount, pt.is_discount_in_percent,vvt.sale_priceg as price,vvt.sale_priceg as order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name,vvt.sale_price as net_price, vvt.sale_priceg as order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', IcelandPriceUpdate') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (166997241092017) and action_performed like '%IcelandPriceUpdate' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in (166997241092017) and action_performed like '%IcelandPriceUpdate' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no) as trp on ppt.visitor_group_no = trp.visitor_group_no and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';SELECT ROW_COUNT()


--- Remove Reprice entries

update visitor_tickets set deleted = '3', action_performed = concat(action_performed, 'IcelandPriceUpdate') where vt_group_no = '166997241092017' and transaction_type_name like '%Reprice%'
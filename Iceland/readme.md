-- query to check the latest version to verify data

select vt.vt_group_no, vt.transaction_id,vt.hotel_id,vt.ticketId,vt.selected_date, vt.version, vt.row_type, vt.admin_currency_code, vt.partner_net_price, vt.partner_gross_price, vt.tax_value, vt.transaction_type_name, vt.col2 from visitor_tickets vt join (select vt_group_no, transaction_id, row_type, max(version) as version from visitor_tickets where vt_group_no = '166997241092017' and col2 != '2' group by vt_group_no, transaction_id, row_type) as maxv on maxv.vt_group_no = vt.vt_group_no and maxv.transaction_id = vt.transaction_id and maxv.row_type = vt.row_type and ABS(ROUND(maxv.version-vt.version,1)) = '0' 


---- After excluding refunded entries

select * from (select vt.vt_group_no, concat(vt.transaction_id, 'R') as transaction_id,vt.hotel_id,vt.ticketId,vt.selected_date, vt.version, vt.row_type, vt.admin_currency_code, vt.partner_net_price, vt.partner_gross_price, vt.tax_value, vt.transaction_type_name, vt.col2, vt.is_refunded from visitor_tickets vt join (select vt_group_no, transaction_id, row_type, max(version) as version from visitor_tickets where vt_group_no = '167248376982761' and col2 != '2' group by vt_group_no, transaction_id, row_type) as maxv on maxv.vt_group_no = vt.vt_group_no and maxv.transaction_id = vt.transaction_id and maxv.row_type = vt.row_type and ABS(ROUND(maxv.version-vt.version,1)) = '0' where vt.is_refunded = '0') as base 


---- Query to get the total order id amount

select vt_group_no, transaction_id, hotel_id, ticketId, selected_date, version, max(admin_currency_code) as admin_currency_code,sum(case when row_type = '1' and transaction_type_name not like '%Reprice%' then 1 else 0 end) as quantity,sum(case when row_type = '1' and transaction_type_name not like '%Reprice%' then partner_net_price else 0 end) as saleprice,sum(case when row_type = '2' and transaction_type_name not like '%Reprice%' then partner_net_price else 0 end) as purchaseprice,sum(case when row_type = '3' and transaction_type_name not like '%Reprice%' then partner_net_price else 0 end) as commission,sum(case when row_type = '4' and transaction_type_name not like '%Reprice%' then partner_net_price else 0 end) as hgscommission,sum(case when row_type = '17' and transaction_type_name not like '%Reprice%' then partner_net_price else 0 end) as merchantcommission,sum(case when row_type = '1' and transaction_type_name like '%Reprice%' then partner_net_price else 0 end) as salepriceDiscount,sum(case when row_type = '2' and transaction_type_name like '%Reprice%' then partner_net_price else 0 end) as purchasepriceDiscount,sum(case when row_type = '3' and transaction_type_name like '%Reprice%' then partner_net_price else 0 end) as commissionDiscount,sum(case when row_type = '4' and transaction_type_name like '%Reprice%' then partner_net_price else 0 end) as hgscommissionDiscount,
sum(case when row_type = '17' and transaction_type_name like '%Reprice%' then partner_net_price else 0 end) as merchantcommissionDiscount  from (select vt.vt_group_no, concat(vt.transaction_id, 'R') as transaction_id,vt.hotel_id,vt.ticketId,vt.ticketpriceschedule_id,vt.selected_date, vt.version, vt.row_type, vt.admin_currency_code, vt.partner_net_price, vt.partner_gross_price, vt.tax_value, vt.transaction_type_name, vt.col2, vt.is_refunded from visitor_tickets vt join (select vt_group_no, transaction_id, row_type, max(version) as version from visitor_tickets where vt_group_no = '166997241092017' and col2 != '2' group by vt_group_no, transaction_id, row_type, ticketId, ticketpriceschedule_id) as maxv on maxv.vt_group_no = vt.vt_group_no and maxv.transaction_id = vt.transaction_id and maxv.row_type = vt.row_type and ABS(ROUND(maxv.version-vt.version,1)) = '0' where vt.is_refunded = '0') as base group by vt_group_no, ticketId, ticketpriceschedule_id
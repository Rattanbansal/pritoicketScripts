#!/bin/bash

set -e  # Exit immediately if any command exits with a non-zero status
TIMEOUT_PERIOD=25

> found_mismatch.txt
> no_mismatch.txt

DB_HOST='localhost'
DB_USER='admin'
DB_PASS='redhat'
DB_NAME='dummy'
BATCH_SIZE=30

mysqlHost="prodrds.prioticket.com"
mysqlUser=pipeuser
mysqlPassword=d4fb46eccNRAL
mysqlDatabase="prioprodrds"

SECDATABASE='priopassdb'
SECHOST='production-secondary-db-node.cluster-ck6w2al7sgpk.eu-west-1.rds.amazonaws.com'
SECUSER='pipeuser'
SECPASSWORD='d4fb46eccNRAL'

vt_group_nos="167449004944596 167715003238471 167965783246965 167872415223916 167958290660202 166619082215900 166566300362270 166617955254508 166550016510238 167527513251518 167577969680613 166704761600113 166620653865328 167567951828223 167490748530968 167786474913789 167655740208327 167413390223916 167293145769774 167344283540715 167146123356834 167302555488673 167302555316841 167292236831839 166644459075656 166963607741426 168155910306779 166912074343530 167248379789924 167309655816834 166316874563381 168026489981932 166679609974884 167006721938960 168243620003907 169926292152508 167146096075899 167299665893647 167379455600744 168009078430644 167456345020372 169720811849528 167249381557393 168138422771406 166678651973334 166645389055179 167327240780224 166576363134541 167347447192632 167398638119788 166799204791768 167295329516786 167295572939996 167293462942512 166643955590058 167034286513605 167301527498253 167612965844065 167300850784911 167386708787543 168017372314133 167032245371098 167344545327723 167406052086174 166669033915968 167570296914910 168148592903402 167958643000686 167344709177764 167472842667088 167327903760874 167516134614071 167292709802306 167286348666630 167301685729799 167465893687046 167343279342022 167516259615146 167663769136349 168096345819165 167612118394735 167898545668709 168156049658898 168010763974259 167845768398668 167881077376947 168997318525665 168545315849817 169037597185757 169867278257057 169296474009470 169305123385880 169624375822569 169832447516379 168527771261722 168804266302596 169435301311337 169045897693828 168613406443717 168918606740020 169713825223653 168960118301373 168942594776873 169210852740652 169436889877092 168491986372120 169452035247969 168880969942346 169918901585878 169841978248441 169686232442815 169444327924188 169468053599370 169514249417826 169943863546875 168303707882504 168424173971381 168906527638070 169770863395889 168096622213411 168122706428546 168242538134994 167654888636111 167664141163252 167731938697966 167144331910582 167761232787903 167973821192462 167395647578332 167310800521162 167308949905633 167516456457921 167310758685325 167308397430572 167370003974890 167397012820978 167854408567703 167759895752364 167603577964694 167318407658471 167708088838293 167515876457148 167508494746196 168069588434147 167533937943558 167567944838772 167525897554255 167508105873337 167587489196311 167603611270980 168120592188680 168208636281635 166479405199633 166461655241382 166454344819860 166498178612574 166480926187309 166480034308157 167025453249212 167422012095652 166748737702263 167310667796342 167999571520894 167517172426140 167526960077548 167751209626750 167413131420471 167371115725237 168258843740526 167352781944055 167516768144729 167516895795683 167387497126131 167370668557893 167509943284417 168215593320012 167147091004309 167179826325670 167473383570618 167043188482099 167140692741886 166885732738122 168199034665103 167853814329301 167362702996848 168016612901724 167284336639613 167293174783454 167285948416054 167612018062872 168242188203861 168175801327946 167354074646039 167351959526134 167353313483785 167362036672562 167466641363322 167516226760746 168156602456712 167646959154691 167671477155426 167654279365937 167698531023269 167248376982761 167266376414370 167853484878817 169174844101224 168744734274425 169227578234393 169816163296853 169840064268661 168838417240142 169417073716836 169538189794274 169471466038604 169306132592053 168269668476943 169270321788216 169417698515304 169607614889669 168304045084404 169601655275495 168312145148522 168328056804064 169816055235433 169721039556616 170067112814259 169124020910610 169651975332155 168389282632297 168269669876895 168484283530724 169088832708543 169953032643531 169071672497041 168476888955909 168493826745221 170419336474671 169826055611121 168880635366496 169486244086102 169831553710913 170118200269494 169356505646136 168855973623781 168330042462640 169036715364480 169278962782563 169728966190615 168303327308727 168313767150225 169962315885522 170385838093872 169762917997331 169572578461429 169720233622383 169408821110547 169080864766200 168839505735620 168296607991778 170481678470857 170102145878425 169727974009908 169659482697638 169841303567492 168519080792662 169798316392189 169684466536174 168425065953701 170464019528073 168294964839905 169839683279711 169591286968722 169046032452014 168511451469823 170372407143053 168310944539642 170440408777618 170600691669516 169260941250705 168596409826452 168276436195752 170532183947668 169185185947024 168614836702586 169185025793670 169961772057838 170661008871189 169194393883294 168909136014113 168813295372225 168759467235408 168474926529051 169220477708750 169053995503621 169089579761503 169046670554049 170368103611052 170689326738828 169668337685392 168302306843563 168302181259822 168302216344062 168302149858600 168760330377524 168268881856827 168302283861244 169624218346454 168545356115905 168518602315305 169045983937255 168968763509294 168372896497165 169304605087233 169805815192705 170609753991850 170153346592425 169744930202929 169598847878609 170386637474267 169901705023360 168448491795275 168414986164057 168605409476077 170506486898499 170392955657354 169081663017107 170436263726659 168302355980770 168788212226233 168439490692922 169081093077259 168812243738015 168424485496147 168693847688134 169833177227794 169599528359194 169280417854457 169236438353906 169141467368634 170644610243259 170237699100103 170713037335123 168439445295945 168570460715147 168812289293912 168495209228531 169148489929986 170697215930637 169115934866069 170697348043694 168562794593255 168422857805379 168751875537422 169166225079886 170126578366161 168562921230735 170317519335366 169425900369773 169945286664348 170662154266811 169909882871354 168779117552336 168872187718365 170541092254014 168310912520206 168916237622363 168310691004363 168354115259462 168294650056537 169237297971010 169885266253798 169954533322879 169401014699369 169348765062647 170065056799679 168727613021825 168328910880543 168572287196452 169539844481350 169606418364958 170436718075189 169790162699495 168278189534537 168312131373525 168665177092016 169081587098611 169541441382253 168371889682501 168690756622359 170859658602245 169114176665582 169929325801853 170307237417000 170611862739977 168354177570236 168476861874288 169988386359790 170531322846551 170455690148234 170645273475634 170004364680793 170125676409944 169746958177863 169349125380388 170290492696415 169641460413274 168855389405420 168477112556943 168277999488069 168890628726606 168321532684477 169062515207439 169289102350202 170023544251171 170680561768693 170307822913479 169528640013231 168312802342226 168319454973110 168718701147284 168355137442404 168753587509413 168373413539344 168328542841698 168778021504415 168382478067712 168327562951318 168381862637597 168286897805335 170680299145206 168371730343748 170066269101366 170428279512867 170903875273671 169910512288422 169841753039939 170300716286707 168425038244589 168277364575892 168347012636657 168820496475948 168951154277767 168400886560496 168485563276555 168304474153172 170712867077721 170696612169769 170836667222442 170472729071989 170816343598270 168329951623559 168302359532246 168423230772926 168302381290091 168416009514264 169296002197041 169762313202542 170653249758327 169226905816231 169727977868181 168440027567523 168726136602480 168500105210593 169002870389329 168502062059425 168681958465586 168500667217921 170714703330838 168976731434547 169945511064403 171016998273155 168329694130612 168657098598700 168527228361359 168510693039908 168615040652931 170515598029635 169943812447796 170644214966742 170852884526162 170394189249040 168381131295729 169037497931606 169002031072100 170248607206611 170394371851904 169364789723836 170473487956357 168813654360522 169425353627477 170964509148394 169591246584664 169762866180547 169450931210343 169754900339223 169633869980047 168511097192137 170453439536826 168320285233708 169504657161944 169971622592812 170448533009342 170454347714858 169461125486430 168399413359267 170472589360717"

for vt_group_no in ${vt_group_nos}

do

    # exit 1

    select_query_vt="insert into visitor_tickets (id, created_date, transaction_id, invoice_id, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, financial_id, financial_name, transaction_type_name, transaction_type_id, ticketId, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, ticket_title, ticketwithdifferentpricing, ticketpriceschedule_id, ticket_extra_option_id, group_type_ticket, group_price, group_quantity, group_linked_with, selected_date, booking_selected_date, from_time, to_time, slot_type, amount_before_extra_discount, discount_before_extra_discount, hto_id, visitor_group_no, roomNo, nights, user_age, gender, user_image, visitor_country, merchantAccountCode, merchantReference, original_pspReference, shopperReference, partner_id, relational_partner_id, partner_name, museum_name, museum_id, hotel_name, hotel_id, pos_point_id, pos_point_name, shift_id, passNo, pass_type, ticketAmt, visit_date, visit_date_time, ticketType, tickettype_name, discount_applied_on_how_many_tickets, paid, payment_method, isBillToHotel, card_name, pspReference, card_type, captured, age_group, discount, isDiscountInPercent, updated_discount_type, without_elo_reference_no, debitor, creditor, split_cash_amount, split_card_amount, split_voucher_amount, split_direct_payment_amount, total_gross_commission, total_net_commission, commission_type, partner_gross_price, order_currency_partner_gross_price, partner_gross_price_without_combi_discount, partner_net_price, order_currency_partner_net_price, partner_net_price_without_combi_discount, isCommissionInPercent, tax_id, tax_value, tax_name, timezone, invoice_status, row_type, updated_by_id, updated_by_username, voucher_updated_by, voucher_updated_by_name, redeem_method, redeem_by_ticket_id, redeem_by_ticket_title, cashier_id, cashier_name, cashier_register_id, targetlocation, paymentMethodType, targetcity, service_name, adjustment_row_type, description, distributor_status, adyen_status, adjustment_method, all_ticket_ids, time_based_done, visitor_invoice_id, ticketPrice, deleted, is_refunded, is_block, is_edited, vt_group_no, user_name, issuer_country_code, distributor_commission_invoice, activation_method, is_prioticket, is_shop_product, shop_category_name, external_account_number, used, ticket_status, is_prepaid, is_purchased_with_postpaid, invoice_type, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, invoice_variant, service_cost, service_cost_net_amount, service_cost_type, scanned_pass, groupTransactionId, booking_status, channel_type, is_voucher, extra_text_field_answer, distributor_type, distributor_partner_id, distributor_partner_name, issuer_country_name, chart_number, extra_discount, manual_payment_note, account_number, is_custom_setting, external_product_id, supplier_currency_code, col1, col2, partner_category_id, col4, partner_category_name, col6, col7, col8, is_data_moved, action_performed, updated_at, tp_payment_method, order_confirm_date, payment_date, order_cancellation_date, voucher_creation_date, primary_host_name,supplier_gross_price, supplier_discount, supplier_ticket_amt, supplier_tax_value,supplier_net_price, last_modified_at, market_merchant_id, merchant_admin_id, order_updated_cashier_id, order_updated_cashier_name, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code) select id, created_date, transaction_id, invoice_id, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, financial_id, financial_name, transaction_type_name, transaction_type_id, ticketId, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, ticket_title, ticketwithdifferentpricing, ticketpriceschedule_id, ticket_extra_option_id, group_type_ticket, group_price, group_quantity, group_linked_with, selected_date, booking_selected_date, from_time, to_time, slot_type, amount_before_extra_discount, discount_before_extra_discount, hto_id, visitor_group_no, roomNo, nights, user_age, gender, user_image, visitor_country, merchantAccountCode, merchantReference, original_pspReference, shopperReference, partner_id, relational_partner_id, partner_name, museum_name, museum_id, hotel_name, hotel_id, pos_point_id, pos_point_name, shift_id, passNo, pass_type, ticketAmt, visit_date, visit_date_time, ticketType, tickettype_name, discount_applied_on_how_many_tickets, paid, payment_method, isBillToHotel, card_name, pspReference, card_type, captured, age_group, discount, isDiscountInPercent, updated_discount_type, without_elo_reference_no, debitor, creditor, split_cash_amount, split_card_amount, split_voucher_amount, split_direct_payment_amount, total_gross_commission, total_net_commission, commission_type,round(((pricevalue/quanity)*(100+tax_value)/100),2) as partner_gross_price, order_currency_partner_gross_price, partner_gross_price_without_combi_discount,round(pricevalue/quanity,2) as partner_net_price, order_currency_partner_net_price, partner_net_price_without_combi_discount, isCommissionInPercent, tax_id, tax_value, tax_name, timezone, invoice_status, row_type, updated_by_id, updated_by_username, voucher_updated_by, voucher_updated_by_name, redeem_method, redeem_by_ticket_id, redeem_by_ticket_title, cashier_id, cashier_name, cashier_register_id, targetlocation, paymentMethodType, targetcity, service_name, adjustment_row_type, description, distributor_status, adyen_status, adjustment_method, all_ticket_ids, time_based_done, visitor_invoice_id, ticketPrice, deleted, is_refunded, is_block, is_edited, vt_group_no, user_name, issuer_country_code, distributor_commission_invoice, activation_method, is_prioticket, is_shop_product, shop_category_name, external_account_number, used, ticket_status, is_prepaid, is_purchased_with_postpaid, invoice_type, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, invoice_variant, service_cost, service_cost_net_amount, service_cost_type, scanned_pass, groupTransactionId, booking_status, channel_type, is_voucher, extra_text_field_answer, distributor_type, distributor_partner_id, distributor_partner_name, issuer_country_name, chart_number, extra_discount, manual_payment_note, account_number, is_custom_setting, external_product_id, supplier_currency_code, col1, col2, partner_category_id, col4, partner_category_name, col6, col7, col8, is_data_moved,concat(action_performed, ' IcelandPriceUpdate') as action_performed, updated_at, tp_payment_method, order_confirm_date, payment_date, order_cancellation_date, voucher_creation_date, primary_host_name,supplier_gross_price, supplier_discount, supplier_ticket_amt, supplier_tax_value,supplier_net_price, last_modified_at, market_merchant_id, merchant_admin_id, order_updated_cashier_id, order_updated_cashier_name,round(version+1,1) version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code from (select base.*,iceland.quanity, case when base.row_type = '1' then iceland.sale when base.row_type = '2' then iceland.purchase when base.row_type = '3' then iceland.distribtor when base.row_type = '4' then iceland.hgs else 0 end as pricevalue from (select vt.* from visitor_tickets vt join (select vt_group_no, transaction_id, row_type, max(version) as version from visitor_tickets where vt_group_no = '$vt_group_no' and col2 != '2' group by vt_group_no,row_type) as maxv on maxv.vt_group_no = vt.vt_group_no and maxv.row_type = vt.row_type and ABS(ROUND(maxv.version-vt.version,1)) = '0' and vt.deleted = '0' and vt.transaction_type_name not like '%Reprice%' and vt.col2!= '2') as base left join iceland on base.vt_group_no = iceland.vt_group_no) as final;SELECT ROW_COUNT();"

    echo "------$(date '+%Y-%m-%d %H:%M:%S.%3N')--------" >> vt_select_query.sql

    echo "$select_query_vt" >> vt_select_query.sql

    # sleep 3
    echo "VT RDS insert query vt"
    timeout $TIMEOUT_PERIOD time mysql -h"$mysqlHost" -u"$mysqlUser" -p"$mysqlPassword" -D"$mysqlDatabase" -sN -e "$select_query_vt" || exit 1

    # sleep 3

    echo "VT secondary insert query vt"
    timeout $TIMEOUT_PERIOD time mysql -h"$SECHOST" -u"$SECUSER" -p"$SECPASSWORD" -D"$SECDATABASE" -sN -e "$select_query_vt" || exit 1

    sleep 3
    select_query_pt="insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, \`unlock\`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image,vvt.sale_priceg as oroginal_price,vvt.sale_priceg as order_currency_oroginal_price,'0' as discount,'0' as order_currency_discount, pt.is_discount_in_percent,vvt.sale_priceg as price,vvt.sale_priceg as order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name,vvt.sale_price as net_price, vvt.sale_priceg as order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', IcelandPriceUpdate') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in ($vt_group_no) and action_performed like '%IcelandPriceUpdate' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in ($vt_group_no) and action_performed like '%IcelandPriceUpdate' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no) as trp on ppt.visitor_group_no = trp.visitor_group_no and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';SELECT ROW_COUNT()"

    echo "------$(date '+%Y-%m-%d %H:%M:%S.%3N')--------" >> pt_select_query.sql

    echo "$select_query_pt" >> pt_select_query.sql

    echo "pt insert query rds"

    timeout $TIMEOUT_PERIOD time mysql -h"$mysqlHost" -u"$mysqlUser" -p"$mysqlPassword" -D"$mysqlDatabase" -sN -e "$select_query_pt" || exit 1

    # sleep 3

    echo "pt insert query sec"

    timeout $TIMEOUT_PERIOD time mysql -h"$SECHOST" -u"$SECUSER" -p"$SECPASSWORD" -D"$SECDATABASE" -sN -e "$select_query_pt" || exit 1


    echo "Sleep Started to Run next VGNS"
    echo "------$(date '+%Y-%m-%d %H:%M:%S.%3N')--------"
    sleep 3

    curl https://report.prioticket.com/Insert_api_data_nested/api_results_v2/$vt_group_no

    exit 1


done



# select transaction_id, count(*) from visitor_tickets where vt_group_no in (172045255276797,171025431591257,171727346539316,172053346499600,171141947172133,171574639920145,172704081562491,171163934037471,171536931080789,171986309649833,172100781072771,171351848854810,171433057167697,171242616086533,171741139833003,171185633076512,172156075664258,171472054427291,172547458139142,171994602778711,171930733511999,171011644400218,172578141163575,171563415795607,172409437657983,172685575287572,171738344350056,171915181827493,171297041994939,171694065980369,171372664507728,172359779009045,171009727210196,171328800669347,171913769909957,171233843827790,171695329843824,172302377028197,172712340166603,171614164484789,171680191898746,171542971521723,172314356772802,172667004798377,171261513579759,172493962896932,172489212878186,172227461759518,171820765792530,171967693251310) and action_performed like '%RockFellerCommision_Update' group by transaction_id


# select transaction_id, row_type, version, partner_gross_price from visitor_tickets where vt_group_no in (172045255276797) and action_performed like '%RockFellerCommision_Update' group by transaction_id


# select prepaid_ticket_id, version, museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee from visitor_tickets where visitor_group_no in (172372552429548,172581021304387,171319842070743,172044725102381,172424987440319,171581197165690,172218824782823,171294830620865,171963335467192,172632428502457,171845059887457,171249535930396,171753352986167,171615494480590,172415206736420,172595013086763,172211262744573,171109848818468,172686371291316,171432563777550,172271791662673,171137599486683,172338975718524,171846823963922,172248768288914,171150416414760,171733260622365,172718747512263,172171190436226,172632333684048,171026681260426,171573650317812,171849895407657,171880775596472,172842214750400,172245315860611,171519070314444,171121424818909,171311329769765,171319400365877,171414246206059,172236811194455,172528341037576,172490619649031,171168096454202,172434321667956,172770507844065,171907540129772,171737520896895,171197228065742,172045255276797,171025431591257,171727346539316,172053346499600,171141947172133,171574639920145,172704081562491,171163934037471,171536931080789,171986309649833,172100781072771,171351848854810,171433057167697,171242616086533,171741139833003,171185633076512,172156075664258,171472054427291,172547458139142,171994602778711,171930733511999,171011644400218,172578141163575,171563415795607,172409437657983,172685575287572,171738344350056,171915181827493,171297041994939,171694065980369,171372664507728,172359779009045,171009727210196,171328800669347,171913769909957,171233843827790,171695329843824,172302377028197,172712340166603,171614164484789,171680191898746,171542971521723,172314356772802,172667004798377,171261513579759,172493962896932,172489212878186,172227461759518,171820765792530,171967693251310)
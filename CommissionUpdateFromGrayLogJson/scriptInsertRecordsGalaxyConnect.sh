#!/bin/bash

set -e  # Exit immediately if any command exits with a non-zero status
TIMEOUT_PERIOD=40


DB_HOST='localhost'
DB_USER='admin'
DB_PASS='redhat'
DB_NAME='dummy'
BATCH_SIZE=1
tablename=$1

mysqlHost="prodrds.prioticket.com"
mysqlUser=pipeuser
mysqlPassword=d4fb46eccNRAL
mysqlDatabase="prioprodrds"

SECDATABASE='priopassdb'
SECHOST='production-secondary-db-node.cluster-ck6w2al7sgpk.eu-west-1.rds.amazonaws.com'
SECUSER='pipeuser'
SECPASSWORD='d4fb46eccNRAL'


# vt_group_numbers=$(timeout $TIMEOUT_PERIOD time mysql -h"$DB_HOST" -u"$DB_USER" -p"$DB_PASS" -D"$DB_NAME" -sN -e "SELECT visitor_group_no FROM $tablename WHERE ticket_id = '$ticket_id' and status = '0'") || exit 1

vt_group_numbers="173201490691272 173201557246119 173202012132209 173202346363028 173204183677552 173204192662817 173204308387412 173204773668709 173204782360580 173204793919088 173204824412898 173204833961927 173204940316450 173205159656809 173205185151959 173205284300448 173206965083739 173208455631345 173208457980563 173208537629573 173209589316291 173209632661708 173209653050708 173209666639923 173209679827528 173209690896806 173209951047760 173210631788705 173210741828475 173211015629521 173211025802056 173212275203152 173212648443006 173212711420753 173212862281278 173212970977192 173213097628452 173213413935415 173218876806182 173219869042733 173219891442059 173220321526650 173220632932363 173221212210900 173221654132088 173221744341052 173221883734782 173221915177692 173222213210654 173222230905879 173222240635301 173222599242982 173222663029375 173222887319109 173226926197039 173227280820300 173227500250322 173227522656194 173227542886960 173228035403860 173228106381094 173228176492791 173228412354821 173228579147843 173228830455255 173228840116297 173228915229084 173228929706893 173229251257561 173229313803676 173229376603765 173229442833014 173229476916503 173229558078818 173229569705292 173229576807099 173229703966548 173229735794337 173229936362702 173229962135889 173230030408981 173230355707831 173230709150678 173230817269183 173230986130601 173231301887750 173231343301192 173231391735175 173231466051386 173231469612772 173235119551747 173235481777786 173235510260042 173235583295882 173235737627178 173235743992099 173235778992624 173235798931197 173235837971573 173235839692389 173236007102920 173236047101055 173236050919311 173236167912942 173236168464507 173236176741462 173236231055899 173236305162763 173236403524121 173236476520044 173236522893782 173236587403686 173236712204333 173236783038808 173236945418426 173237002035306 173237030115839 173237321419680 173237331224450 173237356989655 173237373335927 173237430685317 173237479285727 173237528146636 173237935271692 173237940288645 173238114209203 173238120207914 173238205631982 173238527155317 173238548532116 173238704863183 173238823351354 173239054207872 173239406124630 173239837267283 173239889488888 173240293454638 173240338161887 173242622957210 173243412247941 173243630818767 173244507681849 173244841347424 173244968321161 173244988119431 173244997690659 173245011554878 173245095721509 173245118278041 173245226808897 173245426908261 173245529678063 173245533270349 173245539762710 173245589554229 173245638090414 173245642895708 173245713477883 173245760970502 173246097766736 173246138863592 173246293770781 173246346535323 173246462555811 173246742711190 173246866377955 173246990818417 173247008714130 173247046283333 173247057070706 173247133009965 173247221474088 173247242556317 173247365921694 173247403242669 173247468927869 173247551066851 173247568124826 173247596532503 173247624129127 173247770529918 173247894430607 173248010449888 173248093970447 173248155805237 173248302560666 173248788743748 173248798866936 173249087209371 173249517052923 173251756298291 173251946739402 173252373685546 173252557978637 173252707237520 173252719128624 173252765489858 173253068561288 173253125632289 173253164585773 173253276851764 173253320908509 173253327954755 173253350119819 173253532254666 173253621880959 173253913157727 173253947321940 173254002641820 173254018755629 173254085892406 173254159473675 173254218110532 173254271256467 173254426221256 173254482494941 173254519805502 173254657303793 173254934643977 173254992584887 173254994412621 173255020450419 173255045375193 173255347784157 173255551980527 173255930102871 173255994612531 173256108335724 173256241860506 173256251275820 173256285736814 173256408749646 173256562916708 173256587173239 173256625386643 173256746931514 173256874309415 173256916502430 173256973228891 173257058219277 173257184898911 173257233075773 173257675304453 173257885894567 173258023240886 173259103926478 173260267280375 173261330326975 173261451236440 173261486299273 173261504896236 173261549433545 173261609629030 173261771445793 173261772590280 173261795847830 173261806974693 173262003698577 173262004718570 173262042020885 173262108923015 173262187680638 173262315222868 173262403776136 173262657374267 173262743919326 173262810124819 173262925475571 173262943691399 173262955967850 173262989941312 173263254098964 173263368746994 173263412582581 173263412760165 173263462994077 173263754719420 173263945266942 173263966355450 173264101197422 173264125515313 173264142188447 173264418519535 173264957158362 173265131533452 173265203127633 173265239287493 173265287254229 173265325754616 173265419147672 173265571844718 173265697690964 173265863822346 173266649424045 173268997439417 173269723512779 173270096009002 173270198380683 173270381422504 173270448563527 173270530175088 173270659414427 173270922437520 173270976092831 173270989173018 173271015459054 173271046708676 173271105521780 173271201185597 173271474057300 173271502414286 173271527212749 173271670270559 173271758893126 173271793134030 173271890894869 173272066276441 173272105458651 173272155968365 173272242014706 173272376413287 173272425707048 173272562675238 173272593636529 173272683621359 173273011292294 173273200653865 173273417150113 173273498784395 173273566747873 173273568018738 173274161670514 173274179180457 173274266674576 173274577835018 173274595151321 173274767242450 173274859254383 173275183439011 173275404690898 173277217330756 173277322823515 173277412748225 173277793522140 173277816701867 173277955041720 173278607935239 173278922658734 173278924955661 173279052769332 173279066773852 173279078903020 173279415195097 173279428162074 173279526636425 173279634930576 173279788082069 173279790434134 173279820490848 173279982784601 173280517014178 173280534777043 173280609591786 173280637435109 173281011779570 173281223626677 173281224596342 173281230206759 173281338013461 173281353036541 173281672912566 173281908197250 173282259340276 173282500870607 173282577693586 173282625230904 173282662967239 173282822111319 173282888793374 173282904907178 173283002463034 173283018246025 173283249790426 173283310871376 173283675131927 173283971995613 173284115980120 173285814352557 173286329824670 173286674732759 173286700958008 173286731167344 173286957129741 173287123539460 173287137543178 173287175715985 173287199762936 173287255865802 173287275456099 173287353981035 173287549107001 173287569596294 173287586588135 173287744860115 173287768841711 173287812635892 173287897288466 173287902535351 173287937425814 173287966525417 173287991429908 173288072229537 173288086443152 173288101843813 173288125672200 173288224145487 173288315921148 173288369800086 173288384995923 173288389730701 173288444570232 173288561360789 173288563121043 173288865781562 173288887218247 173289232515818 173289277695908 173289308420311 173289422623943 173289517024634 173289558411230 173289561527114 173289706324655 173289767935189 173289797959106 173289803255593 173289867032200 173290198401096 173290450675455 173290604891838 173290768648225 173290792371719 173290878256864 173291005092946 173291170307418 173291226054356 173291242817993 173291443498163 173291645344696 173291647014962 173291969691847 173292082794978 173292215356482 173292247703114 173292332670732 173292386099871 173292688343564 173293977354123 173294652563911 173295074399648 173295256192248 173295384290056 173295602896082 173295822409472 173296285559964 173296606700395 173296621825980 173296761018584 173296854950268 173296856573261 173296993238337 173297107101875 173297324674182 173297334648528 173297532387193 173297651774650 173297699395413 173297745020829 173297789193520 173297917131661 173298006497286 173298135299419 173298166110529 173298211697431 173298322249531 173299269334175 173299303472322 173299700765712 173299784190972 173299912053456 173300721418807 173304951078814 173304997716895 173305340924109 173305638204382 173305909848712 173306050430547 173306118166786 173306164614451 173306189758769 173306344295013 173306771675300 173308160477514 173308391890928 173308446660292 173308491380805 173308493249245 173308749593100 173309080542023 173309125325362 173309301208387 173313148326908 173313244158658 173313503865992 173313516770466 173313542115452 173313554226450 173313568884639 173313637406980 173313664013496 173313697717616 173313812945402 173313879355386 173313889009725 173314295480082 173314346164613 173314392641711 173314447307699 173314454701653 173314533960553 173314856129826 173314932037514 173314940420014 173314992212978 173315029003467 173315091557487 173315111340100 173315209275067 173315248850208 173315368109613 173315508047700 173315629046625 173315947142420 173316113671138 173316184149165 173316629174497 173316819405530 173316955068357 173317048977104 173317176388773 173317263720514 173317294969558 173317388753715 173317508632259 173317577060736 173317739977537 173317748038822 173317814414441 173318229039801 173318379206416 173320257504349 173320375829813 173321151101681 173321539893479 173322008372953 173322087519620 173322204386161 173322638920582 173322714011863 173322846700808 173322888608397 173322901368732 173322976124364 173323111989838 173323160726194 173323194591874 173323306644293 173323338172014 173323369790574 173323399806155 173323421722871 173323471945222 173323789478745 173324049546964 173324700898392 173324864263656 173325142920993 173325245507019 173325544349668 173325553260676 173325677356940 173325913067552 173326050431342 173326474915056 173326558760218 173326953633561 173327007514770 173328503773643 173330352482644 173330596052891 173330788198194 173330839977293 173331060727448 173331234617621 173331327880994 173331359541970 173331429405173 173331488208375 173331659693054 173331670536910 173332148087931 173332177317582 173332221060183 173332249524571 173332788166041 173332839650321 173332874714125 173332955470238 173333003005285 173333228201604 173333373717379 173333656132423 173334003614648 173334379610619 173334447328105 173334619141186 173334914002599 173338164179222 173338292865749 173338419312009 173339577980487 173339877357844 173339905502456 173339980473772 173339987204250 173340045078013 173340159127959 173341540764123 173341645618035 173342006246587 173342186620584 173342347007470 173342369966209 173342378599831 173342745411857 173342831434997 173343809388582 173347990409972 173348127365613 173348457001678 173348771942237 173348818008300 173348823282984 173348902726328 173348936025153 173348950651356 173349122246406 173349425873983 173349490930013 173349569572867 173349855892146 173349895606026 173349937127811 173350380997679 173350401013491 173351317539911 173351363672085 173351752375022 173352797515725 173355774532728 173356520248654 173357285229681 173357492673927 173357672610263 173357871678344 173357919605571 173357927275810 173357967424009 173358231509207 173358401499970 173358472413572 173358514776638 173358704493075 173358919464687 173358940512491 173358979769710 173358979958505 173359731451597 173360330720816 173360984445005 173361810162108 173364570470646 173364648109416 173365527506249 173365950067523 173366008242765 173366915291895 173367192045101 173368505795083 173368738056442 173369253020001 173369328427880 173369337636862 173373519796436 173373707717610 173373829455293 173373928732714 173374020188052 173374059890390 173374129915749 173374161394910 173374208409953 173374369271434 173374402317293 173374440509563 173374496643248 173374501494293 173374735897775 173374744645162 173375061101490 173375346836274 173375843187842 173375886594900 173375960651694 173375999445196 173376261128284 173376333551235 173376542222363 173376714606429 173377071279447 173377220217929 173377748624272 173377778618825 173378035485851 173378199367359 173381378640534 173382435747153 173382535629190 173382899641168 173382954399458 173383003269864 173383054672666 173383068520451 173383436272091 173383501894113 173383553192197 173383594386414 173383647871371 173383804862579 173383833285601 173383842132840 173383869770739 173384211458386 173384577802108 173384788660399 173385542130304 173385725120639 173385760833725 173385859438238 173385865625370 173386163713365 173386558376052 173386739674712 173386759572666 173387325960806 173390923923468 173391357791329 173391391708691 173391436750050 173391567556100 173391710761128 173391741480590 173391985387304 173392015356100 173392047309404 173392140364226 173392183813965 173392189966562 173392244492327 173392579031855 173392591909969 173392603874213 173392629005091 173392654283587 173392831402991 173393063460382 173393438201541 173393587939764 173393779307178 173394125042370 173394637346450 173394919959357 173395138325224 173399031845918 173399544163832 173400102204340 173400342125393 173400427192388 173400586630235 173400802655467 173401196156544 173401257297859 173401300346995 173401669778248 173401845296530 173402041030621 173402251989477 173402691756565 173402746356723 173402808896785 173402982213354 173403415498209 173403776213372 173403856273233 173403915096207 173404506065244 173404508901740 173404791921160 173404920374108 173405644095342 173406975848942 173408138671004 173408441606233 173408461545807 173408496297608 173408569459754 173408751255468 173408977994814 173409323393539 173409781929786 173409827725674 173409853179436 173409867008209 173409978816225 173410022338510 173410037541109 173410636572482 173410702133188 173410855873732 173410978009148 173411910550215 173412139362024 173412426943839 173412946403125 173416751685916 173416800168476 173417406275642 173417485883618 173417486724293 173417597594806 173418328828417 173418341657119 173418492124881 173418573799470 173418575998014 173418689525739 173419073844738 173419090906089 173419523935151 173419822021274 173420344159889 173420468633645 173420691836410 173420710475574 173425362466776 173426063707970 173426126872367 173426277389692 173426480521270 173426638961751 173427053160311 173427316492976 173427393931408 173427412668303 173427629735557 173428082604058 173428192035846 173428339312924 173428748765435 173428854838329 173429267376711 173429367245094 173429381074433 173429483105176 173429511674295 173429989339403 173430536762331 173433819767565 173434044042323 173434060671509 173434077674712 173434084383092 173434311711032 173434387768969 173434411571790 173434449167378 173434506478815 173434541293219 173434629715613 173434825805395 173435253981863 173435280919533 173435395119427 173435599607269 173435635375249 173435963252169 173435973147694 173435984157437 173436125369885 173436318692797 173436347680176 173436404284397 173436667182286 173436688372243 173436779801601 173436877674719 173437000670853 173437177245050 173437227461043 173437439088887 173437602825963 173437828664045 173438424424062 173438790821741 173441479911214 173442792560334 173442803526690 173442951752022 173443009046216 173443254927423 173443315182800 173443431539001 173443540945329 173443866586376 173443883837324 173443947125852 173444029922005 173444244489088 173444729515292 173444789776775 173444839201430 173445059247508 173445096016770 173445179998567 173445193206996 173445260019197 173446021172159 173446169127329 173446366771971 173446446853647 173446482605943 173446487771511 173446615141319 173447275735794 173447294014415 173447348770170 173447401798823 173447812154022 173450964938006 173451455752805 173451481076824 173451502302346 173451503064993 173451573058113 173451713240508 173451889092059 173452097163900 173452099252307 173452204508926 173452305815732 173452327708903 173452527758429 173452547782180 173452723574278 173452748891258 173452901629287 173452928855533 173453034966765 173453092130153 173453384203491 173453661961704 173453734371296 173453758944623 173453793659088 173453917699050 173454243604404 173454269572936 173454356655057 173454409629331 173454731521323 173454762954371 173454958751102 173455116924844 173455189452355 173455231425902 173455343061602 173455546048993 173455866398888 173455973947224 173456054893222 173456126506567 173457644827581 173459554414473 173459613250575 173460160389532 173460263538453 173460360574655 173460404272801 173460519638620 173460526758425 173461029759717 173461376097892 173461570874164 173461927154580 173462009150345 173462032830511 173462070993415 173462175797931 173462508850296 173462599622652 173462648033280 173462837181128 173463151314688 173463906751765 173464193615255 173464264969604 173464423601026 173464468305235 173464581181636 173464855501694 173465956766747 173468003756976 173468584414266 173468714014671 173468780266557 173468805818918 173468829531104 173469219374228 173469329678359 173469370503480 173469695290017 173469729008620 173469743704860 173469875704575 173469876717327 173469930656354 173470158592844 173470173284342 173470207531678 173470245728852 173470258882036 173470284852240 173470312117959 173470413684066 173470544414640 173470612494832 173470708770994 173470890525409 173470894132292 173471046124934 173471290024998 173471344992089 173471629374889 173471855467971 173471890768270 173472380254744 173472443199378 173472656740574 173472692049772 173472973286734 173473339692038 173473921034311 173476902021228 173477647455811 173477854453871 173477944441642 173478033918176 173478066657274 173478117813694 173478143138940 173478202493527 173478282008534 173478367925747 173478472274584 173478744346983 173478952865165 173478954515303 173479192088798 173479212189153 173479246037134 173479715870646 173479809516820 173480064828927 173480901091642 173480971622719 173481200535308 173481853855418 173481947460577 173485384026758 173485495765008 173486822443683 173486998803717 173487446535915 173487705419487 173487828199643 173487895971523 173488318260522 173488405478167 173488417731925 173488652094548 173489759567690 173489883077720 173490525204036 173490755096969 173491426734989 173491838741466 173492187143501 173494488778583 173494591124279 173494595678053 173494900507448 173495107090041 173495404102827 173495650058103 173495670668248 173495717644871 173495805887605 173496040838522 173496295812943 173496684181544 173496712696464 173496749349490 173496782619067 173496888958046 173497290680755 173497292714914 173497311373980 173497845929801 173498255967963 173498706094213 173498764772526 173498790083663 173499651930596 173499976029048 173502824441907 173503430396669 173503433268364 173503631611293 173503748189583 173504213204742 173504440391042 173504823424811 173505416672406 173505470257853 173505817581916 173505948667928 173505994833623 173506097008091 173507189376788 173507552917460 173507829619849 173508410107404 173511612690470 173512935580276 173512952555024 173513112095681 173513148867475 173513214871040 173513519860677 173513523842740 173513672440522 173513985395934 173515070183383 173515357636283 173520317725531 173520753679096 173521308600943 173521337212239 173521442678112 173521569751695 173521793947488 173522119300186 173522147229638 173522205472027 173522219175166 173522220498446 173522362881769 173522706257679 173522710162017 173522712687170 173522816866915 173522943885524 173522992354421 173523519222436 173523564541451 173523610278573 173523762897392 173523852135717 173524176274153 173524466218136 173525098402548 173525127794202 173525251435582 173525443938646 173525677677196 173526427904504 173526684392073 173528662277990 173529120668120 173529276327478 173529313081300 173529328792353 173529596774910 173529692291554 173529884279002 173529886353449 173529929064629 173529969122462 173529971555472 173530086984334 173530148017444 173530168640182 173530199576824 173530244348429 173530271090585 173530343666637 173530383314509 173530439422895 173530486998796 173530553540313 173530633015746 173530830898254 173530976317803 173531093415405 173531182225518 173531229436712 173531408833057 173531639082630 173531732928921 173532142725998 173532187795658 173532213644689 173532444591852 173532543473970 173532549538255 173532649949332 173532775817944 173532817433655 173532854395514 173532979480003 173533027453470 173533284341608 173533306559108 173533391687352 173533419384211 173533475591473 173533480910943 173533568415521 173533603677989 173533719821850 173533728535776 173533736705089 173533795684114 173533916290008 173534078382873 173534119869505 173534349859193 173534382104259 173534587362208 173534741244978 173537342471900 173537919137455 173537938365574 173537991318839 173538030793392 173538047393072 173538090659343 173538115058058 173538139654105 173538149494512 173538240087333 173538297488997 173538318190240 173538334038617 173538350665802 173538384734637 173538475187278 173538488856764 173538550149892 173538579874768 173538596745673 173538678766638 173538698237490 173538763866211 173538815518447 173538902132135 173539067763919 173539095361234 173539136411351 173539197850930 173539223843456 173539227352914 173539238532279 173539402708718 173539442163469 173539787837027 173539929908837 173540106402182 173540139462087 173540249522822 173540396320599 173540429658320 173540928820517 173541057580924 173541261962729 173541302119943 173541651423660 173541734712081 173542242523859 173542291726808 173542801528067 173543564651462 173545957859820 173546331181859 173546579313757 173546645896020 173546759385855 173546793284218 173546871255649 173547079997108 173547150254638 173547208646368 173547480539643 173547553100338 173547600638234 173547703505267 173547863440206 173547941816927 173547976060493 173547976860377 173548009165813 173548172056224 173548184758433 173548320604381 173548513466571 173548539333302 173548544199564 173548607975328 173548661569368 173548738718413 173549000278361 173549032625570 173549217829813 173549307553908 173549491035845 173549560285027 173549646879488 173549699754631 173549921127910 173549925839912 173549966857636 173550389207759 173550482229939 173550501977619 173550715971362 173550971325562 173551124824044 173551282852009 173551500970228 173551545483915"

# Convert the vt_group_numbers into an array
vt_group_array=($vt_group_numbers)
total_vt_groups=${#vt_group_array[@]}

echo $total_vt_groups


# Print the total count of vt_group_no for the current ticket_id
echo "Processing Ticket ID: $ticket_id with $total_vt_groups vt_group_no values"

# Initialize the progress tracking for the current ticket_id
current_progress=0

# Loop through vt_group_no array in batches
for ((i=0; i<$total_vt_groups; i+=BATCH_SIZE)); do
    # Create a batch of vt_group_no values
    batch=("${vt_group_array[@]:$i:$BATCH_SIZE}")
    batch_size=${#batch[@]}

    # Calculate the current progress level for this ticket_id
    current_progress=$((i + batch_size))
    
    # Join the batch into a comma-separated list
    batch_str=$(IFS=,; echo "${batch[*]}")

    # Print progress information for the current ticket_id
    echo "Processing batch of size $batch_size for Ticket ID: $ticket_id ($current_progress / $total_vt_groups processed)" >> log.txt
    
    # Construct and execute the UPDATE query
    # update_query="UPDATE your_table SET your_column = 'your_value' WHERE ticket_id = $ticket_id AND vt_group_no IN ($batch_str)"

        select_query_vt="insert into visitor_tickets (id, created_date, transaction_id, invoice_id, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, financial_id, financial_name, transaction_type_name, transaction_type_id, ticketId, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, ticket_title, ticketwithdifferentpricing, ticketpriceschedule_id, ticket_extra_option_id, group_type_ticket, group_price, group_quantity, group_linked_with, selected_date, booking_selected_date, from_time, to_time, slot_type, amount_before_extra_discount, discount_before_extra_discount, hto_id, visitor_group_no, roomNo, nights, user_age, gender, user_image, visitor_country, merchantAccountCode, merchantReference, original_pspReference, shopperReference, partner_id, relational_partner_id, partner_name, museum_name, museum_id, hotel_name, hotel_id, pos_point_id, pos_point_name, shift_id, passNo, pass_type, ticketAmt, visit_date, visit_date_time, ticketType, tickettype_name, discount_applied_on_how_many_tickets, paid, payment_method, isBillToHotel, card_name, pspReference, card_type, captured, age_group, discount, isDiscountInPercent, updated_discount_type, without_elo_reference_no, debitor, creditor, split_cash_amount, split_card_amount, split_voucher_amount, split_direct_payment_amount, total_gross_commission, total_net_commission, commission_type, partner_gross_price, order_currency_partner_gross_price, partner_gross_price_without_combi_discount, partner_net_price, order_currency_partner_net_price, partner_net_price_without_combi_discount, isCommissionInPercent, tax_id, tax_value, tax_name, timezone, invoice_status, row_type, updated_by_id, updated_by_username, voucher_updated_by, voucher_updated_by_name, redeem_method, redeem_by_ticket_id, redeem_by_ticket_title, cashier_id, cashier_name, cashier_register_id, targetlocation, paymentMethodType, targetcity, service_name, adjustment_row_type, description, distributor_status, adyen_status, adjustment_method, all_ticket_ids, time_based_done, visitor_invoice_id, ticketPrice, deleted, is_refunded, is_block, is_edited, vt_group_no, user_name, issuer_country_code, distributor_commission_invoice, activation_method, is_prioticket, is_shop_product, shop_category_name, external_account_number, used, ticket_status, is_prepaid, is_purchased_with_postpaid, invoice_type, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, invoice_variant, service_cost, service_cost_net_amount, service_cost_type, scanned_pass, groupTransactionId, booking_status, channel_type, is_voucher, extra_text_field_answer, distributor_type, distributor_partner_id, distributor_partner_name, issuer_country_name, chart_number, extra_discount, manual_payment_note, account_number, is_custom_setting, external_product_id, supplier_currency_code, col1, col2, partner_category_id, col4, partner_category_name, col6, col7, col8, is_data_moved, action_performed, updated_at, tp_payment_method, order_confirm_date, payment_date, order_cancellation_date, voucher_creation_date, primary_host_name,supplier_gross_price, supplier_discount, supplier_ticket_amt, supplier_tax_value,supplier_net_price, last_modified_at, market_merchant_id, merchant_admin_id, order_updated_cashier_id, order_updated_cashier_name, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code) select vtf.id, vtf.created_date, vtf.transaction_id, vtf.invoice_id, vtf.channel_id, vtf.channel_name, vtf.reseller_id, vtf.reseller_name, vtf.saledesk_id, vtf.saledesk_name, vtf.financial_id, vtf.financial_name, vtf.transaction_type_name, vtf.transaction_type_id, vtf.ticketId, vtf.shared_capacity_id, vtf.ticket_booking_id, vtf.related_order_id, vtf.related_booking_id, vtf.ticket_title, vtf.ticketwithdifferentpricing, vtf.ticketpriceschedule_id, vtf.ticket_extra_option_id, vtf.group_type_ticket, vtf.group_price, vtf.group_quantity, vtf.group_linked_with, vtf.selected_date, vtf.booking_selected_date, vtf.from_time, vtf.to_time, vtf.slot_type, vtf.amount_before_extra_discount, vtf.discount_before_extra_discount, vtf.hto_id, vtf.visitor_group_no, vtf.roomNo, vtf.nights, vtf.user_age, vtf.gender, vtf.user_image, vtf.visitor_country, vtf.merchantAccountCode, vtf.merchantReference, vtf.original_pspReference, vtf.shopperReference, vtf.partner_id, vtf.relational_partner_id, vtf.partner_name, vtf.museum_name, vtf.museum_id, vtf.hotel_name, vtf.hotel_id, vtf.pos_point_id, vtf.pos_point_name, vtf.shift_id, vtf.passNo, vtf.pass_type, vtf.ticketAmt, vtf.visit_date, vtf.visit_date_time, vtf.ticketType, vtf.tickettype_name, vtf.discount_applied_on_how_many_tickets, vtf.paid, vtf.payment_method, vtf.isBillToHotel, vtf.card_name, vtf.pspReference, vtf.card_type, vtf.captured, vtf.age_group, vtf.discount, vtf.isDiscountInPercent, vtf.updated_discount_type, vtf.without_elo_reference_no, vtf.debitor, vtf.creditor, vtf.split_cash_amount, vtf.split_card_amount, vtf.split_voucher_amount, vtf.split_direct_payment_amount, vtf.total_gross_commission, vtf.total_net_commission, vtf.commission_type, (case when vtf.row_type = ddd.ddd_row_type then ROUND(ddd.ddd_gross_should_be,2) else ROUND(vtf.partner_gross_price,2) end) as partner_gross_price, vtf.order_currency_partner_gross_price, vtf.partner_gross_price_without_combi_discount, (case when vtf.row_type = ddd.ddd_row_type then ROUND(ddd.ddd_should_be_net,2) else ROUND(vtf.partner_net_price,2) end) as partner_net_price, vtf.order_currency_partner_net_price, vtf.partner_net_price_without_combi_discount, vtf.isCommissionInPercent, vtf.tax_id, vtf.tax_value, vtf.tax_name, vtf.timezone, vtf.invoice_status, vtf.row_type, vtf.updated_by_id, vtf.updated_by_username, vtf.voucher_updated_by, vtf.voucher_updated_by_name, vtf.redeem_method, vtf.redeem_by_ticket_id, vtf.redeem_by_ticket_title, vtf.cashier_id, vtf.cashier_name, vtf.cashier_register_id, vtf.targetlocation, vtf.paymentMethodType, vtf.targetcity, vtf.service_name, vtf.adjustment_row_type, vtf.description, vtf.distributor_status, vtf.adyen_status, vtf.adjustment_method, vtf.all_ticket_ids, vtf.time_based_done, vtf.visitor_invoice_id, vtf.ticketPrice, vtf.deleted, vtf.is_refunded, vtf.is_block, vtf.is_edited, vtf.vt_group_no, vtf.user_name, vtf.issuer_country_code, vtf.distributor_commission_invoice, vtf.activation_method, vtf.is_prioticket, vtf.is_shop_product, vtf.shop_category_name, vtf.external_account_number, vtf.used, vtf.ticket_status, vtf.is_prepaid, vtf.is_purchased_with_postpaid, vtf.invoice_type, vtf.supplier_currency_symbol, vtf.order_currency_code, vtf.order_currency_symbol, vtf.currency_rate, vtf.invoice_variant, vtf.service_cost, vtf.service_cost_net_amount, vtf.service_cost_type, vtf.scanned_pass, vtf.groupTransactionId, vtf.booking_status, vtf.channel_type, vtf.is_voucher, vtf.extra_text_field_answer, vtf.distributor_type, vtf.distributor_partner_id, vtf.distributor_partner_name, vtf.issuer_country_name, vtf.chart_number, vtf.extra_discount, vtf.manual_payment_note, vtf.account_number, vtf.is_custom_setting, vtf.external_product_id, vtf.supplier_currency_code, vtf.col1, vtf.col2, vtf.partner_category_id, vtf.col4, vtf.partner_category_name, vtf.col6, vtf.col7, vtf.col8, vtf.is_data_moved,concat(vtf.action_performed, ', GalaxyConnectCommission') as action_performed, vtf.updated_at, vtf.tp_payment_method, vtf.order_confirm_date, vtf.payment_date, vtf.order_cancellation_date, vtf.voucher_creation_date, vtf.primary_host_name,supplier_gross_price, vtf.supplier_discount, vtf.supplier_ticket_amt, vtf.supplier_tax_value, supplier_net_price, CURRENT_TIMESTAMP as last_modified_at, vtf.market_merchant_id, vtf.merchant_admin_id, vtf.order_updated_cashier_id, vtf.order_updated_cashier_name, ROUND(vtf.version+1,1) as version, vtf.supplier_tax_id, vtf.merchant_currency_code, vtf.merchant_price, vtf.merchant_net_price, vtf.merchant_tax_id, vtf.admin_currency_code from (select fvt.* from visitor_tickets fvt join (select vt_group_no, transaction_id,row_type, max(version) as version from visitor_tickets where vt_group_no in ($batch_str) and col2 != '2' group by vt_group_no, transaction_id, row_type) as mv on mv.vt_group_no = fvt.vt_group_no and fvt.transaction_id = mv.transaction_id and fvt.row_type = mv.row_type and ABS(fvt.version-mv.version) = '0' where fvt.col2 != '2') vtf left join (select vtt.vt_group_no as ddd_vt_group_no, vtt.transaction_id as ddd_transaction_id, vtt.version as ddd_version,vtt.row_type as ddd_row_type,vtt.partner_net_price as ddd_partner_net_price,ROUND(case when final.commission_on_sale = '1' then (final.salePrice*final.percentage_commission/100) else ((final.salePrice-final.costpricing)*final.percentage_commission/100) end ,2) as ddd_should_be_net, vtt.partner_gross_price as ddd_partner_gross_price,vtt.tax_value as ddd_tax_value, FORMAT(ROUND(case when final.commission_on_sale = '1' then (final.salePrice*final.percentage_commission/100) else ((final.salePrice-final.costpricing)*final.percentage_commission/100) end,2),2)*(100+vtt.tax_value)/100 as ddd_gross_should_be, vtt.supplier_net_price as ddd_supplier_bet_price, vtt.supplier_gross_price as ddd_supplier_gross_price,vtt.supplier_tax_value as ddd_supplier_tax, vtt.action_performed as dd_action_performed, concat(vtt.action_performed, ', GalaxyConnectCommission') as dd_action_performed_should_be from visitor_tickets vtt join (SELECT
vt_group_no,
transaction_id,
hotel_id, channel_id, ticketId, ticketpriceschedule_id, version, row_type, partner_net_price,salePrice,costpricing, (case when row_type = '2' and tlc_ticketpriceschedule_id is not NULL then tlc_res_per when row_type = '2' and tlc_ticketpriceschedule_id is NULL and sc_ticketpriceschedule_id is not NULL then sc_res_per when row_type = '2' and tlc_ticketpriceschedule_id is NULL and sc_ticketpriceschedule_id is NULL and clc_ticketpriceschedule_id is not NULL then pl_res_per 
when row_type = '3' and tlc_ticketpriceschedule_id is not NULL then tlc_dist_per when row_type = '3' and tlc_ticketpriceschedule_id is NULL and sc_ticketpriceschedule_id is not NULL then sc_dist_per when row_type = '3' and tlc_ticketpriceschedule_id is NULL and sc_ticketpriceschedule_id is NULL and clc_ticketpriceschedule_id is not NULL then pl_dist_per
when row_type = '4' and tlc_ticketpriceschedule_id is not NULL then tlc_hgs_per when row_type = '4' and tlc_ticketpriceschedule_id is NULL and sc_ticketpriceschedule_id is not NULL then sc_hgs_per when row_type = '4' and tlc_ticketpriceschedule_id is NULL and sc_ticketpriceschedule_id is NULL and clc_ticketpriceschedule_id is not NULL then pl_hgs_per when row_type = '1' then '100.00' else 'No_Setting_found' end) as percentage_commission,
case when tlc_ticketpriceschedule_id is not NULL then tlc_comm_on_sale when tlc_ticketpriceschedule_id is NULL and sc_ticketpriceschedule_id is not NULL then sc_comm_on_sale when tlc_ticketpriceschedule_id is NULL and sc_ticketpriceschedule_id is NULL and clc_ticketpriceschedule_id is not NULL then pl_comm_on_sale else 'No_Setting_found' end as commission_on_sale
FROM
(
SELECT
scdata.*,
'----Price List Level---' AS type3,
pl.ticketpriceschedule_id AS clc_ticketpriceschedule_id,
pl.hotel_prepaid_commission_percentage as pl_dist_per,
pl.hgs_prepaid_commission_percentage as pl_hgs_per,
pl.merchant_fee_percentage as pl_mer_per,
pl.resale_percentage as pl_res_per,
pl.commission_on_sale_price as pl_comm_on_sale
FROM
(
SELECT
tlcdata.*,
'----Sub catalog Level---' AS type2,
sc.catalog_id,
sc.ticketpriceschedule_id AS sc_ticketpriceschedule_id,
sc.resale_currency_level AS sc_resale_currency_level,
sc.hotel_prepaid_commission_percentage as sc_dist_per,
sc.hgs_prepaid_commission_percentage as sc_hgs_per,
sc.merchant_fee_percentage as sc_mer_per,
sc.resale_percentage as sc_res_per,
sc.commission_on_sale_price as sc_comm_on_sale        
FROM
(
SELECT
vt.vt_group_no,
CONCAT(vt.transaction_id, 'R') AS transaction_id,
vt.order_confirm_date,
vt.created_date,
vt.hotel_id,
vt.channel_id,
vt.ticketId,
vt.ticketpriceschedule_id,
vt.version,
vt.row_type,
vt.partner_gross_price,
vt.partner_net_price,
maxversion.salePrice,
maxversion.costpricing,
vt.order_currency_partner_gross_price,
vt.order_currency_partner_net_price,
vt.supplier_gross_price,
vt.supplier_net_price,
vt.col2,
qc.cod_id AS company_id,
qc.channel_id AS company_pricelist_id,
qc.sub_catalog_id AS company_sub_catalog,
'---TLC LEVEL---' AS TYPE,
tlc.ticketpriceschedule_id AS tlc_ticketpriceschedule_id,
tlc.resale_currency_level,
tlc.hotel_prepaid_commission_percentage as tlc_dist_per,
tlc.hgs_prepaid_commission_percentage as tlc_hgs_per,
tlc.merchant_fee_percentage as tlc_mer_per,
tlc.resale_percentage as tlc_res_per,
tlc.commission_on_sale_price as tlc_comm_on_sale
FROM
visitor_tickets vt
JOIN(
SELECT
vt_group_no,
transaction_id,
row_type,
max(case when row_type = '1' then partner_net_price else 0 end) as salePrice,
max(case when row_type = '2' then partner_net_price else 0 end) as costpricing,
MAX(VERSION) AS VERSION
FROM
visitor_tickets
WHERE
vt_group_no in ($batch_str) AND col2 != '2' and transaction_type_name not like '%Reprice Surcharge%' and transaction_type_name not like '%Reprice Discount%' and ticket_title not like '%Discount code%'
GROUP BY
vt_group_no,
transaction_id
) AS maxversion
ON
vt.vt_group_no = maxversion.vt_group_no AND vt.transaction_id = maxversion.transaction_id AND ABS(vt.version - maxversion.version) = '0'
LEFT JOIN tmp.qr_codes qc
ON
qc.cod_id = vt.hotel_id AND qc.cashier_type = '1'
LEFT JOIN tmp.ticket_level_commission tlc
ON
tlc.hotel_id = vt.hotel_id AND tlc.ticketpriceschedule_id = vt.ticketpriceschedule_id AND tlc.ticket_id = vt.ticketId AND tlc.deleted = '0' AND tlc.is_adjust_pricing = '1'
WHERE
vt.col2 != '2'
) AS tlcdata
LEFT JOIN tmp.channel_level_commission sc
ON
tlcdata.ticketpriceschedule_id = sc.ticketpriceschedule_id AND tlcdata.ticketId = sc.ticket_id AND IF(
tlcdata.company_sub_catalog = '0',
122222,
tlcdata.company_sub_catalog
) = sc.catalog_id AND sc.is_adjust_pricing = '1' AND sc.deleted = '0'
) AS scdata
LEFT JOIN tmp.channel_level_commission pl
ON
scdata.ticketpriceschedule_id = pl.ticketpriceschedule_id AND scdata.ticketId = pl.ticket_id AND scdata.channel_id = pl.channel_id AND pl.catalog_id = '0' AND pl.is_adjust_pricing = '1' AND pl.deleted = '0'
) AS shouldbe) as final on vtt.vt_group_no = final.vt_group_no and ABS(vtt.version-final.version) = '0' and vtt.transaction_id = final.transaction_id and vtt.row_type = final.row_type where ABS(case when final.commission_on_sale = '1' then final.partner_net_price-(final.salePrice*final.percentage_commission/100) else final.partner_net_price-((final.salePrice-final.costpricing)*final.percentage_commission/100) end) > '0.02' and final.percentage_commission != 'No_Setting_found' and final.row_type not in ('1','2') and vtt.col2 != '2') as ddd on ddd.ddd_vt_group_no = vtf.vt_group_no and (ddd.ddd_transaction_id+1) = (vtf.transaction_id+1) and ABS(ddd.ddd_version - vtf.version) = '0' and vtf.row_type = ddd.ddd_row_type;SELECT ROW_COUNT();"
    
    echo "------$(date '+%Y-%m-%d %H:%M:%S.%3N')--------" >> vt_select_query.sql

    echo "$select_query_vt" >> vt_select_query.sql

    # sleep 3
    echo "VT RDS insert query vt"
    timeout $TIMEOUT_PERIOD time mysql -h"$mysqlHost" -u"$mysqlUser" -p"$mysqlPassword" -D"$mysqlDatabase" -sN -e "$select_query_vt" || exit 1

    # sleep 3

    # echo "VT secondary insert query vt"
    # timeout $TIMEOUT_PERIOD time mysql -h"$SECHOST" -u"$SECUSER" -p"$SECPASSWORD" -D"$SECDATABASE" -sN -e "$select_query_vt" || exit 1
        
    sleep 3
    select_query_pt="insert into prepaid_tickets (prepaid_ticket_id, is_combi_ticket, visitor_group_no, ticket_id, shared_capacity_id, ticket_booking_id, related_order_id, related_booking_id, hotel_ticket_overview_id, hotel_id, own_supplier_id, distributor_partner_id, distributor_partner_name, hotel_name, shift_id, cashier_register_id, pos_point_id, pos_point_name, channel_id, channel_name, reseller_id, reseller_name, saledesk_id, saledesk_name, title, age_group, museum_id, museum_name, additional_information, location, highlights, image, oroginal_price, order_currency_oroginal_price, discount, order_currency_discount, is_discount_in_percent, price, order_currency_price, ticket_scan_price, cc_rows_value, tax, distributor_type, tax_name, net_price, order_currency_net_price, ticket_amount_before_extra_discount, extra_discount, extra_fee, order_currency_extra_discount, is_combi_discount, combi_discount_gross_amount, order_currency_combi_discount_gross_amount, is_discount_code, discount_code_value, discount_code_amount, order_currency_discount_code_amount, discount_code_promotion_title, service_cost_type, service_cost, net_service_cost, ticket_type, ticket_type_additional_info, discount_applied_on_how_many_tickets, quantity, refund_quantity, timeslot, from_time, to_time, selected_date, booking_selected_date, valid_till, created_date_time, created_at, scanned_at, redemption_notified_at,action_performed, redeem_date_time, is_prioticket, product_type, shop_category_name, rezgo_id, rezgo_ticket_id, rezgo_ticket_price, tps_id, group_type_ticket, group_price, group_quantity, group_linked_with, group_id, supplier_currency_code, supplier_currency_symbol, order_currency_code, order_currency_symbol, currency_rate, selected_quantity, min_qty, max_qty, passNo, bleep_pass_no, pass_type, used, activated, visitor_tickets_id, activation_method, invoice_method_label, booking_type, split_payment_detail, timezone, is_pre_selected_ticket, is_prepaid, is_cancelled, deleted, time_based_done, booking_status, order_status, is_refunded, refunded_by, without_elo_reference_no, is_voucher, is_iticket_product, reference_id, is_addon_ticket, cluster_group_id, clustering_id, related_product_id, parent_product_id, related_product_title, pos_point_id_on_redeem, pos_point_name_on_redeem, distributor_id_on_redeem, distributor_cashier_id_on_redeem, third_party_type, third_party_booking_reference, third_party_response_data, supplier_original_price, supplier_discount, supplier_price, supplier_tax, supplier_net_price,museum_net_fee, distributor_net_fee,hgs_net_fee,museum_gross_fee, distributor_gross_fee,hgs_gross_fee, second_party_type, second_party_booking_reference, second_party_passNo, batch_id, batch_reference, cashier_id, cashier_name, redeem_users, cashier_code, location_code, voucher_updated_by, voucher_updated_by_name, redeem_method, tp_payment_method, order_confirm_date, payment_date, museum_cashier_id, museum_cashier_name, extra_text_field_answer, pick_up_location, refund_note, manual_payment_note, channel_type, financial_id, financial_name, is_custom_setting, external_product_id, account_number, chart_number, is_invoice, split_card_amount, split_cash_amount, split_voucher_amount, split_direct_payment_amount, is_data_moved, last_imported_date, redeem_by_ticket_id, redeem_by_ticket_title, updated_at, commission_type, barcode_type, guest_names, guest_emails, secondary_guest_email, secondary_guest_name, passport_number, order_status_hto, pspReference, merchantReference, merchantAccountCode, reserved_1, reserved_2, reserved_3, authcode, payment_gateway, payment_conditions, payment_term_category, order_cancellation_date, voucher_creation_date, partner_category_id, partner_category_name,last_modified_at, order_updated_cashier_id, order_updated_cashier_name, primary_host_name, is_order_confirmed, booking_information, extra_booking_information, contact_details, contact_information, phone_number, booking_details, market_merchant_id, merchant_admin_id, pax, capacity, commission_json, supplier_cost, partner_cost, tax_id, tax_exception_applied, version, supplier_tax_id, merchant_currency_code, merchant_price, merchant_net_price, merchant_tax_id, admin_currency_code, expiry_date, validity_date, \`unlock\`, checkin_uid, checkin_date, voucher_release_date) select ppt.* from (select pt.prepaid_ticket_id, pt.is_combi_ticket, pt.visitor_group_no, pt.ticket_id, pt.shared_capacity_id, pt.ticket_booking_id, pt.related_order_id, pt.related_booking_id, pt.hotel_ticket_overview_id, pt.hotel_id, pt.own_supplier_id, pt.distributor_partner_id, pt.distributor_partner_name, pt.hotel_name, pt.shift_id, pt.cashier_register_id, pt.pos_point_id, pt.pos_point_name, pt.channel_id, pt.channel_name, pt.reseller_id, pt.reseller_name, pt.saledesk_id, pt.saledesk_name, pt.title, pt.age_group, pt.museum_id, pt.museum_name, pt.additional_information, pt.location, pt.highlights, pt.image, pt.oroginal_price, pt.order_currency_oroginal_price, pt.discount, pt.order_currency_discount, pt.is_discount_in_percent, pt.price, pt.order_currency_price, pt.ticket_scan_price, pt.cc_rows_value, pt.tax, pt.distributor_type, pt.tax_name, pt.net_price, pt.order_currency_net_price, pt.ticket_amount_before_extra_discount, pt.extra_discount, pt.extra_fee, pt.order_currency_extra_discount, pt.is_combi_discount, pt.combi_discount_gross_amount, pt.order_currency_combi_discount_gross_amount, pt.is_discount_code, pt.discount_code_value, pt.discount_code_amount, pt.order_currency_discount_code_amount, pt.discount_code_promotion_title, pt.service_cost_type, pt.service_cost, pt.net_service_cost, pt.ticket_type, pt.ticket_type_additional_info, pt.discount_applied_on_how_many_tickets, pt.quantity, pt.refund_quantity, pt.timeslot, pt.from_time, pt.to_time, pt.selected_date, pt.booking_selected_date, pt.valid_till, pt.created_date_time, pt.created_at, pt.scanned_at, pt.redemption_notified_at, concat(pt.action_performed, ', GalaxyConnectCommission') as action_performed, pt.redeem_date_time, pt.is_prioticket, pt.product_type, pt.shop_category_name, pt.rezgo_id, pt.rezgo_ticket_id, pt.rezgo_ticket_price, pt.tps_id, pt.group_type_ticket, pt.group_price, pt.group_quantity, pt.group_linked_with, pt.group_id, pt.supplier_currency_code, pt.supplier_currency_symbol, pt.order_currency_code, pt.order_currency_symbol, pt.currency_rate, pt.selected_quantity, pt.min_qty, pt.max_qty, pt.passNo, pt.bleep_pass_no, pt.pass_type, pt.used, pt.activated, pt.visitor_tickets_id, pt.activation_method, pt.invoice_method_label, pt.booking_type, pt.split_payment_detail, pt.timezone, pt.is_pre_selected_ticket, pt.is_prepaid, pt.is_cancelled, pt.deleted, pt.time_based_done, pt.booking_status, pt.order_status, pt.is_refunded, pt.refunded_by, pt.without_elo_reference_no, pt.is_voucher, pt.is_iticket_product, pt.reference_id, pt.is_addon_ticket, pt.cluster_group_id, pt.clustering_id, pt.related_product_id, pt.parent_product_id, pt.related_product_title, pt.pos_point_id_on_redeem, pt.pos_point_name_on_redeem, pt.distributor_id_on_redeem, pt.distributor_cashier_id_on_redeem, pt.third_party_type, pt.third_party_booking_reference, pt.third_party_response_data, pt.supplier_original_price, pt.supplier_discount, pt.supplier_price, pt.supplier_tax, pt.supplier_net_price, vvt.purchase_price as museum_net_fee, vvt.distributor_fee as distributor_net_fee, vvt.hgs_fee as hgs_net_fee, vvt.purchase_priceg as museum_gross_fee, vvt.distributor_feeg as distributor_gross_fee, vvt.hgs_feeg as hgs_gross_fee, pt.second_party_type, pt.second_party_booking_reference, pt.second_party_passNo, pt.batch_id, pt.batch_reference, pt.cashier_id, pt.cashier_name, pt.redeem_users, pt.cashier_code, pt.location_code, pt.voucher_updated_by, pt.voucher_updated_by_name, pt.redeem_method, pt.tp_payment_method, pt.order_confirm_date, pt.payment_date, pt.museum_cashier_id, pt.museum_cashier_name, pt.extra_text_field_answer, pt.pick_up_location, pt.refund_note, pt.manual_payment_note, pt.channel_type, pt.financial_id, pt.financial_name, pt.is_custom_setting, pt.external_product_id, pt.account_number, pt.chart_number, pt.is_invoice, pt.split_card_amount, pt.split_cash_amount, pt.split_voucher_amount, pt.split_direct_payment_amount, pt.is_data_moved, pt.last_imported_date, pt.redeem_by_ticket_id, pt.redeem_by_ticket_title, pt.updated_at, pt.commission_type, pt.barcode_type, pt.guest_names, pt.guest_emails, pt.secondary_guest_email, pt.secondary_guest_name, pt.passport_number, pt.order_status_hto, pt.pspReference, pt.merchantReference, pt.merchantAccountCode, pt.reserved_1, pt.reserved_2, pt.reserved_3, pt.authcode, pt.payment_gateway, pt.payment_conditions, pt.payment_term_category, pt.order_cancellation_date, pt.voucher_creation_date, pt.partner_category_id, pt.partner_category_name,CURRENT_TIMESTAMP as last_modified_at, pt.order_updated_cashier_id, pt.order_updated_cashier_name, pt.primary_host_name, pt.is_order_confirmed, pt.booking_information, pt.extra_booking_information, pt.contact_details, pt.contact_information, pt.phone_number, pt.booking_details, pt.market_merchant_id, pt.merchant_admin_id, pt.pax, pt.capacity, pt.commission_json, pt.supplier_cost, pt.partner_cost, pt.tax_id, pt.tax_exception_applied, ROUND((pt.version+1),1) as version, pt.supplier_tax_id, pt.merchant_currency_code, pt.merchant_price, pt.merchant_net_price, pt.merchant_tax_id, pt.admin_currency_code, pt.expiry_date, pt.validity_date, pt.unlock, pt.checkin_uid, pt.checkin_date, pt.voucher_release_date from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in ($batch_str) and action_performed like '%GalaxyConnectCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2') as ppt join (select pt.visitor_group_no, pt.prepaid_ticket_id, max(pt.version) as version from prepaid_tickets pt join (SELECT transaction_id,vt_group_no,version,ticketId,MAX(CASE WHEN row_type = '1' THEN partner_net_price ELSE 0 END) AS sale_price,MAX(CASE WHEN row_type = '2' THEN partner_net_price ELSE 0 END) AS purchase_price,MAX(CASE WHEN row_type = '3' THEN partner_net_price ELSE 0 END) AS distributor_fee,MAX(CASE WHEN row_type = '4' THEN partner_net_price ELSE 0 END) AS hgs_fee,MAX(CASE WHEN row_type = '17' THEN partner_net_price ELSE 0 END) AS merchant_fee,MAX(CASE WHEN row_type = '1' THEN partner_gross_price ELSE 0 END) AS sale_priceg,MAX(CASE WHEN row_type = '2' THEN partner_gross_price ELSE 0 END) AS purchase_priceg,MAX(CASE WHEN row_type = '3' THEN partner_gross_price ELSE 0 END) AS distributor_feeg,MAX(CASE WHEN row_type = '4' THEN partner_gross_price ELSE 0 END) AS hgs_feeg FROM visitor_tickets WHERE vt_group_no in ($batch_str) and action_performed like '%GalaxyConnectCommission' and col2 != '2' GROUP BY vt_group_no,transaction_id,ticketpriceschedule_id) as vvt on pt.prepaid_ticket_id = vvt.transaction_id and pt.visitor_group_no = vvt.vt_group_no where pt.is_addon_ticket != '2' group by pt.visitor_group_no, pt.prepaid_ticket_id) as trp on ppt.visitor_group_no = trp.visitor_group_no and ppt.prepaid_ticket_id = trp.prepaid_ticket_id and ABS(ROUND(ppt.version-(trp.version+1),2)) = '0';SELECT ROW_COUNT()"

    echo "------$(date '+%Y-%m-%d %H:%M:%S.%3N')--------" >> pt_select_query.sql

    echo "$select_query_pt" >> pt_select_query.sql

    echo "pt insert query rds"

    timeout $TIMEOUT_PERIOD time mysql -h"$mysqlHost" -u"$mysqlUser" -p"$mysqlPassword" -D"$mysqlDatabase" -sN -e "$select_query_pt" || exit 1

    # sleep 3

    # echo "pt insert query sec"

    # timeout $TIMEOUT_PERIOD time mysql -h"$SECHOST" -u"$SECUSER" -p"$SECPASSWORD" -D"$SECDATABASE" -sN -e "$select_query_pt" || exit 1

    # sleep 3

    # timeout $TIMEOUT_PERIOD time mysql -h"$DB_HOST" -u"$DB_USER" -p"$DB_PASS" -D"$DB_NAME" -sN -e "update $tablename set status = '1' where visitor_group_no in ($batch_str);SELECT ROW_COUNT()" || exit 1

    echo "Sleep Started to Run next VGNS"
    echo "------$(date '+%Y-%m-%d %H:%M:%S.%3N')--------"

    echo "https://report.prioticket.com/Insert_api_data_nested/api_results_v2/$batch_str"
    curl https://report.prioticket.com/Insert_api_data_nested/api_results_v2/$batch_str

    exit 1
    
    sleep 3

done
